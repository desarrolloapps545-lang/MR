<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <!-- Icono de la pestaña (Favicon) -->
    <link rel="icon" href="img/spinner.png" type="image/png">
    <!-- FontAwesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #cccccc;
            /* display: flex; quitado para evitar conflicto de layout */
        }
        .sidebar {
            width: 220px;
            background-color: #16233c;
            color: white;
            padding: 20px;
            transition: width 0.3s ease, padding 0.3s ease;
            position: relative;
            z-index: 2001;
        }
        .sidebar h2 {
            margin-top: 0;
            text-align: center;
        }
        .sidebar-logo {
            text-align: center;
            margin-bottom: 2px;
        }
        /* Asegura que la imagen del logo se ajuste bien */
        .sidebar-logo img {
            width: 80px;
            border-radius: 15px; /* Bordes redondos */
            border: 3px solid white;
            height: auto;
            cursor: pointer;
        }
        .sidebar ul {
            list-style-type: none;
            padding: 0;
        }
        /* Estilos para sidebar colapsada */
        .sidebar.collapsed {
            width: 60px;
            padding: 20px 10px;
        }
        .sidebar.collapsed h2,
        .sidebar.collapsed #welcome-message,
        .sidebar.collapsed .sidebar-text {
            display: none;
        }
        .sidebar.collapsed .sidebar-logo img {
            width: 40px;
            border-width: 2px;
        }
        .sidebar.collapsed ul li a {
            text-align: center;
            padding: 10px 5px;
        }
        .sidebar.collapsed ul li a i {
            margin-right: 0;
            font-size: 20px;
        }
        
        .sidebar ul li a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            border: 2px solid white;
        }
        .sidebar ul li a:hover, .sidebar ul li a.active {
            background-color: #3498db;
        }
        .sidebar ul li a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .main-content {
            flex-grow: 1;
            padding: 30px;
        }
        .content-header, .modal-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #dfe3e8;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        #record-filters button {
            margin-left: 10px;
            background-color: #2ecc71; /* Verde */
        }
        #cobrador-filter, #municipio-filter-pagos {
            background-color: white;
            color: #333;
            margin-right: 10px;
        }
        #asesor-filter {
            background-color: #2ecc71; /* Verde */
            margin-right: 10px;
            padding-right: 30px; /* Espacio para la flecha */
        }
        .date-filter {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        .content-header h1 {
            margin: 0;
        }
        .btn {
            background-color: #2ecc71; /* Verde principal */
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background-color: #27ae60; /* Verde más oscuro */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #dfe3e8;
        }
        th {
            background-color: #f4f7f9;
            font-weight: 600;
        }
        /* Estilo para que el panel principal ocupe toda la altura */
        #admin-panel {
            min-height: 100vh;
            display: flex;
        }

        /* Estilos para el contenedor de Login */
        #login-container {
            width: 100%;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #cccccc;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #16233c;
            width: 100%;
            max-width: 360px;
            text-align: center;
        }
        .login-box img {
            border-radius: 15px;
            border: 3px solid white;
        }
        .login-box h2 {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #dfe3e8;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .login-box .btn {
            width: 100%;
            background-color: #16233c;
        }
        #error-message {
            color: #e74c3c;
            margin-top: 15px;
        }

        /* Estilos para el Modal */
        .modal {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 450px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        .close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #dfe3e8;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-content .btn {
            width: 100%;
        }
        #add-user-error {
            color: #e74c3c;
            margin-top: 10px;
        }

        /* Estilos para el selector de municipality personalizado */
        #municipality-container {
            margin-bottom: 15px;
        }
        #municipality-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .custom-select {
            position: relative;
        }
        .select-btn {
            width: 100%;
            padding: 12px;
            border: 1px solid #dfe3e8;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            width: 100%;
            box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dfe3e8;
        }
        .dropdown-content.show {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 5px;
            padding: 10px;
        }
        .dropdown-content label {
            color: black;
            padding: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
            font-size: 13px;
            border-radius: 4px;
        }
        .dropdown-content label:hover {
            background-color: #e8f5e9;
        }
        .dropdown-content input {
            margin-right: 10px;
        }

        /* Estilos para el tipo de registro */
        .type-sale, .type-payment {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .type-sale {
            background-color: #e74c3c; /* Rojo */
        }
        .type-payment {
            background-color: #2ecc71; /* Verde */
        }
        /* Pantalla de carga */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #cccccc;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #16233c;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        .loading-logo {
            width: 100px;
            height: auto;
            border-radius: 50%;
            border: 3px solid #90ee90;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        /* Toast Notification */
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        /* Small Spinner for checkboxes */
        .small-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #16233c;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
        }
        /* Estilos para lista de cupos en modal de eliminación */
        .quota-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .quota-item:hover {
            background-color: #f9f9f9;
        }
        /* Alineación de checkboxes en modal */
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }
        /* Estilo para casilla de total en modales de reporte */
        .total-box {
            border: 2px solid #2ecc71;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
        }
        .total-box h3 {
            margin: 0;
            color: #27ae60;
        }
        .filter-section {
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .filter-section h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 16px;
            color: #2c3e50;
        }
        .preview-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        /* Estilos para el grid de selección de municipios */
        #municipalities-list-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        #municipalities-list-container label {
            border: 2px solid #ccc; /* Marco gris */
            border-radius: 15px; /* Bordes redondos */
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Alineado a la izquierda */
            cursor: pointer;
            background-color: #f9f9f9;
            transition: background-color 0.2s;
        }
        #municipalities-list-container label:hover {
            background-color: #e0e0e0;
        }
        #municipalities-list-container label.selected {
            background-color: rgba(128, 128, 128, 0.5) !important; /* Gris medio transparente */
            border-color: #999;
        }
        #municipalities-list-container input[type="checkbox"] {
            display: none; /* Ocultar checkbox */
        }
        /* Estilo para el spinner del modal de actualización */
        .spinner-container {
            position: relative;
            display: inline-block;
            width: 80px;
            height: 80px;
        }
        .spinner-logo {
            width: 60px;
            height: 60px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border-radius: 50%;
            border: 2px solid #90ee90;
            box-sizing: border-box;
        }

        /* Estilos para inputs con búsqueda (Dropdowns personalizados) */
        .searchable-dropdown {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }
        .searchable-dropdown input {
            margin-bottom: 0 !important;
        }
        .dropdown-options {
            display: none;
            position: absolute;
            background-color: white;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dfe3e8;
            border-top: none;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 0 0 4px 4px;
        }
        .dropdown-options.show {
            display: block;
        }
        .dropdown-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }
        .dropdown-option:hover {
            background-color: #e8f5e9;
        }

        /* Ajuste para modal de editar cliente */
        #edit-client-modal .modal-content {
            max-height: 85vh;
            overflow-y: auto;
        }

        /* Ajuste para modal de editar crédito */
        #edit-credit-modal .modal-content {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Ocultar flechas de input number */
        input[type=number].no-spin::-webkit-outer-spin-button,
        input[type=number].no-spin::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number].no-spin {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        /* Botones sección usuarios */
        #add-user-btn,
        #add-user-form .btn,
        #edit-user-form .btn,
        #change-password-form .btn {
            background-color: #16233c;
        }
        #add-user-btn:hover, #add-user-form .btn:hover, #edit-user-form .btn:hover, #change-password-form .btn:hover {
            background-color: #3498db;
        }

        /* Estilos Sección Municipios */
        #municipalities-view .btn {
            background-color: #16233c;
            color: white;
        }
        #municipalities-view .btn:hover {
            background-color: #3498db;
        }
        #btn-view-municipalities-action,
        #btn-create-municipalities-action {
            background-color: white !important;
            color: black !important;
        }

        /* Botones azul oscuro específicos */
        #btn-save-imported-municipalities,
        #btn-create-municipality,
        #open-filter-modal-btn,
        #apply-filters-btn,
        #btn-pg-consult {
            background-color: #16233c;
            color: white;
        }
        #btn-save-imported-municipalities:hover,
        #btn-create-municipality:hover,
        #open-filter-modal-btn:hover,
        #apply-filters-btn:hover,
        #btn-pg-consult:hover {
            background-color: #3498db;
        }

        /* Botones Sección Clientes (Excluyendo acciones de tabla) */
        #clients-view .content-header .btn,
        #add-client-modal .btn,
        #edit-client-modal .btn,
        #search-client-modal .btn,
        #filter-advisor-modal .btn,
        #filter-municipality-modal .btn,
        #enable-credit-modal .btn {
             background-color: #16233c;
        }
        #clients-view .content-header .btn:hover,
        #add-client-modal .btn:hover,
        #edit-client-modal .btn:hover,
        #search-client-modal .btn:hover,
        #filter-advisor-modal .btn:hover,
        #filter-municipality-modal .btn:hover,
        #enable-credit-modal .btn:hover {
             background-color: #3498db;
        }

        /* Botones Sección Informes */
        #reports-view .btn,
        #report-filters-modal .btn {
            background-color: #16233c;
        }
        #reports-view .btn:hover,
        #report-filters-modal .btn:hover {
            background-color: #3498db;
        }
        #reports-view .btn.active {
            background-color: #3498db;
            border: 2px solid #90ee90;
        }

        /* Botones Modo P&G (Diario/Semanal) */
        .pg-mode-btn.active, .pb-mode-btn.active, .cr-mode-btn.active, .pm-mode-btn.active, .ex-mode-btn.active, .gn-mode-btn.active {
            background-color: #3498db !important;
            border: 2px solid #90ee90 !important;
        }
        .pg-mode-btn:hover, .pb-mode-btn:hover, .cr-mode-btn:hover, .pm-mode-btn:hover, .ex-mode-btn:hover, .gn-mode-btn:hover {
            background-color: #3498db !important;
        }

        /* Botones Exportar */
        #btn-open-export-date-modal,
        #btn-export-action,
        #btn-apply-export-date {
            background-color: #16233c;
        }
        #btn-open-export-date-modal:hover,
        #btn-export-action:hover,
        #btn-apply-export-date:hover {
            background-color: #3498db;
        }

        /* Estilos para el Menú de Bienvenida (Dashboard) */
        #welcome-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 80vh;
        }
        .welcome-logo-large {
            width: 110px;
            border-radius: 20px;
            border: 4px solid white;
            margin-bottom: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #dashboard-welcome-text {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 21px;
            text-align: center;
        }
        .dashboard-container {
            background-color: #16233c;
            padding: 40px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: auto;
            border: 2px solid white;
        }
        .dashboard-btn {
            background-color: transparent;
            border: 2px solid white;
            color: white;
            padding: 15px 25px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            gap: 20px;
            transition: all 0.3s ease;
            height: auto;
            width: 280px;
            white-space: nowrap;
        }
        .dashboard-btn:hover {
            background-color: #3498db;
            transform: translateY(-5px);
        }
        .dashboard-btn i {
            font-size: 24px;
            width: 30px;
            text-align: center;
        }

        /* Clases para la animación de transición de bienvenida */
        .logo-animating {
            position: fixed !important;
            z-index: 3000;
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .dashboard-fade-out {
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #sidebar-expand-btn {
            border: none !important;
        }

        /* Estilos para botones del Dashboard */
        .dashboard-control-btn {
            background-color: #16233c !important;
            color: white;
            height: 50px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .dashboard-control-btn:hover, .dashboard-control-btn.active {
            background-color: #3498db !important;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.7); /* Estela azul */
        }

        #sidebar-expand-btn {
            display: none;
        }

        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 3999;
        }
        .sidebar-overlay.active {
            display: block;
        }

        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            /* Sidebar for Mobile */
            .sidebar {
                position: fixed;
                left: -320px; /* Hidden by default */
                top: 0;
                bottom: 0;
                height: auto;
                width: 250px;
                padding: 20px;
                transition: left 0.3s ease-in-out;
                box-shadow: 2px 0 5px rgba(0,0,0,0.5);
                z-index: 4000;
                overflow-y: auto;
            }

            .sidebar.sidebar-mobile-open { left: 0; }

            #mobile-nav-bar {
                display: none; /* Controlado por JS */
                position: absolute; /* Se mueve con el scroll */
                top: 0;
                left: 0;
                width: 100%;
                height: 70px;
                z-index: 3500;
                background-color: #cccccc;
                align-items: center;
                padding-left: 10px;
                box-sizing: border-box;
            }

            #sidebar-expand-btn {
                display: flex;
                background-color: transparent !important;
                border: none !important;
                width: 55px;
                height: 55px;
                padding: 0 !important;
                justify-content: center;
                align-items: center;
                box-shadow: none !important;
            }

            #sidebar-expand-btn img {
                width: 100%;
                height: 100%;
                border-radius: 15px; /* Cuadrado redondeado como el logo */
                border: 2px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                object-fit: cover;
            }
            
            #admin-panel {
                display: block;
            }

            /* Main Content on Mobile */
            .main-content {
                padding: 15px;
                margin-top: 70px; /* Space for fixed button */
                width: 100%;
                box-sizing: border-box;
                margin-left: 0;
            }

            /* Welcome/Dashboard View */
            #welcome-view {
                padding: 15px;
                min-height: 0;
                height: auto;
            }
            .dashboard-container {
                padding: 20px;
                width: 100%;
                box-sizing: border-box;
            }
            .dashboard-btn {
                width: 100%;
                box-sizing: border-box;
            }

            /* Headers */
            .content-header, .modal-header-custom {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .content-header > div {
                flex-wrap: wrap;
            }

            #dashboard-controls {
                flex-wrap: wrap;
            }

            /* Login */
            .login-box {
                padding: 20px;
                width: 90%;
                border: none;
                box-shadow: none;
            }

            /* Modals */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 15px;
                max-height: 90vh;
            }
            #create-municipality-section,
            #view-municipalities-section,
            #import-municipalities-section {
                padding: 20px;
                width: 100%;
                box-sizing: border-box;
            }

            /* Report Filters */
            #pg-report-container > div,
            #payment-behavior-report-container > div,
            #credits-report-container > div,
            #payments-report-container > div,
            #expenses-report-container > div,
            #general-report-container > div {
                gap: 15px;
                padding: 15px;
            }
            #pg-report-container > div > div,
            #payment-behavior-report-container > div > div,
            #credits-report-container > div > div,
            #payments-report-container > div > div,
            #expenses-report-container > div > div,
            #general-report-container > div > div {
                flex-basis: 100%;
                min-width: 0 !important;
            }

            /* Ajustes para botones y campos dentro de los filtros de reportes en móvil */
            #pg-report-container > div > div > div,
            #payment-behavior-report-container > div > div > div,
            #credits-report-container > div > div > div,
            #payments-report-container > div > div > div,
            #expenses-report-container > div > div > div,
            #general-report-container > div > div > div {
                flex-wrap: wrap;
            }

            /* Ajustes para tablas en móvil para que no se corten tanto */
            table {
                font-size: 12px;
            }
            th, td {
                padding: 6px 4px;
                white-space: nowrap;
            }
        }
        
        /* Estilos para el dropdown de historial de pagos (Comportamiento de Pago) */
        .history-dropdown-row {
            background-color: #f9f9f9;
        }
        .history-table-container {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            position: relative;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }
        .history-download-btn {
            position: static;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .history-download-btn:hover {
            background-color: #2980b9;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        .history-table th, .history-table td {
            border: 1px solid #eee;
            padding: 8px;
            text-align: left;
        }
        .history-table th {
            background-color: #f4f7f9;
            font-weight: 600;
        }
    </style>
</head>
<body>

<div id="loading-screen">
    <img src="img/spinner.png" alt="Cargando..." class="loading-logo">
</div>

<div id="admin-panel" style="display: none;"> 
    <div id="mobile-nav-bar" style="display: none;">
        <button id="sidebar-expand-btn" class="btn"><img src="img/logo.png" alt="Menu"></button>
    </div>
    <div class="sidebar">
        <div class="sidebar-logo">
            <!-- Reemplaza 'URL_DE_TU_IMAGEN' con el enlace real de tu logo -->
            <img src="img/logo.png" alt="Logo">
        </div>
        <h2>Admin M&R</h2>
        <p id="welcome-message" style="text-align: center; margin-top: -15px; margin-bottom: 20px; font-size: 14px; color: #ecf0f1; font-weight: 500;"></p>
        <ul>
            <li><a href="#" class="active" id="nav-users"><i class="fas fa-users"></i> <span class="sidebar-text">Usuarios</span></a></li>
            <li><a href="#" id="nav-clients"><i class="fas fa-address-book"></i> <span class="sidebar-text">Clientes</span></a></li>
            <li><a href="#" id="nav-municipalities"><i class="fas fa-map-marked-alt"></i> <span class="sidebar-text">Municipios</span></a></li>
            <li><a href="#" id="nav-app-data"><i class="fas fa-database"></i> <span class="sidebar-text">Tablero de control</span></a></li>
            <li><a href="#" id="nav-import"><i class="fas fa-file-import"></i> <span class="sidebar-text">Importar</span></a></li>
            <li><a href="#" id="nav-export"><i class="fas fa-file-export"></i> <span class="sidebar-text">Exportar</span></a></li>
            <li><a href="#" id="nav-reports"><i class="fas fa-chart-line"></i> <span class="sidebar-text">Informes</span></a></li>
            <li><a href="#" id="refresh-btn"><i class="fas fa-sync-alt"></i> <span class="sidebar-text">Actualizar</span></a></li>
            <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Cerrar Sesión</span></a></li>
        </ul>
    </div>

    <div class="main-content">
        <div class="content-header" id="main-content-header">
            <h1 id="content-title">Gestión de Usuarios</h1>
            <div id="dashboard-controls" style="display: none; align-items: center; gap: 10px;">
                <button class="btn dashboard-control-btn active" id="btn-dashboard-daily" style="min-width: 100px;">Diario</button>
                <button class="btn dashboard-control-btn" id="btn-dashboard-weekly" style="min-width: 100px;">Semanal</button>
                <button class="btn dashboard-control-btn" id="btn-dashboard-refresh" style="width: 50px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                <button class="btn dashboard-control-btn" id="btn-dashboard-download" style="width: 50px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 20px;" title="Descargar"><i class="fas fa-download"></i></button>
            </div>
            <button class="btn" id="open-filter-modal-btn" style="display: none;"><i class="fas fa-filter"></i> Filtrar Datos</button>
            <button class="btn" id="add-user-btn"><i class="fas fa-user-plus"></i> Añadir Usuario</button>
        </div>

        <div id="welcome-view" style="display: none;">
            <img src="img/logo.png" alt="Logo" class="welcome-logo-large">
            <h1 id="dashboard-welcome-text">Bienvenido</h1>
            <div class="dashboard-container">
                <button class="dashboard-btn" onclick="document.getElementById('nav-users').click()"><i class="fas fa-users"></i> Usuarios</button>
                <button class="dashboard-btn" onclick="document.getElementById('nav-clients').click()"><i class="fas fa-address-book"></i> Clientes</button>
                <button class="dashboard-btn" onclick="document.getElementById('nav-municipalities').click()"><i class="fas fa-map-marked-alt"></i> Municipios</button>
                <button class="dashboard-btn" onclick="document.getElementById('nav-app-data').click()"><i class="fas fa-database"></i> Tablero de control</button>
                <button class="dashboard-btn" onclick="document.getElementById('nav-import').click()"><i class="fas fa-file-import"></i> Importar</button>
                <button class="dashboard-btn" onclick="document.getElementById('nav-export').click()"><i class="fas fa-file-export"></i> Exportar</button>
                <button class="dashboard-btn" onclick="document.getElementById('nav-reports').click()"><i class="fas fa-chart-line"></i> Informes</button>
                <button class="dashboard-btn" onclick="document.getElementById('logout-btn').click()"><i class="fas fa-sign-out-alt"></i> Salir</button>
            </div>
        </div>

        <div id="workspace-loader" style="display: none; justify-content: center; align-items: center; height: 70vh; width: 100%;">
            <div class="spinner"></div>
        </div>

        <div class="table-responsive">
            <table id="users-table">
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Cédula</th>
                    <th>Email</th>
                    <th>Municipios</th>
                    <th>Fecha de Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <!-- Los datos de los usuarios se cargarán aquí con JavaScript -->
            </tbody>
            </table>
        </div>

        <div class="table-responsive">
            <table id="payments-table" style="display: none;">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Saldo</th>
                    <th>Cuotas</th>
                    <th>Municipio</th>
                    <th>Registrado por</th>
                    <th>Día</th>
                    <th>Fecha de Prestamo</th>
                </tr>
            </thead>
            <tbody id="payments-table-body">
                <!-- Los datos de los registros se cargarán aquí con JavaScript -->
            </tbody>
            </table>
        </div>

        <div id="dashboard-view" style="display: none;">
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <!-- Tabla Créditos (Izquierda) -->
                <div style="flex: 1; min-width: 45%;">
                    <h2 style="color: #2c3e50; border-bottom: 2px solid #27ae60; padding-bottom: 10px;">Créditos</h2>
                    <div class="table-responsive">
                        <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th>ASESOR</th>
                                <th>MUNICIPIO</th>
                                <th>TIPO CREDITO</th>
                                <th>VALOR CREDITO</th>
                                <th>GANANCIAS</th>
                                <th>VALOR CUOTA</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-creditos-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabla Cobros (Derecha) -->
                <div style="flex: 1; min-width: 45%;">
                    <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">Cobros</h2>
                    <div class="table-responsive">
                        <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th>ASESOR</th>
                                <th>MUNICIPIO</th>
                                <th>COBRO</th>
                                <th>RECAUDO</th>
                                <th>% COBRO</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-cobros-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="clients-view" style="display: none;">
            <div class="content-header">
                <h1>Gestión de Clientes</h1>
                <div style="display: flex; gap: 10px;">
                    <div id="multi-delete-controls" style="display: none; align-items: center; gap: 10px;">
                        <span id="multi-delete-count" style="font-weight: bold; color: #e74c3c;">0 seleccionados</span>
                        <button class="btn" id="btn-confirm-multi-delete" style="background-color: #c0392b; padding: 5px 15px;"><i class="fas fa-trash"></i> Eliminar</button>
                        <button class="btn" id="btn-cancel-multi-delete" style="background-color: #95a5a6; padding: 5px 15px;"><i class="fas fa-times"></i> Cancelar</button>
                    </div>
                    <button class="btn" id="btn-multi-delete-mode" style="background-color: #e74c3c;"><i class="fas fa-trash-alt"></i> Eliminación Múltiple</button>
                    <button class="btn" id="open-search-client-btn"><i class="fas fa-search"></i> Buscar Cliente</button>
                    <button class="btn" id="add-client-btn"><i class="fas fa-user-plus"></i> Nuevo Cliente</button>
                </div>
            </div>
            <div class="table-responsive">
                <table id="clients-table">
                <thead>
                    <tr>
                        <th class="multi-delete-col" style="display: none; width: 30px; text-align: center;"><input type="checkbox" id="select-all-clients"></th>
                        <th>Cliente</th>
                        <th>Cédula</th>
                        <th>Teléfono</th>
                        <th>Municipio</th>
                        <th>Estado Crédito</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="clients-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="municipalities-view" style="display: none;">
            <div class="content-header">
                <h1>Gestión de Municipios</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" id="btn-view-municipalities-action"><i class="fas fa-eye"></i> Ver Municipios</button>
                    <button class="btn" id="btn-create-municipalities-action"><i class="fas fa-plus"></i> Crear Municipios</button>
                    <button class="btn" id="btn-open-import-municipalities"><i class="fas fa-file-import"></i> Importar Municipios</button>
                </div>
            </div>
            
            <div id="municipalities-workspace">
                <div id="municipalities-default-msg" style="text-align: center; padding: 50px; color: #7f8c8d;">
                    <h2>Seleccione una acción a realizar</h2>
                    <i class="fas fa-arrow-up" style="font-size: 2em;"></i>
                </div>

                <div id="create-municipality-section" class="login-box" style="max-width: 600px; margin: 0 auto; text-align: left; display: none;">
                <h2 style="text-align: center;">Crear Municipio</h2>
                <form id="create-municipality-form">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Departamento:</label>
                    <div class="searchable-dropdown">
                        <input type="text" id="municipality-department-select" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <div class="dropdown-options" id="list-municipality-department-select"></div>
                    </div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Municipios:</label>
                    <div id="municipality-inputs-container">
                        <input type="text" class="municipality-input" placeholder="Nombre del Municipio" required style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
                    </div>
                    <button type="button" id="btn-add-municipality-field" class="btn" style="margin-bottom: 15px; width: 100%;"><i class="fas fa-plus"></i> Agregar otro municipio</button>
                    <button type="submit" id="btn-create-municipality" class="btn" style="width: 100%;"><i class="fas fa-save"></i> Crear Municipio</button>
                </form>
                </div>

                <div id="view-municipalities-section" class="login-box" style="max-width: 600px; margin: 0 auto; text-align: left; display: none;">
                    <h2 style="text-align: center;">Ver Municipios</h2>
                    <label>Seleccionar Departamento:</label>
                    <div class="searchable-dropdown">
                        <input type="text" id="view-municipality-department-search" placeholder="Buscar departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                        <div class="dropdown-options" id="list-view-municipality-department"></div>
                    </div>
                    <button id="btn-search-municipalities-list" class="btn" style="width: 100%; margin-bottom: 15px;"><i class="fas fa-search"></i> Buscar</button>
                    
                    <h3 id="municipalities-list-title" style="color: #27ae60; display: none;"></h3>
                    <div id="municipalities-list-result" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>

                <div id="import-municipalities-section" class="login-box" style="max-width: 600px; margin: 0 auto; text-align: left; display: none;">
                    <h2 style="text-align: center;">Importar Municipios</h2>
                    <form id="import-municipalities-form">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Departamento:</label>
                        <div class="searchable-dropdown">
                            <input type="text" id="import-municipality-department-select" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-import-municipality-department-select"></div>
                        </div>
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Seleccionar Word o PDF:</label>
                        <input type="file" id="municipality-file-input" accept=".docx,.doc,.pdf" required style="margin-bottom: 15px;">
                        <button type="submit" class="btn" style="width: 100%;"><i class="fas fa-upload"></i> Procesar e Importar</button>
                    </form>
                    <div id="import-municipalities-status" style="margin-top: 10px; text-align: center; color: #27ae60; font-weight: bold;"></div>
                </div>
            </div>
        </div>

        <div id="reports-view" style="display: none;">
            <div class="content-header">
                <h1>Informes</h1>
                <div style="display: flex; gap: 10px;">
                    <button class="btn report-nav-btn" id="btn-report-pg">
                        <i class="fas fa-balance-scale"></i> P&G
                    </button>
                    <button class="btn report-nav-btn" id="btn-report-payment-behavior">
                        <i class="fas fa-chart-bar"></i> COMPORTAMIENTO DE PAGO
                    </button>
                    <button class="btn report-nav-btn" id="btn-report-credits">
                        <i class="fas fa-hand-holding-usd"></i> CREDITOS
                    </button>
                    <button class="btn report-nav-btn" id="btn-report-payments">
                        <i class="fas fa-money-bill-wave"></i> COBROS
                    </button>
                    <button class="btn report-nav-btn" id="btn-report-expenses">
                        <i class="fas fa-receipt"></i> OTROS GASTOS
                    </button>
                    <button class="btn report-nav-btn" id="btn-report-general">
                        <i class="fas fa-file-alt"></i> REPORTES
                    </button>
                </div>
            </div>

            <div id="reports-default-msg" style="text-align: center; padding: 50px; color: #7f8c8d;">
                <h2>Seleccione el tipo de informe</h2>
                <i class="fas fa-chart-pie" style="font-size: 3em; margin-top: 20px;"></i>
            </div>

            <!-- Contenedor P&G -->
            <div id="pg-report-container" style="display: none; margin-top: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 32px; align-items: flex-start; margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Departamento:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pg-filter-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pg-filter-department"></div>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Municipio:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pg-filter-municipality" placeholder="Seleccionar Municipio..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pg-filter-municipality"></div>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Usuario:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pg-filter-user" placeholder="Seleccionar Usuario..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pg-filter-user"></div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; visibility: hidden;">Modo</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn pg-mode-btn" id="btn-pg-daily" style="background-color: #16233c;">Diario</button>
                            <button class="btn pg-mode-btn" id="btn-pg-weekly" style="background-color: #16233c;">Semanal</button>
                        </div>
                    </div>
                    <div style="flex: 1 1 auto; min-width: 380px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Fecha:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="btn-pg-filter-date" class="btn" style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white; color: #333; display: flex; justify-content: space-between; align-items: center; font-weight: normal;">
                                <span id="pg-filter-date-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Seleccionar Fecha</span>
                                <i class="fas fa-calendar-alt" style="flex-shrink: 0; margin-left: 5px;"></i>
                            </button>
                            <button id="btn-pg-consult" class="btn"><i class="fas fa-search"></i> Consultar</button>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end;">
                            <button id="btn-pg-refresh" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                            <button id="btn-pg-download" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Descargar"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <div class="table-responsive">
                        <table id="pg-table">
                        <thead>
                            <tr>
                                <th>FECHA</th>
                                <th>ASESOR</th>
                                <th>MUNICIPIO</th>
                                <th>COBRO REAL</th>
                                <th>GASTOS</th>
                                <th>CREDITOS</th>
                                <th>GANANCIA</th>
                                <th>RECAUDO</th>
                            </tr>
                        </thead>
                        <tbody id="pg-table-body">
                            <!-- Sin datos por ahora -->
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenedor Comportamiento de Pago -->
            <div id="payment-behavior-report-container" style="display: none; margin-top: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 32px; align-items: flex-start; margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Departamento:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pb-filter-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pb-filter-department"></div>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Municipio:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pb-filter-municipality" placeholder="Seleccionar Municipio..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pb-filter-municipality"></div>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Usuario:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pb-filter-user" placeholder="Seleccionar Usuario..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pb-filter-user"></div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; visibility: hidden;">Modo</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn pb-mode-btn" id="btn-pb-daily" style="background-color: #16233c;">Diario</button>
                            <button class="btn pb-mode-btn" id="btn-pb-weekly" style="background-color: #16233c;">Semanal</button>
                        </div>
                    </div>
                    <div style="flex: 1 1 auto; min-width: 380px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Fecha:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="btn-pb-filter-date" class="btn" style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white; color: #333; display: flex; justify-content: space-between; align-items: center; font-weight: normal;">
                                <span id="pb-filter-date-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Seleccionar Fecha</span>
                                <i class="fas fa-calendar-alt" style="flex-shrink: 0; margin-left: 5px;"></i>
                            </button>
                            <button id="btn-pb-consult" class="btn"><i class="fas fa-search"></i> Consultar</button>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end;">
                            <button id="btn-pb-refresh" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                            <button id="btn-pb-download" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Descargar"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <div class="table-responsive">
                        <table id="pb-table">
                        <thead>
                            <tr>
                                <th>CLIENTE</th>
                                <th>MUNICIPIO</th>
                                <th>ASESOR</th>
                                <th>FECHA PRESTAMO</th>
                                <th>NUEVOS</th>
                                <th>REPRESTES</th>
                                <th>VALOR CUOTA</th>
                                <th>ABONOS</th>
                                <th>SALDO</th>
                            </tr>
                        </thead>
                        <tbody id="pb-table-body">
                            <!-- Datos -->
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenedor Informe de Créditos -->
            <div id="credits-report-container" style="display: none; margin-top: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 32px; margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="flex: 0 1 200px; min-width: 150px; display: flex; flex-direction: column;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Departamento:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="cr-filter-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-cr-filter-department"></div>
                        </div>
                        <div style="margin-top: auto; padding-top: 15px;">
                            <h3 style="margin: 0; color: #2c3e50; font-size: 14px;">TOTAL CREDITOS: <span id="cr-total-display">$0</span></h3>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Municipio:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="cr-filter-municipality" placeholder="Seleccionar Municipio..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-cr-filter-municipality"></div>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Usuario:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="cr-filter-user" placeholder="Seleccionar Usuario..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-cr-filter-user"></div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; visibility: hidden;">Modo</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn cr-mode-btn" id="btn-cr-daily" style="background-color: #16233c;">Diario</button>
                            <button class="btn cr-mode-btn" id="btn-cr-weekly" style="background-color: #16233c;">Semanal</button>
                        </div>
                    </div>
                    <div style="flex: 1 1 auto; min-width: 380px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Fecha:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="btn-cr-filter-date" class="btn" style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white; color: #333; display: flex; justify-content: space-between; align-items: center; font-weight: normal;">
                                <span id="cr-filter-date-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Seleccionar Fecha</span>
                                <i class="fas fa-calendar-alt" style="flex-shrink: 0; margin-left: 5px;"></i>
                            </button>
                            <button id="btn-cr-consult" class="btn"><i class="fas fa-search"></i> Consultar</button>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end;">
                            <button id="btn-cr-refresh" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                            <button id="btn-cr-download" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Descargar"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <div class="table-responsive">
                        <table id="cr-table">
                        <thead>
                            <tr>
                                <th>CLIENTE</th>
                                <th>FECHA</th>
                                <th>ASESOR</th>
                                <th>MUNICIPIO</th>
                                <th>NUEVO</th>
                                <th>REPRESTE</th>
                            </tr>
                        </thead>
                        <tbody id="cr-table-body">
                            <!-- Datos -->
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenedor Informe de Cobros -->
            <div id="payments-report-container" style="display: none; margin-top: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 32px; margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="flex: 0 1 200px; min-width: 150px; display: flex; flex-direction: column;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Departamento:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pm-filter-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pm-filter-department"></div>
                        </div>
                        <div style="margin-top: auto; padding-top: 15px;">
                            <h4 style="margin: 0; color: #2c3e50; font-size: 13px;">COBRO REAL: <span id="pm-total-cobro-display">$0</span></h4>
                            <h4 style="margin: 5px 0 0 0; color: #27ae60; font-size: 13px;">RECAUDO: <span id="pm-total-recaudo-display">$0</span></h4>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Municipio:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pm-filter-municipality" placeholder="Seleccionar Municipio..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pm-filter-municipality"></div>
                        </div>
                    </div>
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Usuario:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="pm-filter-user" placeholder="Seleccionar Usuario..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-pm-filter-user"></div>
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; visibility: hidden;">Modo</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn pm-mode-btn" id="btn-pm-daily" style="background-color: #16233c;">Diario</button>
                            <button class="btn pm-mode-btn" id="btn-pm-weekly" style="background-color: #16233c;">Semanal</button>
                        </div>
                    </div>
                    <div style="flex: 1 1 auto; min-width: 380px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Fecha:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="btn-pm-filter-date" class="btn" style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white; color: #333; display: flex; justify-content: space-between; align-items: center; font-weight: normal;">
                                <span id="pm-filter-date-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Seleccionar Fecha</span>
                                <i class="fas fa-calendar-alt" style="flex-shrink: 0; margin-left: 5px;"></i>
                            </button>
                            <button id="btn-pm-consult" class="btn"><i class="fas fa-search"></i> Consultar</button>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end;">
                            <button id="btn-pm-refresh" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                            <button id="btn-pm-download" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Descargar"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <div class="table-responsive">
                        <table id="pm-table">
                        <thead>
                            <tr>
                                <th>CLIENTE</th>
                                <th>FECHA</th>
                                <th>ASESOR</th>
                                <th>MUNICIPIO</th>
                                <th>CUOTA</th>
                                <th>ABONO</th>
                            </tr>
                        </thead>
                        <tbody id="pm-table-body">
                            <!-- Datos -->
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenedor Informe de Otros Gastos -->
            <div id="expenses-report-container" style="display: none; margin-top: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 32px; align-items: flex-end; margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Usuario:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="ex-filter-user" placeholder="Seleccionar Usuario..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-ex-filter-user"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn ex-mode-btn" id="btn-ex-daily" style="background-color: #16233c;">Diario</button>
                        <button class="btn ex-mode-btn" id="btn-ex-weekly" style="background-color: #16233c;">Semanal</button>
                    </div>
                    <div style="flex: 0 1 auto; min-width: 380px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Fecha:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="btn-ex-filter-date" class="btn" style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white; color: #333; display: flex; justify-content: space-between; align-items: center; font-weight: normal;">
                                <span id="ex-filter-date-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Seleccionar Fecha</span>
                                <i class="fas fa-calendar-alt" style="flex-shrink: 0; margin-left: 5px;"></i>
                            </button>
                            <button id="btn-ex-consult" class="btn"><i class="fas fa-search"></i> Consultar</button>
                            <button id="btn-ex-refresh" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                            <button id="btn-ex-download" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Descargar"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <div class="table-responsive">
                        <table id="ex-table">
                        <thead>
                            <tr>
                                <th>ASESOR</th>
                                <th>FECHA</th>
                                <th>VALOR</th>
                                <th>DESCRIPCION</th>
                            </tr>
                        </thead>
                        <tbody id="ex-table-body">
                            <!-- Datos -->
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Contenedor Informe General (Reportes) -->
            <div id="general-report-container" style="display: none; margin-top: 20px;">
                <div style="display: flex; flex-wrap: wrap; gap: 32px; align-items: flex-end; margin-bottom: 20px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="flex: 0 1 200px; min-width: 150px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Usuario:</label>
                        <div class="searchable-dropdown" style="margin-bottom: 0;">
                            <input type="text" id="gn-filter-user" placeholder="Seleccionar Usuario..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                            <div class="dropdown-options" id="list-gn-filter-user"></div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn gn-mode-btn" id="btn-gn-daily" style="background-color: #16233c;">Diario</button>
                        <button class="btn gn-mode-btn" id="btn-gn-weekly" style="background-color: #16233c;">Semanal</button>
                    </div>
                    <div style="flex: 0 1 auto; min-width: 380px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Fecha:</label>
                        <div style="display: flex; gap: 5px;">
                            <button id="btn-gn-filter-date" class="btn" style="flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background-color: white; color: #333; display: flex; justify-content: space-between; align-items: center; font-weight: normal;">
                                <span id="gn-filter-date-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Seleccionar Fecha</span>
                                <i class="fas fa-calendar-alt" style="flex-shrink: 0; margin-left: 5px;"></i>
                            </button>
                            <button id="btn-gn-consult" class="btn"><i class="fas fa-search"></i> Consultar</button>
                            <button id="btn-gn-refresh" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                            <button id="btn-gn-download" class="btn" style="width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; margin-left: 5px; flex-shrink: 0;" title="Descargar"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <div class="table-responsive">
                        <table id="gn-table">
                        <thead>
                            <tr>
                                <th>ASESOR</th>
                                <th>CREDITO</th>
                                <th>COBRO</th>
                                <th>GASTOS</th>
                                <th>BASE INICIAL</th>
                                <th>BASE FINAL</th>
                                <th>DIA</th>
                                <th>FECHA</th>
                            </tr>
                        </thead>
                        <tbody id="gn-table-body">
                            <!-- Datos -->
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>


</div>

<div id="login-container" style="display: none;">
    <div class="login-box">
        <img src="img/logo.png" alt="Logo" style="width: 100px; margin-bottom: 15px;">
        <h2>Inversiones M&R</h2>
        <form id="login-form">
            <input type="email" id="email" placeholder="Correo electrónico" required>
            <input type="password" id="password" placeholder="Contraseña" required>
            <button type="submit" class="btn"><i class="fas fa-sign-in-alt"></i> Iniciar Sesión</button>
        </form>
        <p id="error-message" style="display: none;"></p>
    </div>
</div>

<!-- Modal para Añadir Usuario -->
<div id="add-user-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-modal-btn">&times;</span>
        <h2>Añadir Nuevo Usuario</h2>
        <form id="add-user-form">
            <input type="text" id="new-user-name" placeholder="Nombre completo" required>
            <input type="text" id="new-user-cedula" placeholder="Cédula" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <input type="email" id="new-user-email" placeholder="Correo electrónico" required>
            <input type="password" id="new-user-password" placeholder="Contraseña (mín. 6 caracteres)" required>
            <select id="new-user-role" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #dfe3e8; margin-bottom: 15px; display: none;">
                <option value="Usuario">Usuario</option>
                <option value="Administrador">Administrador</option>
            </select>
            
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Departamento:</label>
            <div class="searchable-dropdown">
                <input type="text" id="new-user-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-new-user-department"></div>
            </div>
            
            <!-- Contenedor para la selección de municipality -->
            <div id="municipality-container">
                <label for="municipality-select-btn">Asigne municipios</label>
                <button type="button" id="btn-open-municipality-selection" class="btn" style="background-color: #fff; color: #333; border: 1px solid #ccc; width: 100%; text-align: left; justify-content: space-between; display: flex;">
                        <span id="municipality-selected-text">Seleccionar municipios...</span>
                        <i class="fas fa-list"></i>
                </button>
            </div>
            <button type="submit" class="btn"><i class="fas fa-check"></i> Crear Usuario</button>
            <p id="add-user-error" style="display: none;"></p>
        </form>
    </div>
</div>

<!-- Modal para Editar Usuario -->
<div id="edit-user-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-edit-modal-btn">&times;</span>
        <h2>Editar Usuario</h2>
        <form id="edit-user-form">
            <input type="hidden" id="edit-user-uid">
            <label style="display:block; margin-bottom:5px; font-weight:600;">Nombre:</label>
            <input type="text" id="edit-user-name" placeholder="Nombre completo" required>
            
            <label style="display:block; margin-bottom:5px; font-weight:600;">Cédula:</label>
            <input type="text" id="edit-user-cedula" placeholder="Cédula" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            
            <label style="display:block; margin-bottom:5px; font-weight:600;">Email (No editable):</label>
            <input type="email" id="edit-user-email" placeholder="Correo electrónico" readonly style="background-color: #eee; cursor: not-allowed;">
            
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Departamento:</label>
            <div class="searchable-dropdown">
                <input type="text" id="edit-user-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-edit-user-department"></div>
            </div>
            
            <!-- Contenedor para la selección de municipality en edición -->
            <div id="edit-municipality-container">
                <label>Asigne municipios</label>
                <button type="button" id="btn-open-edit-municipality-selection" class="btn" style="background-color: #fff; color: #333; border: 1px solid #ccc; width: 100%; text-align: left; justify-content: space-between; display: flex; margin-bottom: 15px; margin-top: 5px;">
                        <span id="edit-municipality-selected-text">Seleccionar municipios...</span>
                        <i class="fas fa-list"></i>
                </button>
            </div>
            <label id="lbl-edit-user-role" style="display:none; margin-bottom:5px; font-weight:600;">Rol:</label>
            <select id="edit-user-role" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #dfe3e8; margin-bottom: 15px; display: none;">
                <option value="Usuario">Usuario</option>
                <option value="Administrador">Administrador</option>
            </select>
            <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar Cambios</button>
            <p id="edit-user-error" style="display: none; color: #e74c3c; margin-top: 10px;"></p>
        </form>
    </div>
</div>

<!-- Modal para Cambiar Contraseña -->
<div id="change-password-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-change-password-modal-btn">&times;</span>
        <h2>Cambiar Contraseña</h2>
        <form id="change-password-form">
            <input type="hidden" id="change-password-uid">
            <p>Usuario: <strong id="change-password-username"></strong></p>
            <label style="display:block; margin-bottom:5px; font-weight:600;">Nueva Contraseña:</label>
            <input type="password" id="new-password-input" placeholder="Mínimo 6 caracteres" required minlength="6" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
            <button type="submit" class="btn" style="width: 100%;"><i class="fas fa-key"></i> Actualizar Contraseña</button>
            <p id="change-password-error" style="display: none; color: #e74c3c; margin-top: 10px;"></p>
        </form>
    </div>
</div>

<!-- Modal Selección Formato Descarga -->
<div id="download-format-modal" class="modal" style="z-index: 3000;">
    <div class="modal-content" style="width: 300px; text-align: center;">
        <span class="close-btn" id="close-download-format-modal">&times;</span>
        <h3>Seleccione formato</h3>
        <div style="display: flex; justify-content: space-around; margin-top: 20px;">
            <button id="btn-download-excel" class="btn" style="background-color: #27ae60;"><i class="fas fa-file-excel"></i> Excel</button>
            <button id="btn-download-pdf" class="btn" style="background-color: #e74c3c;"><i class="fas fa-file-pdf"></i> PDF</button>
        </div>
    </div>
</div>

<!-- Modal Selección Tipo Reporte -->
<div id="report-type-selection-modal" class="modal" style="z-index: 2500;">
    <div class="modal-content" style="width: 300px; text-align: center;">
        <span class="close-btn" id="close-report-type-selection-modal">&times;</span>
        <h3>Seleccione el tipo de reporte</h3>
        <div style="display: flex; justify-content: space-around; margin-top: 20px; gap: 10px;">
            <button id="btn-select-daily-report" class="btn" style="background-color: #16233c; flex: 1;">Diario</button>
            <button id="btn-select-weekly-report" class="btn" style="background-color: #16233c; flex: 1;">Semanal</button>
        </div>
    </div>
</div>

<!-- Modal Reportes Semanales -->
<div id="view-user-weekly-modal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1000px; position: relative;">
        <span class="close-btn" id="close-view-user-weekly-modal-btn">&times;</span>
        <button class="btn" id="refresh-user-weekly-reports-btn" style="position: absolute; top: 10px; right: 50px; width: 30px; height: 30px; padding: 0; background-color: #3498db; display: flex; align-items: center; justify-content: center; border-radius: 4px;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
        <h2 id="view-user-weekly-title">Reportes semanales de: </h2>
        <div style="overflow-x: auto; max-height: 400px;">
            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f4f7f9;">
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">CREDITO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">COBRO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">GASTOS</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">BASE INICIAL</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">BASE FINAL</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">DIA</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">MES</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">AÑO</th>
                    </tr>
                </thead>
                <tbody id="view-user-weekly-reports-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Usuario -->
<div id="view-user-modal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1000px; position: relative;">
        <span class="close-btn" id="close-view-user-modal-btn">&times;</span>
        <button class="btn" id="refresh-user-reports-btn" style="position: absolute; top: 10px; right: 50px; width: 30px; height: 30px; padding: 0; background-color: #3498db; display: flex; align-items: center; justify-content: center; border-radius: 4px;" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
        <h2 id="view-user-title">Reportes del Usuario</h2>
        <div style="overflow-x: auto; max-height: 400px;">
            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f4f7f9;">
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">CREDITO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">COBRO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">GASTOS</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">BASE INICIAL</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">BASE FINAL</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">DIA</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">FECHA</th>
                    </tr>
                </thead>
                <tbody id="view-user-reports-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Municipios Asignados (Usuario) -->
<div id="view-assigned-municipalities-modal" class="modal" style="z-index: 3000;">
    <div class="modal-content" style="width: 300px; max-height: 80vh; display: flex; flex-direction: column;">
        <span class="close-btn" id="close-view-assigned-munis-btn">&times;</span>
        <h3 id="view-assigned-munis-title" style="margin-top: 0; color: #2c3e50;">Municipios Asignados</h3>
        <ul id="view-assigned-munis-list" style="text-align: left; overflow-y: auto; padding-left: 20px; margin-bottom: 0;"></ul>
    </div>
</div>

<!-- Modal Detalles Cobros Reporte -->
<div id="view-report-payments-modal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 800px;">
        <span class="close-btn" id="close-report-payments-modal-btn">&times;</span>
        <button class="btn" id="download-report-payments-details-btn" style="position: absolute; top: 10px; right: 50px; width: 30px; height: 30px; padding: 0; background-color: #2ecc71; display: flex; align-items: center; justify-content: center; border-radius: 4px;" title="Descargar"><i class="fas fa-download"></i></button>
        <h2>Detalle de Cobros</h2>
        <div class="total-box" style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap;">
            <h3>TOTAL COBROS: <span id="report-payments-total">$0</span></h3>
            <h4 style="margin: 5px 0; color: #2c3e50;">EFECTIVO: <span id="report-payments-cash">0</span></h4>
            <h4 style="margin: 5px 0; color: #2c3e50;">TRANSFERENCIA: <span id="report-payments-transfer">0</span></h4>
        </div>
        <div style="overflow-x: auto; max-height: 400px;">
            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f4f7f9;">
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">FECHA</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">CLIENTE</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">ABONO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">METODO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">MUNICIPIO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="report-payments-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalles Creditos Reporte -->
<div id="view-report-credits-modal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 900px;">
        <span class="close-btn" id="close-report-credits-modal-btn">&times;</span>
        <button class="btn" id="download-report-credits-details-btn" style="position: absolute; top: 10px; right: 50px; width: 30px; height: 30px; padding: 0; background-color: #2ecc71; display: flex; align-items: center; justify-content: center; border-radius: 4px;" title="Descargar"><i class="fas fa-download"></i></button>
        <h2>Detalle de Créditos</h2>
        <div class="total-box">
            <h3>TOTAL CREDITOS: <span id="report-credits-total">$0</span></h3>
        </div>
        <div style="overflow-x: auto; max-height: 400px;">
            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f4f7f9;">
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">FECHA</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">CLIENTE</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">CEDULA</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">TELEFONO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">CREDITO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">INTERESES</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">NRO CUOTAS</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">CUOTA</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">TIPO CREDITO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">TIPO PAGO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">MUNICIPIO</th>
                        <th style="padding: 10px; border-bottom: 1px solid #ddd;">ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="report-credits-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Añadir Cliente -->
<div id="add-client-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-client-modal-btn">&times;</span>
        <h2>Registrar Nuevo Cliente</h2>
        <form id="add-client-form">
            <input type="text" id="new-client-name" placeholder="Nombre del Cliente" required>
            <input type="text" id="new-client-cedula" placeholder="Cédula" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <input type="tel" id="new-client-phone" placeholder="Teléfono">
            <input type="text" id="new-client-address" placeholder="Dirección">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Departamento:</label>
            <div class="searchable-dropdown">
                <input type="text" id="new-client-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-new-client-department"></div>
            </div>
            <div class="searchable-dropdown">
                <input type="text" id="new-client-municipality" placeholder="Seleccionar Municipio..." autocomplete="off" required>
                <div class="dropdown-options" id="list-new-client-municipality"></div>
            </div>
            <select id="new-client-asesor" required>
                <option value="" disabled selected>Seleccionar Asesor...</option>
            </select>
            <select id="new-client-payment-term" required>
                <option value="" disabled selected>Tipo de Pago...</option>
                <option value="Diario">Diario</option>
                <option value="Semanal">Semanal</option>
            </select>
            <button type="submit" class="btn"><i class="fas fa-save"></i> Guardar Cliente</button>
        </form>
    </div>
</div>

<!-- Modal para Editar Cliente -->
<div id="edit-client-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-edit-client-modal-btn">&times;</span>
        <h2>Editar Cliente</h2>
        <form id="edit-client-form">
            <input type="hidden" id="edit-client-id">
            <label>Nombre:</label>
            <input type="text" id="edit-client-name" required>
            <label>Cédula:</label>
            <input type="text" id="edit-client-cedula" required oninput="this.value = this.value.replace(/[^0-9]/g, '')">
            <label>Teléfono:</label>
            <input type="tel" id="edit-client-phone">
            <label>Dirección:</label>
            <input type="text" id="edit-client-address">
            <label>Departamento:</label>
            <div class="searchable-dropdown">
                <input type="text" id="edit-client-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-edit-client-department"></div>
            </div>
            <label>Municipio:</label>
            <div class="searchable-dropdown">
                <input type="text" id="edit-client-municipality" placeholder="Seleccionar Municipio..." autocomplete="off" required>
                <div class="dropdown-options" id="list-edit-client-municipality"></div>
            </div>
            <label>Asesor:</label>
            <select id="edit-client-asesor" required></select>
            <label style="margin-top: 10px; display: block; font-weight: bold;">Frecuencia de Pago Permitida:</label>
            <select id="edit-client-payment-term">
                <option value="Diario">Diario</option>
                <option value="Semanal">Semanal</option>
            </select>
            <button type="submit" class="btn" style="margin-top: 15px;"><i class="fas fa-save"></i> Guardar Cambios</button>
        </form>
    </div>
</div>

<!-- Modal para Buscar Cliente -->
<div id="search-client-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-search-client-modal-btn">&times;</span>
        <h2>Buscar Cliente</h2>
        <input type="text" id="search-client-input" placeholder="Ingrese nombre o cédula..." style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px;">
            <button id="btn-search-cedula" class="btn" style="flex: 1;"><i class="fas fa-id-card"></i> Buscar por Cédula</button>
            <button id="btn-search-name" class="btn" style="flex: 1;"><i class="fas fa-font"></i> Buscar por Nombre</button>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 10px;">
            <button id="btn-filter-advisor" class="btn" style="flex: 1;"><i class="fas fa-user-tie"></i> Filtrar por Asesor</button>
            <button id="btn-filter-municipality" class="btn" style="flex: 1;"><i class="fas fa-map-marked-alt"></i> Filtrar por Municipio</button>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalles del Cliente (Créditos) -->
<div id="client-details-modal" class="modal">
    <div class="modal-content" style="width: 95%; max-width: 1000px;">
        <span class="close-btn" id="close-client-details-btn">&times;</span>
        <h2>Historial de Créditos</h2>
        <h3 id="detail-client-name" style="color: #27ae60; margin-bottom: 15px;"></h3>
        <div id="client-recaudo-container" style="background-color: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #2ecc71;">
            <h4 style="margin: 0; color: #27ae60;">Recaudo Total: <span id="detail-total-recaudo" style="color: #2c3e50; font-size: 1.2em; font-weight: bold;">$0</span></h4>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <div style="overflow-x: auto;">
                <div class="table-responsive">
                    <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f4f7f9;">
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Tipo de credito</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Valor Cuota</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Intereses</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Fecha</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Valor Crédito</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Saldo</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Cuotas Rest.</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Tipo credito</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Asesor</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="client-details-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Crédito Completo -->
<div id="edit-credit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-edit-credit-modal-btn">&times;</span>
        <h2>Editar Crédito</h2>
        <form id="edit-credit-form">
            <input type="hidden" id="edit-credit-id">
            <label>Tipo de Crédito:</label>
            <select id="edit-credit-type" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #ccc; margin-bottom: 10px;">
                <option value="Nuevo">Nuevo</option>
                <option value="Represte">Represte</option>
            </select>
            <label>Valor Cuota:</label>
            <input type="number" id="edit-credit-valor-cuota" placeholder="0" required style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
            <label>Intereses:</label>
            <input type="number" id="edit-credit-interests" placeholder="0" required style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
            <label>Fecha:</label>
            <input type="date" id="edit-credit-date" required style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
            <label>Valor Crédito (Sale Value):</label>
            <input type="number" id="edit-credit-value" placeholder="0" required style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
            <label>Saldo:</label>
            <input type="number" id="edit-credit-balance" placeholder="0" required style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
            <label>Cuotas Restantes:</label>
            <input type="number" id="edit-credit-remaining" required style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dfe3e8; border-radius: 4px; box-sizing: border-box;">
            <label>Frecuencia:</label>
            <select id="edit-credit-term" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #ccc; margin-bottom: 10px;">
                <option value="Diario">Diario</option>
                <option value="Semanal">Semanal</option>
            </select>
            <label>Asesor:</label>
            <select id="edit-credit-asesor" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #ccc; margin-bottom: 15px;" required></select>
            
            <button type="submit" class="btn" style="width: 100%;"><i class="fas fa-save"></i> Guardar Cambios</button>
        </form>
    </div>
</div>

<!-- Modal de Autorización para Frecuencia de Pago -->
<div id="auth-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-auth-modal-btn">&times;</span>
        <h2>Autorización Requerida</h2>
        <p id="auth-message" style="margin-bottom: 15px; font-weight: bold; color: #e74c3c;"></p>
        <label for="auth-input" style="display: block; margin-bottom: 5px;">Escriba "Habilitar" para confirmar:</label>
        <input type="text" id="auth-input" placeholder="Habilitar">
        <button id="confirm-auth-btn" class="btn" style="background-color: #e74c3c;">Confirmar</button>
    </div>
</div>

<!-- Modal de Opciones de Eliminación -->
<div id="delete-options-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-delete-options-btn">&times;</span>
        <h2>Eliminar</h2>
        <p>Cliente: <strong id="delete-client-name-display" style="color: #27ae60;"></strong></p>
        
        <div id="delete-main-options">
            <p>¿Qué desea eliminar?</p>
            <button id="btn-show-quotas" class="btn" style="background-color: #f39c12; width: 100%; margin-bottom: 10px;">
                <i class="fas fa-eraser"></i> Eliminar un Cupo / Crédito
            </button>
            <button id="btn-confirm-delete-client" class="btn" style="background-color: #e74c3c; width: 100%;">
                <i class="fas fa-trash"></i> Eliminar Cliente y Todo su Historial
            </button>
        </div>

        <div id="quotas-list-view" style="display: none;">
            <h4 style="margin-top: 0; margin-bottom: 10px;">Cupos y Créditos Activos:</h4>
            <div id="quotas-list-items" style="max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; margin-bottom: 10px;"></div>
            <button id="btn-back-delete-options" class="btn" style="background-color: #7f8c8d; width: 100%;">
                <i class="fas fa-arrow-left"></i> Volver
            </button>
        </div>
    </div>
</div>

<!-- Modal de Opciones de Eliminación de Usuario -->
<div id="delete-user-options-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-delete-user-options-btn">&times;</span>
        <h2>Eliminar Usuario</h2>
        <p>Usuario: <strong id="delete-user-name-display" style="color: #e74c3c;"></strong></p>
        <p>Seleccione una opción:</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button id="btn-delete-user-only" class="btn" style="background-color: #f39c12;">
                <i class="fas fa-user-times"></i> Solo Eliminar Usuario (Acceso)
            </button>
            <button id="btn-delete-data-only" class="btn" style="background-color: #e67e22;">
                <i class="fas fa-database"></i> Solo Eliminar Datos del Usuario
            </button>
            <button id="btn-delete-user-all" class="btn" style="background-color: #c0392b;">
                <i class="fas fa-trash-alt"></i> Eliminar Usuario y Todos sus Datos
            </button>
        </div>
    </div>
</div>

<!-- Modal para Habilitar Cupo Extra (Selección de Frecuencia) -->
<div id="enable-credit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-enable-credit-modal-btn">&times;</span>
        <h2>Habilitar Cupo Extra</h2>
        <p>Cliente: <strong id="enable-credit-client-name" style="color: #27ae60;"></strong></p>
        <label for="enable-credit-frequency" style="display: block; margin-bottom: 10px; font-weight: bold;">Tipo de Pago:</label>
        <div style="margin-bottom: 20px;">
            <label class="checkbox-label"><input type="checkbox" id="check-freq-diario" class="freq-check-modal" value="Diario" style="width: auto; margin-right: 10px;"> Diario</label>
            <label class="checkbox-label"><input type="checkbox" id="check-freq-semanal" class="freq-check-modal" value="Semanal" style="width: auto; margin-right: 10px;"> Semanal</label>
        </div>
        <button id="confirm-enable-credit-btn" class="btn" style="width: 100%;"><i class="fas fa-check"></i> Confirmar y Habilitar</button>
    </div>
</div>

<!-- Modal Reactivar Crédito -->
<div id="reactivate-credit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-reactivate-modal-btn">&times;</span>
        <h2>Reactivar Crédito</h2>
        <p>¿Desea re activar el credito de este cliente?</p>
        <input type="hidden" id="reactivate-client-id">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="btn-confirm-reactivate" class="btn" style="flex: 1; background-color: #2ecc71;">Aceptar</button>
            <button id="btn-cancel-reactivate" class="btn" style="flex: 1; background-color: #e74c3c;">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal Aprobar Represte -->
<div id="approve-represt-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-approve-represt-modal-btn">&times;</span>
        <h2>Aprobar Pago para Represte</h2>
        <p>¿Desea aprobar el pago para represte?</p>
        <input type="hidden" id="approve-represt-client-id">
        <input type="hidden" id="approve-represt-alert-id">
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button id="btn-confirm-approve-represt" class="btn" style="flex: 1; background-color: #2ecc71;">Aceptar</button>
            <button id="btn-cancel-approve-represt" class="btn" style="flex: 1; background-color: #e74c3c;">Cancelar</button>
        </div>
    </div>
</div>

<!-- Modal Notificación Alerta Represte -->
<div id="alert-represt-notification-modal" class="modal" style="z-index: 3000;">
    <div class="modal-content" style="border: 2px solid #3498db; max-width: 800px; width: 90%;">
        <span class="close-btn" id="close-alert-notification-btn">&times;</span>
        <h2 style="color: #3498db;">Intentos de pago represte</h2>
        <div style="max-height: 400px; overflow-y: auto;">
            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f4f7f9;">
                        <th style="padding: 10px; text-align: left;">Cédula</th><th style="padding: 10px; text-align: left;">Cliente</th><th style="padding: 10px; text-align: left;">Municipio</th><th style="padding: 10px; text-align: left;">Usuario</th>
                    </tr>
                </thead>
                <tbody id="alert-represt-list-body"></tbody>
                </table>
            </div>
        </div>
        <button id="btn-search-all-alert-clients" class="btn" style="width: 100%; background-color: #3498db; margin-top: 15px; display: none;">Buscar Clientes</button>
    </div>
</div>

<!-- Modal de Filtros -->
<div id="filter-options-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-filter-modal-btn">&times;</span>
        <h2>Filtrar Datos</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <label>Fecha Inicio:</label>
            <input type="date" id="filter-start-date" class="date-filter" style="width: 100%;">
            <label>Fecha Fin:</label>
            <input type="date" id="filter-end-date" class="date-filter" style="width: 100%;">
            <label>Departamento:</label>
            <div class="searchable-dropdown">
                <input type="text" id="filter-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-filter-department"></div>
            </div>
            <label>Usuario:</label>
            <div class="searchable-dropdown">
                <input type="text" id="cobrador-filter" placeholder="Seleccionar Usuario..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-cobrador-filter"></div>
            </div>
            <label>Municipio:</label>
            <div class="searchable-dropdown">
                <input type="text" id="municipio-filter-pagos" placeholder="Seleccionar Municipio..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-municipio-filter-pagos"></div>
            </div>
            <button id="apply-filters-btn" class="btn" style="width: 100%; margin-top: 10px;"><i class="fas fa-check"></i> Aplicar Filtrado</button>
        </div>
    </div>
</div>

<!-- Modal para Ver Detalles de Pagos de un Crédito -->
<div id="credit-payments-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 600px;">
        <span class="close-btn" id="close-credit-payments-btn">&times;</span>
        <h2>Detalles del Crédito</h2>
        <div style="max-height: 400px; overflow-y: auto;">
            <div class="table-responsive">
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #f4f7f9;">
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Fecha</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Día</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Abono</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;">Método</th>
                            <th style="padding: 10px; border-bottom: 1px solid #ddd;" id="credit-payments-actions-header">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="credit-payments-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Advertencia de Mora -->
<div id="mora-warning-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-mora-warning-btn">&times;</span>
        <h2 style="color: #e74c3c;"><i class="fas fa-exclamation-triangle"></i> Advertencia de Mora</h2>
        <p id="mora-warning-message" style="font-size: 16px; margin-bottom: 20px;"></p>
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Escriba "AUTORIZAR" para confirmar:</label>
        <input type="text" id="mora-auth-input" placeholder="AUTORIZAR" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button id="btn-cancel-mora" class="btn" style="background-color: #95a5a6; width: auto;">Cancelar</button>
            <button id="btn-accept-mora" class="btn" style="background-color: #e74c3c; width: auto;">Aceptar y Continuar</button>
        </div>
    </div>
</div>

<!-- Modal de Carga para Importación -->
<div id="import-loading-modal" class="modal" style="z-index: 2001;">
    <div class="modal-content" style="text-align: center; width: 300px;">
        <div class="spinner" style="margin: 0 auto;"></div>
        <h3 style="margin-top: 20px; color: #27ae60;">Importando...</h3>
        <p>Por favor espere mientras se procesan los datos.</p>
    </div>
</div>

<!-- Modal para Ver Detalles de Gastos -->
<div id="view-expenses-details-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-view-expenses-details-btn">&times;</span>
        <h2>Detalles gastos</h2>
        <div id="expenses-details-content" style="font-size: 16px; line-height: 1.6;">
            <!-- Contenido dinámico -->
        </div>
    </div>
</div>

<!-- Modal para Editar Gastos -->
<div id="edit-expenses-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-edit-expenses-modal-btn">&times;</span>
        <h2>Editar Gastos</h2>
        <form id="edit-expenses-form">
            <input type="hidden" id="edit-expenses-id">
            <input type="hidden" id="edit-expenses-user">
            <input type="hidden" id="edit-expenses-date">
            <input type="hidden" id="edit-expenses-collection">
            <input type="hidden" id="edit-expenses-timestamp">
            <input type="hidden" id="edit-expenses-others-desc"> <!-- Campo oculto para la descripción -->
            <label>Gasolina:</label>
            <input type="text" id="edit-expenses-fuel" required placeholder="$0">
            <label>Almuerzo:</label>
            <input type="text" id="edit-expenses-lunch" required placeholder="$0">
            <label>Otros:</label>
            <input type="text" id="edit-expenses-others" required placeholder="$0">
            <label>Total Gastos:</label>
            <input type="text" id="edit-expenses-total" readonly style="background-color: #eee; cursor: not-allowed;">
            <button type="submit" class="btn" style="margin-top: 15px;"><i class="fas fa-save"></i> Guardar Cambios</button>
        </form>
    </div>
</div>

<!-- Modal para Filtrar por Asesor -->
<div id="filter-advisor-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-filter-advisor-modal-btn">&times;</span>
        <h2>Filtrar por Asesor</h2>
        <div class="searchable-dropdown">
            <input type="text" id="filter-advisor-select" placeholder="Seleccionar Asesor..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <div class="dropdown-options" id="list-filter-advisor-select"></div>
        </div>
        <button id="btn-search-advisor" class="btn" style="width: 100%; margin-top: 10px;"><i class="fas fa-search"></i> Buscar</button>
    </div>
</div>

<!-- Modal para Filtrar por Municipio -->
<div id="filter-municipality-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-filter-municipality-modal-btn">&times;</span>
        <h2>Filtrar por Municipio</h2>
        <label>Departamento:</label>
        <div class="searchable-dropdown">
            <input type="text" id="filter-municipality-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <div class="dropdown-options" id="list-filter-municipality-department"></div>
        </div>
        <label>Municipio:</label>
        <div class="searchable-dropdown">
            <input type="text" id="filter-municipality-select" placeholder="Seleccionar Municipio..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
            <div class="dropdown-options" id="list-filter-municipality-select"></div>
        </div>
        <button id="btn-search-municipality" class="btn" style="width: 100%;"><i class="fas fa-search"></i> Buscar</button>
    </div>
</div>

<!-- Modal para Exportar Reportes -->
<div id="export-report-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn" id="close-export-modal-btn">&times;</span>
        <h2>Exportar Reportes</h2>
        
        <!-- Sección 1: Periodo -->
        <div class="filter-section">
            <h3>Escoger periodo</h3>
            <button id="btn-open-export-date-modal" class="btn" style="width: auto; padding: 10px 20px;"><i class="fas fa-calendar-alt"></i> Seleccionar Periodo</button>
            <p id="export-period-text" style="margin-top: 10px; font-weight: bold; font-size: 14px; color: #555;">Periodo seleccionado: Todos los días, Todos los meses, 2024</p>
        </div>

        <!-- Sección 2: Municipios -->
        <div class="filter-section">
            <h3>Escoger Departamento</h3>
            <div class="searchable-dropdown">
                <input type="text" id="export-department" placeholder="Seleccionar Departamento..." autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-export-department"></div>
            </div>

            <h3>Escoger municipios</h3>
            <div class="searchable-dropdown">
                <input type="text" id="export-municipality" placeholder="Todos los municipios" autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-export-municipality"></div>
            </div>
        </div>

        <!-- Sección 3: Usuarios -->
        <div class="filter-section">
            <h3>Usuarios</h3>
            <div class="searchable-dropdown">
                <input type="text" id="export-user" placeholder="Todos los usuarios" autocomplete="off" style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px;">
                <div class="dropdown-options" id="list-export-user"></div>
            </div>
        </div>

        <button id="btn-export-action" class="btn" style="width: 100%; margin-top: 10px;"><i class="fas fa-file-export"></i> Exportar</button>
    </div>
</div>

<!-- Modal Filtros de Fecha para Exportar -->
<div id="export-date-filter-modal" class="modal" style="z-index: 1200;">
    <div class="modal-content">
        <span class="close-btn" id="close-export-date-modal-btn">&times;</span>
        <h2>Seleccionar Periodo</h2>
        <label>Día:</label>
        <select id="export-day" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #ccc; margin-bottom: 10px;">
            <option value="all">Todos los días</option>
        </select>
        <label>Mes:</label>
        <select id="export-month" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #ccc; margin-bottom: 10px;">
            <option value="all">Todos los meses</option>
        </select>
        <label>Año:</label>
        <select id="export-year" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #ccc; margin-bottom: 20px;">
            <!-- Se llena dinámicamente -->
        </select>
        <button id="btn-apply-export-date" class="btn" style="width: 100%;"><i class="fas fa-check"></i> Aplicar Filtros</button>
    </div>
</div>

<!-- Modal Previsualización Municipios Importados -->
<div id="preview-municipalities-modal" class="modal">
    <div class="modal-content" style="width: 90%; max-width: 600px;">
        <span class="close-btn" id="close-preview-municipalities-modal">&times;</span>
        <h2 id="preview-municipalities-title">Municipios a importar</h2>
        <div id="preview-municipalities-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
        <button id="btn-save-imported-municipalities" class="btn" style="width: 100%;"><i class="fas fa-save"></i> Guardar Municipios</button>
    </div>
</div>

<!-- Modal Selección de Municipios (Nuevo Usuario) -->
<div id="select-municipalities-modal" class="modal" style="z-index: 1100;">
    <div class="modal-content">
        <span class="close-btn" id="close-select-municipalities-modal">&times;</span>
        <h2>Seleccionar Municipios</h2>
        <input type="text" id="search-municipality-checkboxes" placeholder="Buscar municipio..." style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
        <div id="municipalities-list-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 4px;"></div>
        <button type="button" id="btn-confirm-municipalities" class="btn" style="width: 100%; margin-top: 15px;"><i class="fas fa-check"></i> Confirmar Selección</button>
    </div>
</div>

<!-- Modal de Carga para Actualizar Datos -->
<div id="update-loading-modal" class="modal" style="z-index: 2002; background-color: rgba(0,0,0,0.7);">
    <div class="modal-content" style="text-align: center; width: 300px; background: transparent; box-shadow: none; border: none;">
        <img src="img/spinner.png" alt="Logo" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid #90ee90; margin-bottom: 20px;">
        <div class="spinner" style="width: 50px; height: 50px; margin: 0 auto; border-width: 5px;"></div>
        <h3 style="margin-top: 20px; color: white; text-shadow: 1px 1px 2px black;">Actualizando datos espere por favor</h3>
    </div>
</div>

<!-- Modal Selección de Fechas P&G -->
<div id="pg-date-selection-modal" class="modal">
    <div class="modal-content" style="width: 400px; text-align: center;">
        <span class="close-btn" id="close-pg-date-selection-modal">&times;</span>
        <h3>Seleccion de fechas</h3>
        
        <div id="pg-date-modal-content">
            <label style="display:block; text-align:left; margin-bottom:5px;">Tipo de fecha:</label>
            <select id="pg-date-type" class="btn" style="width: 100%; background-color: white; color: black; border: 1px solid #ccc; margin-bottom: 15px;">
                <option value="specific">Fecha especifica</option>
                <option value="range">Rango</option>
                <option value="all">Todos los dias de todos los meses de todos los años</option>
            </select>

            <!-- Selectores Fecha Específica -->
            <div id="pg-specific-date-container" style="display: flex; gap: 5px; margin-bottom: 15px;">
                <select id="pg-specific-day" class="btn" style="flex: 1; background-color: white; color: black; border: 1px solid #ccc;"></select>
                <select id="pg-specific-month" class="btn" style="flex: 2; background-color: white; color: black; border: 1px solid #ccc;"></select>
                <select id="pg-specific-year" class="btn" style="flex: 1.5; background-color: white; color: black; border: 1px solid #ccc;"></select>
            </div>

            <!-- Selectores Semanal (Semana/Mes) -->
            <div id="pg-week-month-container" style="display: none; gap: 5px; margin-bottom: 15px;">
                <select id="pg-week-number" class="btn" style="flex: 1; background-color: white; color: black; border: 1px solid #ccc; display: none;"></select>
                <select id="pg-wm-month" class="btn" style="flex: 2; background-color: white; color: black; border: 1px solid #ccc;"></select>
                <select id="pg-wm-year" class="btn" style="flex: 1.5; background-color: white; color: black; border: 1px solid #ccc;"></select>
            </div>

            <!-- Selectores Rango -->
            <div id="pg-range-date-container" style="display: none; flex-direction: column; gap: 5px; margin-bottom: 15px;">
                <div style="display: flex; gap: 5px; width: 100%; align-items: center;">
                    <span style="font-size: 12px; width: 40px;">Desde:</span>
                    <select id="pg-range-start-day" class="btn" style="flex: 1; background-color: white; color: black; border: 1px solid #ccc;" title="Día Inicio"></select>
                    <select id="pg-range-start-month" class="btn" style="flex: 2; background-color: white; color: black; border: 1px solid #ccc;" title="Mes Inicio"></select>
                    <select id="pg-range-start-year" class="btn" style="flex: 1.5; background-color: white; color: black; border: 1px solid #ccc;" title="Año Inicio"></select>
                </div>
                <div style="display: flex; gap: 5px; width: 100%; margin-top: 5px; align-items: center;">
                    <span style="font-size: 12px; width: 40px;">Hasta:</span>
                    <select id="pg-range-end-day" class="btn" style="flex: 1; background-color: white; color: black; border: 1px solid #ccc;" title="Día Fin"></select>
                    <select id="pg-range-end-month" class="btn" style="flex: 2; background-color: white; color: black; border: 1px solid #ccc;" title="Mes Fin"></select>
                    <select id="pg-range-end-year" class="btn" style="flex: 1.5; background-color: white; color: black; border: 1px solid #ccc;" title="Año Fin"></select>
                </div>
            </div>

            <div id="pg-date-preview" style="margin-bottom: 20px; font-weight: bold; color: #2c3e50; min-height: 20px;"></div>

            <button id="btn-pg-date-accept" class="btn" style="width: 100%; background-color: #2ecc71;">Aceptar</button>
        </div>
    </div>
</div>

<div id="toast-notification" class="toast"></div>

<input type="file" id="import-excel-input" accept=".xlsx, .xls, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" style="display: none;">

    <!-- SDK de Firebase -->
    <!-- SDK de Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Biblioteca para exportar a Excel (SheetJS) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
    <!-- Bibliotecas para leer Word y PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <!-- Librerías para PDF (jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        // --- Configuración de Supabase ---
        // 1. Verificación de seguridad: Comprobar si las librerías cargaron
        if (typeof window.supabase === 'undefined') {
            const err = "Error Crítico: Las librerías no se cargaron. 'Tracking Prevention' o falta de internet bloqueó los scripts.";
            console.error(err);
            // Mostrar error visualmente en lugar de pantalla blanca
            document.body.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100vh;flex-direction:column;color:#c0392b;text-align:center;padding:20px;background:#f2f2f2;">
                <i class="fas fa-wifi" style="font-size:50px;margin-bottom:20px;"></i>
                <h1>Error de Conexión / Bloqueo</h1><p>${err}</p><p>Intenta desactivar la 'Prevención de rastreo' o verifica tu conexión.</p></div>`;
            throw new Error(err); // Detener ejecución
        }

        const SUPABASE_URL = 'https://fiahwrkuouceyncxoukj.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_9lTA1sPLY9iSTASjrCgE6g_Cr1qQ_Re';
        window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const colombiaDepartments = [
            "Amazonas", "Antioquia", "Arauca", "Atlántico", "Bolívar", "Boyacá", "Caldas", "Caquetá", 
            "Casanare", "Cauca", "Cesar", "Chocó", "Córdoba", "Cundinamarca", "Guainía", "Guaviare", 
            "Huila", "La Guajira", "Magdalena", "Meta", "Nariño", "Norte de Santander", "Putumayo", 
            "Quindío", "Risaralda", "San Andrés y Providencia", "Santander", "Sucre", "Tolima", 
            "Valle del Cauca", "Vaupés", "Vichada"
        ];

        // Elementos del DOM
        const loadingScreen = document.getElementById('loading-screen');
        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const errorMessage = document.getElementById('error-message');
        const refreshBtn = document.getElementById('refresh-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const addUserBtn = document.getElementById('add-user-btn');
        const addUserModal = document.getElementById('add-user-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const addUserForm = document.getElementById('add-user-form');
        const addUserError = document.getElementById('add-user-error');
        const municipalityContainer = document.getElementById('municipality-container');
        const btnOpenMunicipalitySelection = document.getElementById('btn-open-municipality-selection');
        const selectMunicipalitiesModal = document.getElementById('select-municipalities-modal');
        const closeSelectMunicipalitiesModal = document.getElementById('close-select-municipalities-modal');
        const municipalitiesListContainer = document.getElementById('municipalities-list-container');
        const btnConfirmMunicipalities = document.getElementById('btn-confirm-municipalities');
        const municipalitySelectedText = document.getElementById('municipality-selected-text');
        const navUsers = document.getElementById('nav-users');
        const navAppData = document.getElementById('nav-app-data');
        const navClients = document.getElementById('nav-clients');
        const navImport = document.getElementById('nav-import');
        const navMunicipalities = document.getElementById('nav-municipalities');
        const navExport = document.getElementById('nav-export');
        const navReports = document.getElementById('nav-reports');
        const usersTable = document.getElementById('users-table');
        const paymentsTable = document.getElementById('payments-table');
        const dashboardView = document.getElementById('dashboard-view');
        const workspaceLoader = document.getElementById('workspace-loader');
        const contentTitle = document.getElementById('content-title');
        const openFilterModalBtn = document.getElementById('open-filter-modal-btn');
        const cobradorFilter = document.getElementById('cobrador-filter');
        const municipioFilterPagos = document.getElementById('municipio-filter-pagos');
        const filterDepartment = document.getElementById('filter-department');
        const filterStartDate = document.getElementById('filter-start-date');
        const filterEndDate = document.getElementById('filter-end-date');
        const importExcelInput = document.getElementById('import-excel-input');
        const importLoadingModal = document.getElementById('import-loading-modal');
        const updateLoadingModal = document.getElementById('update-loading-modal');
        const welcomeView = document.getElementById('welcome-view');
        const sidebar = document.querySelector('.sidebar');
        const sidebarLogo = document.querySelector('.sidebar-logo img');
        const mobileNavBar = document.getElementById('mobile-nav-bar');
        let isMasterAdmin = false;

        // Función para desvanecer pantalla de carga
        function fadeOutLoadingScreen() {
            loadingScreen.style.transition = 'opacity 0.5s ease-out';
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                loadingScreen.style.opacity = '1';
                loadingScreen.style.transition = '';
            }, 500);
        }

        // New JS for mobile sidebar
        const sidebarExpandBtn = document.getElementById('sidebar-expand-btn');
        const sidebarOverlay = document.createElement('div');
        sidebarOverlay.className = 'sidebar-overlay';
        document.body.appendChild(sidebarOverlay);

        sidebarExpandBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sidebar.classList.toggle('sidebar-mobile-open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('sidebar-mobile-open');
            sidebarOverlay.classList.remove('active');
        });

        // Also close on nav item click
        sidebar.querySelectorAll('ul li a').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) { // Only on mobile view
                    sidebar.classList.remove('sidebar-mobile-open');
                    sidebarOverlay.classList.remove('active');
                }
            });
        });
        
        // Elementos del Modal de Exportar
        const exportReportModal = document.getElementById('export-report-modal');
        const closeExportModalBtn = document.getElementById('close-export-modal-btn');
        const exportDaySelect = document.getElementById('export-day');
        const exportMonthSelect = document.getElementById('export-month');
        const exportYearSelect = document.getElementById('export-year');
        const exportMunicipalitySelect = document.getElementById('export-municipality');
        const exportUserSelect = document.getElementById('export-user');
        const btnExportAction = document.getElementById('btn-export-action');
        const btnOpenExportDateModal = document.getElementById('btn-open-export-date-modal');
        const exportDateFilterModal = document.getElementById('export-date-filter-modal');
        const closeExportDateModalBtn = document.getElementById('close-export-date-modal-btn');
        const btnApplyExportDate = document.getElementById('btn-apply-export-date');

        // Elementos Modal Fecha P&G
        const pgDateSelectionModal = document.getElementById('pg-date-selection-modal');
        const closePgDateSelectionModal = document.getElementById('close-pg-date-selection-modal');
        const btnPgFilterDate = document.getElementById('btn-pg-filter-date');
        const pgDateType = document.getElementById('pg-date-type');
        const pgSpecificContainer = document.getElementById('pg-specific-date-container');
        const pgRangeContainer = document.getElementById('pg-range-date-container');
        const pgDatePreview = document.getElementById('pg-date-preview');
        const btnPgDateAccept = document.getElementById('btn-pg-date-accept');
        const pgFilterDateText = document.getElementById('pg-filter-date-text');
        const btnPgConsult = document.getElementById('btn-pg-consult');
        const btnPgRefresh = document.getElementById('btn-pg-refresh');
        const btnPgDownload = document.getElementById('btn-pg-download');
        
        // Botones modo P&G
        const btnPgDaily = document.getElementById('btn-pg-daily');
        const btnPgWeekly = document.getElementById('btn-pg-weekly');

        // Elementos Comportamiento de Pago
        const btnReportPaymentBehavior = document.getElementById('btn-report-payment-behavior');
        const paymentBehaviorContainer = document.getElementById('payment-behavior-report-container');
        const btnPbFilterDate = document.getElementById('btn-pb-filter-date');
        const pbFilterDateText = document.getElementById('pb-filter-date-text');
        const btnPbConsult = document.getElementById('btn-pb-consult');
        const btnPbRefresh = document.getElementById('btn-pb-refresh');
        const btnPbDownload = document.getElementById('btn-pb-download');
        const btnPbDaily = document.getElementById('btn-pb-daily');
        const btnPbWeekly = document.getElementById('btn-pb-weekly');

        // Elementos Informe de Créditos
        const btnReportCredits = document.getElementById('btn-report-credits');
        const creditsReportContainer = document.getElementById('credits-report-container');
        const btnCrFilterDate = document.getElementById('btn-cr-filter-date');
        const crFilterDateText = document.getElementById('cr-filter-date-text');
        const btnCrConsult = document.getElementById('btn-cr-consult');
        const btnCrRefresh = document.getElementById('btn-cr-refresh');
        const btnCrDownload = document.getElementById('btn-cr-download');
        const btnCrDaily = document.getElementById('btn-cr-daily');
        const btnCrWeekly = document.getElementById('btn-cr-weekly');

        // Elementos Informe de Cobros
        const btnReportPayments = document.getElementById('btn-report-payments');
        const paymentsReportContainer = document.getElementById('payments-report-container');
        const btnPmFilterDate = document.getElementById('btn-pm-filter-date');
        const pmFilterDateText = document.getElementById('pm-filter-date-text');
        const btnPmConsult = document.getElementById('btn-pm-consult');
        const btnPmRefresh = document.getElementById('btn-pm-refresh');
        const btnPmDownload = document.getElementById('btn-pm-download');
        const btnPmDaily = document.getElementById('btn-pm-daily');
        const btnPmWeekly = document.getElementById('btn-pm-weekly');

        // Elementos Informe de Otros Gastos
        const btnReportExpenses = document.getElementById('btn-report-expenses');
        const expensesReportContainer = document.getElementById('expenses-report-container');
        const btnExFilterDate = document.getElementById('btn-ex-filter-date');
        const exFilterDateText = document.getElementById('ex-filter-date-text');
        const btnExConsult = document.getElementById('btn-ex-consult');
        const btnExRefresh = document.getElementById('btn-ex-refresh');
        const btnExDownload = document.getElementById('btn-ex-download');
        const btnExDaily = document.getElementById('btn-ex-daily');
        const btnExWeekly = document.getElementById('btn-ex-weekly');

        // Elementos Informe General (Reportes)
        const btnReportGeneral = document.getElementById('btn-report-general');
        const generalReportContainer = document.getElementById('general-report-container');
        const btnGnFilterDate = document.getElementById('btn-gn-filter-date');
        const gnFilterDateText = document.getElementById('gn-filter-date-text');
        const btnGnConsult = document.getElementById('btn-gn-consult');
        const btnGnDaily = document.getElementById('btn-gn-daily');
        const btnGnWeekly = document.getElementById('btn-gn-weekly');
        const btnGnDownload = document.getElementById('btn-gn-download');

        // Elementos Dashboard
        const dashboardControls = document.getElementById('dashboard-controls');
        const btnDashboardDaily = document.getElementById('btn-dashboard-daily');
        const btnDashboardWeekly = document.getElementById('btn-dashboard-weekly');
        const btnDashboardRefresh = document.getElementById('btn-dashboard-refresh');
        const btnDashboardDownload = document.getElementById('btn-dashboard-download');

        let currentReportDateTarget = 'pg'; // 'pg' or 'pb'

        // Elementos nuevos Semanal
        const pgWeekMonthContainer = document.getElementById('pg-week-month-container');
        const pgWeekNumber = document.getElementById('pg-week-number');

        // Elementos de la vista de Municipios
        const municipalitiesView = document.getElementById('municipalities-view');
        const reportsView = document.getElementById('reports-view');
        const createMunicipalityForm = document.getElementById('create-municipality-form');
        const municipalityDepartmentSelect = document.getElementById('municipality-department-select');
        const municipalityInputsContainer = document.getElementById('municipality-inputs-container');
        const btnAddMunicipalityField = document.getElementById('btn-add-municipality-field');
        const btnCreateMunicipality = document.getElementById('btn-create-municipality');
        const btnOpenImportMunicipalities = document.getElementById('btn-open-import-municipalities');
        const createMunicipalitySection = document.getElementById('create-municipality-section');
        const viewMunicipalitiesSection = document.getElementById('view-municipalities-section');
        const importMunicipalitiesSection = document.getElementById('import-municipalities-section');
        const municipalitiesDefaultMsg = document.getElementById('municipalities-default-msg');
        const btnViewMunicipalitiesAction = document.getElementById('btn-view-municipalities-action');
        const btnCreateMunicipalitiesAction = document.getElementById('btn-create-municipalities-action');
        const importMunicipalitiesForm = document.getElementById('import-municipalities-form');
        const importMunicipalityDepartmentSelect = document.getElementById('import-municipality-department-select');
        const municipalityFileInput = document.getElementById('municipality-file-input');
        const importMunicipalitiesStatus = document.getElementById('import-municipalities-status');
        
        // Elementos del Modal de Previsualización de Municipios
        const previewMunicipalitiesModal = document.getElementById('preview-municipalities-modal');
        const closePreviewMunicipalitiesModal = document.getElementById('close-preview-municipalities-modal');
        const previewMunicipalitiesList = document.getElementById('preview-municipalities-list');
        const btnSaveImportedMunicipalities = document.getElementById('btn-save-imported-municipalities');
        
        // Selectores de Departamento en formularios (Ahora son inputs)
        const newClientDepartment = document.getElementById('new-client-department');
        const editClientDepartment = document.getElementById('edit-client-department');
        
        // Variables para control de edición de usuario
        let currentEditAssignedMunicipalities = [];
        let isEditingUserMode = false;

        // Elementos del Modal de Edición
        const editUserModal = document.getElementById('edit-user-modal');
        const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
        const editUserForm = document.getElementById('edit-user-form');
        const editMunicipalityContainer = document.getElementById('edit-municipality-container');
        const btnOpenEditMunicipalitySelection = document.getElementById('btn-open-edit-municipality-selection');
        const editMunicipalitySelectedText = document.getElementById('edit-municipality-selected-text');
        const editUserError = document.getElementById('edit-user-error');
        const editExpensesUser = document.getElementById('edit-expenses-user');
        const editExpensesDate = document.getElementById('edit-expenses-date');

        // Elementos del Modal de Ver Usuario
        const viewUserModal = document.getElementById('view-user-modal');
        const closeViewUserModalBtn = document.getElementById('close-view-user-modal-btn');
        const viewUserReportsBody = document.getElementById('view-user-reports-body');
        const viewUserTitle = document.getElementById('view-user-title');

        // Elementos Modal Selección Tipo Reporte y Semanal
        const reportTypeSelectionModal = document.getElementById('report-type-selection-modal');
        const closeReportTypeSelectionModal = document.getElementById('close-report-type-selection-modal');
        const btnSelectDailyReport = document.getElementById('btn-select-daily-report');
        const btnSelectWeeklyReport = document.getElementById('btn-select-weekly-report');
        const viewUserWeeklyModal = document.getElementById('view-user-weekly-modal');
        const closeViewUserWeeklyModalBtn = document.getElementById('close-view-user-weekly-modal-btn');
        const viewUserWeeklyTitle = document.getElementById('view-user-weekly-title');
        const viewUserWeeklyReportsBody = document.getElementById('view-user-weekly-reports-body');
        
        // Elementos Modal Ver Municipios Asignados
        const viewAssignedMunisModal = document.getElementById('view-assigned-municipalities-modal');
        const closeViewAssignedMunisBtn = document.getElementById('close-view-assigned-munis-btn');
        const viewAssignedMunisList = document.getElementById('view-assigned-munis-list');
        const viewAssignedMunisTitle = document.getElementById('view-assigned-munis-title');
        
        let selectedUserUidForReports = null;
        let selectedUserNameForReports = null;

        // Elementos de la vista de Clientes
        const clientsView = document.getElementById('clients-view');
        const clientsTableBody = document.getElementById('clients-table-body');
        const addClientBtn = document.getElementById('add-client-btn');
        const addClientModal = document.getElementById('add-client-modal');
        const closeClientModalBtn = document.getElementById('close-client-modal-btn');
        const openSearchClientBtn = document.getElementById('open-search-client-btn');
        const searchClientModal = document.getElementById('search-client-modal');
        const closeSearchClientModalBtn = document.getElementById('close-search-client-modal-btn');
        const searchClientInput = document.getElementById('search-client-input');
        const btnSearchCedula = document.getElementById('btn-search-cedula');
        const btnSearchName = document.getElementById('btn-search-name');
        const btnFilterAdvisor = document.getElementById('btn-filter-advisor');
        const btnFilterMunicipality = document.getElementById('btn-filter-municipality');
        const filterAdvisorModal = document.getElementById('filter-advisor-modal');
        const closeFilterAdvisorModalBtn = document.getElementById('close-filter-advisor-modal-btn');
        const filterAdvisorSelect = document.getElementById('filter-advisor-select');
        const btnSearchAdvisor = document.getElementById('btn-search-advisor');
        
        // Elementos del Modal de Filtrar por Municipio
        const filterMunicipalityModal = document.getElementById('filter-municipality-modal');
        const closeFilterMunicipalityModalBtn = document.getElementById('close-filter-municipality-modal-btn');
        const filterMunicipalityDepartment = document.getElementById('filter-municipality-department');
        const filterMunicipalitySelect = document.getElementById('filter-municipality-select');
        const btnSearchMunicipality = document.getElementById('btn-search-municipality');

        const addClientForm = document.getElementById('add-client-form');
        const newClientMunicipality = document.getElementById('new-client-municipality');
        const newClientAsesor = document.getElementById('new-client-asesor');

        // Elementos del Modal de Editar Cliente
        const editClientModal = document.getElementById('edit-client-modal');
        const closeEditClientModalBtn = document.getElementById('close-edit-client-modal-btn');
        const editClientForm = document.getElementById('edit-client-form');
        const editClientMunicipality = document.getElementById('edit-client-municipality');
        const editClientAsesor = document.getElementById('edit-client-asesor');
        const editClientPaymentTerm = document.getElementById('edit-client-payment-term');
        
        const clientDetailsModal = document.getElementById('client-details-modal');
        const closeClientDetailsBtn = document.getElementById('close-client-details-btn');
        const clientDetailsBody = document.getElementById('client-details-body');
        const detailClientName = document.getElementById('detail-client-name');

        // Elementos del Modal de Detalles de Pagos de Crédito
        const creditPaymentsModal = document.getElementById('credit-payments-modal');
        const closeCreditPaymentsBtn = document.getElementById('close-credit-payments-btn');
        const creditPaymentsBody = document.getElementById('credit-payments-body');

        // Elementos del Modal de Autorización
        const authModal = document.getElementById('auth-modal');
        const closeAuthModalBtn = document.getElementById('close-auth-modal-btn');
        const authInput = document.getElementById('auth-input');
        const confirmAuthBtn = document.getElementById('confirm-auth-btn');
        const authMessage = document.getElementById('auth-message');

        // Elementos del Modal de Opciones de Eliminación
        const deleteOptionsModal = document.getElementById('delete-options-modal');
        const closeDeleteOptionsBtn = document.getElementById('close-delete-options-btn');
        const deleteClientNameDisplay = document.getElementById('delete-client-name-display');
        const btnShowQuotas = document.getElementById('btn-show-quotas');
        const btnConfirmDeleteClient = document.getElementById('btn-confirm-delete-client');
        const deleteMainOptions = document.getElementById('delete-main-options');
        const quotasListView = document.getElementById('quotas-list-view');
        const quotasListItems = document.getElementById('quotas-list-items');
        const btnBackDeleteOptions = document.getElementById('btn-back-delete-options');
        let clientToDelete = null;

        // Elementos del Modal de Habilitar Cupo
        const enableCreditModal = document.getElementById('enable-credit-modal');
        const closeEnableCreditModalBtn = document.getElementById('close-enable-credit-modal-btn');
        const enableCreditClientName = document.getElementById('enable-credit-client-name');
        const checkFreqDiario = document.getElementById('check-freq-diario');
        const checkFreqSemanal = document.getElementById('check-freq-semanal');
        const confirmEnableCreditBtn = document.getElementById('confirm-enable-credit-btn');
        let clientToEnableCredit = null;

        // Elementos del Modal de Advertencia de Mora
        const moraWarningModal = document.getElementById('mora-warning-modal');
        const closeMoraWarningBtn = document.getElementById('close-mora-warning-btn');
        const moraWarningMessage = document.getElementById('mora-warning-message');
        const moraAuthInput = document.getElementById('mora-auth-input');
        const btnCancelMora = document.getElementById('btn-cancel-mora');
        const btnAcceptMora = document.getElementById('btn-accept-mora');

        // Elementos del Modal de Filtros
        const filterOptionsModal = document.getElementById('filter-options-modal');
        const closeFilterModalBtn = document.getElementById('close-filter-modal-btn');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');

        // Elementos del Modal de Ver Detalles de Gastos
        const viewExpensesDetailsModal = document.getElementById('view-expenses-details-modal');
        const closeViewExpensesDetailsBtn = document.getElementById('close-view-expenses-details-btn');

        // Elementos del Modal de Editar Gastos
        const editExpensesModal = document.getElementById('edit-expenses-modal');
        const closeEditExpensesModalBtn = document.getElementById('close-edit-expenses-modal-btn');
        const editExpensesForm = document.getElementById('edit-expenses-form');
        const editExpensesFuel = document.getElementById('edit-expenses-fuel');
        const editExpensesLunch = document.getElementById('edit-expenses-lunch');
        const editExpensesOthers = document.getElementById('edit-expenses-others');
        const editExpensesTotal = document.getElementById('edit-expenses-total');
        const editExpensesOthersDesc = document.getElementById('edit-expenses-others-desc');
        
        // Elementos del Modal de Editar Crédito
        const editCreditModal = document.getElementById('edit-credit-modal');
        const closeEditCreditModalBtn = document.getElementById('close-edit-credit-modal-btn');
        const editCreditForm = document.getElementById('edit-credit-form');

        // Elementos para descarga de reportes de créditos
        const downloadFormatModal = document.getElementById('download-format-modal');
        const closeDownloadFormatModal = document.getElementById('close-download-format-modal');
        const btnDownloadExcel = document.getElementById('btn-download-excel');
        const btnDownloadPdf = document.getElementById('btn-download-pdf');
        let currentDownloadUser = '';
        let currentDownloadDate = '';
        let currentDownloadContext = ''; // 'credits' o 'report'
        let currentDownloadCollection = 'reports';
        let currentGnReportData = []; // Datos del reporte general para descarga
        let currentExReportData = []; // Datos del reporte de otros gastos para descarga
        let currentPmReportData = []; // Datos del reporte de cobros para descarga
        let currentCrReportData = []; // Datos del reporte de creditos para descarga
        let currentPbReportData = []; // Datos del reporte de comportamiento de pago para descarga
        let currentPgReportData = []; // Datos del reporte P&G para descarga
        let currentDashboardCobrosData = [];
        let currentDashboardCreditosData = [];
        let currentHistoryData = null; // Datos para descarga del historial de pagos (dropdown)

        // Función para cerrar todos los modales
        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        }

        // Elementos de Modales de Reportes Detallados
        const viewReportPaymentsModal = document.getElementById('view-report-payments-modal');
        const viewReportCreditsModal = document.getElementById('view-report-credits-modal');
        const mainContentHeader = document.getElementById('main-content-header');

        let currentRecordType = ''; // Para saber qué tabla estamos viendo (debtors o payments)
        
        // Variables para el estado de búsqueda de clientes
        let isClientSearchActive = false;
        let lastClientSearchTerm = '';
        let lastClientSearchType = '';
        
        // Variables para Eliminación Múltiple
        let isMultiDeleteMode = false;
        const btnMultiDeleteMode = document.getElementById('btn-multi-delete-mode');
        const multiDeleteControls = document.getElementById('multi-delete-controls');
        const btnConfirmMultiDelete = document.getElementById('btn-confirm-multi-delete');

        // Variable para controlar si se han aplicado filtros en Datos
        let filtersApplied = false;

        // Variables de estado para persistencia de vistas
        let isUsersViewInitialized = false;
        let isDashboardViewInitialized = false;
        let isClientsViewInitialized = false;
        let isMunicipalitiesViewInitialized = false;
        let isReportsViewInitialized = false;

        // Modales nuevos
        const reactivateCreditModal = document.getElementById('reactivate-credit-modal');
        const approveReprestModal = document.getElementById('approve-represt-modal');
        const alertReprestNotificationModal = document.getElementById('alert-represt-notification-modal');

        let represteAlertCedulas = []; // Para el botón de búsqueda general

        let currentImportDepartment = ''; // Variable para almacenar el departamento en proceso de importación

        // Función para normalizar texto (quitar acentos y minúsculas)
        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        // Función para convertir a Title Case
        function toTitleCase(str) {
            if (!str) return '';
            return str.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        // --- LÓGICA DE AUTENTICACIÓN ---

        // Observador del estado de autenticación
        supabase.auth.onAuthStateChange(async (event, session) => {
            const user = session?.user;

            if (user) {
                // Usuario detectado: Asegurar que el login esté oculto y mostrar carga si es necesario
                loginContainer.style.display = 'none';
                if (loadingScreen.style.display === 'none') loadingScreen.style.display = 'flex';

                try {
                    // Verificar perfil de usuario
                    const { data: userProfile, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('id', user.id)
                        .single();

                    if (error) throw error;

                    if (userProfile && userProfile.is_admin === true) {
                        // Configurar rol
                        isMasterAdmin = (userProfile.role === 'Administrador maestro');
                        
                        // Actualizar UI con datos del usuario
                        const adminName = userProfile.name || 'Administrador';
                        document.getElementById('welcome-message').textContent = `Admin en sesión: ${adminName}`;
                        document.getElementById('dashboard-welcome-text').innerHTML = `Bienvenido, ${adminName}<br><span style="display: block; margin-top: 10px;">selecciona un espacio de trabajo</span>`;
                        
                        // Mostrar Panel y Ocultar Login definitivamente
                        adminPanel.style.display = 'flex';
                        loginContainer.style.display = 'none';
                        
                        // Inicializar vista de bienvenida
                        showWelcomeView(); 
                        
                        // Finalizar carga
                        fadeOutLoadingScreen();

                        // Tareas de fondo (no bloqueantes)
                        setTimeout(cleanOldAlertsReprest, 2000);
                    } else {
                        throw new Error("No tienes permisos de administrador.");
                    }
                } catch (error) {
                    console.error("Error de autenticación/perfil:", error);
                    await supabase.auth.signOut();
                    
                    // Volver al login con error
                    adminPanel.style.display = 'none';
                    loginContainer.style.display = 'flex';
                    fadeOutLoadingScreen();
                    showLoginError(error.message || "Error al cargar perfil.");
                }
            } else {
                // No hay sesión activa
                adminPanel.style.display = 'none';
                loginContainer.style.display = 'flex';
                fadeOutLoadingScreen();
            }
        });

        // Manejar el envío del formulario de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            errorMessage.style.display = 'none';
            
            // Mostrar carga y ocultar login
            loadingScreen.style.display = 'flex';
            loginContainer.style.display = 'none';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
                // El observador onAuthStateChanged se encargará del resto
            } catch (error) {
                console.error("Error de inicio de sesión:", error);
                loadingScreen.style.display = 'none'; // Volver a mostrar la interfaz
                loginContainer.style.display = 'flex';
                showLoginError("Error: " + error.message);
            }
        });

        // Manejar el cierre de sesión
        logoutBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            loadingScreen.style.display = 'flex';
            adminPanel.style.display = 'none';
            await new Promise(resolve => setTimeout(resolve, 1000)); // Espera 1 segundo para mostrar la animación
            await supabase.auth.signOut();
            loginForm.reset(); // Limpia los campos del formulario
        });

        // Manejar clic en actualizar datos
        refreshBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            updateLoadingModal.style.display = 'flex';
            
            const minTime = new Promise(resolve => setTimeout(resolve, 2000));
            const dataLoad = refreshAllData(true);
            
            await Promise.all([minTime, dataLoad]);
            
            updateLoadingModal.style.display = 'none';
            showToast("Datos actualizados");
        });

        // Actualización automática cada 5 segundos
        setInterval(() => {
            refreshAllData(true);
        }, 590000); // Aumentado a casi 10 minutos para no sobrecargar la BD

        // Ejecutar limpieza de alertas cada 10 minutos (600000 ms) de manera silenciosa
        setInterval(() => {
            supabase.auth.getSession().then(({ data }) => {
                if (data.session) {
                    cleanOldAlertsReprest();
                }
            });
        }, 600000);

        async function refreshAllData(isBackground = false) {
            const { data } = await supabase.auth.getSession();
            if (!data.session) return;

            if (navUsers.classList.contains('active')) {
                await loadUsers(isBackground);
            } else if (navAppData.classList.contains('active')) {
                if (filtersApplied) {
                    await loadRecords(currentRecordType || 'debtors', isBackground);
                }
            } else if (navClients.classList.contains('active')) {
                // Evitar recarga si está en modo eliminación múltiple para no perder selección
                if (typeof isMultiDeleteMode !== 'undefined' && isMultiDeleteMode) return;

                if (isClientSearchActive) {
                    await performClientSearch(lastClientSearchTerm, lastClientSearchType, isBackground);
                }
            }
        }

        function showWelcomeView() {
            mainContentHeader.style.display = 'none';
            usersTable.style.display = 'none';
            paymentsTable.style.display = 'none';
            dashboardView.style.display = 'none';
            clientsView.style.display = 'none';
            municipalitiesView.style.display = 'none';
            openFilterModalBtn.style.display = 'none';
            addUserBtn.style.display = 'none';
            openSearchClientBtn.style.display = 'none';
            
            welcomeView.style.display = 'flex';
            document.querySelector('.sidebar').style.display = 'none';
            if(mobileNavBar) mobileNavBar.style.display = 'none';
            
            // Quitar clase active de la barra lateral
            document.querySelectorAll('.sidebar ul li a').forEach(a => a.classList.remove('active'));
        }

        // --- LÓGICA DEL PANEL ---

        // Navegación del panel
        function showSidebarInWorkspace() {
            if (window.innerWidth > 768) {
                sidebar.style.display = 'block';
                sidebar.classList.add('collapsed'); // Iniciar colapsada en desktop
            } else {
                sidebar.style.display = 'block'; // Asegurarse que sea visible para la animación
                sidebar.classList.remove('collapsed'); // No debe estar colapsada en móvil
            }
        }

        sidebarLogo.addEventListener('click', (e) => {
            if (window.innerWidth > 768 && sidebar.style.display !== 'none') {
                e.stopPropagation();
                sidebar.classList.toggle('collapsed');
            } else if (sidebar.classList.contains('sidebar-mobile-open')) {
                // En móvil, si el sidebar está abierto, el logo lo cierra.
                sidebar.classList.remove('sidebar-mobile-open');
                sidebarOverlay.classList.remove('active');
            }
        });

        document.addEventListener('click', (e) => {
            // Desktop: collapse sidebar on outside click
            if (window.innerWidth > 768 && !sidebar.contains(e.target) && !sidebar.classList.contains('collapsed') && sidebar.style.display !== 'none') {
                sidebar.classList.add('collapsed');
            }
        });

        // Función para animar la transición de bienvenida a la barra lateral
        async function handleWelcomeTransition() {
            if (welcomeView.style.display === 'none') return;

            const logo = document.querySelector('.welcome-logo-large');
            const dashboardContainer = document.querySelector('.dashboard-container');
            const welcomeText = document.getElementById('dashboard-welcome-text');

            if (!logo) return;

            // Obtener posición inicial
            const rect = logo.getBoundingClientRect();

            // Fijar posición inicial para evitar salto
            logo.style.position = 'fixed';
            logo.style.top = rect.top + 'px';
            logo.style.left = rect.left + 'px';
            logo.style.width = rect.width + 'px';
            logo.style.margin = '0';
            logo.classList.add('logo-animating');

            // Desvanecer contenido
            if (dashboardContainer) dashboardContainer.classList.add('dashboard-fade-out');
            if (welcomeText) welcomeText.classList.add('dashboard-fade-out');

            // Forzar reflow
            logo.offsetHeight;

            // Establecer posición final (simulando la posición en la barra lateral colapsada)
            // Sidebar padding-top: 20px, padding-left: 10px. Logo width: 40px.
            logo.style.top = '22px'; // Ajuste visual aproximado
            logo.style.left = '12px'; // Ajuste visual aproximado
            logo.style.width = '40px';
            logo.style.borderWidth = '2px';
            logo.style.borderRadius = '15px';

            // Esperar a que termine la animación
            await new Promise(resolve => setTimeout(resolve, 800));
        }

        navUsers.addEventListener('click', async (e) => {
            e.preventDefault();
            closeAllModals();
            await handleWelcomeTransition(); // Ejecutar animación si aplica
            if (window.innerWidth <= 768) {
                mobileNavBar.style.display = 'flex';
            }
            localStorage.setItem('lastSection', 'users');
            navAppData.classList.remove('active');
            navUsers.classList.add('active');
            navImport.classList.remove('active');
            navClients.classList.remove('active');
            navMunicipalities.classList.remove('active');
            navExport.classList.remove('active');
            navReports.classList.remove('active');

            dashboardControls.style.display = 'none';
            welcomeView.style.display = 'none';
            showSidebarInWorkspace();
            mainContentHeader.style.display = 'flex'; // Mostrar header principal
            contentTitle.textContent = 'Gestión de Usuarios';
            contentTitle.style.display = 'block';
            paymentsTable.style.display = 'none';
            dashboardView.style.display = 'none';
            clientsView.style.display = 'none';
            cobradorFilter.style.display = 'none';
            openSearchClientBtn.style.display = 'none';
            openFilterModalBtn.style.display = 'none';
            municipioFilterPagos.style.display = 'none';
            addUserBtn.style.display = 'inline-block';
            municipalitiesView.style.display = 'none';
            reportsView.style.display = 'none';
            addUserBtn.innerHTML = '<i class="fas fa-user-plus"></i> Añadir Usuario';
            
            if (!isUsersViewInitialized) {
                loadingScreen.style.display = 'flex';
                usersTable.style.display = 'none';
                const delayPromise = new Promise(resolve => setTimeout(resolve, 3000));
                await Promise.all([loadUsers(), delayPromise]);
                isUsersViewInitialized = true;
                fadeOutLoadingScreen();
            } else {
                usersTable.style.display = 'table';
            }
        });

        navAppData.addEventListener('click', async (e) => {
            e.preventDefault();
            closeAllModals();
            await handleWelcomeTransition(); // Ejecutar animación si aplica
            if (window.innerWidth <= 768) {
                mobileNavBar.style.display = 'flex';
            }
            localStorage.setItem('lastSection', 'appData');
            navUsers.classList.remove('active');
            navAppData.classList.add('active');
            navImport.classList.remove('active');
            navMunicipalities.classList.remove('active');
            navClients.classList.remove('active');
            navExport.classList.remove('active');
            navReports.classList.remove('active');
            exitMultiDeleteMode(); // Salir del modo eliminación si estaba activo

            dashboardControls.style.display = 'flex';
            welcomeView.style.display = 'none';
            showSidebarInWorkspace();
            mainContentHeader.style.display = 'flex'; // Mostrar header principal
            contentTitle.textContent = 'Tablero de control';
            contentTitle.style.display = 'block';
            usersTable.style.display = 'none';
            paymentsTable.style.display = 'none';
            dashboardView.style.display = 'block';
            addUserBtn.style.display = 'none'; // Ocultar el botón de añadir
            openSearchClientBtn.style.display = 'none';
            clientsView.style.display = 'none';
            municipalitiesView.style.display = 'none';
            reportsView.style.display = 'none';
            openFilterModalBtn.style.display = 'none';
            
            cobradorFilter.style.display = 'none';
            municipioFilterPagos.style.display = 'none';
            
            if (!isDashboardViewInitialized) {
                loadingScreen.style.display = 'flex';
                const delayPromise = new Promise(resolve => setTimeout(resolve, 1000));
                loadDashboardData();
                await delayPromise;
                isDashboardViewInitialized = true;
                fadeOutLoadingScreen();
            }
        });

        navClients.addEventListener('click', async (e) => {
            e.preventDefault();

            // REFUERZO: Limpiar alertas antiguas al entrar a clientes
            cleanOldAlertsReprest();

            closeAllModals();
            await handleWelcomeTransition(); // Ejecutar animación si aplica
            if (window.innerWidth <= 768) {
                mobileNavBar.style.display = 'flex';
            }
            localStorage.setItem('lastSection', 'clients');
            navUsers.classList.remove('active');
            navAppData.classList.remove('active');
            navImport.classList.remove('active');
            navMunicipalities.classList.remove('active');
            navExport.classList.remove('active');
            navReports.classList.remove('active');
            navClients.classList.add('active');
            exitMultiDeleteMode(); // Asegurar estado inicial

            dashboardControls.style.display = 'none';
            welcomeView.style.display = 'none';
            showSidebarInWorkspace();
            mainContentHeader.style.display = 'none'; // Ocultar header principal para evitar doble línea
            // Ocultar otras vistas
            usersTable.style.display = 'none';
            paymentsTable.style.display = 'none';
            dashboardView.style.display = 'none';
            openFilterModalBtn.style.display = 'none';
            addUserBtn.style.display = 'none';
            openSearchClientBtn.style.display = 'inline-block';
            municipalitiesView.style.display = 'none';
            reportsView.style.display = 'none';
            contentTitle.style.display = 'none'; // Usamos el título interno de clients-view

            if (!isClientsViewInitialized) {
                loadingScreen.style.display = 'flex';
                const delayPromise = new Promise(resolve => setTimeout(resolve, 3000));
                // Resetear estado de búsqueda solo la primera vez
                isClientSearchActive = false;
                lastClientSearchTerm = '';
                lastClientSearchType = '';
                clientsView.style.display = 'none';
                clientsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Busque al cliente a revisar</td></tr>';
                await delayPromise;
                isClientsViewInitialized = true;
                fadeOutLoadingScreen();
            }

            // Verificar alertas de represte al entrar
            try {
                const { data: alertsSnap, error: alertsError } = await supabase.from('alerts_represt').select('*');
                const alerts = [];
                represteAlertCedulas = []; // Resetear
                alertsSnap.forEach(d => {
                    if (d.represt !== true) { // d is the object
                        alerts.push(d);
                        if (d.cedula) represteAlertCedulas.push(d.cedula);
                    }
                });

                const searchAllBtn = document.getElementById('btn-search-all-alert-clients');

                if (alerts.length > 0) {
                    const tbody = document.getElementById('alert-represt-list-body');
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;"><div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div></td></tr>';
                    alertReprestNotificationModal.style.display = 'flex';
                    searchAllBtn.style.display = 'block';

                    const clientPromises = alerts.map(async (alertData) => {
                        let clientName = 'Desconocido';
                        let clientMuni = 'Desconocido';
                        const { data: clientQuery, error } = await supabase
                            .from('clients')
                            .select('name, municipality')
                            .eq('cedula', alertData.cedula)
                            .limit(1)
                            .single();
                        if (clientQuery) {
                            clientName = clientQuery.name || 'Desconocido';
                            clientMuni = clientQuery.municipality || 'Desconocido';
                        }
                        return { ...alertData, clientName, clientMuni };
                    });

                    const enrichedAlerts = await Promise.all(clientPromises);
                    let html = '';
                    enrichedAlerts.forEach(a => {
                        html += `<tr>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${a.cedula || 'N/A'}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${a.clientName}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${a.clientMuni}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${a.user_name || 'Desconocido'}</td>
                        </tr>`;
                    });
                    tbody.innerHTML = html;
                }
            } catch (err) { console.error("Error checking alerts:", err); }
            
            // Siempre mostrar la vista al final
            clientsView.style.display = 'block'; 
        });

        navMunicipalities.addEventListener('click', async (e) => {
            e.preventDefault();
            closeAllModals();
            await handleWelcomeTransition(); // Ejecutar animación si aplica
            if (window.innerWidth <= 768) {
                mobileNavBar.style.display = 'flex';
            }
            localStorage.setItem('lastSection', 'municipalities');
            navUsers.classList.remove('active');
            navAppData.classList.remove('active');
            navImport.classList.remove('active');
            navClients.classList.remove('active');
            navExport.classList.remove('active');
            navReports.classList.remove('active');
            navMunicipalities.classList.add('active');

            dashboardControls.style.display = 'none';
            welcomeView.style.display = 'none';
            showSidebarInWorkspace();
            mainContentHeader.style.display = 'none'; // Ocultar header principal
            usersTable.style.display = 'none';
            paymentsTable.style.display = 'none';
            dashboardView.style.display = 'none';
            clientsView.style.display = 'none';
            openFilterModalBtn.style.display = 'none';
            addUserBtn.style.display = 'none';
            openSearchClientBtn.style.display = 'none';
            reportsView.style.display = 'none';
            
            municipalitiesView.style.display = 'block';
            
            if (!isMunicipalitiesViewInitialized) {
                loadingScreen.style.display = 'flex';
                const delayPromise = new Promise(resolve => setTimeout(resolve, 3000));
                hideAllMunicipalitySections(); // Mostrar mensaje por defecto solo la primera vez
                // Cargar departamentos
                await Promise.all([populateDepartmentsList(), delayPromise]);
                isMunicipalitiesViewInitialized = true;
                fadeOutLoadingScreen();
            }
        });

        navReports.addEventListener('click', async (e) => {
            e.preventDefault();
            closeAllModals();
            await handleWelcomeTransition(); // Ejecutar animación si aplica
            if (window.innerWidth <= 768) {
                mobileNavBar.style.display = 'flex';
            }
            localStorage.setItem('lastSection', 'reports');
            navUsers.classList.remove('active');
            navAppData.classList.remove('active');
            navImport.classList.remove('active');
            navClients.classList.remove('active');
            navMunicipalities.classList.remove('active');
            navExport.classList.remove('active');
            navReports.classList.add('active');

            dashboardControls.style.display = 'none';
            welcomeView.style.display = 'none';
            showSidebarInWorkspace();
            mainContentHeader.style.display = 'none'; // Ocultar header principal
            usersTable.style.display = 'none';
            paymentsTable.style.display = 'none';
            dashboardView.style.display = 'none';
            clientsView.style.display = 'none';
            municipalitiesView.style.display = 'none';
            openFilterModalBtn.style.display = 'none';
            addUserBtn.style.display = 'none';
            openSearchClientBtn.style.display = 'none';
            
            reportsView.style.display = 'block';
            
            if (!isReportsViewInitialized) {
                loadingScreen.style.display = 'flex';
                const delayPromise = new Promise(resolve => setTimeout(resolve, 1000));
                // No resetear vista de informes para mantener persistencia
                await delayPromise;
                isReportsViewInitialized = true;
                fadeOutLoadingScreen();
            }
        });


        // --- LÓGICA DEL MODAL DE FILTROS ---
        openFilterModalBtn.addEventListener('click', () => {
            filterOptionsModal.style.display = 'flex';
        });

        // Listener para cambio de departamento en Filtros de Datos
        filterDepartment.addEventListener('change', async (e) => {
            await loadMunicipalitiesForSelect(e.target.value, municipioFilterPagos, true, true); // true = es un input searchable, true = incluir "Todos"
        });

        closeFilterModalBtn.addEventListener('click', () => {
            filterOptionsModal.style.display = 'none';
        });

        applyFiltersBtn.addEventListener('click', () => {
            filterOptionsModal.style.display = 'none';
            filtersApplied = true; // Marcar que se han aplicado filtros
            // Al aplicar filtros, cargamos los registros
            loadRecords(currentRecordType);
        });

        // (Se eliminaron los listeners directos de cambio en filtros para que solo aplique con el botón)

        // Lógica de Importación de Excel
        navImport.addEventListener('click', (e) => {
            e.preventDefault();
            importExcelInput.click();
        });

        // Lógica de Exportación (Modal)
        btnOpenExportDateModal.addEventListener('click', () => {
            exportDateFilterModal.style.display = 'flex';
        });

        navExport.addEventListener('click', async (e) => {
            e.preventDefault();
            
            // Llenar días si está vacío
            if (exportDaySelect.options.length <= 1) {
                for (let i = 1; i <= 31; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = i;
                    exportDaySelect.appendChild(opt);
                }
            }

            // Llenar meses si está vacío
            if (exportMonthSelect.options.length <= 1) {
                const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                months.forEach((m, index) => {
                    const opt = document.createElement('option');
                    opt.value = index + 1;
                    opt.textContent = m;
                    exportMonthSelect.appendChild(opt);
                });
            }

            // Llenar años (Año actual y futuros si se requiere, aquí solo actual y anteriores si se desea, pero el prompt dice "al pasar los años vaya agregando")
            // Limpiamos para asegurar que esté actualizado
            exportYearSelect.innerHTML = '<option value="all">Todos los años</option>';
            const currentYear = new Date().getFullYear();
            const startYear = 2024; // Año base
            for (let y = startYear; y <= currentYear; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                exportYearSelect.appendChild(opt);
            }

            // Actualizar texto del periodo
            updateExportPeriodText();

            // Llenar Departamentos para Exportar
            const deptInput = document.getElementById('export-department');
            deptInput.value = '';
            document.getElementById('export-municipality').value = 'Todos los Municipios';
            deptInput.placeholder = 'Cargando...';
            
            try {
                const { data: snapshot, error } = await supabase.from('municipalities').select('department');
                const departments = [...new Set(snapshot.map(item => item.department))].sort();
                
                setupSearchableInput('export-department', 'list-export-department', departments, true); // Incluir "Todos"
                
                if (departments.length === 1) {
                    deptInput.value = departments[0];
                    deptInput.disabled = true;
                    // Cargar municipios automáticamente
                    loadMunicipalitiesForSelect(departments[0], exportMunicipalitySelect, true, true);
                } else {
                    deptInput.placeholder = 'Seleccionar Departamento...';
                    deptInput.disabled = false;
                }
            } catch (error) {
                console.error("Error loading export departments:", error);
            }

            // Llenar Usuarios para Exportar
            const userInput = document.getElementById('export-user');
            userInput.value = '';
            userInput.placeholder = 'Cargando...';
            
            const { data: usersSnapshot, error } = await supabase.from('users').select('name').order('name');
            const userNames = ['Todos los usuarios'];
            usersSnapshot.forEach(user => {
                userNames.push(user.name);
            });
            setupSearchableInput('export-user', 'list-export-user', userNames, false);
            userInput.placeholder = 'Todos los usuarios';

            exportReportModal.style.display = 'flex';
        });

        document.getElementById('export-department').addEventListener('change', (e) => {
            const dept = e.target.value;
            if (dept) {
                loadMunicipalitiesForSelect(dept, exportMunicipalitySelect, true, true);
            }
        });

        closeExportDateModalBtn.addEventListener('click', () => {
            exportDateFilterModal.style.display = 'none';
        });

        btnApplyExportDate.addEventListener('click', () => {
            updateExportPeriodText();
            exportDateFilterModal.style.display = 'none';
        });

        function updateExportPeriodText() {
            const d = exportDaySelect.value;
            const m = exportMonthSelect.value;
            const y = exportYearSelect.value;
            
            let text = "Periodo seleccionado: ";
            
            if (d !== 'all' && m !== 'all' && y !== 'all') {
                // Formato dd-MM-yyyy
                const dayStr = String(d).padStart(2, '0');
                const monthStr = String(m).padStart(2, '0');
                text += `${dayStr}-${monthStr}-${y}`;
            } else {
                const dayText = d === 'all' ? "Todos los días" : d;
                const monthText = m === 'all' ? "Todos los meses" : exportMonthSelect.options[exportMonthSelect.selectedIndex].text;
                const yearText = y;
                
                if (d === 'all' && m === 'all' && y === 'all') {
                    text += "Todos los dias de todos los años";
                } else if (d === 'all' && m === 'all') {
                    text += `Todos los días del ${y}`;
                } else {
                    text += `${dayText}, ${monthText}, ${yearText}`;
                }
            }
            document.getElementById('export-period-text').textContent = text;
        }

        // --- LÓGICA DE MUNICIPIOS ---

        async function populateDepartmentsList() {
            colombiaDepartments.sort();
            // Llenar los dropdowns de Crear e Importar Municipios
            setupSearchableInput('municipality-department-select', 'list-municipality-department-select', colombiaDepartments);
            setupSearchableInput('import-municipality-department-select', 'list-import-municipality-department-select', colombiaDepartments);
            // Llenar el dropdown del modal "Ver Municipios"
            setupSearchableInput('view-municipality-department-search', 'list-view-municipality-department', colombiaDepartments);
        }

        function hideAllMunicipalitySections() {
            municipalitiesDefaultMsg.style.display = 'block';
            createMunicipalitySection.style.display = 'none';
            viewMunicipalitiesSection.style.display = 'none';
            importMunicipalitiesSection.style.display = 'none';
        }

        // Lógica para agregar campos de municipio dinámicamente
        btnAddMunicipalityField.addEventListener('click', () => {
            const currentInputs = municipalityInputsContainer.querySelectorAll('input');
            if (currentInputs.length >= 5) {
                return alert("Máximo 5 municipios por vez.");
            }
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'municipality-input';
            input.placeholder = 'Nombre del Municipio';
            input.required = true;
            input.style.width = '100%';
            input.style.padding = '12px';
            input.style.marginBottom = '10px';
            input.style.border = '1px solid #dfe3e8';
            input.style.borderRadius = '4px';
            input.style.boxSizing = 'border-box';
            input.style.marginBottom = '0'; // Reset margin for flex layout
            
            const div = document.createElement('div');
            div.className = 'municipality-input-group';
            div.style.display = 'flex';
            div.style.gap = '5px';
            div.style.marginBottom = '10px';
            div.style.alignItems = 'center';

            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn';
            deleteBtn.style.backgroundColor = '#e74c3c';
            deleteBtn.style.padding = '0';
            deleteBtn.style.width = '45px'; // Tamaño cuadrado pequeño (aprox 5*5 relativo a escala visual)
            deleteBtn.style.height = '42px'; // Altura igual al input
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.onclick = () => {
                div.remove();
                updateCreateButtonText();
            };

            div.appendChild(input);
            div.appendChild(deleteBtn);
            
            municipalityInputsContainer.appendChild(div);
            updateCreateButtonText();
        });

        function updateCreateButtonText() {
            const count = municipalityInputsContainer.querySelectorAll('input').length;
            if (count > 1) {
                btnCreateMunicipality.innerHTML = '<i class="fas fa-save"></i> Crear Municipios';
            } else {
                btnCreateMunicipality.innerHTML = '<i class="fas fa-save"></i> Crear Municipio';
            }
        }

        // Crear Municipio Manualmente
        createMunicipalityForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const department = municipalityDepartmentSelect.value;
            const inputs = municipalityInputsContainer.querySelectorAll('input');
            const municipalities = Array.from(inputs).map(i => i.value.trim()).filter(v => v);
            
            if (!department || municipalities.length === 0) return alert("Complete todos los campos.");

            try {
                const rowsToInsert = municipalities.map(muni => ({ department: department, name: muni }));
                const { error } = await supabase.from('municipalities').upsert(rowsToInsert, { onConflict: 'department, name' });

                if (error) throw error;

                const msg = municipalities.length > 1 ? "Se crearon exitosamente los municipios" : "Se creo exitosamente el municipio";
                showToast(msg);
                
                // Resetear inputs
                municipalityInputsContainer.innerHTML = '';
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'municipality-input';
                input.placeholder = 'Nombre del Municipio';
                input.required = true;
                input.style.width = '100%';
                input.style.padding = '12px';
                input.style.marginBottom = '10px';
                input.style.border = '1px solid #dfe3e8';
                input.style.borderRadius = '4px';
                input.style.boxSizing = 'border-box';
                municipalityInputsContainer.appendChild(input);
                updateCreateButtonText();

            } catch (error) {
                console.error("Error creando municipio:", error);
                alert("Error al crear municipio: " + error.message);
            }
        });

        // Botones de Acción en Municipios
        btnCreateMunicipalitiesAction.addEventListener('click', () => {
            hideAllMunicipalitySections();
            municipalitiesDefaultMsg.style.display = 'none';
            createMunicipalitySection.style.display = 'block';
        });

        btnViewMunicipalitiesAction.addEventListener('click', () => {
            hideAllMunicipalitySections();
            municipalitiesDefaultMsg.style.display = 'none';
            document.getElementById('view-municipality-department-search').value = '';
            document.getElementById('municipalities-list-result').innerHTML = '';
            document.getElementById('municipalities-list-title').style.display = 'none';
            document.getElementById('municipalities-list-result').style.display = 'none';
            viewMunicipalitiesSection.style.display = 'block';
        });

        // Buscar Municipios en el Modal "Ver Municipios"
        document.getElementById('btn-search-municipalities-list').addEventListener('click', async () => {
            const deptInput = document.getElementById('view-municipality-department-search');
            const deptName = deptInput.value.trim();
            
            if (!deptName) return alert("Seleccione un departamento.");

            // Validar que el departamento exista en la lista local (coincidencia exacta insensible)
            const normalizedInput = normalizeText(deptName);
            const matchedDept = colombiaDepartments.find(d => normalizeText(d) === normalizedInput);

            if (!matchedDept) {
                return alert("Departamento no válido. Seleccione uno de la lista.");
            }

            const listContainer = document.getElementById('municipalities-list-result');
            const title = document.getElementById('municipalities-list-title');
            
            listContainer.innerHTML = '<div class="spinner" style="width: 30px; height: 30px; margin: 10px auto;"></div>';
            listContainer.style.display = 'block';
            title.style.display = 'none';

            const munis = await loadMunicipalitiesByDepartment(deptName);
            
            title.textContent = `Municipios del departamento de ${deptName}`;
            title.style.display = 'block';
            
            if (munis.length === 0) {
                listContainer.innerHTML = '<p style="text-align:center; padding:10px;">No hay municipios registrados.</p>';
            } else {
                listContainer.innerHTML = '';
                munis.forEach(m => {
                    const div = document.createElement('div');
                    div.style.cssText = "padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;";
                    div.innerHTML = `<span>${m}</span>
                        <div>
                            <button class="btn btn-edit-muni" data-dept="${matchedDept}" data-muni="${m}" style="background-color: #f39c12; padding: 5px 10px; margin-right: 5px; width: auto; display: inline-block;"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-delete-muni" data-dept="${matchedDept}" data-muni="${m}" style="background-color: #e74c3c; padding: 5px 10px; width: auto; display: inline-block;"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    listContainer.appendChild(div);
                });
            }
        });

        // Event Listener para editar/eliminar municipios de la lista
        document.getElementById('municipalities-list-result').addEventListener('click', async (e) => {
            // Editar
            const editBtn = e.target.closest('.btn-edit-muni');
            if (editBtn) {
                const dept = editBtn.dataset.dept;
                const oldName = editBtn.dataset.muni;
                const newName = prompt("Nuevo nombre para el municipio:", oldName);
                
                if (newName && newName.trim() !== "" && newName !== oldName) {
                    try {
                        const { error } = await supabase
                            .from('municipalities')
                            .update({ name: newName.trim() })
                            .eq('department', dept)
                            .eq('name', oldName);
                        if (error) throw error;
                        showToast("Municipio actualizado");
                        document.getElementById('btn-search-municipalities-list').click(); // Recargar lista
                    } catch (error) {
                        console.error("Error actualizando municipio:", error);
                        alert("Error al actualizar: " + error.message);
                    }
                }
                return;
            }

            // Eliminar
            const deleteBtn = e.target.closest('.btn-delete-muni');
            if (deleteBtn) {
                const dept = deleteBtn.dataset.dept;
                const muniName = deleteBtn.dataset.muni;
                
                if (confirm(`¿Estás seguro de eliminar el municipio "${muniName}"?`)) {
                    try {
                        const { error } = await supabase
                            .from('municipalities')
                            .delete()
                            .eq('department', dept)
                            .eq('name', muniName);
                        showToast("Municipio eliminado");
                        document.getElementById('btn-search-municipalities-list').click(); // Recargar lista
                    } catch (error) {
                        console.error("Error eliminando municipio:", error);
                        alert("Error al eliminar: " + error.message);
                    }
                }
            }
        });

        // Modal Importar Municipios
        btnOpenImportMunicipalities.addEventListener('click', () => {
            hideAllMunicipalitySections();
            municipalitiesDefaultMsg.style.display = 'none';
            importMunicipalitiesSection.style.display = 'block';
            importMunicipalitiesStatus.textContent = '';
        });

        importMunicipalitiesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const department = importMunicipalityDepartmentSelect.value;
            const file = municipalityFileInput.files[0];

            if (!department || !file) return alert("Seleccione departamento y archivo.");

            const loadingText = importLoadingModal.querySelector('h3');
            loadingText.textContent = 'Importando...';
            importLoadingModal.style.display = 'flex'; // Mostrar modal de carga
            
            try {
                let text = '';
                if (file.name.endsWith('.pdf')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        text += content.items.map(item => item.str).join(' ') + '\n';
                    }
                } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    text = result.value;
                } else {
                    throw new Error("Formato no soportado. Use PDF o Word.");
                }

                // Procesar texto: separar por saltos de línea o comas
                const municipalities = text.split(/[\n,]+/).map(m => m.trim()).filter(m => m.length > 0);

                if (municipalities.length === 0) throw new Error("No se encontraron municipios en el archivo.");

                // Preparar previsualización
                currentImportDepartment = department;
                document.getElementById('preview-municipalities-title').textContent = 'Municipios a importar del ' + department;
                renderPreviewMunicipalities(municipalities);
                
                // importMunicipalitiesSection.style.display = 'none'; // No es necesario ocultar, el modal de preview se superpone
                previewMunicipalitiesModal.style.display = 'flex'; // Mostrar modal de previsualización

            } catch (error) {
                console.error("Error importando:", error);                
                alert("Error: " + error.message);
            } finally {
                importLoadingModal.style.display = 'none';
                municipalityFileInput.value = '';
            }
        });

        function renderPreviewMunicipalities(list) {
            previewMunicipalitiesList.innerHTML = '';
            list.forEach(mun => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <input type="text" value="${mun}" disabled style="flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    <button class="btn btn-edit-preview" style="background-color: #f39c12; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-delete-preview" style="background-color: #e74c3c; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer;"><i class="fas fa-trash"></i></button>
                `;
                
                // Evento Editar
                const input = div.querySelector('input');
                const editBtn = div.querySelector('.btn-edit-preview');
                editBtn.addEventListener('click', () => {
                    if (input.disabled) {
                        input.disabled = false;
                        input.focus();
                        editBtn.innerHTML = '<i class="fas fa-check"></i>';
                        editBtn.style.backgroundColor = '#2ecc71';
                    } else {
                        input.disabled = true;
                        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                        editBtn.style.backgroundColor = '#f39c12';
                    }
                });

                // Evento Eliminar
                div.querySelector('.btn-delete-preview').addEventListener('click', () => {
                    div.remove();
                });

                previewMunicipalitiesList.appendChild(div);
            });
        }

        btnSaveImportedMunicipalities.addEventListener('click', async () => {
            const inputs = previewMunicipalitiesList.querySelectorAll('input');
            const municipalitiesToSave = Array.from(inputs).map(input => input.value.trim()).filter(val => val.length > 0);

            if (municipalitiesToSave.length === 0) return alert("No hay municipios para guardar.");

            // Mostrar modal de carga
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Registrando municipios espere por favor";
            loadingModal.style.display = 'flex';

            try {
                const rowsToInsert = municipalitiesToSave.map(muni => ({ department: currentImportDepartment, name: muni }));
                const { error } = await supabase.from('municipalities').upsert(rowsToInsert, { onConflict: 'department, name' });

                if (error) throw error;
                
                showToast("Municipios guardados exitosamente.");
                previewMunicipalitiesModal.style.display = 'none';
            } catch (error) {
                console.error("Error guardando municipios:", error);
                alert("Error al guardar: " + error.message);
            } finally {
                loadingModal.style.display = 'none';
            }
        });

        closePreviewMunicipalitiesModal.addEventListener('click', () => {
            previewMunicipalitiesModal.style.display = 'none';
        });

        closeExportModalBtn.addEventListener('click', () => {
            exportReportModal.style.display = 'none';
        });

        btnExportAction.addEventListener('click', async () => {
            // Mostrar modal de carga
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            const loadingDesc = loadingModal.querySelector('p');
            loadingText.textContent = "Procesando datos y realizando la exportacion";
            loadingDesc.textContent = "Por favor espere...";
            loadingModal.style.display = 'flex';

            try {
                // 1. Construir consulta para Debtors en Supabase
                let query = supabase.from('debtors').select('*');

                // Filtrar registros con balance > 0
                query = query.gt('balance', 0);
                
                // Filtro Usuario
                const user = document.getElementById('export-user').value.trim();
                if (user && user !== 'Todos los usuarios') {
                    query = query.where('asesorName', '==', user);
                }

                // Filtro Municipio
                const municipality = document.getElementById('export-municipality').value;
                if (municipality && municipality !== 'Todos los Municipios') {
                    query = query.where('municipality', '==', municipality);
                }

                const { data: debtors, error: debtorsError } = await query;
                if (debtorsError) throw debtorsError;

                // Filtro Departamento (en memoria si no se seleccionó municipio específico)
                const department = document.getElementById('export-department').value;
                if (department && (!municipality || municipality === 'Todos los Municipios')) {
                    const { data: deptMunisData, error: deptError } = await supabase
                        .from('municipalities')
                        .select('name')
                        .eq('department', department);
                    
                    if (deptMunisData) {
                        const deptMunis = deptMunisData.map(m => m.name);
                        debtors = debtors.filter(d => deptMunis.includes(d.municipality));
                    } else {
                        debtors = []; // Si el departamento no existe, no hay resultados
                    }
                }

                // Filtro Fecha (Periodo)
                const day = exportDaySelect.value;
                const month = exportMonthSelect.value;
                const year = exportYearSelect.value;

                debtors = debtors.filter(d => {
                    // Parsear fecha dd-MM-yyyy o Timestamp
                    let dateObj = parseDate(d.saleDate);
                    
                    // Fallback a createdAt si no hay saleDate o falló el parseo
                    if (!dateObj) dateObj = parseDate(d.createdAt);
                    
                    if (!dateObj) return false;

                    const dd = dateObj.getDate();
                    const mm = dateObj.getMonth() + 1;
                    const yyyy = dateObj.getFullYear();

                    if (year !== 'all' && yyyy !== parseInt(year)) return false;
                    if (month !== 'all' && mm !== parseInt(month)) return false;
                    if (day !== 'all' && dd !== parseInt(day)) return false;
                    return true;
                });

                if (debtors.length === 0) {
                    loadingModal.style.display = 'none';
                    alert("No se encontraron registros para exportar con los filtros seleccionados.");
                    return;
                }

                // 2. Procesar Datos para Excel
                const processDebtor = async (debtor) => {
                    // Obtener ABONO (suma de todos los pagos para este crédito)
                    const { data: payments, error: paymentsError } = await supabase
                        .from('payments')
                        .select('payment_amount')
                        .eq('debtor_id', debtor.id);

                    let totalAbonoCredito = 0;
                    if (payments) {
                        payments.forEach(p => {
                            totalAbonoCredito += (Number(p.payment_amount) || 0);
                        });
                    }
                    const abono = totalAbonoCredito;

                    // Recaudo Total (Suma de todos los pagos por cédula)
                    const { data: allPayments, error: allPaymentsError } = await supabase
                        .from('payments')
                        .select('payment_amount')
                        .eq('cedula', debtor.cedula);

                    let totalRecaudo = 0;
                    if (allPayments) {
                        allPayments.forEach(p => totalRecaudo += (Number(p.payment_amount) || 0));
                    }
                    // El recaudo de clientes importados ya está en la tabla de pagos, no se necesita sumar de 'clients'

                    const creditoNuevo = debtor.CreditType === 'Nuevo' ? (Number(debtor.saleValue) || 0) : 0;
                    const represte = debtor.CreditType === 'Represte' ? (Number(debtor.saleValue) || 0) : 0;
                    const saldo = Number(debtor.balance) || 0;
                    const valorCuota = Number(debtor.valorCuota) || 0;

                    // Determinar fecha de préstamo para exportación
                    let fechaPrestamoExport = null;
                    let dateSource = (debtor.imported === true && debtor.saleDate) ? debtor.saleDate : debtor.createdAt;
                    let parsedDate = parseDate(dateSource);

                    if (parsedDate) {
                        // Ajustar a mediodía para evitar problemas de zona horaria en la exportación
                        parsedDate.setHours(12, 0, 0, 0);
                        fechaPrestamoExport = parsedDate;
                    }

                    // ESTADO column logic
                    let estado = 'GRIS';
                    const pTerm = debtor.paymentTerm || '';
                    const remaining = Number(debtor.remainingPayments) || 0;
                    const saleDate = parseDate(debtor.saleDate);
                    const numPayments = Number(debtor.numberOfPayments) || 0;

                    // Check ROJO first
                    if (saleDate && numPayments > 0 && pTerm) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        let expirationDate = new Date(saleDate);

                        if (pTerm === 'Diario') {
                            expirationDate.setDate(expirationDate.getDate() + numPayments);
                        } else if (pTerm === 'Semanal') {
                            expirationDate.setDate(expirationDate.getDate() + (numPayments * 7));
                        }

                        if (expirationDate < today) {
                            estado = 'ROJO';
                        }
                    }

                    // If not ROJO, check others
                    if (estado !== 'ROJO') {
                        if ((pTerm === 'Diario' && remaining === 1) || (pTerm === 'Semanal' && remaining === 5)) {
                            estado = 'VERDE';
                        } else if ((pTerm === 'Diario' && saldo === 20000) || (pTerm === 'Semanal' && saldo === 40000)) {
                            estado = 'AMARILLO';
                        }
                    }

                    return {
                        "CLIENTE": debtor.name || '',
                        "CEDULA": debtor.cedula || '',
                        "MUNICIPIO": debtor.municipality || '',
                        "ASESOR": debtor.asesorName || '',
                        "DIRECCION": debtor.address || '',
                        "TELEFONO": Number(debtor.phone) || 0,
                        "FECHA DE PRESTAMO": fechaPrestamoExport,
                        "CREDITO NUEVO": creditoNuevo > 0 ? creditoNuevo : '',
                        "REPRESTE": represte > 0 ? represte : '',
                        "CUOTA": Number(debtor.remainingPayments) || 0,
                        "DIA": debtor.loanDay || '',
                        "VALOR-CUOTA": valorCuota,
                        "ABONO": abono,
                        "SALDO": saldo,
                        "RECAUDO TOTAL": totalRecaudo,
                        "TIPO DE PAGO": debtor.paymentTerm || '',
                        "ESTADO": estado
                    };
                };

                const exportData = await Promise.all(debtors.map(processDebtor));

                // 3. Generar Excel
                const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                const wb = XLSX.utils.book_new();

                // --- Aplicar formato de fecha corta a la columna de fecha ---
                const dateHeader = "FECHA DE PRESTAMO";
                const range = XLSX.utils.decode_range(ws['!ref']);
                let dateColumnIndex = -1;

                // Encontrar la columna por el encabezado
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell = ws[XLSX.utils.encode_cell({ r: 0, c: C })];
                    if (cell && cell.v === dateHeader) {
                        dateColumnIndex = C;
                        break;
                    }
                }

                // Si se encuentra la columna, aplicar el formato a cada celda de datos
                if (dateColumnIndex > -1) {
                    for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: dateColumnIndex });
                        const cell = ws[cellAddress];
                        // Asegurarse de que la celda exista y sea un número (fecha de Excel)
                        if (cell && (cell.t === 'n' || cell.t === 'd')) {
                            cell.z = 'm/d/yy';
                        }
                    }
                }
                // --- Fin de la aplicación de formato ---

                // --- Aplicar formato de color a la columna ESTADO ---
                const estadoHeader = "ESTADO";
                let estadoColumnIndex = -1;

                // Encontrar la columna por el encabezado
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cell = ws[XLSX.utils.encode_cell({ r: 0, c: C })];
                    if (cell && cell.v === estadoHeader) {
                        estadoColumnIndex = C;
                        break;
                    }
                }

                // Si se encuentra la columna, aplicar el formato a cada celda de datos
                if (estadoColumnIndex > -1) {
                    for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: estadoColumnIndex });
                        const cell = ws[cellAddress];
                        if (cell && cell.v) {
                            const estadoValue = cell.v;
                            let color = "BFBFBF"; // GRIS (Gris estándar de Excel)

                            if (estadoValue === 'VERDE') color = "92D050"; // Verde
                            else if (estadoValue === 'AMARILLO') color = "FFFF00"; // Amarillo
                            else if (estadoValue === 'ROJO') color = "FF0000"; // Rojo
                            
                            // Aplicar el estilo de relleno
                            cell.s = { fill: { patternType: "solid", fgColor: { rgb: color } } };
                        }
                    }
                }
                // --- Fin de la aplicación de formato de color ---

                XLSX.utils.book_append_sheet(wb, ws, "Reporte");
                
                XLSX.writeFile(wb, "Reporte_Exportado.xlsx");

                showToast("Exportacion realizada con exito");
            } catch (e) {
                console.error(e);
                alert("Error exportando: " + e.message);
            } finally {
                loadingModal.style.display = 'none';
            }
        });

        // Detectar Enter en búsqueda de cliente
        searchClientInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const term = searchClientInput.value.trim();
                if (!term) return;
                // Si contiene solo números (y guiones opcionales), asumimos cédula. Si tiene letras, nombre.
                const isCedula = /^[\d-]+$/.test(term);
                performClientSearch(term, isCedula ? 'cedula' : 'name');
            }
        });

        importExcelInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validar que el archivo sea realmente un Excel por su extensión
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                alert('Por favor, selecciona un archivo de Excel válido (.xlsx o .xls).');
                e.target.value = '';
                return;
            }

            const loadingText = importLoadingModal.querySelector('h3');
            loadingText.textContent = 'Importando...';
            importLoadingModal.style.display = 'flex';

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet, { cellDates: true }); // Leer fechas correctamente

                // Normalizar claves del JSON a mayúsculas para evitar problemas de mayúsculas/minúsculas
                // Y normalizar valores de Municipio y Cliente si están todo en mayúsculas
                
                // Pre-cargar todos los municipios de la BD para normalización
                const { data: allMunicipalitiesSnapshot } = await supabase.from('municipalities').select('name');
                const dbMunicipalities = new Set();
                if (allMunicipalitiesSnapshot) {
                    allMunicipalitiesSnapshot.forEach(row => dbMunicipalities.add(row.name));
                }
                
                // Función para buscar municipio en BD (insensible)
                const findDbMunicipality = (inputMuni) => {
                    if (!inputMuni) return inputMuni;
                    const normalizedInput = normalizeText(inputMuni);
                    for (let dbMuni of dbMunicipalities) {
                        if (normalizeText(dbMuni) === normalizedInput) {
                            return dbMuni; // Retornar el nombre exacto de la BD
                        }
                    }
                    return toTitleCase(inputMuni); // Si no encuentra, Title Case
                };

                const normalizedJson = json.map(row => {
                    const newRow = {};
                    Object.keys(row).forEach(key => {
                        newRow[key.trim().toUpperCase()] = row[key];
                    });
                    return newRow;
                });

                if (normalizedJson.length === 0) {
                    alert('El archivo Excel parece estar vacío.');
                    return;
                }

                // Función auxiliar para buscar valores usando múltiples posibles nombres de columna
                const getColVal = (row, aliases) => {
                    for (let alias of aliases) {
                        if (row[alias] !== undefined) return row[alias];
                    }
                    return null;
                };

                // Función para formatear fecha a dd-MM-yyyy
                const parseExcelDate = (rawDate) => {
                    if (!rawDate) return null;
                    if (rawDate instanceof Date) return new Date(rawDate.getTime() - (rawDate.getTimezoneOffset() * 60000));
                    
                    // Si es un número (serial de Excel) y no fue convertido por cellDates: true
                    if (typeof rawDate === 'number') {
                        // Ajuste aproximado para fechas Excel (días desde 1900-01-01)
                        return new Date(Math.round((rawDate - 25569) * 86400 * 1000));
                    }
                    
                    const strDate = String(rawDate).trim();
                    // Intentar parsear dd/mm/yyyy
                    const parts = strDate.split(/[\/\-]/);
                    if (parts.length === 3) {
                        // Asumimos dd/mm/yyyy
                        const day = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const year = parseInt(parts[2], 10);
                        if (!isNaN(day) && !isNaN(month) && !isNaN(year)) {
                            return new Date(year, month, day);
                        }
                    }
                    return new Date(rawDate);
                };

                // Función para buscar coincidencia de asesor en usuarios
                const { data: usersList, error: usersError } = await supabase.from('users').select('*');
                if (usersError) throw usersError;

                const findExactMatchUser = (excelName) => {
                    if (!excelName) return null;
                    const normalizedExcel = String(excelName).trim().toUpperCase(); // Corregido para usar usersList
                    const user = usersList.find(u => (u.name || '').toUpperCase() === normalizedExcel);
                    return user ? user.name : null;
                };

                // Obtener Cédula del Cobrador desde el nombre del archivo
                const fileName = file.name;
                const fileCedula = fileName.replace(/\.[^/.]+$/, ""); // Eliminar extensión del archivo
                let cobradorNameFromTitle = fileCedula; // Por defecto usa la cédula si no encuentra el nombre
                let isCollectorVerified = false; // Bandera para saber si el cobrador existe en BD

                const { data: cobradorData, error: cobradorError } = await supabase
                    .from('users')
                    .select('name')
                    .eq('cedula', fileCedula).limit(1).single();
                if (cobradorData) {
                    cobradorNameFromTitle = cobradorData.name;
                    isCollectorVerified = true;
                } else {
                    // Se eliminó la pregunta de crear cobrador
                }

                // Sincronizar Clientes con la colección 'clients'
                const uniqueCedulas = new Set();
                normalizedJson.forEach(row => {
                    const rawCedula = getColVal(row, ['CEDULA']);
                    const cedula = rawCedula ? String(rawCedula).trim() : null;
                    if (cedula) uniqueCedulas.add(cedula);
                });


                const dbClientInfo = new Map();
                const clientPromises = Array.from(uniqueCedulas).map(async cedula => {
                    const { data: existingClient, error } = await supabase
                        .from('clients')
                        .select('*')
                        .eq('cedula', cedula).limit(1).single();

                    // Buscar datos del Excel para este cliente
                    const row = normalizedJson.find(r => {
                        const rCedula = getColVal(r, ['CEDULA']);
                        return rCedula && String(rCedula).trim() === cedula;
                    });
                    
                    let rawAsesor = getColVal(row, ['ASESOR']);
                    let matchedAsesor = findExactMatchUser(rawAsesor) || rawAsesor || '';

                    const clientData = {
                        name: toTitleCase(getColVal(row, ['CLIENTE'])) || 'Desconocido',
                        cedula: cedula,
                        phone: Number(getColVal(row, ['TELEFONO'])) || 0,
                        address: getColVal(row, ['DIRECCION']) || '',
                        municipality: findDbMunicipality(getColVal(row, ['MUNICIPIO'])) || '',
                        asesorName: matchedAsesor,
                        totalRecaudo: Number(getColVal(row, ['RECAUDO TOTAL'])) || 0,
                        imported: true
                    };

                    if (!existingClient) {
                        // Crear nuevo cliente en 'clients'
                        clientData.paymentTerm = ['Diario']; // Default como array
                        let initialTerm = 'Diario';
                        const excelPaymentType = getColVal(row, ['TIPO DE PAGO']);
                        if (excelPaymentType) {
                            const typeUpper = String(excelPaymentType).toUpperCase().trim();
                            if (typeUpper === 'SEMANAL') initialTerm = 'Semanal';
                            else if (typeUpper === 'DIARIO') initialTerm = 'Diario';
                        }
                        clientData.paymentTerm = [initialTerm]; // Asigna la frecuencia detectada
                        clientData.created_at = new Date().toISOString();
                        await supabase.from('clients').insert(clientData);
                        dbClientInfo.set(cedula, clientData);
                    } else {
                        // Cliente existe, actualizamos datos
                        await supabase.from('clients').update({
                            name: clientData.name,
                            phone: clientData.phone,
                            address: clientData.address,
                            asesorName: clientData.asesorName,
                            totalRecaudo: clientData.totalRecaudo,
                            imported: true
                        })
                        .eq('id', existingClient.id);
                        dbClientInfo.set(cedula, { ...existingClient, ...clientData });
                    }
                });
                await Promise.all(clientPromises);

                let rowsImported = 0;

                // Optimización: Procesar en lotes para no bloquear pero ser más rápido que secuencial
                const chunkSize = 50;
                
                const processRow = async (row) => {
                    const rawCedula = getColVal(row, ['CEDULA']);
                    const cedula = rawCedula ? String(rawCedula).trim() : '';
                    
                    // Obtener datos del Excel
                    let name = toTitleCase(getColVal(row, ['CLIENTE']));
                    let phone = Number(getColVal(row, ['TELEFONO'])) || 0;
                    let address = getColVal(row, ['DIRECCION']);
                    let municipality = findDbMunicipality(getColVal(row, ['MUNICIPIO']));
                    let asesor = getColVal(row, ['ASESOR']);

                    // Buscar coincidencia de asesor
                    let matchedAsesor = findExactMatchUser(asesor);
                    if (matchedAsesor) asesor = matchedAsesor;

                    // Obtener frecuencia de pago del cliente para asignarla al crédito importado
                    let clientPaymentTerm = 'Diario';
                    if (cedula && dbClientInfo.has(cedula)) {
                        const cData = dbClientInfo.get(cedula);
                        if (cData.paymentTerm) clientPaymentTerm = Array.isArray(cData.paymentTerm) ? cData.paymentTerm[0] : cData.paymentTerm;
                    }

                    // Lógica para determinar frecuencia basada en TIPO DE PAGO del Excel
                    const excelPaymentType = getColVal(row, ['TIPO DE PAGO']);
                    if (excelPaymentType) {
                        const typeUpper = String(excelPaymentType).toUpperCase().trim();
                        if (typeUpper === 'SEMANAL') {
                            clientPaymentTerm = 'Semanal';
                        } else if (typeUpper === 'DIARIO') {
                            clientPaymentTerm = 'Diario';
                        }
                    }

                    // Completar con datos de la base de datos si existen y faltan en Excel
                    if (cedula && dbClientInfo.has(cedula)) {
                        const dbData = dbClientInfo.get(cedula);
                        if (!name) name = dbData.name;
                        if (!phone) phone = dbData.phone;
                        if (!address) address = dbData.address;
                        if (!municipality) municipality = dbData.municipality;
                        if (!asesor && !isCollectorVerified) asesor = dbData.asesorName;
                    }

                    // Valores por defecto
                    name = name || 'Desconocido';
                    municipality = municipality || '';
                    
                    // Si el cobrador del archivo está verificado, se le asignan todos los registros
                    if (isCollectorVerified) {
                        asesor = cobradorNameFromTitle;
                    } else {
                        asesor = asesor || cobradorNameFromTitle || 'Importado';
                    }

                    address = address || '';
                    
                    // Procesamiento robusto de fechas
                    const rawDate = getColVal(row, ['FECHA DE PRESTAMO']);
                    let dateObj = parseExcelDate(rawDate);
                    let formattedDate = '';
                    let dia = getColVal(row, ['DIA']) || '';

                    if (dateObj && !isNaN(dateObj.getTime())) {
                        // Validación extra para evitar fechas incorrectas como 1969
                        if (dateObj.getFullYear() < 2000) {
                            // Si la fecha es muy antigua, intentamos usar la fecha actual o dejarla vacía si es crítico
                            // O intentar parsear como string si rawDate era string
                            if (typeof rawDate === 'string') {
                                formattedDate = rawDate; // Usar el string original si existe
                            }
                        } else {
                            const d = String(dateObj.getDate()).padStart(2, '0');
                            const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                            const y = dateObj.getFullYear();
                            formattedDate = `${d}-${m}-${y}`;
                        }

                        if (formattedDate && (!dia || String(dia).trim() === '')) {
                            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                            dia = days[dateObj.getDay()];
                        }
                    } else if (typeof rawDate === 'string') {
                        // Fallback si no se pudo crear objeto fecha pero hay string
                        formattedDate = rawDate;
                    }

                    // Valores numéricos
                    const abono = Number(getColVal(row, ['ABONO'])) || 0;
                    const saldo = Number(getColVal(row, ['SALDO'])) || 0;
                    const cuota = Number(getColVal(row, ['CUOTA'])) || 0;
                    const valorCuota = Number(getColVal(row, ['VALOR CUOTA'])) || 0;
                    const factor = Number(getColVal(row, ['FACTOR CUOTA'])) || 0;
                    const creditoNuevo = Number(getColVal(row, ['CREDITO NUEVO'])) || 0;
                    const represte = Number(getColVal(row, ['REPRESTE'])) || 0;

                    let newDebtorId = null;

                    // 1. Procesar REPRESTE (Nuevo Crédito) - Primero para obtener ID
                    if (creditoNuevo > 0 || represte > 0) {
                        const creditValue = creditoNuevo > 0 ? creditoNuevo : represte;
                        const creditData = {
                            name: name,
                            cedula: cedula,
                            CreditType: creditoNuevo > 0 ? 'Nuevo' : 'Represte',
                            paymentTerm: clientPaymentTerm, // Guardar la frecuencia de pago
                            saleValue: creditValue,
                            totalCreditValue: creditValue,
                            balance: saldo, // Usar saldo como balance
                            municipality: municipality,
                            asesorName: asesor, // Se mantiene el asesor leído de la columna del Excel
                            saleDate: formattedDate,
                            numberOfPayments: cuota,
                            remainingPayments: cuota,
                            factor: factor,
                            loanDay: dia,
                            valorCuota: valorCuota,
                            phone: phone,
                            address: address,
                            created_at: new Date().toISOString(),
                            imported: true
                        };
                        const { data: newDoc, error } = await supabase.from('debtors').insert(creditData).select('id').single();
                        if (newDoc) newDebtorId = newDoc.id;
                    }

                    // 2. Procesar PAGO (Abono)
                    if (abono > 0) {
                        const paymentData = {
                            debtorName: name,
                            cedula: cedula,
                            paymentAmount: abono,
                            paymentMethod: 'Efectivo', // Default
                            remainingBalance: saldo,
                            Quota: cuota,
                            valorCuota: valorCuota,
                            municipality: municipality,
                            userName: asesor,
                            paymentDate: formattedDate,
                            phone: phone,
                            address: address,
                            created_at: new Date().toISOString(),
                            imported: true
                        };
                        if (newDebtorId) paymentData.debtorId = newDebtorId;
                        await supabase.from('payments').insert(paymentData);
                    }
                    return 1;
                };

                for (let i = 0; i < normalizedJson.length; i += chunkSize) {
                    const chunk = normalizedJson.slice(i, i + chunkSize);
                    const results = await Promise.all(chunk.map(processRow));
                    rowsImported += results.length;
                }

                alert(`Se han importado ${rowsImported} registros exitosamente.`);
                
                // Restaurar la vista anterior
                const lastSection = localStorage.getItem('lastSection');
                if (lastSection === 'users') navUsers.click();
                else if (lastSection === 'clients') navClients.click();
                else if (lastSection === 'appData') navAppData.click();
                else navAppData.click(); // Default

            } catch (error) {
                console.error("Error al importar:", error);
                alert('Error al importar el archivo: ' + error.message);
                importLoadingModal.style.display = 'none';
                paymentsTable.style.display = 'table';
            } finally {
                e.target.value = '';
                importLoadingModal.style.display = 'none';
            }
        });

        // Recargar los pagos cuando se cambia el filtro de cobrador o municipio
        cobradorFilter.addEventListener('change', async () => {
            const selectedCobradorName = cobradorFilter.value; // Ahora es un input
            const municipioInput = document.getElementById('municipio-filter-pagos');
            // Limpiar y preparar el filtro de municipios

            if (selectedCobradorName !== 'all') {
                // Buscar los municipios del cobrador seleccionado
                const { data: cobradorData, error } = await supabase
                    .from('users')
                    .select('assigned_municipality')
                    .eq('name', selectedCobradorName)
                    .single();
                if (cobradorData) {
                    const assignedMunicipalities = cobradorData.assigned_municipality || [];
                    setupSearchableInput('municipio-filter-pagos', 'list-municipio-filter-pagos', assignedMunicipalities, true);
                    municipioInput.value = '';
                    municipioInput.placeholder = 'Seleccionar Municipio...';
                }
            }
            // No recargar automáticamente, esperar al botón aplicar
        });

        // Abrir el modal para añadir usuario
        addUserBtn.addEventListener('click', () => {
            addUserModal.style.display = 'flex';
            populateDepartments('new-user-department', null); // null porque el municipio se maneja en modal aparte
            // Limpiar municipios al abrir
            isEditingUserMode = false;
            municipalitiesListContainer.innerHTML = '';
            municipalitySelectedText.textContent = 'Seleccione un departamento primero';

            const roleSelect = document.getElementById('new-user-role');
            if (isMasterAdmin) {
                roleSelect.style.display = 'block';
                roleSelect.value = 'Usuario';
            } else {
                roleSelect.style.display = 'none';
                roleSelect.value = 'Usuario';
            }
        });

        // Función para cerrar y resetear el modal
        function closeAndResetModal() {
            addUserModal.style.display = 'none';
            addUserForm.reset();
            addUserError.style.display = 'none';
            window.dispatchEvent(new CustomEvent('modal-closed')); // Notificar cierre
        }

        // Cerrar el modal
        closeModalBtn.addEventListener('click', () => {
            closeAndResetModal();
        });


        // --- LÓGICA DEL MODAL DE AÑADIR USUARIO ---

        // --- CACHE SYSTEM ---
        let globalDepartmentsCache = null;
        let globalUsersCache = null;

        async function ensureDepartmentsCache() {
            if (globalDepartmentsCache) return globalDepartmentsCache;
            try {
                const { data: snapshot, error } = await supabase.from('municipalities').select('department, name');
                if (error) throw error;
                globalDepartmentsCache = {};
                snapshot.forEach(row => {
                    if (!globalDepartmentsCache[row.department]) globalDepartmentsCache[row.department] = [];
                    globalDepartmentsCache[row.department].push(row.name);
                });
                return globalDepartmentsCache;
            } catch (error) {
                console.error("Error caching departments:", error);
                return {};
            }
        }

        async function ensureUsersCache() {
            if (globalUsersCache) return globalUsersCache;
            try {
                const { data, error } = await supabase.from('users').select('*');
                if (error) throw error;
                globalUsersCache = data;
                return globalUsersCache;
            } catch (error) {
                console.error("Error caching users:", error);
                return [];
            }
        }

        async function populateDepartments(inputId, municipalityInputId = null) {
            const input = document.getElementById(inputId);
            const listId = 'list-' + inputId;
            
            input.value = '';
            input.placeholder = 'Cargando...';
            input.disabled = true;
            
            // Si hay input de municipio asociado, resetearlo
            if (municipalityInputId) {
                 const muniInput = document.getElementById(municipalityInputId);
                 if(muniInput) {
                     muniInput.value = '';
                     muniInput.placeholder = 'Seleccione un departamento';
                     muniInput.disabled = true;
                     // Limpiar lista de municipios si existe
                     const muniList = document.getElementById('list-' + municipalityInputId);
                     if(muniList) muniList.innerHTML = '';
                 }
            }

            try {
                const departmentsCache = await ensureDepartmentsCache();
                const departments = Object.keys(departmentsCache).sort();
                
                setupSearchableInput(inputId, listId, departments);

                if (departments.length === 1 && departments[0]) {
                    input.value = departments[0];
                    input.disabled = true;
                    // Disparar evento change manualmente
                    input.dispatchEvent(new Event('change'));
                } else {
                    input.placeholder = 'Seleccionar Departamento...';
                    input.disabled = false;
                }
            } catch (error) {
                console.error("Error loading departments:", error);
                input.placeholder = 'Error al cargar';
            }
        }

        // Cargar municipios cuando se selecciona un departamento
        async function loadMunicipalitiesByDepartment(department) {
            try {
                const cache = await ensureDepartmentsCache();
                return (cache[department] || []).sort();
            } catch (error) {
                console.error("Error cargando municipios:", error);
                return [];
            }
        }

        // Cargar municipios en un input searchable (para clientes y filtros)
        async function loadMunicipalitiesForSelect(departmentId, element, isInput = true, includeAllOption = false) {
            if (!isInput) {
                // Comportamiento antiguo para selects normales
                // El filtro de pagos usa select normal 'municipio-filter-pagos'
                element.innerHTML = '<option value="" disabled selected>Cargando...</option>';
            } else {
                element.value = '';
                element.placeholder = 'Cargando...';
                element.disabled = true;
            }

            try {
                const departmentsCache = await ensureDepartmentsCache();
                let munis = departmentsCache[departmentId] || [];
                munis = [...munis].sort();

                if (includeAllOption) {
                    munis.unshift("Todos los Municipios");
                }

                if (!isInput) {
                    element.innerHTML = '<option value="" disabled selected>Seleccionar Municipio...</option>';
                    munis.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = m;
                        element.appendChild(opt);
                    });
                } else {
                    // Configurar input searchable
                    const listId = 'list-' + element.id;
                    setupSearchableInput(element.id, listId, munis);
                    element.placeholder = 'Seleccionar Municipio...';
                    element.disabled = false;
                    if (includeAllOption) {
                        element.value = 'Todos los Municipios';
                    }
                }
            } catch (error) {
                console.error("Error loading municipalities for select:", error);
                if(isInput) {
                    element.placeholder = 'Error al cargar';
                    element.disabled = false;
                }
            }
        }

        // Función genérica para configurar inputs con búsqueda
        function setupSearchableInput(inputId, listId, options) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            
            // Limpiar lista
            list.innerHTML = '';
            
            // Llenar opciones
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'dropdown-option';
                div.textContent = opt;
                div.addEventListener('click', () => {
                    input.value = opt;
                    list.classList.remove('show');
                    // Disparar evento change manual
                    input.dispatchEvent(new Event('change'));
                });
                list.appendChild(div);
            });

            // Evento focus para mostrar lista
            input.addEventListener('focus', () => {
                list.classList.add('show');
                // Resetear filtro visual
                Array.from(list.children).forEach(child => child.style.display = 'block');
            });

            // Evento click para asegurar que se abra la lista al hacer clic (incluso si ya tiene foco)
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                list.classList.add('show');
                Array.from(list.children).forEach(child => child.style.display = 'block');
            });

            // Evento input para filtrar
            input.addEventListener('input', () => {
                const term = normalizeText(input.value);
                Array.from(list.children).forEach(child => {
                    const text = normalizeText(child.textContent);
                    // Búsqueda insensible a mayúsculas/acentos
                    if (text.includes(term)) { 
                        child.style.display = 'block';
                    } else {
                        child.style.display = 'none';
                    }
                });
                list.classList.add('show');
            });

            // Cerrar al hacer clic fuera (Manejado en window.click globalmente, pero necesitamos referencia)
            // Se añade lógica específica en window.click
        }

        // Listener para cambio de departamento en Añadir Usuario
        document.getElementById('new-user-department').addEventListener('change', async (e) => {
            const dept = e.target.value;
            const munis = await loadMunicipalitiesByDepartment(dept);
            renderMunicipalityDropdown(municipalitiesListContainer, munis, handleMunicipalitySelection, true);
            municipalitySelectedText.textContent = 'Seleccionar municipios...';
        });

        // Listener para cambio de departamento en Editar Usuario
        document.getElementById('edit-user-department').addEventListener('change', async (e) => {
            // Se mantiene la selección actual al cambiar de departamento para que aparezcan marcados en el modal
        });

        function renderMunicipalityDropdown(container, list, changeHandler, checkboxOnRight = false) {
            container.innerHTML = '';
            list.forEach(municipality => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = municipality;
                
                // Evento para cambiar estilo al seleccionar
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        label.classList.add('selected');
                    } else {
                        label.classList.remove('selected');
                    }
                    changeHandler();
                });

                label.appendChild(checkbox); 
                label.appendChild(document.createTextNode(municipality));
                container.appendChild(label);
            });
        }

        // Búsqueda en checkboxes de Añadir Usuario
        document.getElementById('search-municipality-checkboxes').addEventListener('input', (e) => {
            const term = normalizeText(e.target.value);
            const labels = municipalitiesListContainer.querySelectorAll('label');
            labels.forEach(label => {
                const text = normalizeText(label.textContent);
                label.style.display = text.includes(term) ? 'flex' : 'none';
            });
        });

        // Abrir modal de selección de municipios
        btnOpenMunicipalitySelection.addEventListener('click', () => {
            if (document.getElementById('new-user-department').value) {
                selectMunicipalitiesModal.style.display = 'flex';
            } else {
                alert("Por favor seleccione un departamento primero.");
            }
        });

        // Abrir modal de selección de municipios en Editar Usuario
        btnOpenEditMunicipalitySelection.addEventListener('click', async () => {
            const dept = document.getElementById('edit-user-department').value;
            if (dept) {
                isEditingUserMode = true;
                const munis = await loadMunicipalitiesByDepartment(dept);
                renderMunicipalityDropdown(municipalitiesListContainer, munis, handleMunicipalitySelection, true);
                // Marcar los que ya tiene asignados
                markSelectedMunicipalities(currentEditAssignedMunicipalities);
                selectMunicipalitiesModal.style.display = 'flex';
            } else {
                alert("Por favor seleccione un departamento primero.");
            }
        });

        // Lógica de selección de municipality (máximo 5)
        function handleMunicipalitySelection() {
            // Esta función se llama al cambiar un checkbox, pero la actualización del texto principal se hace al confirmar
            const checkedBoxes = municipalitiesListContainer.querySelectorAll('input[type="checkbox"]:checked');
            
            if (checkedBoxes.length === 0) {
                municipalitySelectedText.textContent = 'Seleccionar municipios...';
            } else if (checkedBoxes.length === 1) {
                municipalitySelectedText.textContent = '1 municipio seleccionado';
            } else {
                municipalitySelectedText.textContent = `${checkedBoxes.length} municipios seleccionados`;
            }
        }

        function markSelectedMunicipalities(assignedList) {
            const checkboxes = municipalitiesListContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                if (assignedList.includes(cb.value)) {
                    cb.checked = true;
                    cb.parentElement.classList.add('selected');
                }
            });
        }
        
        btnConfirmMunicipalities.addEventListener('click', () => {
            const checkedBoxes = municipalitiesListContainer.querySelectorAll('input[type="checkbox"]:checked');
            const selectedCount = checkedBoxes.length;
            
            if (isEditingUserMode) {
                currentEditAssignedMunicipalities = Array.from(checkedBoxes).map(cb => cb.value);
                updateEditMunicipalityText(selectedCount);
            } else {
                // Para nuevo usuario, el texto se actualiza aquí
                handleMunicipalitySelection();
            }
            
            selectMunicipalitiesModal.style.display = 'none';
        });
        
        closeSelectMunicipalitiesModal.addEventListener('click', () => {
            selectMunicipalitiesModal.style.display = 'none';
        });

        // Manejar clics en la ventana para cerrar modales o dropdowns
        window.addEventListener('click', (event) => {
            
            // Cerrar dropdowns customizados al hacer clic fuera
            const dropdowns = document.querySelectorAll('.searchable-dropdown');
            dropdowns.forEach(dd => {
                if (!dd.contains(event.target)) {
                    const list = dd.querySelector('.dropdown-options');
                    if (list) list.classList.remove('show');
                }
            });

            if (event.target === filterAdvisorModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === filterMunicipalityModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === filterOptionsModal) {
                // filterOptionsModal.style.display = 'none';
            }
            if (event.target === downloadFormatModal) {
                return; // No cerrar al dar fuera
            }
            if (event.target === reportTypeSelectionModal) {
                return; // No cerrar al dar fuera
            }
            if (event.target === selectMunicipalitiesModal) {
                // selectMunicipalitiesModal.style.display = 'none'; // NO cerrar al dar fuera
            }
        });

        // Manejar la creación de un nuevo usuario
        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-user-name').value;
            const cedula = document.getElementById('new-user-cedula').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-password').value;
            const roleSelect = document.getElementById('new-user-role');
            const role = roleSelect.value;
            const is_admin = (role === 'Administrador' || role === 'Administrador maestro');
            addUserError.style.display = 'none';

            let assigned_municipality = [];
            const checkedBoxes = municipalitiesListContainer.querySelectorAll('input[type="checkbox"]:checked');
            checkedBoxes.forEach(cb => assigned_municipality.push(cb.value));

            try {
                const userData = {
                    name: name,
                    cedula: cedula,
                    role: role,
                    is_admin: is_admin,
                    assigned_municipality: assigned_municipality,
                };

                // Llamar a la Edge Function para crear el usuario de forma segura
                const { data, error } = await supabase.functions.invoke('create-user', {
                    body: {
                        email: email,
                        password: password,
                        userData: userData
                    }
                });

                if (error) throw error;
                if (data.error) throw new Error(data.error);

                closeAndResetModal();
                showToast("Usuario registrado exitosamente");
                loadUsers(); // Recargar la lista de usuarios

            } catch (error) {
                console.error("Error al crear usuario:", error);
                addUserError.textContent = getSupabaseErrorMessage(error);
                addUserError.style.display = 'block';
            }
        });

        // --- LÓGICA DEL MODAL DE EDITAR USUARIO ---

        // Cerrar modal de edición
        closeEditModalBtn.addEventListener('click', () => {
            editUserModal.style.display = 'none';
        });

        // --- LÓGICA SELECCIÓN TIPO REPORTE ---
        closeReportTypeSelectionModal.addEventListener('click', () => {
            reportTypeSelectionModal.style.display = 'none';
        });

        btnSelectDailyReport.addEventListener('click', async () => {
            reportTypeSelectionModal.style.display = 'none';
            await loadDailyReports(selectedUserUidForReports, selectedUserNameForReports);
        });

        btnSelectWeeklyReport.addEventListener('click', async () => {
            reportTypeSelectionModal.style.display = 'none';
            await loadWeeklyReports(selectedUserUidForReports, selectedUserNameForReports);
        });

        closeViewUserWeeklyModalBtn.addEventListener('click', () => {
            viewUserWeeklyModal.style.display = 'none';
        });

        // Cerrar modal de ver usuario
        closeViewUserModalBtn.addEventListener('click', () => {
            viewUserModal.style.display = 'none';
        });

        // Botones de actualizar manual en modales de reportes
        document.getElementById('refresh-user-reports-btn').addEventListener('click', () => {
            if (selectedUserUidForReports && selectedUserNameForReports) {
                loadDailyReports(selectedUserUidForReports, selectedUserNameForReports);
            }
        });

        document.getElementById('refresh-user-weekly-reports-btn').addEventListener('click', () => {
            if (selectedUserUidForReports && selectedUserNameForReports) {
                loadWeeklyReports(selectedUserUidForReports, selectedUserNameForReports);
            }
        });

        async function refreshActiveReportView() {
            await new Promise(resolve => setTimeout(resolve, 200));
            if (document.getElementById('view-user-modal').style.display === 'flex') {
                document.getElementById('refresh-user-reports-btn').click();
            }
            if (document.getElementById('view-user-weekly-modal').style.display === 'flex') {
                document.getElementById('refresh-user-weekly-reports-btn').click();
            }
            if (document.getElementById('general-report-container').style.display === 'block') {
                generateGnReport();
            }
        }

        function updateEditMunicipalityText(count) {
            if (count === 0) editMunicipalitySelectedText.textContent = 'Seleccionar municipios...';
            else if (count === 1) editMunicipalitySelectedText.textContent = '1 municipio seleccionado';
            else editMunicipalitySelectedText.textContent = `${count} municipios seleccionados`;
        }

        // Abrir modal de edición (Delegación de eventos en la tabla)
        usersTable.addEventListener('click', async (e) => {
            const btn = e.target.closest('.edit-user-btn');
            if (btn) {
                const uid = btn.dataset.uid;
                try {
                    const { data, error } = await supabase.from('users').select('*').eq('id', uid).single();
                    if (error || !data) return alert("Usuario no encontrado");
                    
                    document.getElementById('edit-user-uid').value = uid;
                    document.getElementById('edit-user-name').value = data.name;
                    
                    // Cargar departamentos en el select de edición
                    await populateDepartments('edit-user-department', null);
                    // Nota: No sabemos el departamento del usuario si no se guardó. 
                    
                    const editCedulaInput = document.getElementById('edit-user-cedula');
                    editCedulaInput.value = data.cedula || '';

                    // Permitir editar la cédula siempre
                    editCedulaInput.readOnly = false;
                    editCedulaInput.style.backgroundColor = 'white';
                    editCedulaInput.style.cursor = 'text';

                    document.getElementById('edit-user-email').value = data.email;

                    const roleSelect = document.getElementById('edit-user-role');
                    const roleLabel = document.getElementById('lbl-edit-user-role');
                    
                    if (isMasterAdmin) {
                        roleSelect.style.display = 'block';
                        if(roleLabel) roleLabel.style.display = 'block';
                        roleSelect.value = data.role || 'Usuario';
                    } else {
                        roleSelect.style.display = 'none';
                        if(roleLabel) roleLabel.style.display = 'none';
                    }

                    // Resetear checkboxes
                    // Si el usuario ya tiene municipios asignados, se mostrarán cuando seleccione el departamento correcto
                    // O podríamos intentar cargar todos los municipios de todos los departamentos (muy costoso)
                    // Por ahora, solo mostramos el texto de cuántos tiene asignados
                    if (data.assigned_municipality) {
                        currentEditAssignedMunicipalities = data.assigned_municipality;
                        updateEditMunicipalityText(data.assigned_municipality.length);
                    } else {
                        currentEditAssignedMunicipalities = [];
                        updateEditMunicipalityText(0);
                    }
                    editUserModal.style.display = 'flex';
                } catch (error) {
                    console.error("Error cargando usuario:", error);
                }
            }

            // Lógica para Cambiar Contraseña
            const changePassBtn = e.target.closest('.change-password-btn');
            if (changePassBtn) {
                const uid = changePassBtn.dataset.uid;
                const name = changePassBtn.dataset.name;
                
                document.getElementById('change-password-uid').value = uid;
                document.getElementById('change-password-username').textContent = name;
                document.getElementById('change-password-modal').style.display = 'flex';
            }

            // Lógica para Eliminar Usuario
            const deleteBtn = e.target.closest('.delete-user-btn');
            if (deleteBtn) {
                const uid = deleteBtn.dataset.uid;
                const name = deleteBtn.dataset.name;
                const isAdmin = deleteBtn.dataset.isAdmin === 'true';

                userToDelete = { uid: uid, name: name };

                if (isAdmin) {
                    if (confirm(`¿Desea eliminar al administrador ${name}? Esta acción es irreversible.`)) {
                        try {
                            const { error } = await supabase.functions.invoke('delete-user-and-data', { body: { uid, userName: name, option: 'all' } });
                            if (error) throw error;
                            showToast(`Administrador ${name} eliminado.`);
                        } catch (error) {
                            alert("Error: " + error.message);
                        }
                    }
                } else {
                    document.getElementById('delete-user-name-display').textContent = name;
                    document.getElementById('delete-user-options-modal').style.display = 'flex';
                }
            }
        });

        async function loadDailyReports(uid, userName) {
            viewUserTitle.textContent = `Reportes diarios de: ${userName}`;
            viewUserReportsBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Cargando...</td></tr>';
            viewUserModal.style.display = 'flex';

            try {
                const { data: reports, error } = await supabase
                    .from('reports')
                    .select('*')
                    .eq('user_name', userName);

                if (error) throw error;

                if (!reports || reports.length === 0) {
                    viewUserReportsBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No hay reportes para este usuario.</td></tr>';
                } else {
                    let html = '';
                    
                    // Ordenar por fecha descendente (asumiendo formato dd-MM-yyyy)
                    reports.sort((a, b) => {
                        const dateA = a.report_date ? new Date(a.report_date.split('-').reverse().join('-')) : new Date(0);
                        const dateB = b.report_date ? new Date(b.report_date.split('-').reverse().join('-')) : new Date(0);
                        return dateB - dateA;
                    });

                    reports.forEach(data => { // data es ahora un objeto de fila
                        const dateParts = data.report_date ? data.report_date.split('-') : [];
                        let dayName = 'N/A';
                        if (dateParts.length === 3) {
                            const dateObj = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
                            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                            dayName = days[dateObj.getDay()];
                        }

                        html += `<tr>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(data.credits_report || 0).toLocaleString('es-CO')}
                                <button class="btn view-report-credits-btn" data-date="${data.report_date}" data-user="${userName}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Créditos"><i class="fas fa-eye"></i></button>
                                <button class="btn download-report-credits-btn" data-date="${data.report_date}" data-user="${userName}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #2ecc71; display: inline-flex; justify-content: center; align-items: center;" title="Descargar Créditos"><i class="fas fa-download"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(data.payments_report || 0).toLocaleString('es-CO')}
                                <button class="btn view-report-payments-btn" data-date="${data.report_date}" data-user="${userName}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Cobros"><i class="fas fa-eye"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; white-space: nowrap;">$${(data.expense_report || 0).toLocaleString('es-CO')}
                                <button class="btn edit-expense-btn" data-date="${data.report_date}" data-user="${userName}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn view-expense-details-btn" data-date="${data.report_date}" data-user="${userName}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver detalles"><i class="fas fa-eye"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;" id="cell-initialBase-${data.id}">$${(data.initial_base || 0).toLocaleString('es-CO')}
                                <button class="btn edit-base-btn" data-id="${data.id}" data-field="initial_base" data-val="${data.initial_base || 0}" data-collection="reports" style="width: 20px; height: 20px; padding: 0; font-size: 10px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-edit"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;" id="cell-finalBase-${data.id}">$${(data.final_base || 0).toLocaleString('es-CO')}
                                <button class="btn edit-base-btn" data-id="${data.id}" data-field="final_base" data-val="${data.final_base || 0}" data-collection="reports" style="width: 20px; height: 20px; padding: 0; font-size: 10px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-edit"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${dayName}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${data.report_date || 'N/A'}</td>
                        </tr>`;
                    });
                    viewUserReportsBody.innerHTML = html;
                }
            } catch (error) {
                console.error("Error cargando reportes:", error);
                viewUserReportsBody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Error al cargar datos.</td></tr>';
            }
        }

        async function loadWeeklyReports(uid, userName) {
            viewUserWeeklyTitle.textContent = `Reportes semanales de: ${userName}`;
            viewUserWeeklyReportsBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Cargando...</td></tr>';
            viewUserWeeklyModal.style.display = 'flex';

            try {
                const { data: reports, error } = await supabase
                    .from('wreports')
                    .select('*')
                    .eq('user_name', userName);

                if (error) throw error;

                if (!reports || reports.length === 0) {
                    viewUserWeeklyReportsBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No hay reportes semanales para este usuario.</td></tr>';
                } else {
                    let html = '';
                    
                    // Ordenar por fecha de creación descendente
                    reports.sort((a, b) => {
                        const dateA = a.created_at ? new Date(a.created_at) : new Date(0);
                        const dateB = b.created_at ? new Date(b.created_at) : new Date(0);
                        return dateB - dateA;
                    });

                    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

                    reports.forEach(data => {
                        const createdAt = data.created_at ? new Date(data.created_at) : null;
                        let day = 'N/A';
                        let month = 'N/A';
                        let year = 'N/A';

                        if (createdAt) {
                            day = createdAt.getDate();
                            month = months[createdAt.getMonth()];
                            year = createdAt.getFullYear();
                        }
                        
                        // Construir dateStr para los botones
                        const dStr = String(day).padStart(2, '0');
                        const mStr = String(createdAt.getMonth() + 1).padStart(2, '0');
                        const yStr = year;
                        const dateStr = `${dStr}-${mStr}-${yStr}`;

                        html += `<tr>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(data.credits_report || 0).toLocaleString('es-CO')}
                                <button class="btn view-report-credits-btn" data-date="${dateStr}" data-user="${data.user_name}" data-collection="wreports" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Créditos"><i class="fas fa-eye"></i></button>
                                <button class="btn download-report-credits-btn" data-date="${dateStr}" data-user="${data.user_name}" data-collection="wreports" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #2ecc71; display: inline-flex; justify-content: center; align-items: center;" title="Descargar Créditos"><i class="fas fa-download"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(data.payments_report || 0).toLocaleString('es-CO')}
                                <button class="btn view-report-payments-btn" data-date="${dateStr}" data-user="${data.user_name}" data-collection="wreports" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Cobros"><i class="fas fa-eye"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(data.expense_report || 0).toLocaleString('es-CO')}
                                <button class="btn edit-weekly-expense-btn" data-created-at="${createdAt ? createdAt.getTime() : 0}" data-user="${data.user_name}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="btn view-weekly-expense-details-btn" data-created-at="${createdAt ? createdAt.getTime() : 0}" data-user="${data.user_name}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver detalles"><i class="fas fa-eye"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;" id="cell-initialBase-${data.id}">$${(data.initial_base || 0).toLocaleString('es-CO')}
                                <button class="btn edit-base-btn" data-id="${data.id}" data-field="initial_base" data-val="${data.initial_base || 0}" data-collection="wreports" style="width: 20px; height: 20px; padding: 0; font-size: 10px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-edit"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;" id="cell-finalBase-${data.id}">$${(data.final_base || 0).toLocaleString('es-CO')}
                                <button class="btn edit-base-btn" data-id="${data.id}" data-field="final_base" data-val="${data.final_base || 0}" data-collection="wreports" style="width: 20px; height: 20px; padding: 0; font-size: 10px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-edit"></i></button>
                            </td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${day}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${month}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${year}</td>
                        </tr>`;
                    });
                    viewUserWeeklyReportsBody.innerHTML = html;
                }
            } catch (error) {
                console.error("Error cargando reportes semanales:", error);
                viewUserWeeklyReportsBody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error al cargar datos.</td></tr>';
            }
        }

        // Listener para editar bases (Delegación global para ambos modales)
        document.addEventListener('click', async (e) => {
            const editBaseBtn = e.target.closest('.edit-base-btn');
            if (editBaseBtn) {
                const id = editBaseBtn.dataset.id;
                const field = editBaseBtn.dataset.field;
                const val = editBaseBtn.dataset.val;
                const collection = editBaseBtn.dataset.collection;
                const cell = document.getElementById(`cell-${field}-${id}`);
                
                cell.innerHTML = `
                    <input type="number" id="input-${field}-${id}" value="${val}" style="width: 80px;">
                    <button class="btn save-base-btn" data-id="${id}" data-field="${field}" data-collection="${collection}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; background-color: #2ecc71; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-save"></i></button>
                `;
            }

            const saveBaseBtn = e.target.closest('.save-base-btn');
            if (saveBaseBtn) {
                const id = saveBaseBtn.dataset.id;
                const field = saveBaseBtn.dataset.field;
                const collection = saveBaseBtn.dataset.collection;
                const newVal = Number(document.getElementById(`input-${field}-${id}`).value);
                
                saveBaseBtn.innerHTML = '<div class="small-spinner"></div>';
                saveBaseBtn.disabled = true;

                try {
                    const { data: docSnap, error: fetchError } = await supabase.from(collection).select('*').eq('id', id).single();
                    if (fetchError) throw fetchError;
                    
                    if (docSnap) {
                        const data = docSnap;
                        
                        if (field === 'initial_base') {
                            const payments = Number(data.payments_report) || 0;
                            const credits = Number(data.credits_report) || 0;
                            const expenses = data.expense_report !== undefined ? Number(data.expense_report) : (Number(data.expenses_report) || 0);
                            const final_base = (newVal + payments) - (credits + expenses);
                            
                            const updatePayload = { initial_base: newVal };
                            if (data.og_final_base !== undefined && data.og_final_base !== null) {
                                updatePayload.og_final_base = final_base;
                            } else {
                                updatePayload.final_base = final_base;
                            }
                            await supabase.from(collection).update(updatePayload).eq('id', id);
                        } else if (field === 'final_base') {
                            const updatePayload = {};
                            if (data.og_final_base !== undefined && data.og_final_base !== null) {
                                updatePayload.og_final_base = newVal;
                            } else {
                                updatePayload.final_base = newVal;
                            }
                            await supabase.from(collection).update(updatePayload).eq('id', id);
                        } else {
                            await supabase.from(collection).update({ [field]: newVal }).eq('id', id);
                        }
                    }
                    showToast("Base actualizada");
                    refreshActiveReportView();
                } catch (error) {
                    console.error("Error actualizando base:", error);
                    alert("Error: " + error.message);
                }
            }
        });

        // Listener para ver detalles de gastos semanales
        viewUserWeeklyReportsBody.addEventListener('click', async (e) => {
            const btn = e.target.closest('.view-weekly-expense-details-btn');
            if (btn) {
                const createdAtMillis = Number(btn.dataset.createdAt);
                const userName = btn.dataset.user;
                
                if (!createdAtMillis) return;

                try {
                    const reportDate = new Date(createdAtMillis);
                    const startDate = new Date(reportDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(reportDate);
                    endDate.setHours(23, 59, 59, 999); // Corregido para usar toISOString

                    const { data: expensesSnapshot, error } = await supabase
                        .from('wexpenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1)
                        .single();

                    if (!expensesSnapshot) {
                        alert("No se encontraron detalles de gastos semanales.");
                        return;
                    }

                    const data = expensesSnapshot;
                    const othersVal = (data.others && data.others.length > 0) ? data.others[0] : 0;
                    const othersDesc = (data.others && data.others.length > 1) ? data.others[1] : '';

                    const content = document.getElementById('expenses-details-content');
                    content.innerHTML = `
                        <p><strong>Gasolina:</strong> $${(data.fuel || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Almuerzo:</strong> $${(data.lunch || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Otros:</strong> $${Number(othersVal).toLocaleString('es-CO')} <br> <span style="font-size: 0.9em; color: #666;">(Este gasto es de: ${othersDesc || 'Sin descripción'})</span></p>
                    `;
                    viewExpensesDetailsModal.style.display = 'flex';

                } catch (error) {
                    console.error("Error al ver detalles semanales:", error);
                    alert("Error: " + error.message);
                }
            }
        });
        
        // Listener para editar gastos semanales y descargar créditos semanales
        viewUserWeeklyReportsBody.addEventListener('click', async (e) => {
            // Editar Gastos Semanales
            const btnEdit = e.target.closest('.edit-weekly-expense-btn');
            if (btnEdit) {
                const createdAtMillis = Number(btnEdit.dataset.createdAt);
                const userName = btnEdit.dataset.user;
                
                if (!createdAtMillis) return;

                try {
                    const reportDate = new Date(createdAtMillis);
                    const startDate = new Date(reportDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(reportDate);
                    endDate.setHours(23, 59, 59, 999); // Corregido para usar toISOString

                    const { data: doc, error } = await supabase
                        .from('wexpenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1)
                        .single();

                    if (!doc) {
                        alert("No se encontró el registro de gastos para esta semana.");
                        return;
                    }

                    const data = doc;

                    document.getElementById('edit-expenses-id').value = doc.id;
                    document.getElementById('edit-expenses-user').value = userName;
                    document.getElementById('edit-expenses-collection').value = 'wexpenses';
                    document.getElementById('edit-expenses-timestamp').value = createdAtMillis;
                    
                    editExpensesFuel.value = formatCurrency(data.fuel || 0);
                    editExpensesLunch.value = formatCurrency(data.lunch || 0);
                    editExpensesOthers.value = formatCurrency((data.others && data.others.length > 0) ? data.others[0] : 0);
                    editExpensesOthersDesc.value = (data.others && data.others.length > 1) ? data.others[1] : '';
                    calculateExpensesTotal();

                    editExpensesModal.style.display = 'flex';
                } catch (error) {
                    console.error("Error al cargar gastos semanales:", error);
                    alert("Error: " + error.message);
                }
                return;
            }

            // Descargar Créditos Semanales
            const btnDownload = e.target.closest('.download-report-credits-btn');
            if (btnDownload) {
                currentDownloadUser = btnDownload.dataset.user;
                currentDownloadDate = btnDownload.dataset.date;
                currentDownloadContext = 'credits';
                currentDownloadCollection = 'wreports';
                downloadFormatModal.style.display = 'flex';
                return;
            }
        });

        // Listener para ver detalles de créditos y cobros en reportes semanales
        viewUserWeeklyReportsBody.addEventListener('click', async (e) => {
            // Ver Detalle Cobros
            const btnPayments = e.target.closest('.view-report-payments-btn');
            if (btnPayments) {
                const dateStr = btnPayments.dataset.date;
                const userName = btnPayments.dataset.user;
                loadReportPaymentsDetails(userName, dateStr, 'Semanal', 'wreports');
                return;
            }
            // Ver Detalle Créditos
            const btnCredits = e.target.closest('.view-report-credits-btn');
            if (btnCredits) {
                const dateStr = btnCredits.dataset.date;
                const userName = btnCredits.dataset.user;
                loadReportCreditsDetails(userName, dateStr, 'Semanal', 'wreports');
                return;
            }
        });

        // --- LÓGICA DEL MODAL DE CAMBIAR CONTRASEÑA ---
        const changePasswordModal = document.getElementById('change-password-modal');
        const closeChangePasswordModalBtn = document.getElementById('close-change-password-modal-btn');
        const changePasswordForm = document.getElementById('change-password-form');
        const changePasswordError = document.getElementById('change-password-error');

        closeChangePasswordModalBtn.addEventListener('click', () => {
            changePasswordModal.style.display = 'none';
            changePasswordForm.reset();
            changePasswordError.style.display = 'none';
        });

        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('change-password-uid').value;
            const newPassword = document.getElementById('new-password-input').value;
            const submitBtn = changePasswordForm.querySelector('button[type="submit"]');
            
            if (newPassword.length < 6) {
                changePasswordError.textContent = "La contraseña debe tener al menos 6 caracteres.";
                changePasswordError.style.display = 'block';
                return;
            }

            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="small-spinner" style="border-top-color: white;"></div> Procesando...';
            submitBtn.disabled = true;
            changePasswordError.style.display = 'none';

            try {
                const { data, error } = await supabase.functions.invoke('change-password', {
                    body: { uid: uid, newPassword: newPassword }
                });
                if (error) throw error;
                if (data.error) throw new Error(data.error);
                
                showToast("Contraseña actualizada correctamente");
                changePasswordModal.style.display = 'none';
                changePasswordForm.reset();
            } catch (error) {
                changePasswordError.textContent = "Error: " + (error.message || "No se pudo actualizar.");
                changePasswordError.style.display = 'block';
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- LÓGICA PARA VER DETALLES DE COBROS Y CRÉDITOS EN REPORTES ---

        // Delegación de eventos para botones en la tabla de reportes
        viewUserReportsBody.addEventListener('click', async (e) => {
            // Ver Detalle Cobros
            const btnPayments = e.target.closest('.view-report-payments-btn');
            if (btnPayments) {
                const dateStr = btnPayments.dataset.date;
                const userName = btnPayments.dataset.user;
                const collection = btnPayments.dataset.collection || 'reports';
                loadReportPaymentsDetails(userName, dateStr, 'Diario', collection);
                return;
            }

            // Ver Detalle Créditos
            const btnCredits = e.target.closest('.view-report-credits-btn');
            if (btnCredits) {
                const dateStr = btnCredits.dataset.date;
                const userName = btnCredits.dataset.user;
                const collection = btnCredits.dataset.collection || 'reports';
                loadReportCreditsDetails(userName, dateStr, 'Diario', collection);
                return;
            }

            // Descargar Créditos
            const btnDownload = e.target.closest('.download-report-credits-btn');
            if (btnDownload) {
                currentDownloadUser = btnDownload.dataset.user;
                currentDownloadDate = btnDownload.dataset.date;
                currentDownloadContext = 'credits';
                currentDownloadCollection = 'reports';
                downloadFormatModal.style.display = 'flex';
                return;
            }
        });

        // Función auxiliar para obtener datos de cobros (usada para ver y descargar)
        async function getPaymentDetailsData(userName, dateStr, paymentTermFilter = null, collectionName = 'reports') {
            try {
                let startDate, endDate;
                const [day, month, year] = dateStr.split('-').map(Number);
                const reportDate = new Date(year, month - 1, day);

                if (collectionName === 'wreports') {
                    const sunday = new Date(reportDate);
                    sunday.setHours(23, 59, 59, 999);
                    const monday = new Date(reportDate);
                    monday.setDate(reportDate.getDate() - 6);
                    monday.setHours(0, 0, 0, 0);
                    startDate = monday;
                    endDate = sunday;
                } else {
                    startDate = new Date(year, month - 1, day, 0, 0, 0);
                    endDate = new Date(year, month - 1, day, 23, 59, 59, 999);
                }

                const { data: allPayments, error } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('user_name', userName)
                    .gte('created_at', startDate.toISOString())
                    .lte('created_at', endDate.toISOString());

                if (error) throw error;

                let payments = [];
                if (paymentTermFilter) {
                    const debtorIds = new Set(allPayments.map(p => p.debtor_id).filter(id => id));
                    const debtorTerms = {};
                    if (debtorIds.size > 0) {
                        const debtorIdArray = Array.from(debtorIds);
                        const { data: debtorSnapshots, error: debtorError } = await supabase
                            .from('debtors')
                            .select('id, payment_term')
                            .in('id', debtorIdArray);
                        
                        if (debtorError) throw debtorError;

                        if (debtorSnapshots) {
                            debtorSnapshots.forEach(doc => debtorTerms[doc.id] = doc.payment_term);
                        }
                    }
                    payments = allPayments.filter(p => {
                        const pTerm = p.debtor_id ? debtorTerms[p.debtor_id] : null;
                        if (!pTerm) return false;
                        const filterUpper = paymentTermFilter.toUpperCase();
                        return Array.isArray(pTerm) ? pTerm.some(t => String(t).toUpperCase() === filterUpper) : String(pTerm).toUpperCase() === filterUpper;
                    });
                } else {
                    payments = allPayments;
                }
                return payments;
            } catch (error) { console.error("Error getting payment details:", error); throw error; }
        }

        async function loadReportPaymentsDetails(userName, dateStr, paymentTermFilter = null, collectionName = 'reports') {
            const modal = document.getElementById('view-report-payments-modal');
            const tbody = document.getElementById('report-payments-body');
            const totalSpan = document.getElementById('report-payments-total');
            const cashSpan = document.getElementById('report-payments-cash');
            const transferSpan = document.getElementById('report-payments-transfer');
            
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';
            totalSpan.textContent = '$0';
            cashSpan.textContent = '0';
            transferSpan.textContent = '0';
            modal.style.display = 'flex';

            // Set globals for download
            currentDownloadUser = userName;
            currentDownloadDate = dateStr;
            currentDownloadCollection = collectionName;

            try {
                const payments = await getPaymentDetailsData(userName, dateStr, paymentTermFilter, collectionName);

                let total = 0;
                let cashTotal = 0;
                let transferTotal = 0;

                payments.forEach(data => {
                    const amount = Number(data.payment_amount) || 0;
                    total += amount;
                    const method = (data.payment_method || '').toLowerCase();
                    if (method.includes('efectivo')) {
                        cashTotal += amount;
                    } else if (method.includes('transferencia')) {
                        transferTotal += amount;
                    }
                });

                totalSpan.textContent = '$' + total.toLocaleString('es-CO');
                cashSpan.textContent = '$' + cashTotal.toLocaleString('es-CO');
                transferSpan.textContent = '$' + transferTotal.toLocaleString('es-CO');

                let html = '';
                if (payments.length === 0) {
                    html = '<tr><td colspan="6" style="text-align:center;">No hay cobros registrados.</td></tr>';
                } else {
                    payments.forEach(p => {
                        // Formatear fecha createdAt para mostrar
                        let dateDisplay = p.payment_date || 'N/A';
                        if (p.created_at) {
                            const d = new Date(p.created_at);
                            const day = String(d.getDate()).padStart(2, '0');
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const year = d.getFullYear();
                            dateDisplay = `${day}-${month}-${year}`;
                        }

                        html += `<tr id="rep-pay-row-${p.id}"><td class="cell-date" data-ts="${p.created_at ? new Date(p.created_at).getTime() : 0}">${dateDisplay}</td>
                            <td class="cell-client">${p.debtor_name || 'N/A'}</td>
                            <td class="cell-amount" data-val="${p.payment_amount}">$${(Number(p.payment_amount) || 0).toLocaleString('es-CO')}</td>
                            <td class="cell-method">${p.payment_method || 'N/A'}</td>
                            <td class="cell-muni">${p.municipality || 'N/A'}</td>
                            <td>
                                <button class="btn edit-report-payment-btn" data-id="${p.id}" data-user="${userName}" data-date="${dateStr}" data-collection="${collectionName}" style="background-color: #f39c12; padding: 5px 10px;"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                tbody.innerHTML = html;
            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error al cargar datos.</td></tr>';
            }
        }

        // Event Listener para editar cobros en el reporte
        document.getElementById('report-payments-body').addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-report-payment-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const row = document.getElementById(`rep-pay-row-${id}`);
                
                const dateCell = row.querySelector('.cell-date');
                const ts = Number(dateCell.dataset.ts);
                let isoDate = '';
                if (ts > 0) {
                    const d = new Date(ts);
                    isoDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
                dateCell.innerHTML = `<input type="date" class="edit-date" value="${isoDate}" style="width: 110px;">`;

                const client = row.querySelector('.cell-client').textContent;
                row.querySelector('.cell-client').innerHTML = `<input type="text" class="edit-client" value="${client}" style="width: 100px;">`;
                
                const amount = row.querySelector('.cell-amount').dataset.val || 0;
                row.querySelector('.cell-amount').innerHTML = `<input type="number" class="edit-amount" value="${amount}" style="width: 80px;">`;
                
                const method = row.querySelector('.cell-method').textContent;
                row.querySelector('.cell-method').innerHTML = `<select class="edit-method"><option value="Efectivo" ${method==='Efectivo'?'selected':''}>Efectivo</option><option value="Transferencia" ${method==='Transferencia'?'selected':''}>Transferencia</option></select>`;
                
                const muni = row.querySelector('.cell-muni').textContent;
                row.querySelector('.cell-muni').innerHTML = `<input type="text" class="edit-muni" value="${muni}" style="width: 80px;">`;
                
                editBtn.parentElement.innerHTML = `<button class="btn save-report-payment-btn" data-id="${id}" data-user="${editBtn.dataset.user}" data-date="${editBtn.dataset.date}" data-collection="${editBtn.dataset.collection}" style="background-color: #2ecc71; padding: 5px 10px;"><i class="fas fa-save"></i></button>`;
            }

            const saveBtn = e.target.closest('.save-report-payment-btn');
            if (saveBtn) {
                const id = saveBtn.dataset.id;
                const userName = saveBtn.dataset.user;
                const dateStr = saveBtn.dataset.date;
                const collectionName = saveBtn.dataset.collection || 'reports';
                const row = document.getElementById(`rep-pay-row-${id}`);
                
                const newAmount = Number(row.querySelector('.edit-amount').value);
                const newDateVal = row.querySelector('.edit-date').value;
                
                saveBtn.innerHTML = '<div class="small-spinner"></div>';
                saveBtn.disabled = true;

                try {
                    const updateData = {};
                    if (newDateVal) {
                        const [y, m, d] = newDateVal.split('-').map(Number); // Crear fecha a mediodía
                        const newDateObj = new Date(y, m - 1, d, 12, 0, 0);
                        updateData.created_at = newDateObj.toISOString();
                        updateData.payment_date = `${String(d).padStart(2,'0')}-${String(m).padStart(2,'0')}-${y}`;
                    }

                    await supabase.from('payments').update({
                        ...updateData,
                        debtor_name: row.querySelector('.edit-client').value,
                        payment_amount: newAmount,
                        payment_method: row.querySelector('.edit-method').value,
                        municipality: row.querySelector('.edit-muni').value
                    })
                    .eq('id', id);

                    // Recalcular totales consultando de nuevo para precisión
                    const termFilter = collectionName === 'wreports' ? 'Semanal' : 'Diario';
                    const payments = await getPaymentDetailsData(userName, dateStr, termFilter, collectionName);
                    const newTotalPayments = payments.reduce((sum, p) => sum + (Number(p.paymentAmount) || 0), 0);
                    
                    // Actualizar totales visuales en el modal
                    document.getElementById('report-payments-total').textContent = '$' + newTotalPayments.toLocaleString('es-CO');
                    let cashTotal = 0, transferTotal = 0;
                    payments.forEach(p => {
                        const amt = Number(p.payment_amount) || 0;
                        if ((p.paymentMethod || '').toLowerCase().includes('efectivo')) cashTotal += amt;
                        else if ((p.paymentMethod || '').toLowerCase().includes('transferencia')) transferTotal += amt;
                    });
                    document.getElementById('report-payments-cash').textContent = '$' + cashTotal.toLocaleString('es-CO');
                    document.getElementById('report-payments-transfer').textContent = '$' + transferTotal.toLocaleString('es-CO');

                    // Actualizar Reporte
                    const [day, month, year] = dateStr.split('-').map(Number);
                    const startOfDay = new Date(year, month - 1, day, 0, 0, 0).toISOString();
                    const endOfDay = new Date(year, month - 1, day, 23, 59, 59).toISOString();

                    let reportsQuery;
                    if (collectionName === 'wreports') {
                        reportsQuery = await supabase.from('wreports').select('*').eq('user_name', userName).gte('created_at', startOfDay).lte('created_at', endOfDay).limit(1).single();
                    } else {
                        reportsQuery = await supabase.from('reports').select('*').eq('user_name', userName).eq('report_date', dateStr).limit(1).single();
                    }

                    const rDoc = reportsQuery.data;
                    if (rDoc) {
                        const rData = rDoc;
                        const initialBase = Number(rData.initial_base) || 0;
                        const credits = Number(rData.credits_report) || 0;
                        const expenses = rData.expense_report !== undefined ? Number(rData.expense_report) : (Number(rData.expenses_report) || 0);
                        const finalBase = (initialBase + newTotalPayments) - (credits + expenses);
                        
                        const updatePayload = { payments_report: newTotalPayments };
                        if (rData.og_final_base !== undefined && rData.og_final_base !== null) {
                            updatePayload.og_final_base = finalBase;
                        } else {
                            updatePayload.final_base = finalBase;
                        }
                        
                        const { error: updateError } = await supabase
                            .from(collectionName)
                            .update(updatePayload)
                            .eq('id', rDoc.id);

                        if (updateError) throw updateError;
                    }

                    showToast("Cobro actualizado");
                    loadReportPaymentsDetails(userName, dateStr, termFilter, collectionName); // Recargar vista con filtro correcto
                    refreshActiveReportView();
                } catch (error) {
                    alert("Error: " + error.message);
                    saveBtn.disabled = false;
                }
            }
        });

        // Función auxiliar para obtener datos de créditos (usada para ver y descargar)
        async function getCreditDetailsData(userName, dateStr, paymentTermFilter = null, collectionName = 'reports') {
            try {
                let startDate, endDate;
                const [day, month, year] = dateStr.split('-').map(Number);
                const reportDate = new Date(year, month - 1, day);

                if (collectionName === 'wreports') {
                    // Para reportes semanales, obtener la semana completa de Lunes a Domingo.
                    const sunday = new Date(reportDate);
                    sunday.setHours(23, 59, 59, 999);

                    const monday = new Date(reportDate);
                    monday.setDate(reportDate.getDate() - 6); // Retroceder 6 días desde el Domingo para llegar al Lunes
                    monday.setHours(0, 0, 0, 0);

                    startDate = monday;
                    endDate = sunday;
                } else {
                    // Para reportes diarios, solo el día.
                    startDate = new Date(year, month - 1, day, 0, 0, 0);
                    endDate = new Date(year, month - 1, day, 23, 59, 59);
                }

                // 1. Consultar registros nativos (created_at)
                const { data: nativeSnap, error } = await supabase
                    .from('debtors')
                    .select('*')
                    .eq('asesor_name', userName)
                    .gte('created_at', startDate.toISOString())
                    .lte('created_at', endDate.toISOString());

                if (error) throw error;

                let credits = [];
                nativeSnap.forEach(data => {
                    // Ignorar importados
                    if (data.imported !== true) {
                        if (paymentTermFilter) {
                            const pTerm = data.payment_term;
                            let match = false;
                            const filterUpper = paymentTermFilter.toUpperCase();
                            
                            if (Array.isArray(pTerm)) {
                                if (pTerm.some(t => String(t).toUpperCase() === filterUpper)) match = true;
                            } else if (pTerm) {
                                if (String(pTerm).toUpperCase() === filterUpper) match = true;
                            }
                            if (match) credits.push(data);
                        } else {
                            credits.push(data);
                        }
                    }
                });
                
                return credits;
            } catch (error) {
                console.error("Error obteniendo datos de créditos:", error);
                throw error;
            }
        }

        async function loadReportCreditsDetails(userName, dateStr, paymentTermFilter = null, collectionName = 'reports') {
            const modal = document.getElementById('view-report-credits-modal');
            const tbody = document.getElementById('report-credits-body');
            const totalSpan = document.getElementById('report-credits-total');

            tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';
            totalSpan.textContent = '$0';
            modal.style.display = 'flex';

            // Set globals for download
            currentDownloadUser = userName;
            currentDownloadDate = dateStr;
            currentDownloadCollection = collectionName;

            try {
                const credits = await getCreditDetailsData(userName, dateStr, paymentTermFilter, collectionName);
                let total = 0;

                credits.forEach(data => {
                    total += Number(data.sale_value) || 0;
                });

                totalSpan.textContent = '$' + total.toLocaleString('es-CO');

                let html = '';
                if (credits.length === 0) {
                    html = '<tr><td colspan="12" style="text-align:center;">No hay créditos registrados.</td></tr>';
                } else {
                    credits.forEach(c => {
                        // Formatear fecha createdAt
                        let dateDisplay = c.sale_date || 'N/A';
                        if (c.created_at) {
                            const d = new Date(c.created_at);
                            const day = String(d.getDate()).padStart(2, '0');
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const year = d.getFullYear();
                            dateDisplay = `${day}-${month}-${year}`;
                        }

                        html += `<tr id="rep-cred-row-${c.id}"><td class="cell-date" data-ts="${c.created_at ? new Date(c.created_at).getTime() : 0}">${dateDisplay}</td>
                            <td class="cell-name">${c.name || 'N/A'}</td>
                            <td class="cell-cedula">${c.cedula || 'N/A'}</td>
                            <td class="cell-phone">${c.phone || 'N/A'}</td>
                            <td class="cell-credit" data-val="${c.sale_value}">$${(Number(c.sale_value) || 0).toLocaleString('es-CO')}</td>
                            <td class="cell-interests" data-val="${c.interests}">$${(Number(c.interests) || 0).toLocaleString('es-CO')}</td>
                            <td class="cell-cuotas">${c.number_of_payments || 'N/A'}</td>
                            <td class="cell-valor-cuota" data-val="${c.valor_cuota}">$${(Number(c.valor_cuota) || 0).toLocaleString('es-CO')}</td>
                            <td class="cell-type">${c.credit_type || 'N/A'}</td>
                            <td class="cell-term">${c.payment_term || 'N/A'}</td>
                            <td class="cell-muni">${c.municipality || 'N/A'}</td>
                            <td>
                                <button class="btn edit-report-credit-btn" data-id="${c.id}" data-user="${userName}" data-date="${dateStr}" data-collection="${collectionName}" style="background-color: #f39c12; padding: 5px 10px;"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                tbody.innerHTML = html;
            } catch (error) {
                console.error(error);
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center; color:red;">Error al cargar datos.</td></tr>';
            }
        }

        // Event Listener para editar créditos en el reporte
        document.getElementById('report-credits-body').addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-report-credit-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const row = document.getElementById(`rep-cred-row-${id}`);

                const dateCell = row.querySelector('.cell-date');
                const ts = Number(dateCell.dataset.ts);
                let isoDate = '';
                if (ts > 0) {
                    const d = new Date(ts);
                    isoDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }
                dateCell.innerHTML = `<input type="date" class="edit-date" value="${isoDate}" style="width: 110px;">`;
                
                const name = row.querySelector('.cell-name').textContent;
                row.querySelector('.cell-name').innerHTML = `<input type="text" class="edit-name" value="${name}" style="width: 100px;">`;
                
                const cedula = row.querySelector('.cell-cedula').textContent;
                row.querySelector('.cell-cedula').innerHTML = `<input type="text" class="edit-cedula" value="${cedula}" style="width: 80px;">`;
                
                const phone = row.querySelector('.cell-phone').textContent;
                row.querySelector('.cell-phone').innerHTML = `<input type="text" class="edit-phone" value="${phone}" style="width: 80px;">`;
                
                const creditVal = row.querySelector('.cell-credit').dataset.val || 0;
                row.querySelector('.cell-credit').innerHTML = `<input type="number" class="edit-credit" value="${creditVal}" style="width: 80px;">`;
                
                const interestsVal = row.querySelector('.cell-interests').dataset.val || 0;
                row.querySelector('.cell-interests').innerHTML = `<input type="number" class="edit-interests" value="${interestsVal}" style="width: 80px;">`;

                const cuotas = row.querySelector('.cell-cuotas').textContent;
                row.querySelector('.cell-cuotas').innerHTML = `<input type="number" class="edit-cuotas" value="${cuotas}" style="width: 50px;">`;
                
                const valorCuota = row.querySelector('.cell-valor-cuota').dataset.val || 0;
                row.querySelector('.cell-valor-cuota').innerHTML = `<input type="number" class="edit-valor-cuota" value="${valorCuota}" style="width: 80px;">`;
                
                const type = row.querySelector('.cell-type').textContent;
                row.querySelector('.cell-type').innerHTML = `<select class="edit-type"><option value="Nuevo" ${type==='Nuevo'?'selected':''}>Nuevo</option><option value="Represte" ${type==='Represte'?'selected':''}>Represte</option></select>`;
                
                const term = row.querySelector('.cell-term').textContent;
                row.querySelector('.cell-term').innerHTML = `<select class="edit-term"><option value="Diario" ${term==='Diario'?'selected':''}>Diario</option><option value="Semanal" ${term==='Semanal'?'selected':''}>Semanal</option></select>`;
                
                const muni = row.querySelector('.cell-muni').textContent;
                row.querySelector('.cell-muni').innerHTML = `<input type="text" class="edit-muni" value="${muni}" style="width: 80px;">`;
                
                editBtn.parentElement.innerHTML = `<button class="btn save-report-credit-btn" data-id="${id}" data-user="${editBtn.dataset.user}" data-date="${editBtn.dataset.date}" data-collection="${editBtn.dataset.collection}" style="background-color: #2ecc71; padding: 5px 10px;"><i class="fas fa-save"></i></button>`;
            }

            const saveBtn = e.target.closest('.save-report-credit-btn');
            if (saveBtn) {
                const id = saveBtn.dataset.id;
                const userName = saveBtn.dataset.user;
                const dateStr = saveBtn.dataset.date;
                const collectionName = saveBtn.dataset.collection || 'reports';
                const row = document.getElementById(`rep-cred-row-${id}`);
                
                const newCreditVal = Number(row.querySelector('.edit-credit').value);
                const newInterestsVal = Number(row.querySelector('.edit-interests').value);
                const newDateVal = row.querySelector('.edit-date').value;
                
                saveBtn.innerHTML = '<div class="small-spinner"></div>';
                saveBtn.disabled = true;

                try {
                    const updateData = {};
                    if (newDateVal) {
                        const [y, m, d] = newDateVal.split('-');
                        const newDateObj = new Date(y, m - 1, d, 12, 0, 0); // Mediodía
                        updateData.created_at = newDateObj.toISOString();
                        updateData.sale_date = `${d}-${m}-${y}`;
                    }

                    await supabase.from('debtors').update({
                        ...updateData,
                        name: row.querySelector('.edit-name').value,
                        cedula: row.querySelector('.edit-cedula').value,
                        phone: Number(row.querySelector('.edit-phone').value),
                        total_credit_value: newCreditVal,
                        sale_value: newCreditVal,
                        interests: newInterestsVal,
                        number_of_payments: Number(row.querySelector('.edit-cuotas').value),
                        remaining_payments: Number(row.querySelector('.edit-cuotas').value),
                        valor_cuota: Number(row.querySelector('.edit-valor-cuota').value),
                        credit_type: row.querySelector('.edit-type').value,
                        payment_term: row.querySelector('.edit-term').value,
                        municipality: row.querySelector('.edit-muni').value
                    })
                    .eq('id', id);

                    const termFilter = collectionName === 'wreports' ? 'Semanal' : 'Diario';
                    const credits = await getCreditDetailsData(userName, dateStr, termFilter, collectionName);
                    const newTotal = credits.reduce((sum, c) => sum + (Number(c.sale_value) || 0), 0);
                    document.getElementById('report-credits-total').textContent = '$' + newTotal.toLocaleString('es-CO');

                    // Recalcular totales en el reporte
                    const [day, month, year] = dateStr.split('-').map(Number);
                    const startOfDay = new Date(year, month - 1, day, 0, 0, 0).toISOString();
                    const endOfDay = new Date(year, month - 1, day, 23, 59, 59).toISOString();

                    let reportsQuery;
                    if (collectionName === 'wreports') {
                        reportsQuery = await supabase.from('wreports').select('*').eq('user_name', userName).gte('created_at', startOfDay).lte('created_at', endOfDay).limit(1).single();
                    } else {
                        reportsQuery = await supabase.from('reports').select('*').eq('user_name', userName).eq('report_date', dateStr).limit(1).single();
                    }

                    const rDoc = reportsQuery.data;
                    if (rDoc) {
                        const rData = rDoc;
                        const initialBase = Number(rData.initial_base) || 0;
                        const payments = Number(rData.payments_report) || 0;
                        const expenses = rData.expense_report !== undefined ? Number(rData.expense_report) : (Number(rData.expenses_report) || 0);
                        const finalBase = (initialBase + payments) - (newTotal + expenses);
                        
                        const updatePayload = { credits_report: newTotal };
                        if (rData.og_final_base !== undefined && rData.og_final_base !== null) {
                            updatePayload.og_final_base = finalBase;
                        } else {
                            updatePayload.final_base = finalBase;
                        }
                        await supabase.from(collectionName).update(updatePayload).eq('id', rDoc.id);
                    }
                    showToast("Crédito actualizado");
                    loadReportCreditsDetails(userName, dateStr, termFilter, collectionName);
                    refreshActiveReportView();
                } catch (error) {
                    alert("Error: " + error.message);
                    saveBtn.disabled = false;
                }
            }
        });

        // Lógica de descarga de créditos
        closeDownloadFormatModal.addEventListener('click', () => {
            downloadFormatModal.style.display = 'none';
        });

        // Dashboard Buttons Logic
        btnDashboardDaily.addEventListener('click', () => {
            btnDashboardDaily.classList.add('active');
            btnDashboardWeekly.classList.remove('active');
            loadDashboardData();
        });

        btnDashboardWeekly.addEventListener('click', () => {
            btnDashboardWeekly.classList.add('active');
            btnDashboardDaily.classList.remove('active');
            loadDashboardData();
        });

        btnDashboardRefresh.addEventListener('click', () => {
            loadDashboardData();
        });

        btnDashboardDownload.addEventListener('click', () => {
            currentDownloadContext = 'dashboard';
            downloadFormatModal.style.display = 'flex';
        });

        btnDownloadExcel.addEventListener('click', async () => {
            downloadFormatModal.style.display = 'none';
            if (currentDownloadContext === 'credits') {
                await downloadCredits('excel');
            } else if (currentDownloadContext === 'report') {
                // Deprecated context?
            } else if (currentDownloadContext === 'general_report') {
                await downloadGeneralReport('excel');
            } else if (currentDownloadContext === 'payment_details') {
                await downloadPaymentDetails('excel');
            } else if (currentDownloadContext === 'expenses_report') {
                await downloadExpensesReport('excel');
            } else if (currentDownloadContext === 'payments_report_main') {
                await downloadPaymentsReport('excel');
            } else if (currentDownloadContext === 'credits_report_main') {
                await downloadCreditsReport('excel');
            } else if (currentDownloadContext === 'payment_behavior_report_main') {
                await downloadPaymentBehaviorReport('excel');
            } else if (currentDownloadContext === 'pg_report_main') {
                await downloadPgReport('excel');
            } else if (currentDownloadContext === 'dashboard') {
                await downloadDashboardReport('excel');
            } else if (currentDownloadContext === 'payment_behavior_history') {
                await downloadMissedPaymentHistory('excel');
            }
        });

        btnDownloadPdf.addEventListener('click', async () => {
            downloadFormatModal.style.display = 'none';
            if (currentDownloadContext === 'credits') {
                await downloadCredits('pdf');
            } else if (currentDownloadContext === 'general_report') {
                await downloadGeneralReport('pdf');
            } else if (currentDownloadContext === 'payment_details') {
                await downloadPaymentDetails('pdf');
            } else if (currentDownloadContext === 'expenses_report') {
                await downloadExpensesReport('pdf');
            } else if (currentDownloadContext === 'payments_report_main') {
                await downloadPaymentsReport('pdf');
            } else if (currentDownloadContext === 'credits_report_main') {
                await downloadCreditsReport('pdf');
            } else if (currentDownloadContext === 'payment_behavior_report_main') {
                await downloadPaymentBehaviorReport('pdf');
            } else if (currentDownloadContext === 'pg_report_main') {
                await downloadPgReport('pdf');
            } else if (currentDownloadContext === 'dashboard') {
                await downloadDashboardReport('pdf');
            } else if (currentDownloadContext === 'payment_behavior_history') {
                await downloadMissedPaymentHistory('pdf');
            }
        });

        // Función auxiliar para aplicar formato de fecha a todas las celdas de tipo fecha en la hoja
        function applyExcelDateFormat(ws) {
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = ws[cellAddress];
                    if (cell && cell.t === 'd') {
                        cell.z = 'm/d/yy';
                    }
                }
            }
        }

        async function downloadCredits(format) {
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            const loadingDesc = loadingModal.querySelector('p');
            loadingText.textContent = "Generando archivo...";
            loadingDesc.textContent = "Por favor espere.";
            loadingModal.style.display = 'flex';

            try {
                const filter = currentDownloadCollection === 'wreports' ? 'Semanal' : 'Diario';
                const credits = await getCreditDetailsData(currentDownloadUser, currentDownloadDate, filter, currentDownloadCollection);
                
                if (credits.length === 0) {
                    alert("No hay datos para descargar.");
                    return;
                }

                if (format === 'excel') {
                    const exportData = credits.map(c => {
                        const fecha = c.created_at ? new Date(c.created_at) : null;
                        if (fecha) fecha.setHours(12, 0, 0, 0);
                        return {
                            "FECHA": fecha,
                            "CLIENTE": c.name,
                            "CEDULA": c.cedula,
                            "TELEFONO": c.phone,
                            "CREDITO": Number(c.totalCreditValue) || 0,
                            "NRO CUOTAS": c.number_of_payments,
                            "CUOTA": Number(c.valor_cuota) || 0,
                            "TIPO CREDITO": c.credit_type,
                            "TIPO PAGO": c.payment_term,
                            "MUNICIPIO": c.municipality
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                    applyExcelDateFormat(ws);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Creditos");
                    XLSX.writeFile(wb, `Creditos_${currentDownloadUser}_${currentDownloadDate}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
                    
                    doc.text(`Reporte de Créditos - ${currentDownloadUser}`, 14, 15);
                    doc.text(`Fecha: ${currentDownloadDate}`, 14, 22);
                    
                    const tableColumn = ["Fecha", "Cliente", "Cédula", "Teléfono", "Crédito", "Cuotas", "Valor Cuota", "Tipo", "Frecuencia", "Municipio"];
                    const tableRows = credits.map(c => {
                        let dateStr = c.sale_date || 'N/A';
                        if (c.created_at) {
                            const d = new Date(c.created_at);
                            dateStr = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
                        }
                        return [
                            dateStr,
                            c.name || '',
                            c.cedula || '',
                            c.phone || '',
                            "$" + (Number(c.total_credit_value) || 0).toLocaleString('es-CO'),
                            c.number_of_payments || '',
                            "$" + (Number(c.valor_cuota) || 0).toLocaleString('es-CO'),
                            c.credit_type || '',
                            c.payment_term || '',
                            c.municipality || ''
                        ];
                    });

                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 30,
                        theme: 'grid',
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [39, 174, 96] }
                    });
                    
                    doc.save(`Creditos_${currentDownloadUser}_${currentDownloadDate}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) {
                console.error(error);
                alert("Error al descargar: " + error.message);
            } finally {
                loadingModal.style.display = 'none';
            }
        }

        async function downloadPaymentDetails(format) {
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            const loadingDesc = loadingModal.querySelector('p');
            loadingText.textContent = "Generando archivo...";
            loadingDesc.textContent = "Por favor espere.";
            loadingModal.style.display = 'flex';

            try {
                const filter = currentDownloadCollection === 'wreports' ? 'Semanal' : 'Diario';
                const payments = await getPaymentDetailsData(currentDownloadUser, currentDownloadDate, filter, currentDownloadCollection);
                
                if (payments.length === 0) { alert("No hay datos para descargar."); return; }

                if (format === 'excel') {
                    const exportData = payments.map(p => {
                        const fecha = p.created_at ? new Date(p.created_at) : null;
                        if (fecha) fecha.setHours(12, 0, 0, 0);
                        return {
                            "FECHA": fecha,
                            "CLIENTE": p.debtor_name,
                            "ABONO": Number(p.payment_amount) || 0,
                            "METODO": p.payment_method,
                            "MUNICIPIO": p.municipality
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                    applyExcelDateFormat(ws);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Cobros");
                    XLSX.writeFile(wb, `Cobros_${currentDownloadUser}_${currentDownloadDate}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text(`Reporte de Cobros - ${currentDownloadUser}`, 14, 15);
                    doc.text(`Fecha: ${currentDownloadDate}`, 14, 22);
                    const tableColumn = ["Fecha", "Cliente", "Abono", "Método", "Municipio"];
                    const tableRows = payments.map(p => {
                        let dateDisplay = p.payment_date || 'N/A';
                        if (p.created_at) {
                            const d = new Date(p.created_at);
                            dateDisplay = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
                        }
                        return [
                            dateDisplay,
                            p.debtor_name || '',
                            "$" + (Number(p.payment_amount) || 0).toLocaleString('es-CO'),
                            p.payment_method || '',
                            p.municipality || ''
                        ];
                    });
                    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 30, theme: 'grid', styles: { fontSize: 10 } });
                    doc.save(`Cobros_${currentDownloadUser}_${currentDownloadDate}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadGeneralReport(format) {
            if (currentGnReportData.length === 0) { alert("No hay datos para descargar. Genere el reporte primero."); return; }
            
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                if (format === 'excel') {
                    const exportData = currentGnReportData.map(r => {
                        const createdAt = r.created_at ? new Date(r.created_at) : null;
                        if (createdAt) createdAt.setHours(12, 0, 0, 0);
                        const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                        let dayName = createdAt ? days[createdAt.getDay()] : 'N/A';
                        const gastos = r.expense_report !== undefined ? r.expense_report : (r.expenses_report || 0);
                        return {
                            "ASESOR": r.user_name,
                            "CREDITO": Number(r.credits_report) || 0,
                            "COBRO": Number(r.payments_report) || 0,
                            "GASTOS": Number(gastos) || 0,
                            "BASE INICIAL": Number(r.initial_base) || 0,
                            "BASE FINAL": Number(r.final_base) || 0,
                            "DIA": dayName,
                            "FECHA": createdAt
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                    applyExcelDateFormat(ws);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Reporte General");
                    XLSX.writeFile(wb, `Reporte_General_${new Date().getTime()}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    doc.text(`Reporte General`, 14, 15);
                    const tableColumn = ["Asesor", "Crédito", "Cobro", "Gastos", "Base Inicial", "Base Final", "Día", "Fecha"];
                    const tableRows = currentGnReportData.map(r => {
                        const createdAt = r.created_at ? new Date(r.created_at) : null;
                        let displayDate = 'N/A';
                        if (createdAt) {
                            displayDate = `${String(createdAt.getDate()).padStart(2,'0')}-${String(createdAt.getMonth()+1).padStart(2,'0')}-${createdAt.getFullYear()}`;
                        }
                        const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                        let dayName = createdAt ? days[createdAt.getDay()] : 'N/A';
                        const gastos = r.expense_report !== undefined ? r.expense_report : (r.expenses_report || 0);
                        return [
                            r.user_name || '',
                            "$" + (Number(r.credits_report) || 0).toLocaleString('es-CO'),
                            "$" + (Number(r.payments_report) || 0).toLocaleString('es-CO'),
                            "$" + (Number(gastos) || 0).toLocaleString('es-CO'),
                            "$" + (Number(r.initial_base) || 0).toLocaleString('es-CO'),
                            "$" + (Number(r.final_base) || 0).toLocaleString('es-CO'),
                            dayName,
                            displayDate
                        ];
                    });
                    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 25, theme: 'grid', styles: { fontSize: 8 } });
                    doc.save(`Reporte_General_${new Date().getTime()}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadExpensesReport(format) {
            if (currentExReportData.length === 0) { alert("No hay datos para descargar. Genere el reporte primero."); return; }
            
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                // Filtrar y mapear datos (excluyendo valores <= 0 como en la tabla)
                const filteredData = currentExReportData.filter(r => {
                    const othersVal = (r.others && r.others.length > 0) ? (Number(r.others[0]) || 0) : 0;
                    return othersVal > 0;
                });

                if (filteredData.length === 0) { alert("No hay registros válidos para descargar."); loadingModal.style.display = 'none'; return; }

                if (format === 'excel') {
                    const exportData = filteredData.map(r => {
                        const fecha = r.created_at ? new Date(r.created_at) : null;
                        if (fecha) fecha.setHours(12, 0, 0, 0);
                        const othersVal = (r.others && r.others.length > 0) ? (Number(r.others[0]) || 0) : 0;
                        const othersDesc = (r.others && r.others.length > 1) ? r.others[1] : 'N/A';
                        return {
                            "ASESOR": r.user_name || 'N/A',
                            "FECHA": fecha,
                            "VALOR": othersVal,
                            "DESCRIPCION": othersDesc
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                    applyExcelDateFormat(ws);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Otros Gastos");
                    XLSX.writeFile(wb, `Otros_Gastos_${new Date().getTime()}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text(`Reporte Otros Gastos`, 14, 15);
                    const tableColumn = ["Asesor", "Fecha", "Valor", "Descripción"];
                    const tableRows = filteredData.map(r => {
                        const othersVal = (r.others && r.others.length > 0) ? (Number(r.others[0]) || 0) : 0;
                        const othersDesc = (r.others && r.others.length > 1) ? r.others[1] : 'N/A';
                        let dateStr = 'N/A';
                        if (r.created_at) {
                            const d = new Date(r.created_at);
                            dateStr = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
                        }
                        return [r.user_name || 'N/A', dateStr, "$" + othersVal.toLocaleString('es-CO'), othersDesc];
                    });
                    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 25, theme: 'grid', styles: { fontSize: 10 } });
                    doc.save(`Otros_Gastos_${new Date().getTime()}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadCreditsReport(format) {
            if (currentCrReportData.length === 0) { alert("No hay datos para descargar. Genere el reporte primero."); return; }
            
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                if (format === 'excel') {
                    const exportData = currentCrReportData.map(r => {
                        const dateObj = parseDate(r.sale_date) || (r.created_at ? new Date(r.created_at) : null);
                        if (dateObj) dateObj.setHours(12, 0, 0, 0);
                        const saleValue = Number(r.sale_value) || 0;
                        const creditType = (r.credit_type || '').toUpperCase();
                        let nuevo = 0;
                        let represte = 0;
                        if (creditType === 'NUEVO') nuevo = saleValue;
                        else if (creditType === 'REPRESTE') represte = saleValue;

                        return {
                            "CLIENTE": r.name || 'N/A',
                            "FECHA": dateObj,
                            "ASESOR": r.asesor_name || 'N/A',
                            "MUNICIPIO": r.municipality || 'N/A',
                            "NUEVO": nuevo,
                            "REPRESTE": represte
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                    applyExcelDateFormat(ws);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Informe Creditos");
                    XLSX.writeFile(wb, `Informe_Creditos_${new Date().getTime()}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text(`Informe de Créditos`, 14, 15);
                    const tableColumn = ["Cliente", "Fecha", "Asesor", "Municipio", "Nuevo", "Represte"];
                    const tableRows = currentCrReportData.map(r => {
                        const dateObj = parseDate(r.sale_date) || (r.created_at ? new Date(r.created_at) : null);
                        let dateStr = 'N/A';
                        if (dateObj) {
                            dateStr = `${String(dateObj.getDate()).padStart(2,'0')}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${dateObj.getFullYear()}`;
                        }
                        const saleValue = Number(r.sale_value) || 0;
                        const creditType = (r.credit_type || '').toUpperCase();
                        let nuevo = 0;
                        let represte = 0;
                        if (creditType === 'NUEVO') nuevo = saleValue;
                        else if (creditType === 'REPRESTE') represte = saleValue;

                        return [r.name || 'N/A', dateStr, r.asesor_name || 'N/A', r.municipality || 'N/A', "$" + nuevo.toLocaleString('es-CO'), "$" + represte.toLocaleString('es-CO')];
                    });
                    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 25, theme: 'grid', styles: { fontSize: 10 } });
                    doc.save(`Informe_Creditos_${new Date().getTime()}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadPaymentBehaviorReport(format) {
            if (currentPbReportData.length === 0) { alert("No hay datos para descargar. Genere el reporte primero."); return; }
            
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                if (format === 'excel') {
                    const exportData = currentPbReportData.map(r => {
                        const fecha = r.dateObj;
                        if (fecha) fecha.setHours(12, 0, 0, 0);
                        return {
                            "CLIENTE": r.name || 'N/A',
                            "MUNICIPIO": r.municipality || 'N/A',
                            "ASESOR": r.asesor_name || 'N/A',
                            "FECHA PRESTAMO": fecha,
                            "NUEVOS": r.nuevos,
                            "REPRESTES": r.represtes,
                            "VALOR CUOTA": r.valor_cuota,
                            "ABONOS": r.abonos,
                            "SALDO": r.balance
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                    applyExcelDateFormat(ws);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Comportamiento Pago");
                    XLSX.writeFile(wb, `Comportamiento_Pago_${new Date().getTime()}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    doc.text(`Informe de Comportamiento de Pago`, 14, 15);
                    const tableColumn = ["Cliente", "Municipio", "Asesor", "Fecha", "Nuevos", "Represtes", "Cuota", "Abonos", "Saldo"];
                    const tableRows = currentPbReportData.map(r => {
                        return [
                            r.name || 'N/A',
                            r.municipality || 'N/A',
                            r.asesor_name || 'N/A',
                            r.dateStr || 'N/A',
                            "$" + r.nuevos.toLocaleString('es-CO'),
                            "$" + r.represtes.toLocaleString('es-CO'),
                            "$" + r.valor_cuota.toLocaleString('es-CO'),
                            "$" + r.abonos.toLocaleString('es-CO'),
                            "$" + r.balance.toLocaleString('es-CO')
                        ];
                    });
                    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 25, theme: 'grid', styles: { fontSize: 8 } });
                    doc.save(`Comportamiento_Pago_${new Date().getTime()}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadPgReport(format) {
            if (currentPgReportData.length === 0) { alert("No hay datos para descargar. Genere el reporte primero."); return; }
            
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                if (format === 'excel') {
                    const exportData = currentPgReportData.map(r => {
                        return {
                            "FECHA": r.date,
                            "ASESOR": r.user,
                            "MUNICIPIO": r.muni,
                            "COBRO REAL": r.cobro,
                            "GASTOS": r.gastos,
                            "CREDITOS": r.creditos,
                            "GANANCIA": r.ganancia,
                            "RECAUDO": r.cobroReal
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    // No aplicamos formato de fecha porque 'FECHA' aquí puede ser un string de rango o semana
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Reporte P&G");
                    XLSX.writeFile(wb, `Reporte_PG_${new Date().getTime()}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    doc.text(`Reporte P&G`, 14, 15);
                    const tableColumn = ["Fecha", "Asesor", "Municipio", "Cobro Real", "Gastos", "Créditos", "Ganancia", "Recaudo"];
                    const tableRows = currentPgReportData.map(r => {
                        return [
                            r.date,
                            r.user,
                            r.muni,
                            "$" + r.cobro.toLocaleString('es-CO'),
                            "$" + r.gastos.toLocaleString('es-CO'),
                            "$" + r.creditos.toLocaleString('es-CO'),
                            "$" + r.ganancia.toLocaleString('es-CO'),
                            "$" + r.cobroReal.toLocaleString('es-CO')
                        ];
                    });
                    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 25, theme: 'grid', styles: { fontSize: 8 } });
                    doc.save(`Reporte_PG_${new Date().getTime()}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadPaymentsReport(format) {
            if (currentPmReportData.length === 0) { alert("No hay datos para descargar. Genere el reporte primero."); return; }
            
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                if (format === 'excel') {
                    const exportData = currentPmReportData.map(r => { // Corregido para usar created_at
                        const dateObj = parseDate(r.payment_date) || (r.created_at ? new Date(r.created_at) : null);
                        if (dateObj) dateObj.setHours(12, 0, 0, 0);
                        return {
                            "CLIENTE": r.debtor_name || 'N/A',
                            "FECHA": dateObj,
                            "ASESOR": r.user_name || 'N/A',
                            "MUNICIPIO": r.municipality || 'N/A',
                            "CUOTA": Number(r.valor_cuota) || 0,
                            "ABONO": Number(r.payment_amount) || 0
                        };
                    });
                    const ws = XLSX.utils.json_to_sheet(exportData, { cellDates: true });
                    applyExcelDateFormat(ws);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Informe Cobros");
                    XLSX.writeFile(wb, `Informe_Cobros_${new Date().getTime()}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text(`Informe de Cobros`, 14, 15);
                    const tableColumn = ["Cliente", "Fecha", "Asesor", "Municipio", "Cuota", "Abono"];
                    const tableRows = currentPmReportData.map(r => {
                        const dateObj = parseDate(r.payment_date) || (r.created_at ? new Date(r.created_at) : null);
                        let dateStr = 'N/A';
                        if (dateObj) {
                            dateStr = `${String(dateObj.getDate()).padStart(2,'0')}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${dateObj.getFullYear()}`;
                        }
                        return [
                            r.debtor_name || 'N/A',
                            dateStr,
                            r.user_name || 'N/A',
                            r.municipality || 'N/A',
                            "$" + (Number(r.valor_cuota) || 0).toLocaleString('es-CO'),
                            "$" + (Number(r.payment_amount) || 0).toLocaleString('es-CO')
                        ];
                    });
                    doc.autoTable({ head: [tableColumn], body: tableRows, startY: 25, theme: 'grid', styles: { fontSize: 10 } });
                    doc.save(`Informe_Cobros_${new Date().getTime()}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadMissedPaymentHistory(format) {
            if (!currentHistoryData) return;
            
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                const { debtor, payments, mode } = currentHistoryData;
                const isWeekly = mode === 'Semanal';
                
                // Datos de cabecera
                const headerData = {
                    "ASESOR": debtor.asesor_name || '',
                    "MUNICIPIO": debtor.municipality || '',
                    "FECHA PRESTAMO": debtor.sale_date || '',
                    "TIPO CREDITO": debtor.credit_type || '',
                    "VALOR CUOTA": Number(debtor.valor_cuota) || 0,
                    "SALDO ACTUAL": Number(debtor.balance) || 0,
                    "FRECUENCIA": debtor.payment_term || ''
                };

                if (format === 'excel') {
                    const wb = XLSX.utils.book_new();
                    
                    // Crear hoja
                    let wsData = [];
                    
                    // Fila de datos del cliente
                    wsData.push(["ASESOR", "MUNICIPIO", "FECHA PRESTAMO", "TIPO CREDITO", "VALOR CUOTA", "SALDO ACTUAL", "FRECUENCIA"]);
                    const clientRow = [
                        headerData["ASESOR"],
                        headerData["MUNICIPIO"],
                        headerData["FECHA PRESTAMO"],
                        headerData["TIPO CREDITO"],
                        headerData["VALOR CUOTA"],
                        headerData["SALDO ACTUAL"],
                        headerData["FRECUENCIA"]
                    ];
                    wsData.push(clientRow);
                    
                    // Dos filas vacías
                    wsData.push([]);
                    wsData.push([]);
                    
                    // Tabla de pagos
                    if (isWeekly) {
                        wsData.push(["SEMANA", "MES", "FECHA PAGO", "VALOR CUOTA", "ABONO"]);
                        payments.forEach(p => {
                            // Parse date string to Date object for Excel
                            const [d, m, y] = p.date.split('-').map(Number);
                            const dateObj = new Date(y, m - 1, d, 12, 0, 0);
                            wsData.push([p.weekNum, p.month, dateObj, p.quotaVal, p.amount]);
                        });
                    } else {
                        wsData.push(["FECHA PAGO", "VALOR CUOTA", "ABONO"]);
                        payments.forEach(p => {
                            const [d, m, y] = p.date.split('-').map(Number);
                            const dateObj = new Date(y, m - 1, d, 12, 0, 0);
                            wsData.push([dateObj, p.quotaVal, p.amount]);
                        });
                    }

                    const ws = XLSX.utils.aoa_to_sheet(wsData, { cellDates: true });
                    
                    // Apply short date format to date cells
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cell = ws[XLSX.utils.encode_cell({r: R, c: C})];
                            if (cell && cell.t === 'd') cell.z = 'm/d/yy';
                        }
                    }

                    XLSX.utils.book_append_sheet(wb, ws, "Historial");
                    XLSX.writeFile(wb, `Historial_Pagos_${debtor.name}.xlsx`);

                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(12);
                    doc.text(`Historial de Pagos - ${debtor.name}`, 14, 15);
                    
                    // Sección de datos arriba
                    doc.setFontSize(10);
                    let y = 25;
                    doc.text(`Asesor: ${headerData["ASESOR"]} | Municipio: ${headerData["MUNICIPIO"]}`, 14, y); y += 6;
                    doc.text(`Fecha Préstamo: ${headerData["FECHA PRESTAMO"]} | Tipo: ${headerData["TIPO CREDITO"]}`, 14, y); y += 6;
                    doc.text(`Cuota: $${headerData["VALOR CUOTA"].toLocaleString('es-CO')} | Saldo: $${headerData["SALDO ACTUAL"].toLocaleString('es-CO')}`, 14, y); y += 6;
                    doc.text(`Frecuencia: ${headerData["FRECUENCIA"]}`, 14, y); y += 10;

                    let tableHead = isWeekly ? [["Semana", "Mes", "Fecha Pago", "Valor Cuota", "Abono"]] : [["Fecha Pago", "Valor Cuota", "Abono"]];
                    let tableBody = payments.map(p => {
                        return isWeekly 
                            ? [p.weekNum, p.month, p.date, "$" + p.quotaVal.toLocaleString('es-CO'), "$" + p.amount.toLocaleString('es-CO')]
                            : [p.date, "$" + p.quotaVal.toLocaleString('es-CO'), "$" + p.amount.toLocaleString('es-CO')];
                    });

                    doc.autoTable({
                        head: tableHead,
                        body: tableBody,
                        startY: y,
                        theme: 'grid'
                    });
                    doc.save(`Historial_Pagos_${debtor.name}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        async function downloadDashboardReport(format) {
            const loadingModal = document.getElementById('import-loading-modal');
            const loadingText = loadingModal.querySelector('h3');
            loadingText.textContent = "Generando archivo...";
            loadingModal.style.display = 'flex';

            try {
                const date = new Date();
                const dateStr = `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()}`;

                if (format === 'excel') {
                    const wb = XLSX.utils.book_new();
                    
                    // Hoja Cobros
                    const cobrosData = currentDashboardCobrosData.map(c => ({
                        "ASESOR": c.asesor,
                        "MUNICIPIO": c.municipio,
                        "COBRO": c.cobro,
                        "RECAUDO": c.recaudo,
                        "% COBRO": (c.cobro > 0 ? Math.round((c.recaudo / c.cobro) * 100) : 0) + '%'
                    }));
                    const wsCobros = XLSX.utils.json_to_sheet(cobrosData);
                    XLSX.utils.book_append_sheet(wb, wsCobros, "Cobros");

                    // Hoja Créditos
                    const creditosData = currentDashboardCreditosData.map(c => ({
                        "ASESOR": c.asesor_name,
                        "MUNICIPIO": c.municipality,
                        "TIPO CREDITO": c.credit_type,
                        "VALOR CREDITO": Number(c.sale_value) || 0,
                        "GANANCIAS": Number(c.interests) || 0,
                        "CUOTA": c.number_of_payments
                    }));
                    const wsCreditos = XLSX.utils.json_to_sheet(creditosData);
                    XLSX.utils.book_append_sheet(wb, wsCreditos, "Creditos");

                    XLSX.writeFile(wb, `Dashboard_${dateStr}.xlsx`);
                } else {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'mm', 'a4');
                    
                    doc.text("Tablero de Control - Cobros", 14, 15);
                    const cobrosRows = currentDashboardCobrosData.map(c => [
                        c.asesor, c.municipio, 
                        "$" + c.cobro.toLocaleString('es-CO'), 
                        "$" + c.recaudo.toLocaleString('es-CO'), 
                        (c.cobro > 0 ? Math.round((c.recaudo / c.cobro) * 100) : 0) + '%'
                    ]);
                    doc.autoTable({ head: [["Asesor", "Municipio", "Cobro", "Recaudo", "% Cobro"]], body: cobrosRows, startY: 20 });

                    doc.addPage();
                    doc.text("Tablero de Control - Créditos", 14, 15);
                    const creditosRows = currentDashboardCreditosData.map(c => [
                        c.asesor_name, c.municipality, c.credit_type,
                        "$" + (Number(c.sale_value)||0).toLocaleString('es-CO'),
                        "$" + (Number(c.interests)||0).toLocaleString('es-CO'),
                        c.number_of_payments
                    ]);
                    doc.autoTable({ head: [["Asesor", "Municipio", "Tipo", "Valor", "Ganancias", "Cuota"]], body: creditosRows, startY: 20 });
                    
                    doc.save(`Dashboard_${dateStr}.pdf`);
                }
                showToast("Descarga completada");
            } catch (error) { console.error(error); alert("Error al descargar: " + error.message); } finally { loadingModal.style.display = 'none'; }
        }

        document.getElementById('download-report-payments-details-btn').addEventListener('click', () => {
            currentDownloadContext = 'payment_details';
            downloadFormatModal.style.display = 'flex';
        });

        document.getElementById('download-report-credits-details-btn').addEventListener('click', () => {
            currentDownloadContext = 'credits';
            downloadFormatModal.style.display = 'flex';
        });

        // Cerrar modales de reportes (solo con X)
        document.getElementById('close-report-payments-modal-btn').addEventListener('click', () => {
            document.getElementById('view-report-payments-modal').style.display = 'none';
        });

        document.getElementById('close-report-credits-modal-btn').addEventListener('click', () => {
            document.getElementById('view-report-credits-modal').style.display = 'none';
        });

        // Guardar cambios de edición
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('edit-user-uid').value;
            const name = document.getElementById('edit-user-name').value;
            const cedula = document.getElementById('edit-user-cedula').value;
            const updateData = { name: name, cedula: cedula };

            if (isMasterAdmin) {
                const role = document.getElementById('edit-user-role').value;
                updateData.role = role;
                updateData.isAdmin = (role === 'Administrador');
            }

            updateData.assignedMunicipality = currentEditAssignedMunicipalities;

            const submitBtn = editUserForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="small-spinner" style="border-top-color: white;"></div> Actualizando...';
            submitBtn.disabled = true;
            
            try {
                // 1. Obtener nombre anterior para actualizar referencias
                const { data: userDoc, error: fetchError } = await supabase.from('users').select('name').eq('id', uid).single();
                const oldName = userDoc ? userDoc.name : '';

                // 2. Actualizar usuario principal
                const { error: updateError } = await supabase.from('users').update(updateData).eq('id', uid);
                if (updateError) throw updateError;

                // 3. Actualizar referencias en otras colecciones si el nombre cambió
                if (oldName && oldName !== name) {
                    const updatePromises = [];

                    // Colecciones que usan 'asesorName'
                    const collectionsAsesor = ['debtors', 'clients'];
                    for (const col of collectionsAsesor) {
                        updatePromises.push(
                            supabase.from(col).update({ asesor_name: name }).eq('asesor_name', oldName)
                        );
                    }

                    // Colecciones que usan 'userName'
                    const collectionsUser = ['payments', 'reports', 'expenses', 'wexpenses', 'wreports'];
                    for (const col of collectionsUser) {
                        updatePromises.push(
                            supabase.from(col).update({ user_name: name }).eq('user_name', oldName)
                        );
                    }

                    // Ejecutar todas las actualizaciones
                    if (updatePromises.length > 0) {
                        await Promise.all(updatePromises);
                    }
                }

                editUserModal.style.display = 'none';
                showToast("Usuario editado exitosamente");
                loadUsers();
            } catch (error) {
                console.error("Error al actualizar usuario:", error);
                editUserError.textContent = "Error al actualizar: " + error.message;
                editUserError.style.display = 'block';
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // --- LÓGICA DE EDICIÓN DE GASTOS ---

        // Ver Detalles de Gastos
        viewUserReportsBody.addEventListener('click', async (e) => {
            const btn = e.target.closest('.view-expense-details-btn');
            if (btn) {
                const reportDateStr = btn.dataset.date;
                const userName = btn.dataset.user;
                
                try {
                    const [day, month, year] = reportDateStr.split('-').map(Number);
                    const startDate = new Date(year, month - 1, day, 0, 0, 0);
                    const endDate = new Date(year, month - 1, day, 23, 59, 59);
                    
                    const { data: expenseData, error } = await supabase
                        .from('expenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1)
                        .single();

                    if (!expenseData) {
                        alert("No se encontraron detalles de gastos.");
                        return;
                    }

                    const data = expenseData;
                    const othersVal = (data.others && data.others.length > 0) ? data.others[0] : 0;
                    const othersDesc = (data.others && data.others.length > 1) ? data.others[1] : '';

                    const content = document.getElementById('expenses-details-content');
                    content.innerHTML = `
                        <p><strong>Gasolina:</strong> $${(data.fuel || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Almuerzo:</strong> $${(data.lunch || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Otros:</strong> $${Number(othersVal).toLocaleString('es-CO')} <br> <span style="font-size: 0.9em; color: #666;">(Este gasto es de: ${othersDesc || 'Sin descripción'})</span></p>
                    `;
                    viewExpensesDetailsModal.style.display = 'flex';

                } catch (error) {
                    console.error("Error al ver detalles:", error);
                }
            }
        });

        viewUserReportsBody.addEventListener('click', async (e) => {
            const btn = e.target.closest('.edit-expense-btn');
            if (btn) {
                const reportDateStr = btn.dataset.date; // dd-MM-yyyy
                const userName = btn.dataset.user;

                if (!reportDateStr || !userName) return;

                try {
                    // Convertir fecha string a rango de timestamps para la consulta
                    const [day, month, year] = reportDateStr.split('-').map(Number);
                    const startDate = new Date(year, month - 1, day, 0, 0, 0);
                    const endDate = new Date(year, month - 1, day, 23, 59, 59, 999);

                    const { data: doc, error } = await supabase
                        .from('expenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1)
                        .single();

                    if (!doc) {
                        alert("No se encontró el registro de gastos detallado para esta fecha.");
                        return;
                    }

                    const data = doc;

                    document.getElementById('edit-expenses-id').value = doc.id;
                    document.getElementById('edit-expenses-user').value = userName;
                    document.getElementById('edit-expenses-date').value = reportDateStr;
                    document.getElementById('edit-expenses-collection').value = 'expenses';
                    editExpensesFuel.value = formatCurrency(data.fuel || 0);
                    editExpensesLunch.value = formatCurrency(data.lunch || 0);
                    editExpensesOthers.value = formatCurrency((data.others && data.others.length > 0) ? data.others[0] : 0);
                    editExpensesOthersDesc.value = (data.others && data.others.length > 1) ? data.others[1] : ''; // Guardar descripción actual
                    calculateExpensesTotal();

                    editExpensesModal.style.display = 'flex';

                } catch (error) {
                    console.error("Error al buscar gastos:", error);
                    alert("Error al cargar gastos: " + error.message);
                }
            }
        });

        function formatCurrency(value) {
            // Si es número, formatear. Si es string, limpiar y formatear.
            let num = typeof value === 'number' ? value : Number(value.toString().replace(/\D/g, ''));
            return '$' + num.toLocaleString('es-CO');
        }

        function parseCurrency(value) {
            return Number(value.replace(/\D/g, ''));
        }

        function calculateExpensesTotal() {
            const fuel = parseCurrency(editExpensesFuel.value) || 0;
            const lunch = parseCurrency(editExpensesLunch.value) || 0;
            const others = parseCurrency(editExpensesOthers.value) || 0;
            editExpensesTotal.value = formatCurrency(fuel + lunch + others);
        }

        [editExpensesFuel, editExpensesLunch, editExpensesOthers].forEach(input => {
            input.addEventListener('input', (e) => {
                // Formatear el input actual enquanto se escribe
                e.target.value = formatCurrency(parseCurrency(e.target.value));
                calculateExpensesTotal();
            });
        });

        editExpensesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-expenses-id').value;
            const userName = document.getElementById('edit-expenses-user').value;
            const reportDateStr = document.getElementById('edit-expenses-date').value;
            const collectionName = document.getElementById('edit-expenses-collection').value || 'expenses';
            const timestamp = Number(document.getElementById('edit-expenses-timestamp').value);
            const fuel = parseCurrency(editExpensesFuel.value);
            const lunch = parseCurrency(editExpensesLunch.value);
            const othersVal = parseCurrency(editExpensesOthers.value);
            const othersDesc = document.getElementById('edit-expenses-others-desc').value; // Recuperar descripción
            const total = parseCurrency(editExpensesTotal.value);

            try {
                await supabase.from(collectionName).update({
                    fuel: fuel,
                    lunch: lunch,
                    others: [othersVal, othersDesc], // Guardar valor y descripción original
                    total_expenses: total
                }).eq('id', id);

                // Actualizar Reporte Automáticamente (Diario)
                if (collectionName === 'expenses' && userName && reportDateStr) {
                    const { data: reportDoc, error } = await supabase.from('reports')
                        .select('*')
                        .eq('user_name', userName)
                        .eq('report_date', reportDateStr)
                        .limit(1)
                        .single();

                    if (reportDoc) {
                        const rData = reportDoc;
                        const payments = Number(rData.payments_report) || 0;
                        const baseInicial = Number(rData.initial_base) || 0;
                        const credits = Number(rData.credits_report) || 0;
                        const gastos = total;
                        const final_base = (baseInicial + payments) - (credits + gastos);

                        const updatePayload = { expense_report: gastos };
                        if (rData.og_final_base !== undefined && rData.og_final_base !== null) {
                            updatePayload.og_final_base = final_base;
                        } else {
                            updatePayload.final_base = final_base;
                        }
                        await supabase.from('reports').update(updatePayload).eq('id', reportDoc.id);
                    }
                }
                // Actualizar Reporte Automáticamente (Semanal)
                else if (collectionName === 'wexpenses' && userName && timestamp) {
                    const reportDate = new Date(timestamp);
                    const startDate = new Date(reportDate); startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(reportDate); endDate.setHours(23, 59, 59, 999);

                    const { data: reportDoc, error } = await supabase.from('wreports')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1).single();

                    if (reportDoc) {
                        const rData = reportDoc;
                        const payments = Number(rData.payments_report) || 0;
                        const baseInicial = Number(rData.initial_base) || 0;
                        const credits = Number(rData.credits_report) || 0;
                        const gastos = total;
                        const final_base = (baseInicial + payments) - (credits + gastos);

                        const updatePayload = { expense_report: gastos };
                        if (rData.og_final_base !== undefined && rData.og_final_base !== null) {
                            updatePayload.og_final_base = final_base;
                        } else {
                            updatePayload.final_base = final_base;
                        }
                        await supabase.from('wreports').update(updatePayload).eq('id', reportDoc.id);
                    }
                }

                showToast("Gastos actualizados correctamente");
                editExpensesModal.style.display = 'none';
                refreshActiveReportView();
                // Nota: La tabla de reportes no se actualiza automáticamente porque lee de 'reports', no de 'expenses'.
            } catch (error) {
                console.error("Error al actualizar gastos:", error);
                alert("Error al actualizar: " + error.message);
            }
        });

        closeEditExpensesModalBtn.addEventListener('click', () => {
            editExpensesModal.style.display = 'none';
        });

        closeViewExpensesDetailsBtn.addEventListener('click', () => {
            viewExpensesDetailsModal.style.display = 'none';
        });

        // --- LÓGICA DE BÚSQUEDA DE CLIENTES ---

        openSearchClientBtn.addEventListener('click', () => {
            searchClientInput.value = '';
            searchClientModal.style.display = 'flex';
            searchClientInput.focus();
        });

        closeSearchClientModalBtn.addEventListener('click', () => {
            searchClientModal.style.display = 'none';
        });

        btnSearchCedula.addEventListener('click', () => {
            const term = searchClientInput.value.trim();
            if (!term) return alert("Ingrese una cédula");
            performClientSearch(term, 'cedula');
        });

        btnSearchName.addEventListener('click', () => {
            const term = searchClientInput.value.trim();
            if (!term) return alert("Ingrese un nombre");
            performClientSearch(term, 'name');
        });

        // Lógica para Filtrar por Asesor en Clientes
        btnFilterAdvisor.addEventListener('click', async () => {
            // Llenar input searchable de asesores
            const options = ['Todos los Usuarios'];
            const { data: users, error } = await supabase.from('users').select('name').order('name');
            if (error) { console.error(error); return; }

            users.forEach(user => {
                options.push(user.name);
            });
            setupSearchableInput('filter-advisor-select', 'list-filter-advisor-select', options);
            filterAdvisorModal.style.display = 'flex';
        });

        closeFilterAdvisorModalBtn.addEventListener('click', () => {
            filterAdvisorModal.style.display = 'none';
        });

        btnSearchAdvisor.addEventListener('click', () => {
            const advisor = filterAdvisorSelect.value;
            if (!advisor) return alert("Seleccione un asesor");
            performClientSearch(advisor, 'asesor');
            filterAdvisorModal.style.display = 'none';
        });

        // Lógica para Filtrar por Municipio en Clientes
        btnFilterMunicipality.addEventListener('click', async () => {
            // Cargar departamentos desde la colección 'municipality'
            const deptInput = document.getElementById('filter-municipality-department');
            deptInput.value = '';
            deptInput.placeholder = 'Cargando...';
            
            try {
                const { data: depts, error } = await supabase.from('municipalities').select('department');
                const departments = [...new Set(depts.map(d => d.department))].sort();
                
                setupSearchableInput('filter-municipality-department', 'list-filter-municipality-department', departments, true);
                deptInput.placeholder = 'Seleccionar Departamento...';

                if (departments.length === 1) {
                    deptInput.value = departments[0];
                    deptInput.disabled = true;
                    loadMunicipalitiesForSelect(departments[0], filterMunicipalitySelect, true, true);
                } else {
                    deptInput.disabled = false;
                }

                filterMunicipalityModal.style.display = 'flex';
            } catch (error) {
                console.error("Error cargando departamentos:", error);
                alert("Error al cargar departamentos.");
            }
        });

        document.getElementById('filter-municipality-department').addEventListener('change', (e) => {
            loadMunicipalitiesForSelect(e.target.value, filterMunicipalitySelect, true, true);
        });

        closeFilterMunicipalityModalBtn.addEventListener('click', () => {
            filterMunicipalityModal.style.display = 'none';
        });

        btnSearchMunicipality.addEventListener('click', () => {
            const municipality = filterMunicipalitySelect.value;
            const department = document.getElementById('filter-municipality-department').value;
            if (!municipality) return alert("Seleccione un municipio");
            performClientSearch(municipality, 'municipality', false, department);
            filterMunicipalityModal.style.display = 'none';
        });

        // --- LÓGICA DE ELIMINACIÓN MÚLTIPLE ---

        btnMultiDeleteMode.addEventListener('click', () => {
            isMultiDeleteMode = true;
            updateMultiDeleteUI();
        });

        document.getElementById('btn-cancel-multi-delete').addEventListener('click', () => {
            exitMultiDeleteMode();
        });

        function exitMultiDeleteMode() {
            isMultiDeleteMode = false;
            updateMultiDeleteUI();
            // Desmarcar todos
            const checkboxes = document.querySelectorAll('.client-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            document.getElementById('select-all-clients').checked = false;
        }

        function updateMultiDeleteUI() {
            const cols = document.querySelectorAll('.multi-delete-col');
            if (isMultiDeleteMode) {
                btnMultiDeleteMode.style.display = 'none';
                multiDeleteControls.style.display = 'flex';
                cols.forEach(el => el.style.display = 'table-cell');
                updateMultiDeleteCount();
            } else {
                btnMultiDeleteMode.style.display = 'inline-flex';
                multiDeleteControls.style.display = 'none';
                cols.forEach(el => el.style.display = 'none');
            }
        }

        document.getElementById('select-all-clients').addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.client-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateMultiDeleteCount();
        });

        function updateMultiDeleteCount() {
            const count = document.querySelectorAll('.client-checkbox:checked').length;
            document.getElementById('multi-delete-count').textContent = `${count} seleccionados`;
        }

        // Delegación para checkboxes individuales
        clientsTableBody.addEventListener('change', (e) => {
            if (e.target.classList.contains('client-checkbox')) {
                updateMultiDeleteCount();
            }
        });

        btnConfirmMultiDelete.addEventListener('click', async () => {
            const selected = document.querySelectorAll('.client-checkbox:checked');
            if (selected.length === 0) return alert("No hay clientes seleccionados.");
            
            if (!confirm(`¿Estás seguro de eliminar ${selected.length} clientes? Esta acción borrará permanentemente a los clientes, sus créditos, pagos y cupos.`)) return;

            const originalText = btnConfirmMultiDelete.innerHTML;
            btnConfirmMultiDelete.innerHTML = '<div class="small-spinner" style="border-top-color: white;"></div> Eliminando...';
            btnConfirmMultiDelete.disabled = true;

            try {
                // Procesar eliminaciones en paralelo (o en lotes si son muchos, aquí usamos Promise.all)
                const deletePromises = Array.from(selected).map(async (cb) => {
                    const id = cb.value;
                    const cedula = cb.dataset.cedula;
                    
                    // Reutilizamos la lógica de eliminación completa
                    await deleteClientFullData(id, cedula);
                });

                await Promise.all(deletePromises);
                
                showToast(`${selected.length} clientes eliminados correctamente.`);
                exitMultiDeleteMode();
                refreshClientView(); // Recargar vista de clientes
            } catch (error) {
                console.error("Error en eliminación múltiple:", error);
                alert("Ocurrió un error al eliminar algunos clientes: " + error.message);
            } finally {
                btnConfirmMultiDelete.innerHTML = originalText;
                btnConfirmMultiDelete.disabled = false;
            }
        });

        async function performClientSearch(term, type, isBackground = false, extraFilter = null) {
            if (!isBackground) {
                searchClientModal.style.display = 'none';
                workspaceLoader.style.display = 'flex';
                clientsView.style.display = 'none';
                clientsTableBody.innerHTML = '';
            }

            // Actualizar estado de búsqueda
            isClientSearchActive = true;
            lastClientSearchTerm = term;
            lastClientSearchType = type;

            try {
                // Obtener todos los clientes para filtrar en memoria (case-insensitive)
                const [{ data: clientsSnapshot }, { data: debtorsSnapshot }, { data: alertsSnapshot }] = await Promise.all([
                    supabase.from('clients').select('*').order('name'),
                    supabase.from('debtors').select('*'),
                    supabase.from('alerts_represt').select('*')
                ]);

                let filteredDocs = [];
                if (type === 'cedula_list') {
                    filteredDocs = clientsSnapshot.filter(doc => term.includes(doc.cedula));
                } else if (type === 'cedula') {
                    filteredDocs = clientsSnapshot.filter(doc => doc.cedula === term);
                } else if (type === 'asesor') {
                    if (term === 'Todos los Usuarios') {
                        filteredDocs = clientsSnapshot;
                    } else {
                        filteredDocs = clientsSnapshot.filter(doc => doc.asesor_name === term);
                    }
                } else if (type === 'municipality') {
                    if (term === 'Todos los Municipios') {
                        if (extraFilter) {
                            const { data: deptMunisData } = await supabase.from('municipalities').select('name').eq('department', extraFilter);
                            const deptMunis = deptMunisData ? deptMunisData.map(m => m.name) : [];
                            filteredDocs = clientsSnapshot.filter(doc => deptMunis.includes(doc.municipality));
                        } else {
                            filteredDocs = clientsSnapshot;
                        }
                    } else {
                        filteredDocs = clientsSnapshot.filter(doc => doc.municipality === term);
                    }
                } else {
                    // Búsqueda por nombre (Case insensitive y parcial)
                    const lowerTerm = term.toLowerCase();
                    filteredDocs = clientsSnapshot.filter(doc => {
                        const name = (doc.name || '').toLowerCase();
                        return name.includes(lowerTerm);
                    });
                }

                renderClientsList(filteredDocs, debtorsSnapshot, alertsSnapshot);

            } catch (error) {
                console.error("Error en búsqueda:", error);
                if (!isBackground) alert("Error al buscar: " + error.message);
            } finally {
                if (!isBackground) {
                    workspaceLoader.style.display = 'none';
                    clientsView.style.display = 'block';
                }
            }
        }

        // --- LÓGICA DE GESTIÓN DE CLIENTES ---

        function refreshClientView() {
            if (isClientSearchActive) {
                performClientSearch(lastClientSearchTerm, lastClientSearchType);
            } else {
                // Si no hay búsqueda activa, mostrar el mensaje inicial en lugar de cargar todos los clientes.
                const colspan = isMultiDeleteMode ? 7 : 6;
                clientsTableBody.innerHTML = `<tr><td colspan="${colspan}" style="text-align:center;">Busque al cliente a revisar</td></tr>`;
            }
        }

        // Cargar Clientes
        async function loadClients(isBackground = false) {
            if (!isBackground) {
                workspaceLoader.style.display = 'flex';
                clientsView.style.display = 'none';
                clientsTableBody.innerHTML = '';
            }
            try {
                const [{ data: clientsSnapshot }, { data: debtorsSnapshot }, { data: alertsSnapshot }] = await Promise.all([
                    supabase.from('clients').select('*').order('name'),
                    supabase.from('debtors').select('*'),
                    supabase.from('alerts_represt').select('*')
                ]);
                renderClientsList(clientsSnapshot, debtorsSnapshot, alertsSnapshot);

            } catch (e) {
                console.error(e);
                clientsTableBody.innerHTML = '<tr><td colspan="6">Error al cargar clientes</td></tr>';
            } finally {
                if (!isBackground) {
                    workspaceLoader.style.display = 'none';
                    clientsView.style.display = 'block';
                }
            }
        }

        function renderClientsList(clientsList, debtorsSnapshot, alertsSnapshot) {
            // Verificar créditos abiertos y calcular recaudo por cédula en debtors
            const openCreditsMap = new Map(); // Map cedula -> count
            const alertsMap = new Map(); // Map cedula -> alertDocId

            if (alertsSnapshot) {
                alertsSnapshot.forEach(d => {
                    if (d.cedula) { // d es ahora el objeto de datos
                        alertsMap.set(d.cedula, { id: d.id, represt: d.represt === true });
                    }
                });
            }

            debtorsSnapshot.forEach(d => {
                if (d.cedula) {
                    // Crédito Abierto: Si tiene saldo pendiente (balance > 0)
                    if (d.balance !== undefined && Number(d.balance) > 0) {
                        const current = openCreditsMap.get(d.cedula) || 0;
                        openCreditsMap.set(d.cedula, current + 1);
                    }
                }
            });

            let html = '';
            // Determinar si está vacío (soporte para QuerySnapshot y Array)
            const isEmpty = !clientsList || clientsList.length === 0;

            if (isEmpty) {
                const colspan = isMultiDeleteMode ? 7 : 6;
                html = `<tr><td colspan="${colspan}" style="text-align:center;">No se encontraron clientes.</td></tr>`;
            } else {
                clientsList.forEach(data => { // data es ahora el objeto de la fila
                    const openCreditsCount = openCreditsMap.get(data.cedula) || 0;
                    const alertInfo = alertsMap.get(data.cedula);
                    
                    let statusHtml = '';
                    if (alertInfo && alertInfo.represt === false) {
                        statusHtml = `<button class="btn status-btn-alert" data-id="${doc.id}" data-alert-id="${alertInfo.id}" style="background-color: #3498db; color: white; border: none; border-radius: 12px; padding: 5px 10px; cursor: pointer; font-size: 12px;">Intento de pago represte</button>`;
                    } else if (data.closed === true) {
                        statusHtml = `<button class="btn status-btn-closed" data-id="${doc.id}" style="background-color: #95a5a6; color: white; border: none; border-radius: 12px; padding: 5px 10px; cursor: pointer; font-size: 12px;">Crédito cerrado</button>`;
                    } else {
                        if (openCreditsCount >= 2) {
                            statusHtml = `<span class="type-sale" style="background-color: #e74c3c;">${openCreditsCount} Créditos Abiertos</span>`;
                        } else if (openCreditsCount === 1) {
                            statusHtml = `<span class="type-sale" style="background-color: #e74c3c;">Crédito Abierto</span>`;
                        } else {
                            statusHtml = `<span class="type-payment" style="background-color: #2ecc71;">Sin Crédito</span>`;
                        }
                    }
                    
                    // Manejar si es string o array para soportar múltiples selecciones
                    let freqs = [];
                    if (Array.isArray(data.payment_term)) {
                        freqs = data.payment_term;
                    } else {
                        freqs = [data.payment_term || 'Diario'];
                    }

                    html += `<tr>
                        <td class="multi-delete-col" style="display: ${isMultiDeleteMode ? 'table-cell' : 'none'}; text-align: center;">
                            <input type="checkbox" class="client-checkbox" value="${data.id}" data-cedula="${data.cedula}">
                        </td>
                        <td>${data.name || 'N/A'}</td>
                        <td>${data.cedula || 'N/A'}</td>
                        <td>${data.phone || 'N/A'}</td>
                        <td>${data.municipality || 'N/A'}</td>
                        <td>${statusHtml}</td>
                        <td>
                            <button class="btn view-details-btn" data-cedula="${data.cedula}" data-name="${data.name}" style="background-color: #2ecc71; padding: 5px 10px; margin-right: 5px;"><i class="fas fa-eye"></i></button>
                            <button class="btn edit-client-btn" data-id="${data.id}" style="background-color: #f39c12; padding: 5px 10px; margin-right: 5px;" title="Editar Cliente"><i class="fas fa-edit"></i></button>
                            <button class="btn enable-credit-btn" data-cedula="${data.cedula}" data-freqs="${freqs.join(',')}" style="background-color: #9b59b6; padding: 5px 10px; margin-right: 5px;" title="Habilitar Crédito"><i class="fas fa-plus-circle"></i></button>
                            <button class="btn delete-client-btn" data-id="${data.id}" data-cedula="${data.cedula}" data-name="${data.name}" style="background-color: #e74c3c; padding: 5px 10px;"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            }
            clientsTableBody.innerHTML = html;
        }

        // Eliminar Cliente
        clientsTableBody.addEventListener('click', async (e) => {
            // Ver Detalles
            const viewBtn = e.target.closest('.view-details-btn');
            if (viewBtn) {
                const cedula = viewBtn.dataset.cedula;
                const name = viewBtn.dataset.name;
                openClientDetails(cedula, name);
                return;
            }

            // Editar Cliente
            const editBtn = e.target.closest('.edit-client-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                openEditClientModal(id);
                return;
            }

            // Habilitar Crédito (Nuevo espacio vacío)
            const enableBtn = e.target.closest('.enable-credit-btn');
            if (enableBtn) {
                const cedula = enableBtn.dataset.cedula;
                const clientFreqsStr = enableBtn.dataset.freqs || '';
                const clientFreqs = clientFreqsStr ? clientFreqsStr.split(',') : [];
                const name = e.target.closest('tr').cells[0].textContent; // Obtener nombre de la fila
                
                // UI: Spinner
                const originalContent = enableBtn.innerHTML;
                enableBtn.innerHTML = '<div class="small-spinner" style="border-top-color: white;"></div>';
                enableBtn.disabled = true;

                try {
                    // 1. Verificar si ya tiene cupo extra habilitado en tabla 'extras'
                    const { data: extrasSnapshot, error: extrasError } = await supabase
                        .from('extras')
                        .select('id')
                        .where('cedula', '==', cedula)
                        .where('valid', '==', true);

                    if (extrasSnapshot && extrasSnapshot.length > 0) {
                        alert("El cliente ya tiene un cupo extra habilitado (pendiente de uso).");
                        return;
                    }

                    // 2. Verificar créditos activos en tabla 'debtors'
                    const { data: debtorsSnapshot, error: debtorsError } = await supabase.from('debtors').select('*').eq('cedula', cedula);
                    if (debtorsError) throw debtorsError;

                    let maxRemaining = 0;
                    let activeCreditsCount = 0;
                    let activeFrequencies = [];

                    debtorsSnapshot.forEach(d => {
                        if (d.balance > 0) {
                            activeCreditsCount++;
                            let freq = d.payment_term;
                            // Fallback: Si el crédito no tiene frecuencia (dato antiguo), usar la del cliente
                            if (!freq && clientFreqs.length > 0) {
                                freq = clientFreqs[0]; 
                            }
                            if (freq) activeFrequencies.push(freq);
                            const rem = Number(d.remainingPayments) || 0;
                            if (rem > maxRemaining) maxRemaining = rem;
                        }
                    });

                    // REGLA: Si tiene 2 activos y en mora (o simplemente 2 activos), no dejar abrir más.
                    if (activeCreditsCount >= 2) {
                        alert("El cliente ya tiene 2 cupos activos. Debe estar al día con ambos para habilitar nuevos cupos.");
                        return;
                    }

                    // Si tiene 2 o más pagos pendientes, mostrar modal de advertencia
                    if (maxRemaining >= 2) {
                        clientToEnableCredit = { cedula: cedula, name: name, activeFrequencies: activeFrequencies }; // Guardar contexto
                        moraWarningMessage.textContent = `El cliente tiene ${maxRemaining} pagos pendientes en un crédito activo. ¿Desea habilitar un nuevo cupo de todas formas?`;
                        moraAuthInput.value = ''; // Limpiar input
                        moraWarningModal.style.display = 'flex';
                        
                        // Restaurar botón y salir, esperando interacción con el modal
                        enableBtn.innerHTML = originalContent;
                        enableBtn.disabled = false;
                        return;
                    }

                    // Si no hay mora, abrir directamente el modal de frecuencia
                    openFrequencyModal(cedula, name, activeFrequencies);

                } catch (error) {
                    console.error(error);
                    alert("Error al habilitar crédito: " + error.message);
                } finally {
                    enableBtn.innerHTML = originalContent;
                    enableBtn.disabled = false;
                }
                return;
            }

            const btn = e.target.closest('.delete-client-btn');
            if (btn) {
                clientToDelete = {
                    id: btn.dataset.id,
                    cedula: btn.dataset.cedula,
                    name: btn.dataset.name
                };
                deleteClientNameDisplay.textContent = clientToDelete.name;
                deleteMainOptions.style.display = 'block';
                quotasListView.style.display = 'none';
                deleteOptionsModal.style.display = 'flex';
                return;
            }

            // Botón Crédito Cerrado (Gris)
            const closedBtn = e.target.closest('.status-btn-closed');
            if (closedBtn) {
                document.getElementById('reactivate-client-id').value = closedBtn.dataset.id;
                reactivateCreditModal.style.display = 'flex';
                return;
            }

            // Botón Alerta Represte (Azul)
            const alertBtn = e.target.closest('.status-btn-alert');
            if (alertBtn) {
                document.getElementById('approve-represt-client-id').value = alertBtn.dataset.id;
                document.getElementById('approve-represt-alert-id').value = alertBtn.dataset.alertId;
                approveReprestModal.style.display = 'flex';
                return;
            }
        });

        // Función auxiliar para verificar el estado del crédito (Rojo > 2 pagos restantes)
        async function checkClientCreditStatus(cedula) {
            const { data: snapshot, error } = await supabase.from('debtors').select('balance, remaining_payments').eq('cedula', cedula);
            if (!snapshot || snapshot.length === 0) return 'GREEN'; // Sin créditos es seguro

            let isRed = false;
            snapshot.forEach(data => {
                // Si tiene saldo pendiente Y más de 2 pagos restantes -> ROJO
                if (data.balance > 0 && Number(data.remaining_payments) > 2) {
                    isRed = true;
                }
            });
            return isRed ? 'RED' : 'GREEN';
        }

        // Función auxiliar para abrir el modal de frecuencia
        function openFrequencyModal(cedula, name, activeFrequencies = []) {
            clientToEnableCredit = { cedula: cedula, name: name };
            enableCreditClientName.textContent = name;
            
            // Resetear checkboxes
            checkFreqDiario.checked = false;
            checkFreqSemanal.checked = false;
            checkFreqDiario.disabled = false;
            checkFreqSemanal.disabled = false;
            
            // Preseleccionar Diario por defecto
            checkFreqDiario.checked = true;
            
            enableCreditModal.style.display = 'flex';
        }

        // --- LÓGICA DEL MODAL DE HABILITAR CUPO EXTRA ---

        closeEnableCreditModalBtn.addEventListener('click', () => {
            enableCreditModal.style.display = 'none';
        });

        // Lógica para checkboxes mutuamente excluyentes en el modal
        function handleModalFreqCheck(e) {
            if (e.target.checked) {
                if (e.target === checkFreqDiario) {
                    checkFreqSemanal.checked = false;
                } else if (e.target === checkFreqSemanal) {
                    checkFreqDiario.checked = false;
                }
            }
        }
        checkFreqDiario.addEventListener('change', handleModalFreqCheck);
        checkFreqSemanal.addEventListener('change', handleModalFreqCheck);

        // --- LÓGICA DEL MODAL DE ADVERTENCIA DE MORA ---
        
        btnAcceptMora.addEventListener('click', () => {
            if (moraAuthInput.value !== 'AUTORIZAR') {
                alert('Debe escribir "AUTORIZAR" correctamente para continuar.');
                return;
            }

            moraWarningModal.style.display = 'none';
            if (clientToEnableCredit) {
                openFrequencyModal(clientToEnableCredit.cedula, clientToEnableCredit.name, clientToEnableCredit.activeFrequencies);
            }
        });

        btnCancelMora.addEventListener('click', () => {
            moraWarningModal.style.display = 'none';
            clientToEnableCredit = null;
        });

        closeMoraWarningBtn.addEventListener('click', () => {
            moraWarningModal.style.display = 'none';
            clientToEnableCredit = null;
        });

        confirmEnableCreditBtn.addEventListener('click', async () => {
            if (!clientToEnableCredit) return;

            // Seleccionar la frecuencia que está marcada Y habilitada (la nueva que se va a crear)
            const selectedFrequency = checkFreqDiario.checked ? 'Diario' : (checkFreqSemanal.checked ? 'Semanal' : null);
            const cedula = clientToEnableCredit.cedula;

            if (!selectedFrequency) {
                alert("Por favor seleccione una frecuencia de pago.");
                return;
            }

            // UI: Loading
            const originalText = confirmEnableCreditBtn.innerHTML;
            confirmEnableCreditBtn.innerHTML = '<div class="small-spinner" style="border-top-color: white;"></div> Procesando...';
            confirmEnableCreditBtn.disabled = true;

            try {
                // 1. Obtener datos completos del cliente de Supabase
                const { data: clientQuery, error: clientError } = await supabase
                    .from('clients')
                    .select('*')
                    .eq('cedula', cedula)
                    .limit(1).single();

                let clientData = { name: clientToEnableCredit.name, cedula: cedula };
                let clientDocId = null;
                
                if (clientQuery) {
                    clientData = clientQuery;
                    clientDocId = clientQuery.id;
                }

                // 2. Crear espacio vacío en extras (Cupo Extra)
                await supabase.from('extras').insert({
                    cedula: cedula,
                    payment_term: selectedFrequency,
                    valid: true
                });

                // 3. Actualizar la frecuencia en el cliente (Mover funcionalidad)
                if (clientDocId) {
                    let currentFreqs = Array.isArray(clientData.payment_term) ? [...clientData.payment_term] : (clientData.payment_term ? [clientData.payment_term] : []);

                    if (!currentFreqs.includes(selectedFrequency)) {
                        currentFreqs.push(selectedFrequency);
                        await supabase.from('clients').update({ payment_term: currentFreqs }).eq('id', clientDocId);
                    }
                }

                showToast("Cupo habilitado con frecuencia " + selectedFrequency);
                enableCreditModal.style.display = 'none';
                refreshClientView(); // Recargar tabla para ver cambios
            } catch (error) {
                console.error("Error al habilitar cupo:", error);
                alert("Error: " + error.message);
            } finally {
                confirmEnableCreditBtn.innerHTML = originalText;
                confirmEnableCreditBtn.disabled = false;
            }
        });

        // --- LÓGICA MODALES NUEVOS (Reactivar y Aprobar Represte) ---

        // Reactivar Crédito
        document.getElementById('close-reactivate-modal-btn').addEventListener('click', () => {
            reactivateCreditModal.style.display = 'none';
        });
        document.getElementById('btn-cancel-reactivate').addEventListener('click', () => {
            reactivateCreditModal.style.display = 'none';
        });
        document.getElementById('btn-confirm-reactivate').addEventListener('click', async () => {
            const clientId = document.getElementById('reactivate-client-id').value;
            try {
                await supabase.from('clients').update({ closed: false }).eq('id', clientId);
                showToast("Crédito reactivado");
                reactivateCreditModal.style.display = 'none';
                refreshClientView();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        // Aprobar Represte
        document.getElementById('close-approve-represt-modal-btn').addEventListener('click', () => {
            approveReprestModal.style.display = 'none';
        });
        document.getElementById('btn-cancel-approve-represt').addEventListener('click', async () => {
            const alertId = document.getElementById('approve-represt-alert-id').value;
            try {
                await supabase.from('alerts_represt').delete().eq('id', alertId);
                showToast("Petición rechazada");
                approveReprestModal.style.display = 'none';
                refreshClientView();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });
        document.getElementById('btn-confirm-approve-represt').addEventListener('click', async () => {
            const alertId = document.getElementById('approve-represt-alert-id').value;
            try {
                await supabase.from('alerts_represt').update({ represt: true }).eq('id', alertId);
                showToast("Pago para represte aprobado");
                approveReprestModal.style.display = 'none';
                refreshClientView();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        // Notificación Alerta
        document.getElementById('close-alert-notification-btn').addEventListener('click', () => {
            alertReprestNotificationModal.style.display = 'none';
        });

        document.getElementById('btn-search-all-alert-clients').addEventListener('click', () => {
            if (represteAlertCedulas.length > 0) {
                alertReprestNotificationModal.style.display = 'none';
                performClientSearch(represteAlertCedulas, 'cedula_list');
            }
        });

        // Cerrar modal de autorización
        closeAuthModalBtn.addEventListener('click', () => {
            authModal.style.display = 'none';
        });
                
        // Cerrar modal al hacer clic fuera
        window.addEventListener('click', (event) => {
            if (event.target === authModal) {
                authModal.style.display = 'none';
            }
            // Evitar que se cierren estos modales al hacer clic fuera
            if (event.target === filterOptionsModal) {
                // No hacer nada, forzar uso de la X
                return;
            }
            if (event.target === viewExpensesDetailsModal) {
                return;
            }
            if (event.target === viewReportPaymentsModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === viewReportCreditsModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === exportReportModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === previewMunicipalitiesModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === exportDateFilterModal) {
                return;
            }
            if (event.target === deleteUserOptionsModal) {
                return;
            }
            if (event.target === pgDateSelectionModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === reactivateCreditModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === approveReprestModal) {
                return; // No cerrar al hacer clic fuera
            }
            if (event.target === viewAssignedMunisModal) {
                return; // No cerrar al hacer clic fuera (Solo X)
            }
            // ... (resto de validaciones de cierre de modales existentes)
        });

        // --- LÓGICA DEL MODAL DE OPCIONES DE ELIMINACIÓN ---

        closeDeleteOptionsBtn.addEventListener('click', () => {
            deleteOptionsModal.style.display = 'none';
        });

        btnBackDeleteOptions.addEventListener('click', () => {
            quotasListView.style.display = 'none';
            deleteMainOptions.style.display = 'block';
        });

        // Opción 1: Eliminar Cliente Completo
        btnConfirmDeleteClient.addEventListener('click', async () => {
            if (!clientToDelete) return;
            
            if (confirm(`¿Estás seguro de eliminar a ${clientToDelete.name}?\n\nEsta acción eliminará permanentemente:\n- El cliente de la base de datos\n- Todos los créditos y cupos habilitados\n- Todo el historial de pagos\n\n¿Desea continuar?`)) {
                const originalText = btnConfirmDeleteClient.innerHTML;
                btnConfirmDeleteClient.innerHTML = '<div class="small-spinner" style="border-top-color: white;"></div> Eliminando...';
                btnConfirmDeleteClient.disabled = true;

                try {
                    await deleteClientFullData(clientToDelete.id, clientToDelete.cedula);

                    showToast("Cliente y datos asociados eliminados");
                    deleteOptionsModal.style.display = 'none';
                    refreshClientView();
                } catch (error) {
                    alert('Error al eliminar: ' + error.message);
                } finally {
                    btnConfirmDeleteClient.innerHTML = originalText;
                    btnConfirmDeleteClient.disabled = false;
                }
            }
        });

        // Función auxiliar para eliminar todos los datos de un cliente (usada en individual y múltiple)
        async function deleteClientFullData(clientId, clientCedula) {
            // 1. Eliminar Cliente
            await supabase.from('clients').delete().eq('id', clientId);

            // 2. Eliminar Créditos y Cupos (Debtors) y sus pagos asociados
            const { data: debtorsSnapshot, error: debtorsError } = await supabase.from('debtors').select('id').eq('cedula', clientCedula);
            const deleteDebtorsPromises = [];
            for (const debtorDoc of debtorsSnapshot) {
                // Borrar pagos asociados al crédito
                deleteDebtorsPromises.push(supabase.from('payments').delete().eq('debtor_id', debtorDoc.id));
                // Borrar el crédito
                deleteDebtorsPromises.push(supabase.from('debtors').delete().eq('id', debtorDoc.id));
            }
            await Promise.all(deleteDebtorsPromises);

            // 3. Eliminar Pagos sueltos (por cédula)
            await supabase.from('payments').delete().eq('cedula', clientCedula);

            // 4. Eliminar Extras (Cupos habilitados no usados)
            await supabase.from('extras').delete().eq('cedula', clientCedula);
        }

        // Opción 2: Mostrar lista de cupos para eliminar uno específico
        btnShowQuotas.addEventListener('click', async () => {
            if (!clientToDelete) return;
            
            quotasListItems.innerHTML = '<div style="padding: 20px; text-align: center;"><div class="spinner" style="width: 30px; height: 30px; margin: 0 auto;"></div></div>';
            deleteMainOptions.style.display = 'none';
            quotasListView.style.display = 'block';

            try {
                const [{ data: debtorsSnapshot }, { data: extrasSnapshot }] = await Promise.all([
                    supabase.from('debtors').select('*').eq('cedula', clientToDelete.cedula),
                    supabase.from('extras').select('*').eq('cedula', clientToDelete.cedula)
                ]);
                
                if ((!debtorsSnapshot || debtorsSnapshot.length === 0) && (!extrasSnapshot || extrasSnapshot.length === 0)) {
                    quotasListItems.innerHTML = '<div style="padding: 15px; text-align: center; color: #777;">No hay cupos o créditos registrados.</div>';
                    return;
                }

                let html = '';
                debtorsSnapshot.forEach(data => {
                    html += `<div class="quota-item">
                        <div class="quota-info">
                            <strong>${data.product || 'Cupo'}</strong><br>
                            <span style="color: #555;">Fecha: ${data.sale_date || 'N/A'}</span><br>
                            <span style="color: #555;">Valor: $${(data.total_credit_value || 0).toLocaleString('es-CO')}</span>
                        </div>
                        <button class="btn btn-delete-quota-item" onclick="deleteSpecificQuota('${data.id}', 'debtors')" style="background-color: #e74c3c; padding: 5px 10px;"><i class="fas fa-trash"></i></button>
                    </div>`;
                });

                extrasSnapshot.forEach(data => {
                    if (data.valid) {
                        html += `<div class="quota-item">
                            <div class="quota-info">
                                <strong>Cupo Extra Habilitado</strong><br>
                                <span style="color: #555;">Frecuencia: ${data.payment_term || 'N/A'}</span><br>
                                <span style="color: #2ecc71;">Pendiente de uso</span>
                            </div>
                            <button class="btn btn-delete-quota-item" onclick="deleteSpecificQuota('${data.id}', 'extras')" style="background-color: #e74c3c; padding: 5px 10px;"><i class="fas fa-trash"></i></button>
                        </div>`;
                    }
                });

                quotasListItems.innerHTML = html;
            } catch (error) {
                console.error(error);
                quotasListItems.innerHTML = '<div style="padding: 15px; color: red;">Error al cargar cupos.</div>';
            }
        });

        // Función global para eliminar un cupo específico desde la lista
        window.deleteSpecificQuota = async (docId, collectionName = 'debtors') => {
            if (confirm('¿Estás seguro de eliminar este registro?')) {
                try {
                    await supabase.from(collectionName).delete().eq('id', docId);
                    showToast("Registro eliminado");
                    // Recargar la lista
                    btnShowQuotas.click();
                    // Actualizar tabla de clientes de fondo si es necesario
                    refreshClientView(); 
                } catch (error) {
                    alert("Error al eliminar: " + error.message);
                }
            }
        };

        // --- LÓGICA DEL MODAL DE OPCIONES DE ELIMINACIÓN DE USUARIO ---
        const deleteUserOptionsModal = document.getElementById('delete-user-options-modal');
        const closeDeleteUserOptionsBtn = document.getElementById('close-delete-user-options-btn');
        const btnDeleteUserOnly = document.getElementById('btn-delete-user-only');
        const btnDeleteDataOnly = document.getElementById('btn-delete-data-only');
        const btnDeleteUserAll = document.getElementById('btn-delete-user-all');
        let userToDelete = null;

        closeDeleteUserOptionsBtn.addEventListener('click', () => {
            deleteUserOptionsModal.style.display = 'none';
            userToDelete = null;
        });

        async function deleteUserData(userName) { // Esta función ahora se ejecuta en el backend (Edge Function)
            const collections = [
                { name: 'debtors', field: 'asesor_name' },
                { name: 'payments', field: 'user_name' },
                { name: 'reports', field: 'user_name' },
                { name: 'expenses', field: 'user_name' },
                { name: 'wreports', field: 'user_name' },
                { name: 'wexpenses', field: 'user_name' },
                { name: 'clients', field: 'asesor_name' }
            ];

            const promises = [];
            for (const col of collections) {
                promises.push(
                    supabase.from(col.name).delete().eq(col.field, userName)
                );
            }
            await Promise.all(promises);
        }

        btnDeleteUserOnly.addEventListener('click', async () => {
            if (!userToDelete) return;
            if (!confirm("¿Confirma eliminar SOLO el acceso del usuario?")) return;
            
            try {
                const { error } = await supabase.functions.invoke('delete-user-and-data', { body: { uid: userToDelete.uid, userName: userToDelete.name, option: 'user_only' } });
                if (error) throw error;
                showToast(`Usuario ${userToDelete.name} eliminado.`);
                deleteUserOptionsModal.style.display = 'none';
                loadUsers();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        btnDeleteDataOnly.addEventListener('click', async () => {
            if (!userToDelete) return;
            if (!confirm("¿Confirma eliminar SOLO los datos del usuario?")) return;

            const originalText = btnDeleteDataOnly.innerHTML;
            btnDeleteDataOnly.innerHTML = '<div class="small-spinner"></div> Eliminando...';
            btnDeleteDataOnly.disabled = true;

            try {
                const { error } = await supabase.functions.invoke('delete-user-and-data', { body: { uid: userToDelete.uid, userName: userToDelete.name, option: 'data_only' } });
                if (error) throw error;
                showToast(`Datos de ${userToDelete.name} eliminados.`);
                deleteUserOptionsModal.style.display = 'none';
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btnDeleteDataOnly.innerHTML = originalText;
                btnDeleteDataOnly.disabled = false;
            }
        });

        btnDeleteUserAll.addEventListener('click', async () => {
            if (!userToDelete) return;
            if (!confirm("¿Confirma eliminar TODO (Usuario y Datos)?")) return;

            const originalText = btnDeleteUserAll.innerHTML;
            btnDeleteUserAll.innerHTML = '<div class="small-spinner"></div> Eliminando...';
            btnDeleteUserAll.disabled = true;

            try {
                const { error } = await supabase.functions.invoke('delete-user-and-data', { body: { uid: userToDelete.uid, userName: userToDelete.name, option: 'all' } });
                if (error) throw error;
                showToast(`Usuario y datos eliminados.`);
                deleteUserOptionsModal.style.display = 'none';
                loadUsers();
            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                btnDeleteUserAll.innerHTML = originalText;
                btnDeleteUserAll.disabled = false;
            }
        });

        // Función para abrir modal de edición de cliente
        async function openEditClientModal(id) {
            try {
                // Parallel fetch: Client doc + Cache warmup
                const [clientResult, departmentsCache] = await Promise.all([
                    supabase.from('clients').select('*').eq('id', id).single(),
                    ensureDepartmentsCache(),
                    ensureUsersCache() // Warm up users cache in parallel
                ]);
                const { data, error } = clientResult;
                if (error || !data) return alert("Cliente no encontrado");

                document.getElementById('edit-client-id').value = id;
                document.getElementById('edit-client-name').value = data.name;
                document.getElementById('edit-client-cedula').value = data.cedula;
                document.getElementById('edit-client-phone').value = data.phone || '';
                document.getElementById('edit-client-address').value = data.address || '';
                
                // Setup Departments Dropdown from cache
                const departments = Object.keys(departmentsCache).sort();
                setupSearchableInput('edit-client-department', 'list-edit-client-department', departments, true);
                
                const deptInput = document.getElementById('edit-client-department');
                const muniInput = document.getElementById('edit-client-municipality');

                // Reset inputs
                deptInput.value = '';
                muniInput.value = '';
                muniInput.disabled = true;

                if (data.municipality) {
                    muniInput.value = data.municipality;
                    
                    // Find department in memory
                    let deptName = null;
                    for (const [dept, munis] of Object.entries(departmentsCache)) {
                        if (munis.includes(data.municipality)) {
                            deptName = dept;
                            break;
                        }
                    }
                    
                    if (deptName) {
                        deptInput.value = deptName;
                        // Cargar la lista de municipios para este departamento
                        await loadMunicipalitiesForSelect(deptName, muniInput, true, false); // false = no incluir "Todos"
                        // Restaurar el valor del municipio (porque loadMunicipalitiesForSelect lo limpia)
                        muniInput.value = data.municipality;
                    } else {
                        muniInput.disabled = false;
                    }
                } else {
                    muniInput.placeholder = 'Seleccione un departamento';
                }

                // Llenar asesores
                await populateAdvisorSelects('edit-client-asesor', data.asesor_name, data.municipality);

                // Establecer frecuencia de pago (Default: Diario)
                editClientPaymentTerm.value = data.paymentTerm || 'Diario';

                editClientModal.style.display = 'flex';
            } catch (error) {
                console.error(error);
                alert("Error al cargar datos del cliente");
            }
        }

        // Guardar cambios de cliente
        editClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-client-id').value;
            
            const newName = document.getElementById('edit-client-name').value;
            const newCedula = document.getElementById('edit-client-cedula').value;
            const newPhone = document.getElementById('edit-client-phone').value;
            const newAddress = document.getElementById('edit-client-address').value;
            const newMunicipality = editClientMunicipality.value;
            const newAsesor = editClientAsesor.value; // Corregido para usar asesor_name
            const newPaymentTerm = [editClientPaymentTerm.value]; // Siempre como array

            const updateData = {
                name: newName,
                cedula: newCedula,
                phone: Number(newPhone) || null,
                address: newAddress,
                municipality: newMunicipality,
                asesorName: newAsesor,
                paymentTerm: newPaymentTerm
            };

            const submitBtn = editClientForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="small-spinner" style="border-top-color: white;"></div> Actualizando...';
            submitBtn.disabled = true;

            try {
                // 1. Obtener datos antiguos para buscar referencias
                const { data: oldData, error: fetchError } = await supabase.from('clients').select('cedula').eq('id', id).single();
                if (fetchError || !oldData) throw new Error("Cliente no encontrado");
                const oldCedula = oldData.cedula;

                // 2. Actualizar Cliente
                await supabase.from('clients').update(updateData).eq('id', id);

                // 3. Actualizar registros relacionados (Debtors y Payments)
                const batchPromises = [];

                // Actualizar Debtors (Créditos)
                batchPromises.push(supabase.from('debtors').update({
                        name: newName,
                        cedula: newCedula,
                        phone: Number(newPhone) || 0,
                        address: newAddress,
                        municipality: newMunicipality,
                        asesor_name: newAsesor
                    })
                    .eq('cedula', oldCedula)
                );

                // Actualizar Payments (Cobros)
                batchPromises.push(supabase.from('payments').update({
                        debtorName: newName,
                        cedula: newCedula,
                        phone: Number(newPhone) || 0,
                        address: newAddress,
                        municipality: newMunicipality,
                        user_name: newAsesor
                    })
                    .eq('cedula', oldCedula)
                );

                await Promise.all(batchPromises);

                editClientModal.style.display = 'none';
                showToast("Cliente y registros asociados actualizados");
                refreshClientView();
            } catch (error) {
                console.error(error);
                alert("Error al actualizar: " + error.message);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        closeEditClientModalBtn.addEventListener('click', () => {
            editClientModal.style.display = 'none';
        });

        // Variables globales para listeners del modal de detalles
        let clientDetailsUnsubscribeDebtors = null;
        let clientDetailsUnsubscribePayments = null;
        let clientDetailsUnsubscribeClient = null;

        // Función para abrir modal de detalles
        function openClientDetails(cedula, name) {
            clientDetailsModal.dataset.cedula = cedula;
            clientDetailsModal.dataset.name = name;
            detailClientName.textContent = name;
            document.getElementById('detail-total-recaudo').textContent = 'Cargando...';
            clientDetailsBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></td></tr>';
            clientDetailsModal.style.display = 'flex';

            // Cargar datos una vez al abrir
            const loadAndRenderDetails = async () => {
                const { data: clientData } = await supabase.from('clients').select('total_recaudo').eq('cedula', cedula).single();
                const { data: paymentsData } = await supabase.from('payments').select('payment_amount').eq('cedula', cedula);
                const { data: debtorsData } = await supabase.from('debtors').select('*').eq('cedula', cedula);

                let totalRecaudo = 0;
                if (clientData) totalRecaudo += (Number(clientData.total_recaudo) || 0);
                if (paymentsData) paymentsData.forEach(p => totalRecaudo += (Number(p.payment_amount) || 0));
                
                document.getElementById('detail-total-recaudo').textContent = '$' + totalRecaudo.toLocaleString('es-CO');

                let html = '';
                if (!debtorsData || debtorsData.length === 0) {
                    html = '<tr><td colspan="8">Este cliente no tiene créditos registrados.</td></tr>';
                } else {
                    debtorsData.sort((a, b) => {
                        const dateA = parseDate(a.sale_date) || new Date(0);
                        const dateB = parseDate(b.sale_date) || new Date(0);
                        return dateB - dateA;
                    });

                    debtorsData.forEach(data => {
                        html += `<tr id="credit-row-${data.id}">
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${data.credit_type || 'N/A'}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(Number(data.valor_cuota) || 0).toLocaleString('es-CO')}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(Number(data.interests) || 0).toLocaleString('es-CO')}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${data.sale_date || 'N/A'}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(Number(data.sale_value) || 0).toLocaleString('es-CO')}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">$${(Number(data.balance) || 0).toLocaleString('es-CO')}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;" class="remaining-cell">${data.remaining_payments ?? 'N/A'}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;" class="term-cell">${data.payment_term || 'N/A'}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${data.asesor_name || 'N/A'}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center; white-space: nowrap;" class="actions-cell">
                                <button class="btn view-credit-payments-btn" data-id="${data.id}" style="background-color: #3498db; padding: 5px; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center;"><i class="fas fa-eye"></i></button>
                                <button class="btn edit-credit-history-btn" data-id="${data.id}" data-remaining="${data.remaining_payments ?? ''}" data-term="${data.payment_term || ''}" style="background-color: #f39c12; padding: 5px; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px;"><i class="fas fa-edit"></i></button>
                                <button class="btn delete-credit-history-btn" data-id="${data.id}" style="background-color: #e74c3c; padding: 5px; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; margin-left: 5px;" title="Eliminar Crédito (Emergencia)"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                    });
                }
                clientDetailsBody.innerHTML = html;
            };
            
            loadAndRenderDetails();
        }

        clientDetailsBody.addEventListener('click', async (e) => {
            const btn = e.target.closest('.view-credit-payments-btn');
            if (btn) {
                const creditId = btn.dataset.id;
                loadCreditPayments(creditId);
                return;
            }

            const editBtn = e.target.closest('.edit-credit-history-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                openEditCreditModal(id);
                return;
            }

            const deleteBtn = e.target.closest('.delete-credit-history-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                if (confirm("¿Estás seguro de eliminar este crédito y todos sus pagos asociados? Esta acción es irreversible y se debe usar solo en emergencias.")) {
                    try {
                        // 1. Eliminar pagos asociados
                        await supabase.from('payments').delete().eq('debtor_id', id);
                        
                        // 2. Eliminar el crédito (debtor)
                        await supabase.from('debtors').delete().eq('id', id);

                        showToast("Crédito eliminado correctamente");
                        refreshClientView(); // Actualizar vista principal de clientes
                        openClientDetails(clientDetailsModal.dataset.cedula, clientDetailsModal.dataset.name); // Recargar detalles
                    } catch (error) {
                        console.error("Error deleting credit:", error);
                        alert("Error al eliminar: " + error.message);
                    }
                }
                return;
            }
        });

        // Función para abrir modal de editar crédito
        async function openEditCreditModal(id) {
            try {
                const [{ data }, _] = await Promise.all([
                    supabase.from('debtors').select('*').eq('id', id).single(),
                    ensureUsersCache() // Warm up users cache
                ]);

                if (!data) return alert("Crédito no encontrado");

                document.getElementById('edit-credit-id').value = id;
                document.getElementById('edit-credit-type').value = data.credit_type || 'Nuevo';
                document.getElementById('edit-credit-valor-cuota').value = data.valor_cuota || 0;
                document.getElementById('edit-credit-interests').value = data.interests || 0;
                document.getElementById('edit-credit-value').value = data.sale_value || 0;
                document.getElementById('edit-credit-balance').value = data.balance || 0;
                document.getElementById('edit-credit-remaining').value = data.remaining_payments || 0;
                document.getElementById('edit-credit-term').value = data.payment_term || 'Diario';

                // Formatear fecha para input date (YYYY-MM-DD)
                let isoDate = '';
                if (data.sale_date) {
                    const parts = data.sale_date.split('-');
                    if (parts.length === 3) {
                        isoDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
                    }
                }
                document.getElementById('edit-credit-date').value = isoDate;

                // Cargar asesores (filtrados por municipio del crédito si existe)
                await populateAdvisorSelects('edit-credit-asesor', data.asesor_name, data.municipality);

                editCreditModal.style.display = 'flex';
            } catch (error) {
                console.error(error);
                alert("Error al cargar datos del crédito");
            }
        }

        closeEditCreditModalBtn.addEventListener('click', () => {
            editCreditModal.style.display = 'none';
        });

        editCreditForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-credit-id').value;
            const dateVal = document.getElementById('edit-credit-date').value;
            
            const updateData = {
                credit_type: document.getElementById('edit-credit-type').value,
                valor_cuota: Number(document.getElementById('edit-credit-valor-cuota').value),
                interests: Number(document.getElementById('edit-credit-interests').value),
                sale_value: Number(document.getElementById('edit-credit-value').value),
                balance: Number(document.getElementById('edit-credit-balance').value),
                remaining_payments: Number(document.getElementById('edit-credit-remaining').value),
                payment_term: document.getElementById('edit-credit-term').value,
                asesor_name: document.getElementById('edit-credit-asesor').value
            };

            if (dateVal) {
                const [y, m, d] = dateVal.split('-');
                updateData.sale_date = `${d}-${m}-${y}`;
                // Actualizar created_at (Timestamp)
                updateData.created_at = new Date(y, m - 1, d, 12, 0, 0).toISOString();
            }

            try {
                await supabase.from('debtors').update(updateData).eq('id', id);
                showToast("Crédito actualizado correctamente");
                editCreditModal.style.display = 'none';
                // Recargar detalles
                openClientDetails(clientDetailsModal.dataset.cedula, clientDetailsModal.dataset.name);
            } catch (error) {
                console.error(error);
                alert("Error al actualizar crédito: " + error.message);
            }
        });

        async function loadCreditPayments(creditId) {
            creditPaymentsModal.style.display = 'flex';
            creditPaymentsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Cargando pagos...</td></tr>';
            
            try {
                const { data: payments, error } = await supabase.from('payments').select('*').eq('debtor_id', creditId);
                if (error) throw error;
                
                if (!payments || payments.length === 0) {
                    creditPaymentsBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay pagos registrados para este crédito.</td></tr>';
                    return;
                }

                let html = '';

                // Mostrar siempre la columna de acciones
                const actionsHeader = document.getElementById('credit-payments-actions-header');
                if (actionsHeader) {
                    actionsHeader.style.display = 'table-cell';
                }
                
                payments.forEach(payment => { // payment es ahora un objeto de fila
                    let dateStr = payment.payment_date || 'N/A';
                    // Asegurar formato visual dd-MM-yyyy si viene como YYYY-MM-DD
                    if (dateStr !== 'N/A' && /^\d{4}-\d{2}-\d{2}$/.test(dateStr)) { 
                        const [y, m, d] = dateStr.split('-'); 
                        dateStr = `${d}-${m}-${y}`; 
                    }

                    const actionsHtml = `
                        <button class="btn edit-payment-btn" data-id="${payment.id}" data-date="${dateStr}" data-day="${payment.payment_day || ''}" style="background-color: #f39c12; padding: 5px 10px; margin-right: 5px;" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="btn delete-payment-btn" data-id="${payment.id}" data-amount="${payment.payment_amount}" data-debtor-id="${payment.debtor_id}" style="background-color: #e74c3c; padding: 5px 10px;" title="Eliminar"><i class="fas fa-trash"></i></button>
                    `;

                    html += `<tr id="row-${payment.id}">
                        <td style="padding: 10px; border-bottom: 1px solid #eee;" class="date-cell">${dateStr}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;" class="day-cell">${payment.payment_day || 'N/A'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;" class="amount-cell" data-amount="${payment.payment_amount || 0}">$${(Number(payment.payment_amount) || 0).toLocaleString('es-CO')}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee;" class="method-cell">${payment.payment_method || 'N/A'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${actionsHtml}</td>
                    </tr>`;
                });
                creditPaymentsBody.innerHTML = html;
            } catch (error) {
                console.error("Error loading payments:", error);
                creditPaymentsBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error al cargar pagos.</td></tr>';
            }
        }

        // Manejar edición de pagos importados
        creditPaymentsBody.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.edit-payment-btn');
            if (editBtn) {
                const id = editBtn.dataset.id;
                const currentDateStr = editBtn.dataset.date; // dd-MM-yyyy
                const row = document.getElementById(`row-${id}`);

                // Convertir dd-MM-yyyy a YYYY-MM-DD para el input date
                let isoDate = '';
                if (currentDateStr && currentDateStr.includes('-')) {
                    const [d, m, y] = currentDateStr.split('-');
                    isoDate = `${y}-${m}-${d}`;
                }

                // Hacer campos editables
                // Fecha
                row.querySelector('.date-cell').innerHTML = `<input type="date" id="edit-date-${id}" value="${isoDate}" style="width: 130px;">`;
                
                // Abono
                const amountCell = row.querySelector('.amount-cell');
                const currentAmount = amountCell.dataset.amount;
                amountCell.innerHTML = `<input type="number" id="edit-amount-${id}" value="${currentAmount}" style="width: 100px;">`;

                // Método
                const methodCell = row.querySelector('.method-cell');
                const currentMethod = methodCell.textContent.trim();
                methodCell.innerHTML = `<select id="edit-method-${id}" style="width: 120px;">
                                            <option value="Efectivo" ${currentMethod === 'Efectivo' ? 'selected' : ''}>Efectivo</option>
                                            <option value="Transferencia" ${currentMethod === 'Transferencia' ? 'selected' : ''}>Transferencia</option>
                                        </select>`;
                
                // Cambiar botón a Guardar
                const actionsCell = editBtn.parentElement;
                actionsCell.innerHTML = `<button class="btn save-payment-btn" data-id="${id}" data-old-amount="${currentAmount}" style="background-color: #2ecc71; padding: 5px 10px;"><i class="fas fa-save"></i></button>`;
                return;
            }

            const saveBtn = e.target.closest('.save-payment-btn');
            if (saveBtn) {
                const id = saveBtn.dataset.id;
                const oldAmount = Number(saveBtn.dataset.oldAmount);
                const newDateVal = document.getElementById(`edit-date-${id}`).value; // YYYY-MM-DD
                const newAmount = Number(document.getElementById(`edit-amount-${id}`).value);
                const newMethod = document.getElementById(`edit-method-${id}`).value;

                if (!newDateVal) return alert("Fecha inválida");

                // Convertir YYYY-MM-DD a dd-MM-yyyy para guardar
                const [y, m, d] = newDateVal.split('-');
                const formattedDate = `${d}-${m}-${y}`;
                
                // Calcular el nuevo día de la semana
                const newDateObj = new Date(y, m - 1, d);
                // Crear fecha para createdAt (mediodía para evitar problemas de zona horaria)
                const newCreatedAt = new Date(y, m - 1, d, 12, 0, 0);

                const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                const newDay = days[newDateObj.getDay()];

                try { // 1. Actualizar el documento del pago
                    await supabase.from('payments').update({
                        payment_date: formattedDate,
                        created_at: newCreatedAt.toISOString(),
                        payment_day: newDay,
                        payment_amount: newAmount,
                        payment_method: newMethod,
                        isEdited: true // Marcar como editado
                    }).eq('id', id);

                    // 2. Ajustar el saldo del deudor
                    const { data: paymentDoc, error } = await supabase.from('payments').select('debtor_id').eq('id', id).single();
                    const debtorId = paymentDoc.debtor_id;
                    if (debtorId) {
                        const balanceAdjustment = oldAmount - newAmount;
                        // Supabase no tiene 'increment', se debe hacer con RPC o leer y escribir
                        const { data: debtorData } = await supabase.from('debtors').select('balance').eq('id', debtorId).single();
                        const newBalance = (Number(debtorData.balance) || 0) + balanceAdjustment;
                        await supabase.from('debtors').update({ balance: newBalance }).eq('id', debtorId);
                    }

                    showToast("Pago actualizado y saldo ajustado");
                    if (debtorId) loadCreditPayments(debtorId); // Recargar la lista de pagos

                } catch (error) {
                    console.error(error);
                    alert("Error al actualizar: " + error.message);
                }
                return;
            }

            // Delete Button
            const deleteBtn = e.target.closest('.delete-payment-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                const amount = Number(deleteBtn.dataset.amount);
                const debtorId = deleteBtn.dataset.debtorId;

                if (confirm("¿Estás seguro de eliminar este pago? El saldo del crédito aumentará.")) {
                    try {
                        // 1. Eliminar pago
                        await supabase.from('payments').delete().eq('id', id);
                        
                        // 2. Actualizar saldo del deudor: Sumar el valor eliminado al balance
                        if (debtorId) {
                            // Leer, modificar y escribir para simular 'increment'
                            const { data: debtorData } = await supabase.from('debtors').select('balance, remaining_payments').eq('id', debtorId).single();
                            const newBalance = (Number(debtorData.balance) || 0) + amount;
                            const newRemaining = (Number(debtorData.remaining_payments) || 0) + 1;
                            await supabase.from('debtors').update({ balance: newBalance, remaining_payments: newRemaining }).eq('id', debtorId);
                            
                            // Actualizar vista de detalles del cliente (fondo)
                            const { data: dData, error } = await supabase.from('debtors').select('cedula, name').eq('id', debtorId).single();
                            
                            if (dData) {
                                openClientDetails(dData.cedula, dData.name);
                            }
                        }

                        showToast("Pago eliminado y saldo ajustado");
                        loadCreditPayments(debtorId);

                    } catch (error) {
                        console.error(error);
                        alert("Error al eliminar pago: " + error.message);
                    }
                }
            }
        });

        closeClientDetailsBtn.addEventListener('click', () => {
            clientDetailsModal.style.display = 'none';
            if (clientDetailsUnsubscribeDebtors) { clientDetailsUnsubscribeDebtors(); clientDetailsUnsubscribeDebtors = null; }
            if (clientDetailsUnsubscribePayments) { clientDetailsUnsubscribePayments(); clientDetailsUnsubscribePayments = null; }
            if (clientDetailsUnsubscribeClient) { clientDetailsUnsubscribeClient(); clientDetailsUnsubscribeClient = null; }
        });

        closeCreditPaymentsBtn.addEventListener('click', () => {
            creditPaymentsModal.style.display = 'none';
        });

        // Abrir Modal de Añadir Cliente
        addClientBtn.addEventListener('click', async () => {
            populateDepartments('new-client-department', 'new-client-municipality');
            // newClientMunicipality.innerHTML = '<option value="" disabled selected>Seleccione un departamento primero</option>'; // Ya no es select
            newClientMunicipality.value = '';
            newClientMunicipality.placeholder = 'Seleccione un departamento primero';
            newClientMunicipality.disabled = true;

            // Populate advisors
            // await populateAdvisorSelects('new-client-asesor'); // Se llena al seleccionar municipio

            addClientModal.style.display = 'flex';
        });

        closeClientModalBtn.addEventListener('click', () => {
            addClientModal.style.display = 'none';
        });

        // Listener para cambio de departamento en Nuevo Cliente
        newClientDepartment.addEventListener('change', async (e) => {
            const dept = e.target.value;
            await loadMunicipalitiesForSelect(dept, newClientMunicipality);
        });

        // Listener para cambio de departamento en Editar Cliente
        editClientDepartment.addEventListener('change', async (e) => {
            const dept = e.target.value;
            await loadMunicipalitiesForSelect(dept, editClientMunicipality);
        });

        // Guardar Nuevo Cliente
        addClientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('new-client-name').value,
                cedula: document.getElementById('new-client-cedula').value,
                phone: document.getElementById('new-client-phone').value,
                address: document.getElementById('new-client-address').value, // Corregido para usar asesor_name
                municipality: newClientMunicipality.value,
                asesor_name: newClientAsesor.value,
                payment_term: [document.getElementById('new-client-payment-term').value],
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase.from('clients').insert(data);
                if (error) throw error;
                addClientModal.style.display = 'none';
                addClientForm.reset();
                refreshClientView();
            } catch (error) {
                console.error("Error Supabase:", error);
                alert('Error al guardar cliente: ' + error.message);
            }
        });

        // Listeners para cambio de municipio
        newClientMunicipality.addEventListener('change', (e) => {
            populateAdvisorSelects('new-client-asesor', null, e.target.value);
        });

        editClientMunicipality.addEventListener('change', (e) => {
            populateAdvisorSelects('edit-client-asesor', null, e.target.value);
        });

        // Función para llenar el select de asesores
        async function populateAdvisorSelects(selectId, selectedValue = null, municipality = null) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="" disabled selected>Seleccionar Asesor...</option>';
            
            if (!municipality) return;

            try {
                const allUsers = await ensureUsersCache(); // Usa el caché
                // Filter in memory
                const users = allUsers.filter(u => u.assigned_municipality && u.assigned_municipality.includes(municipality));
                
                // Ordenar alfabéticamente por nombre
                users.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                users.forEach(user => {
                    const option = document.createElement('option'); // Corregido para usar usersList
                    option.value = user.name;
                    option.textContent = user.name;
                    if (selectedValue && user.name === selectedValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Error loading advisors:", error);
            }
        }

        // Función auxiliar para parsear fechas (soporta YYYY-MM-DD y DD/MM/YYYY)
        // Movida al ámbito global para ser usada en loadRecords y handleExport
        const parseDate = (input) => {
            if (!input) return null;
            if (input instanceof Date) return input;
            // No hay toDate() en Supabase, las fechas vienen como strings ISO

            if (typeof input === 'string') {
                // Intentar formato YYYY-MM-DD
                if (/^\d{4}-\d{2}-\d{2}$/.test(input)) {
                    const [y, m, d] = input.split('-').map(Number);
                    return new Date(y, m - 1, d);
                }
                // Intentar formato DD/MM/YYYY o DD-MM-YYYY
                if (/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/.test(input)) {
                    const parts = input.split(/[\/-]/).map(Number);
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            const d = new Date(input);
            return isNaN(d.getTime()) ? null : d;
        };


        // Función auxiliar para construir la consulta filtrada
        function buildFilteredQuery(collectionName) {
            let query = supabase.from(collectionName).select('*');
            const selectedCobrador = cobradorFilter.value;
            const selectedMunicipio = municipioFilterPagos.value;
            
            if (collectionName === 'payments' || collectionName === 'debtors') {
                const userField = collectionName === 'debtors' ? 'asesor_name' : 'user_name';
                if (selectedCobrador && selectedCobrador !== 'all' && selectedCobrador !== 'Todos los Usuarios') {
                    query = query.eq(userField, selectedCobrador);
                }
                if (selectedMunicipio && selectedMunicipio !== 'all' && selectedMunicipio !== 'Todos los Municipios') {
                    query = query.eq('municipality', selectedMunicipio);
                }
            }
            return query;
        }


        // Función para llenar el filtro de cobradores
        async function populateCobradorFilter() {
            const { data: cobradoresSnapshot, error } = await supabase.from('users').select('name');
            const options = ['Todos los Usuarios'];
            cobradoresSnapshot.forEach(cobrador => {
                options.push(cobrador.name);
            });
            setupSearchableInput('cobrador-filter', 'list-cobrador-filter', options);
            document.getElementById('cobrador-filter').placeholder = 'Todos los Usuarios';
        }

        // Función para llenar el filtro de municipios para la sección de pagos
        // Función para cargar y mostrar los registros (Ventas o Pagos)
        async function loadRecords(collectionName, isBackground = false) {
            if (!isBackground) {
                workspaceLoader.style.display = 'flex';
                paymentsTable.style.display = 'none';
            }
            try {
                if (collectionName === 'debtors') {
                    const paymentsTableBody = document.getElementById('payments-table-body');
                    if (!isBackground) paymentsTableBody.innerHTML = '';

                    const { data: records, error } = await buildFilteredQuery('debtors');
                    if (error) throw error;
                    
                    // Convertir a array y ordenar descendente por fecha
                    records.sort((a, b) => {
                        const dateA = parseDate(a.sale_date) || new Date(0);
                        const dateB = parseDate(b.sale_date) || new Date(0);
                        return dateB - dateA;
                    });

                    // Obtener fechas del filtro
                    const startDateVal = filterStartDate.value;
                    const endDateVal = filterEndDate.value;
                    const startDate = startDateVal ? new Date(startDateVal + 'T00:00:00') : null;
                    const endDate = endDateVal ? new Date(endDateVal + 'T23:59:59') : null;

                    let recordsHtml = '';
                    records.forEach(record => {

                        // Filtrado por fecha en cliente
                        const recordDate = parseDate(record.sale_date);
                        if (startDate && (!recordDate || recordDate < startDate)) return;
                        if (endDate && (!recordDate || recordDate > endDate)) return;

                        // Formato de fecha dd-MM-yyyy
                        let formattedDate = 'N/A';
                        if (recordDate) {
                            const day = String(recordDate.getDate()).padStart(2, '0');
                            const month = String(recordDate.getMonth() + 1).padStart(2, '0');
                            const year = recordDate.getFullYear();
                            formattedDate = `${day}-${month}-${year}`;
                        }

                        recordsHtml += `<tr>
                                            <td>${record.name || 'N/A'}</td>
                                            <td>${(record.balance !== undefined && record.balance !== null) ? `$${Number(record.balance).toLocaleString('es-CO')}` : 'N/A'}</td>
                                            <td>${record.number_of_payments ?? 'N/A'}</td>
                                            <td>${record.municipality || 'N/A'}</td>
                                            <td>${record.asesor_name || 'N/A'}</td>
                                            <td>${record.loan_day || 'N/A'}</td>
                                            <td>${formattedDate}</td>
                                         </tr>`;
                    });
                    paymentsTable.style.display = 'table';
                    paymentsTableBody.innerHTML = recordsHtml || `<tr><td colspan="7" style="text-align: center;">No se encontraron datos con los filtros aplicados</td></tr>`;
                }
            } catch (error) {
                console.error("Error al cargar registros:", error);
                document.getElementById('payments-table-body').innerHTML = `<tr><td colspan="7">Error al cargar los datos.</td></tr>`;
            } finally {
                if (!isBackground) {
                    workspaceLoader.style.display = 'none';
                }
            }
        }

        // Función para cargar y mostrar los usuarios
        async function loadUsers(isBackground = false) {
            if (!isBackground) {
                workspaceLoader.style.display = 'flex';
                usersTable.style.display = 'none';
            }
            const userTableBody = document.getElementById('user-table-body');
            if (!isBackground) userTableBody.innerHTML = '';
            
            try { // Corregido para usar Supabase
                const { data: usersSnapshot, error } = await supabase.from('users').select('*').order('name');
                if (error) throw error;
                
                let userHtml = '';
                usersSnapshot.forEach(user => {
                    // El ID de la fila es el UID del usuario
                    const uid = user.id; 

                    // Generar el texto de los municipality (Conteo y Botón)
                    const munisCount = user.assigned_municipality ? user.assigned_municipality.length : 0;
                    const munisListStr = user.assigned_municipality ? user.assigned_municipality.join('|') : '';
                    
                    const municipalityHtml = `Asignados ${munisCount} <button class="btn view-assigned-munis-btn" data-munis="${munisListStr}" data-name="${user.name || 'Usuario'}" style="background-color: #3498db; padding: 2px 8px; font-size: 12px; margin-left: 5px; border-radius: 4px;" title="Ver Municipios"><i class="fas fa-eye"></i></button>`;

                    let canDelete = false;
                    if (isMasterAdmin) {
                        if (user.role !== 'Administrador maestro') {
                            canDelete = true;
                        }
                    } else {
                        if (!user.isAdmin) {
                            canDelete = true;
                        }
                    }

                    const deleteButton = canDelete 
                        ? `<button class="btn delete-user-btn" data-uid="${uid}" data-name="${user.name || 'Usuario'}" data-is-admin="${user.isAdmin}" style="padding: 5px 10px; font-size: 14px; background-color: #e74c3c;" title="Eliminar Usuario"><i class="fas fa-trash"></i></button>`
                        : '';

                    userHtml += `<tr data-uid="${uid}">
                                    <td>${user.name || 'N/A'}</td>
                                    <td>${user.cedula || 'N/A'}</td>
                                    <td>${user.email}</td>
                                    <td>${municipalityHtml}</td>
                                    <td>${user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A'}</td>
                                    <td>
                                        <div style="display: flex; flex-direction: row; align-items: center; gap: 10px;">
                                            <button class="btn edit-user-btn" data-uid="${uid}" style="padding: 5px 10px; font-size: 14px; background-color: #2ecc71;"><i class="fas fa-edit"></i></button>
                                            <button class="btn change-password-btn" data-uid="${uid}" data-name="${user.name || 'Usuario'}" style="padding: 5px 10px; font-size: 14px; background-color: #f39c12;" title="Cambiar Contraseña"><i class="fas fa-key"></i></button>
                                            ${deleteButton}
                                        </div>
                                    </td>
                                </tr>`;
                });

                userTableBody.innerHTML = userHtml || '<tr><td colspan="7">No se encontraron usuarios.</td></tr>';
            } catch (error) {
                console.error(error);
                userTableBody.innerHTML = '<tr><td colspan="7">Error al cargar usuarios.</td></tr>';
            } finally {
                if (!isBackground) {
                    workspaceLoader.style.display = 'none';
                    usersTable.style.display = 'table';
                }
            }
        }

        // Listener para ver municipios asignados
        usersTable.addEventListener('click', (e) => {
            const btn = e.target.closest('.view-assigned-munis-btn');
            if (btn) {
                const munisStr = btn.dataset.munis;
                const name = btn.dataset.name;
                const munis = munisStr ? munisStr.split('|') : [];

                viewAssignedMunisTitle.textContent = `Municipios de ${name}`;
                viewAssignedMunisList.innerHTML = '';

                if (munis.length === 0) {
                    viewAssignedMunisList.innerHTML = '<li>No tiene municipios asignados.</li>';
                } else {
                    munis.sort().forEach(m => {
                        const li = document.createElement('li');
                        li.textContent = m;
                        li.style.padding = '5px 0';
                        li.style.borderBottom = '1px solid #eee';
                        viewAssignedMunisList.appendChild(li);
                    });
                }
                viewAssignedMunisModal.style.display = 'flex';
            }
        });

        // Cerrar modal de municipios asignados
        closeViewAssignedMunisBtn.addEventListener('click', () => {
            viewAssignedMunisModal.style.display = 'none';
        });


        // --- FUNCIONES AUXILIARES ---

        function showLoginError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return "El correo electrónico no está registrado.";
                case 'auth/wrong-password':
                    return "La contraseña es incorrecta.";
                case 'auth/invalid-email':
                    return "El formato del correo es inválido.";
                case 'auth/email-already-in-use':
                    return "Este correo electrónico ya está registrado.";
                case 'auth/weak-password': // Corregido para usar getSupabaseErrorMessage
                    return "La contraseña debe tener al menos 6 caracteres.";
                default:
                    return "Ocurrió un error al iniciar sesión.";
            }
        }

        function getSupabaseErrorMessage(error) {
            if (error.message.includes("User not found")) {
                return "El correo electrónico no está registrado.";
            }
            if (error.message.includes("Invalid login credentials")) {
                return "La contraseña es incorrecta.";
            }
            if (error.message.includes("Email rate limit exceeded")) {
                return "Demasiados intentos. Intenta más tarde.";
            }
            if (error.message.includes("Password should be at least 6 characters")) {
                return "La contraseña debe tener al menos 6 caracteres.";
            }
            return error.message || "Ocurrió un error.";
        }

        function showToast(message) { // Sin cambios
            const toast = document.getElementById("toast-notification");
            toast.textContent = message;
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 2000);
        }

        // Función para cargar datos del Tablero de Control
        async function loadDashboardData() {
            const isWeekly = btnDashboardWeekly.classList.contains('active');
            
            const tbodyCobros = document.getElementById('dashboard-cobros-body');
            const tbodyCreditos = document.getElementById('dashboard-creditos-body');
            
            tbodyCobros.innerHTML = '<tr><td colspan="5" style="text-align:center;"><div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div></td></tr>';
            tbodyCreditos.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div></td></tr>';

            const now = new Date();
            let startDate, endDate;

            if (isWeekly) {
                // Semana actual (Lunes a Domingo)
                const day = now.getDay();
                const diff = now.getDate() - day + (day === 0 ? -6 : 1); // Ajustar al lunes
                // Correct way to create date to avoid month crossing issues
                startDate = new Date(now.getFullYear(), now.getMonth(), diff);
                startDate.setHours(0, 0, 0, 0);
                
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                endDate.setHours(23, 59, 59, 999);
            } else {
                // Hoy
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
            }

            try {
                // 1. Cargar Créditos (Debtors)
                const { data: debtorsSnapshot, error: debtorsError } = await supabase
                    .from('debtors')
                    .select('*')
                    .gte('created_at', startDate.toISOString())
                    .lte('created_at', endDate.toISOString());

                if (debtorsError) throw debtorsError;
                
                const creditos = [];
                debtorsSnapshot.forEach(d => {

                    // Ignorar importados
                    if (d.imported === true) return;

                    // Filtro por modo (Diario o Semanal)
                    let match = false;
                    const term = d.payment_term;

                    if (isWeekly) { // Modo Semanal
                        if (Array.isArray(term)) match = term.some(t => String(t).toUpperCase() === 'SEMANAL');
                        else match = String(term).toUpperCase() === 'SEMANAL';
                    } else { // Modo Diario
                        if (Array.isArray(term)) match = term.some(t => String(t).toUpperCase() === 'DIARIO');
                        else match = String(term).toUpperCase() === 'DIARIO';
                    }

                    if (match) {
                        creditos.push(d);
                    }
                });

                currentDashboardCreditosData = creditos;

                let htmlCreditos = '';
                if (creditos.length === 0) {
                    htmlCreditos = '<tr><td colspan="6" style="text-align:center;">No hay créditos registrados.</td></tr>';
                } else {
                    creditos.forEach(c => {
                        htmlCreditos += `<tr><td>${c.asesor_name || 'N/A'}</td>
                            <td>${c.municipality || 'N/A'}</td>
                            <td>${c.credit_type || 'N/A'}</td>
                            <td>$${(Number(c.sale_value) || 0).toLocaleString('es-CO')}</td>
                            <td>$${(Number(c.interests) || 0).toLocaleString('es-CO')}</td>
                            <td>$${(Number(c.valor_cuota) || 0).toLocaleString('es-CO')}</td>
                        </tr>`;
                    });
                }
                tbodyCreditos.innerHTML = htmlCreditos;
                
                // 2. Cargar y procesar Cobros
                if (!isWeekly) {
                    // A. Obtener deudores activos (balance > 0)
                    const { data: debtorsSnap, error: activeDebtorsError } = await supabase.from('debtors').select('*').gt('balance', 0);
                    if (activeDebtorsError) throw activeDebtorsError;

                    const debtorMap = new Map();
                    debtorsSnap.forEach(d => {
                        debtorMap.set(d.id, d);
                    });

                    // B. Obtener pagos de hoy
                    const { data: paymentsSnap, error: paymentsError } = await supabase
                        .from('payments')
                        .select('*')
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString());
                    if (paymentsError) throw paymentsError;

                    const payments = [];
                    const paymentDebtorIds = new Set();

                    paymentsSnap.forEach(p => {
                        if (p.imported !== true && p.debtor_id) {
                            payments.push(p);
                            paymentDebtorIds.add(p.debtor_id);
                        }
                    });

                    // C. Identificar y cargar deudores que pagaron hoy pero no están activos (saldo 0)
                    const missingDebtorIds = [];
                    paymentDebtorIds.forEach(id => {
                        if (!debtorMap.has(id)) {
                            missingDebtorIds.push(id);
                        }
                    });

                    if (missingDebtorIds.length > 0) { // No hay FieldPath.documentId(), se hace una consulta IN
                        const { data: missingDebtors, error } = await supabase
                            .from('debtors')
                            .select('*')
                            .in('id', missingDebtorIds);
                        if (missingDebtors) {
                            missingDebtors.forEach(d => {
                                debtorMap.set(d.id, d);
                            });
                        }
                    }

                    // D. Procesar datos
                    const cobrosMap = {}; // Key: asesor|municipio

                    // Helper para verificar si es Diario
                    const isDiario = (d) => {
                        const term = d.payment_term;
                        if (Array.isArray(term)) return term.some(t => String(t).toUpperCase() === 'DIARIO');
                        return String(term).toUpperCase() === 'DIARIO';
                    };

                    // Calcular Cobro (Esperado)
                    debtorMap.forEach((d, id) => {
                        if (!isDiario(d)) return;

                        // Excluir créditos creados hoy del Cobro Esperado
                        const createdDate = d.created_at ? new Date(d.created_at) : null;
                        const isCreatedToday = createdDate && createdDate >= startDate && createdDate <= endDate;

                        if (!isCreatedToday) {
                            const key = `${d.asesor_name}|${d.municipality}`;
                            if (!cobrosMap[key]) cobrosMap[key] = { asesor: d.asesor_name, municipio: d.municipality, cobro: 0, recaudo: 0 };
                            cobrosMap[key].cobro += (Number(d.valor_cuota) || 0);
                        }
                    });

                    // Calcular Recaudo (Real)
                    payments.forEach(p => {
                        const d = debtorMap.get(p.debtor_id);
                        if (!d || !isDiario(d)) return;

                        const key = `${p.user_name}|${p.municipality}`;
                        if (!cobrosMap[key]) cobrosMap[key] = { asesor: p.user_name, municipio: p.municipality, cobro: 0, recaudo: 0 };
                        cobrosMap[key].recaudo += (Number(p.payment_amount) || 0);
                    });

                    // E. Renderizar
                    const cobrosList = Object.values(cobrosMap).sort((a, b) => (a.asesor || '').localeCompare(b.asesor || '') || (a.municipio || '').localeCompare(b.municipio || ''));
                    currentDashboardCobrosData = cobrosList;

                    let htmlCobros = '';
                    if (cobrosList.length === 0) {
                        htmlCobros = '<tr><td colspan="5" style="text-align:center;">No hay datos de cobros para hoy.</td></tr>';
                    } else {
                        cobrosList.forEach(c => {
                            const pct = c.cobro > 0 ? Math.round((c.recaudo / c.cobro) * 100) : 0;
                            htmlCobros += `<tr><td>${c.asesor || 'N/A'}</td><td>${c.municipio || 'N/A'}</td><td>$${c.cobro.toLocaleString('es-CO')}</td><td>$${c.recaudo.toLocaleString('es-CO')}</td><td>${pct}%</td></tr>`;
                        });
                    }
                    tbodyCobros.innerHTML = htmlCobros;
                } else {
                    // --- LÓGICA SEMANAL PARA COBROS (Lunes a Domingo) ---

                    // A. Obtener todos los créditos activos para identificar los 'Semanales'.
                    const { data: debtorsSnap, error: debtorsError } = await supabase.from('debtors').select('*').gt('balance', 0);
                    if (debtorsError) throw debtorsError;
                    
                    const weeklyDebtorIds = new Set();
                    const weeklyDebtorsData = {}; // Mapa: { debtorId: { valorCuota, asesorName, municipality } }

                    debtorsSnap.forEach(d => {

                        // Excluir créditos creados en la semana actual
                        const createdDate = d.created_at ? new Date(d.created_at) : null;
                        if (createdDate && createdDate >= startDate && createdDate <= endDate) {
                            return;
                        }

                        let isSemanal = false;
                        const term = d.payment_term;
                        if (Array.isArray(term)) isSemanal = term.some(t => String(t).toUpperCase() === 'SEMANAL');
                        else isSemanal = String(term).toUpperCase() === 'SEMANAL';

                        if (isSemanal) {
                            // Si es semanal y no fue creado esta semana, es elegible para cobro.
                            weeklyDebtorIds.add(d.id);
                            weeklyDebtorsData[d.id] = {
                                valorCuota: Number(d.valor_cuota) || 0,
                                asesorName: d.asesor_name,
                                municipality: d.municipality
                            };
                        }
                    });

                    // B. Preparar la estructura para agregar los datos
                    const cobrosMap = {}; // Clave: asesor|municipio

                    // C. Calcular "Cobro" (esperado) iterando sobre los créditos semanales elegibles
                    for (const debtorId in weeklyDebtorsData) {
                        const debtor = weeklyDebtorsData[debtorId];
                        const key = `${debtor.asesorName}|${debtor.municipality}`;
                        if (!cobrosMap[key]) {
                            cobrosMap[key] = { asesor: debtor.asesorName, municipio: debtor.municipality, cobro: 0, recaudo: 0 };
                        }
                        // Cada crédito semanal elegible tiene un cobro esperado esta semana.
                        cobrosMap[key].cobro += debtor.valorCuota;
                    }

                    // D. Obtener los pagos de la semana y calcular "Recaudo" (real)
                    const { data: paymentsSnap, error: paymentsError } = await supabase.from('payments').select('*').gte('created_at', startDate.toISOString()).lte('created_at', endDate.toISOString());
                    if (paymentsError) throw paymentsError;

                    paymentsSnap.forEach(p => {
                        // Ignorar importados y pagos de créditos que no son semanales elegibles
                        if (p.imported === true || !weeklyDebtorIds.has(p.debtor_id)) return;

                        const key = `${p.user_name}|${p.municipality}`;
                        if (cobrosMap[key]) { // Solo sumar a grupos que tienen un cobro esperado
                            cobrosMap[key].recaudo += (Number(p.payment_amount) || 0);
                        }
                    });

                    // E. Renderizar la tabla
                    const cobrosList = Object.values(cobrosMap).sort((a, b) => (a.asesor || '').localeCompare(b.asesor || '') || (a.municipio || '').localeCompare(b.municipio || ''));
                    currentDashboardCobrosData = cobrosList;

                    let htmlCobros = '';
                    if (cobrosList.length === 0) {
                        htmlCobros = '<tr><td colspan="5" style="text-align:center;">No hay cobros semanales para esta semana.</td></tr>';
                    } else {
                        cobrosList.forEach(c => {
                            const pct = c.cobro > 0 ? Math.round((c.recaudo / c.cobro) * 100) : 0;
                            htmlCobros += `<tr><td>${c.asesor || 'N/A'}</td><td>${c.municipio || 'N/A'}</td><td>$${c.cobro.toLocaleString('es-CO')}</td><td>$${c.recaudo.toLocaleString('es-CO')}</td><td>${pct}%</td></tr>`;
                        });
                    }
                    tbodyCobros.innerHTML = htmlCobros;
                }

            } catch (error) {
                console.error("Error loading dashboard data:", error);
                tbodyCreditos.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error.</td></tr>';
                tbodyCobros.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">Error.</td></tr>';
            }
        }

        // --- LÓGICA DE INTERFAZ INFORMES (Sin lógica de datos aún) ---
        
        // Manejo de botones de navegación de informes (Estilos Active)
        const reportNavButtons = document.querySelectorAll('.report-nav-btn');
        reportNavButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                reportNavButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Manejo de botones de modo P&G (Diario/Semanal)
        const pgModeButtons = document.querySelectorAll('.pg-mode-btn');
        pgModeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                pgModeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('pg-filter-date-text').textContent = 'Seleccionar Fecha';
                // No resetear texto de fecha al cambiar modo para persistencia
                // pgFilterDateText.textContent = 'Seleccionar Fecha';
            });
        });

        // Manejo de botones de modo PB (Diario/Semanal)
        const pbModeButtons = document.querySelectorAll('.pb-mode-btn');
        pbModeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                pbModeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('pb-filter-date-text').textContent = 'Seleccionar Fecha';
            });
        });

        // Manejo de botones de modo CR (Diario/Semanal)
        const crModeButtons = document.querySelectorAll('.cr-mode-btn');
        crModeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                crModeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('cr-filter-date-text').textContent = 'Seleccionar Fecha';
            });
        });

        // Manejo de botones de modo PM (Diario/Semanal)
        const pmModeButtons = document.querySelectorAll('.pm-mode-btn');
        pmModeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                pmModeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('pm-filter-date-text').textContent = 'Seleccionar Fecha';
            });
        });

        // Manejo de botones de modo EX (Diario/Semanal)
        const exModeButtons = document.querySelectorAll('.ex-mode-btn');
        exModeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                exModeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('ex-filter-date-text').textContent = 'Seleccionar Fecha';
            });
        });

        // Manejo de botones de modo GN (Diario/Semanal)
        const gnModeButtons = document.querySelectorAll('.gn-mode-btn');
        gnModeButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                gnModeButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('gn-filter-date-text').textContent = 'Seleccionar Fecha';
            });
        });

        document.getElementById('btn-report-pg').addEventListener('click', () => {
            // Mostrar contenedor P&G y ocultar otros si existieran
            const pgContainer = document.getElementById('pg-report-container');
            const defaultMsg = document.getElementById('reports-default-msg');

            // Toggle simple para mostrar/ocultar
            if (pgContainer.style.display === 'none') {
                pgContainer.style.display = 'block';
                defaultMsg.style.display = 'none';
                loadPgFilters();
                // Resetear botones de modo
                document.querySelectorAll('.pg-mode-btn').forEach(b => b.classList.remove('active'));
            } else {
                pgContainer.style.display = 'none';
                defaultMsg.style.display = 'block';
            }
            document.getElementById('payment-behavior-report-container').style.display = 'none';
            document.getElementById('credits-report-container').style.display = 'none';
            document.getElementById('payments-report-container').style.display = 'none';
            document.getElementById('expenses-report-container').style.display = 'none';
            document.getElementById('general-report-container').style.display = 'none';
        });

        btnReportPaymentBehavior.addEventListener('click', () => {
            const pbContainer = document.getElementById('payment-behavior-report-container');
            const pgContainer = document.getElementById('pg-report-container');
            const defaultMsg = document.getElementById('reports-default-msg');

            if (pbContainer.style.display === 'none') {
                pbContainer.style.display = 'block';
                pgContainer.style.display = 'none';
                defaultMsg.style.display = 'none';
                loadPbFilters();
                document.querySelectorAll('.pb-mode-btn').forEach(b => b.classList.remove('active'));
            } else {
                pbContainer.style.display = 'none';
                defaultMsg.style.display = 'block';
            }
            document.getElementById('credits-report-container').style.display = 'none';
            document.getElementById('payments-report-container').style.display = 'none';
            document.getElementById('expenses-report-container').style.display = 'none';
            document.getElementById('general-report-container').style.display = 'none';
        });

        btnReportCredits.addEventListener('click', () => {
            const crContainer = document.getElementById('credits-report-container');
            const pgContainer = document.getElementById('pg-report-container');
            const pbContainer = document.getElementById('payment-behavior-report-container');
            const defaultMsg = document.getElementById('reports-default-msg');
            const pmContainer = document.getElementById('payments-report-container');
            const exContainer = document.getElementById('expenses-report-container');
            const gnContainer = document.getElementById('general-report-container');

            if (crContainer.style.display === 'none') {
                crContainer.style.display = 'block';
                pgContainer.style.display = 'none';
                pbContainer.style.display = 'none';
                pmContainer.style.display = 'none';
                exContainer.style.display = 'none';
                gnContainer.style.display = 'none';
                defaultMsg.style.display = 'none';
                loadCrFilters();
                document.querySelectorAll('.cr-mode-btn').forEach(b => b.classList.remove('active'));
            } else {
                crContainer.style.display = 'none';
                defaultMsg.style.display = 'block';
            }
        });

        btnReportPayments.addEventListener('click', () => {
            const pmContainer = document.getElementById('payments-report-container');
            const crContainer = document.getElementById('credits-report-container');
            const pgContainer = document.getElementById('pg-report-container');
            const pbContainer = document.getElementById('payment-behavior-report-container');
            const defaultMsg = document.getElementById('reports-default-msg');
            const exContainer = document.getElementById('expenses-report-container');
            const gnContainer = document.getElementById('general-report-container');

            if (pmContainer.style.display === 'none') {
                pmContainer.style.display = 'block';
                crContainer.style.display = 'none';
                pgContainer.style.display = 'none';
                pbContainer.style.display = 'none';
                exContainer.style.display = 'none';
                gnContainer.style.display = 'none';
                defaultMsg.style.display = 'none';
                loadPmFilters();
                document.querySelectorAll('.pm-mode-btn').forEach(b => b.classList.remove('active'));
            } else {
                pmContainer.style.display = 'none';
                defaultMsg.style.display = 'block';
            }
        });

        btnReportExpenses.addEventListener('click', () => {
            const exContainer = document.getElementById('expenses-report-container');
            const pmContainer = document.getElementById('payments-report-container');
            const crContainer = document.getElementById('credits-report-container');
            const pgContainer = document.getElementById('pg-report-container');
            const pbContainer = document.getElementById('payment-behavior-report-container');
            const defaultMsg = document.getElementById('reports-default-msg');
            const gnContainer = document.getElementById('general-report-container');

            if (exContainer.style.display === 'none') {
                exContainer.style.display = 'block';
                pmContainer.style.display = 'none';
                crContainer.style.display = 'none';
                pgContainer.style.display = 'none';
                pbContainer.style.display = 'none';
                gnContainer.style.display = 'none';
                defaultMsg.style.display = 'none';
                loadExFilters();
                document.querySelectorAll('.ex-mode-btn').forEach(b => b.classList.remove('active'));
            } else {
                exContainer.style.display = 'none';
                defaultMsg.style.display = 'block';
            }
        });

        btnReportGeneral.addEventListener('click', () => {
            const gnContainer = document.getElementById('general-report-container');
            const exContainer = document.getElementById('expenses-report-container');
            const pmContainer = document.getElementById('payments-report-container');
            const crContainer = document.getElementById('credits-report-container');
            const pgContainer = document.getElementById('pg-report-container');
            const pbContainer = document.getElementById('payment-behavior-report-container');
            const defaultMsg = document.getElementById('reports-default-msg');

            if (gnContainer.style.display === 'none') {
                gnContainer.style.display = 'block';
                exContainer.style.display = 'none';
                pmContainer.style.display = 'none';
                crContainer.style.display = 'none';
                pgContainer.style.display = 'none';
                pbContainer.style.display = 'none';
                defaultMsg.style.display = 'none';
                loadGnFilters();
                document.querySelectorAll('.gn-mode-btn').forEach(b => b.classList.remove('active'));
            } else {
                gnContainer.style.display = 'none';
                defaultMsg.style.display = 'block';
            }
        });

        // Lógica Modal Fecha P&G
        btnPgFilterDate.addEventListener('click', () => {
            currentReportDateTarget = 'pg';
            // Inicializar selects si están vacíos
            if (document.getElementById('pg-specific-day').options.length === 0) {
                populatePgDateSelects();
            }
            
            // Determinar modo (Diario/Semanal)
            const isDaily = btnPgDaily.classList.contains('active');
            
            // Limpiar y reconstruir opciones según modo
            pgDateType.innerHTML = '';
            
            if (isDaily) {
                // Lógica para Diario
                const opts = [
                    {val: 'specific', text: 'Fecha especifica'},
                    {val: 'range', text: 'Rango'},
                    {val: 'all', text: 'Todos los dias de todos los meses de todos los años'}
                ];
                opts.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.val;
                    opt.textContent = o.text;
                    pgDateType.appendChild(opt);
                });
            } else {
                // Lógica para Semanal
                const opts = [
                    {val: 'week_of_month', text: 'Semanas del mes'},
                    {val: 'range', text: 'Rango de fechas'},
                    {val: 'month', text: 'Mes'},
                    {val: 'all', text: 'Todas las semanas de todos los meses y de todos los años'}
                ];
                opts.forEach(o => {
                    const opt = document.createElement('option');
                    opt.value = o.val;
                    opt.textContent = o.text;
                    pgDateType.appendChild(opt);
                });
            }
            
            // Seleccionar primera opción por defecto
            pgDateType.selectedIndex = 0;
            updatePgModalView();
            
            pgDateSelectionModal.style.display = 'flex';
        });

        btnPbFilterDate.addEventListener('click', () => {
            currentReportDateTarget = 'pb';
            if (document.getElementById('pg-specific-day').options.length === 0) {
                populatePgDateSelects();
            }
            
            pgDateType.innerHTML = '';
            let opts = [];

            if (btnPbWeekly.classList.contains('active')) {
                opts = [
                    {val: 'week_of_month', text: 'Semanas del mes'},
                    {val: 'range', text: 'Rango de fechas'},
                    {val: 'month', text: 'Mes'}
                    // Removed 'all' option for PB report
                ];
            } else {
                opts = [
                    {val: 'specific', text: 'Fecha especifica'},
                    {val: 'range', text: 'Rango'}
                    // Removed 'all' option for PB report
                ];
            }
            
            opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.val;
                opt.textContent = o.text;
                pgDateType.appendChild(opt);
            });
            pgDateType.selectedIndex = 0;
            updatePgModalView();
            pgDateSelectionModal.style.display = 'flex';
        });

        btnCrFilterDate.addEventListener('click', () => {
            currentReportDateTarget = 'cr';
            if (document.getElementById('pg-specific-day').options.length === 0) {
                populatePgDateSelects();
            }
            
            pgDateType.innerHTML = '';
            let opts = [];

            if (btnCrWeekly.classList.contains('active')) {
                opts = [
                    {val: 'week_of_month', text: 'Semanas del mes'},
                    {val: 'range', text: 'Rango de fechas'},
                    {val: 'month', text: 'Mes'},
                    {val: 'all', text: 'Todas las semanas de todos los meses y de todos los años'}
                ];
            } else {
                opts = [
                    {val: 'specific', text: 'Fecha especifica'},
                    {val: 'range', text: 'Rango'},
                    {val: 'all', text: 'Todos los dias de todos los meses de todos los años'}
                ];
            }
            
            opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.val;
                opt.textContent = o.text;
                pgDateType.appendChild(opt);
            });
            pgDateType.selectedIndex = 0;
            updatePgModalView();
            pgDateSelectionModal.style.display = 'flex';
        });

        btnPmFilterDate.addEventListener('click', () => {
            currentReportDateTarget = 'pm';
            if (document.getElementById('pg-specific-day').options.length === 0) {
                populatePgDateSelects();
            }
            
            pgDateType.innerHTML = '';
            let opts = [];

            if (btnPmWeekly.classList.contains('active')) {
                opts = [
                    {val: 'week_of_month', text: 'Semanas del mes'},
                    {val: 'range', text: 'Rango de fechas'},
                    {val: 'month', text: 'Mes'},
                    {val: 'all', text: 'Todas las semanas de todos los meses y de todos los años'}
                ];
            } else {
                opts = [
                    {val: 'specific', text: 'Fecha especifica'},
                    {val: 'range', text: 'Rango'},
                    {val: 'all', text: 'Todos los dias de todos los meses de todos los años'}
                ];
            }
            
            opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.val;
                opt.textContent = o.text;
                pgDateType.appendChild(opt);
            });
            pgDateType.selectedIndex = 0;
            updatePgModalView();
            pgDateSelectionModal.style.display = 'flex';
        });

        btnExFilterDate.addEventListener('click', () => {
            currentReportDateTarget = 'ex';
            if (document.getElementById('pg-specific-day').options.length === 0) {
                populatePgDateSelects();
            }
            
            pgDateType.innerHTML = '';
            let opts = [];

            if (btnExWeekly.classList.contains('active')) {
                opts = [
                    {val: 'week_of_month', text: 'Semanas del mes'},
                    {val: 'range', text: 'Rango de fechas'},
                    {val: 'month', text: 'Mes'},
                    {val: 'all', text: 'Todas las semanas de todos los meses y de todos los años'}
                ];
            } else {
                opts = [
                    {val: 'specific', text: 'Fecha especifica'},
                    {val: 'range', text: 'Rango'},
                    {val: 'all', text: 'Todos los dias de todos los meses de todos los años'}
                ];
            }
            
            opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.val;
                opt.textContent = o.text;
                pgDateType.appendChild(opt);
            });
            pgDateType.selectedIndex = 0;
            updatePgModalView();
            pgDateSelectionModal.style.display = 'flex';
        });

        btnGnFilterDate.addEventListener('click', () => {
            currentReportDateTarget = 'gn';
            if (document.getElementById('pg-specific-day').options.length === 0) {
                populatePgDateSelects();
            }
            
            pgDateType.innerHTML = '';
            let opts = [];

            if (btnGnWeekly.classList.contains('active')) {
                opts = [
                    {val: 'week_of_month', text: 'Semanas del mes'},
                    {val: 'range', text: 'Rango de fechas'},
                    {val: 'month', text: 'Mes'},
                    {val: 'all', text: 'Todas las semanas de todos los meses y de todos los años'}
                ];
            } else {
                opts = [
                    {val: 'specific', text: 'Fecha especifica'},
                    {val: 'range', text: 'Rango'},
                    {val: 'all', text: 'Todos los dias de todos los meses de todos los años'}
                ];
            }
            
            opts.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.val;
                opt.textContent = o.text;
                pgDateType.appendChild(opt);
            });
            pgDateType.selectedIndex = 0;
            updatePgModalView();
            pgDateSelectionModal.style.display = 'flex';
        });

        closePgDateSelectionModal.addEventListener('click', () => {
            pgDateSelectionModal.style.display = 'none';
        });

        function populatePgDateSelects() {
            const days = Array.from({length: 31}, (_, i) => i + 1);
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const currentYear = new Date().getFullYear();
            const years = [];
            for(let y = currentYear; y <= currentYear + 5; y++) years.push(y);
            const weeks = [1, 2, 3, 4];

            const fill = (id, items, isMonth) => {
                const sel = document.getElementById(id);
                sel.innerHTML = '';
                items.forEach((item, idx) => {
                    const opt = document.createElement('option');
                    opt.value = isMonth ? idx + 1 : item;
                    opt.textContent = item;
                    sel.appendChild(opt);
                });
            };

            fill('pg-specific-day', days);
            fill('pg-specific-month', months, true);
            fill('pg-specific-year', years);

            fill('pg-range-start-day', days);
            fill('pg-range-start-month', months, true);
            fill('pg-range-start-year', years);

            fill('pg-range-end-day', days);
            fill('pg-range-end-month', months, true);
            fill('pg-range-end-year', years);

            fill('pg-week-number', weeks);
            fill('pg-wm-month', months, true);
            fill('pg-wm-year', years);
            
            // Set current date defaults
            const now = new Date();
            document.getElementById('pg-specific-day').value = now.getDate();
            document.getElementById('pg-specific-month').value = now.getMonth() + 1;
            document.getElementById('pg-specific-year').value = now.getFullYear();

            document.getElementById('pg-range-start-day').value = now.getDate();
            document.getElementById('pg-range-start-month').value = now.getMonth() + 1;
            document.getElementById('pg-range-start-year').value = now.getFullYear();

            document.getElementById('pg-range-end-day').value = now.getDate();
            document.getElementById('pg-range-end-month').value = now.getMonth() + 1;
            document.getElementById('pg-range-end-year').value = now.getFullYear();

            document.getElementById('pg-wm-month').value = now.getMonth() + 1;
            document.getElementById('pg-wm-year').value = now.getFullYear();
            // Calcular semana actual aproximada
            const currentWeek = Math.min(4, Math.ceil(now.getDate() / 7));
            document.getElementById('pg-week-number').value = currentWeek;
        }

        function updatePgModalView() {
            const type = pgDateType.value;
            if (type === 'specific') {
                pgSpecificContainer.style.display = 'flex';
                pgRangeContainer.style.display = 'none';
                pgWeekMonthContainer.style.display = 'none';
            } else if (type === 'range') {
                pgSpecificContainer.style.display = 'none';
                pgRangeContainer.style.display = 'flex';
                pgWeekMonthContainer.style.display = 'none';
            } else if (type === 'week_of_month') {
                pgSpecificContainer.style.display = 'none';
                pgRangeContainer.style.display = 'none';
                pgWeekMonthContainer.style.display = 'flex';
                pgWeekNumber.style.display = 'block'; // Mostrar selector de semana
            } else if (type === 'month') {
                pgSpecificContainer.style.display = 'none';
                pgRangeContainer.style.display = 'none';
                pgWeekMonthContainer.style.display = 'flex';
                pgWeekNumber.style.display = 'none'; // Ocultar selector de semana
            } else {
                pgSpecificContainer.style.display = 'none';
                pgRangeContainer.style.display = 'none';
                pgWeekMonthContainer.style.display = 'none';
            }
            updatePgDatePreview();
        }

        function updatePgDatePreview() {
            const type = pgDateType.value;
            let text = '';
            
            if (type === 'specific') {
                const d = String(document.getElementById('pg-specific-day').value).padStart(2, '0');
                const m = String(document.getElementById('pg-specific-month').value).padStart(2, '0');
                const y = document.getElementById('pg-specific-year').value;
                text = `${d}-${m}-${y}`;
            } else if (type === 'range') {
                const dStart = String(document.getElementById('pg-range-start-day').value).padStart(2, '0');
                const mStart = String(document.getElementById('pg-range-start-month').value).padStart(2, '0');
                const yStart = document.getElementById('pg-range-start-year').value;
                
                const dEnd = String(document.getElementById('pg-range-end-day').value).padStart(2, '0');
                const mEnd = String(document.getElementById('pg-range-end-month').value).padStart(2, '0');
                const yEnd = document.getElementById('pg-range-end-year').value;
                
                text = `${dStart}-${mStart}-${yStart} -> ${dEnd}-${mEnd}-${yEnd}`;
            } else if (type === 'week_of_month') {
                const w = document.getElementById('pg-week-number').value;
                const m = document.getElementById('pg-wm-month').options[document.getElementById('pg-wm-month').selectedIndex].text;
                const y = document.getElementById('pg-wm-year').value;
                text = `Semana ${w} - ${m} ${y}`;
            } else if (type === 'month') {
                const m = document.getElementById('pg-wm-month').options[document.getElementById('pg-wm-month').selectedIndex].text;
                const y = document.getElementById('pg-wm-year').value;
                text = `Mes: ${m} ${y}`;
            } else if (type === 'all') {
                const isDaily = btnPgDaily.classList.contains('active');
                text = isDaily ? 'Todos los dias' : 'Todas las semanas';
            }
            pgDatePreview.textContent = text;
        }

        pgDateType.addEventListener('change', updatePgModalView);
        
        // Listeners para actualizar preview al cambiar selects
        const pgSelects = document.querySelectorAll('#pg-date-modal-content select');
        pgSelects.forEach(sel => sel.addEventListener('change', updatePgDatePreview));

        btnPgDateAccept.addEventListener('click', () => {
            if (currentReportDateTarget === 'pg') {
                pgFilterDateText.textContent = pgDatePreview.textContent;
            } else if (currentReportDateTarget === 'pb') {
                pbFilterDateText.textContent = pgDatePreview.textContent;
            } else if (currentReportDateTarget === 'cr') {
                crFilterDateText.textContent = pgDatePreview.textContent;
            } else if (currentReportDateTarget === 'pm') {
                pmFilterDateText.textContent = pgDatePreview.textContent;
            } else if (currentReportDateTarget === 'ex') {
                exFilterDateText.textContent = pgDatePreview.textContent;
            } else if (currentReportDateTarget === 'gn') {
                gnFilterDateText.textContent = pgDatePreview.textContent;
            }
            pgDateSelectionModal.style.display = 'none';
            // Ya no genera reporte automáticamente, se requiere dar clic en Consultar
        });

        document.getElementById('pg-filter-department').addEventListener('change', (e) => {
            const dept = e.target.value;
            const muniInput = document.getElementById('pg-filter-municipality');
            if (dept) {
                loadMunicipalitiesForSelect(dept, muniInput, true, true);
                muniInput.value = ''; // Limpiar selección por defecto al cambiar departamento
                muniInput.placeholder = 'Seleccionar Municipio...';
            }
        });

        document.getElementById('pb-filter-department').addEventListener('change', (e) => {
            const dept = e.target.value;
            const muniInput = document.getElementById('pb-filter-municipality');
            if (dept) {
                loadMunicipalitiesForSelect(dept, muniInput, true, true);
                muniInput.value = '';
                muniInput.placeholder = 'Seleccionar Municipio...';
            }
        });

        document.getElementById('cr-filter-department').addEventListener('change', (e) => {
            const dept = e.target.value;
            const muniInput = document.getElementById('cr-filter-municipality');
            if (dept) {
                loadMunicipalitiesForSelect(dept, muniInput, true, true);
                muniInput.value = '';
                muniInput.placeholder = 'Seleccionar Municipio...';
            }
        });

        document.getElementById('pm-filter-department').addEventListener('change', (e) => {
            const dept = e.target.value;
            const muniInput = document.getElementById('pm-filter-municipality');
            if (dept) {
                loadMunicipalitiesForSelect(dept, muniInput, true, true);
                muniInput.value = '';
                muniInput.placeholder = 'Seleccionar Municipio...';
            }
        });

        btnPgConsult.addEventListener('click', () => {
            if (document.getElementById('btn-pg-daily').classList.contains('active')) {
                generatePgReport('Diario');
            } else if (document.getElementById('btn-pg-weekly').classList.contains('active')) {
                generatePgReport('Semanal');
            }
        });

        btnPgRefresh.addEventListener('click', () => {
            if (document.getElementById('btn-pg-daily').classList.contains('active')) {
                generatePgReport('Diario');
            } else if (document.getElementById('btn-pg-weekly').classList.contains('active')) {
                generatePgReport('Semanal');
            }
        });

        btnPgDownload.addEventListener('click', () => {
            currentDownloadContext = 'pg_report_main';
            downloadFormatModal.style.display = 'flex';
        });

        btnPbConsult.addEventListener('click', () => {
            generatePaymentBehaviorReport();
        });

        btnPbRefresh.addEventListener('click', () => {
            generatePaymentBehaviorReport();
        });

        btnPbDownload.addEventListener('click', () => {
            currentDownloadContext = 'payment_behavior_report_main';
            downloadFormatModal.style.display = 'flex';
        });

        btnCrConsult.addEventListener('click', () => {
            generateCreditsReport();
        });

        btnCrRefresh.addEventListener('click', () => {
            generateCreditsReport();
        });

        btnCrDownload.addEventListener('click', () => {
            currentDownloadContext = 'credits_report_main';
            downloadFormatModal.style.display = 'flex';
        });

        btnPmConsult.addEventListener('click', () => {
            generatePmReport();
        });

        btnPmRefresh.addEventListener('click', () => {
            generatePmReport();
        });

        btnPmDownload.addEventListener('click', () => {
            currentDownloadContext = 'payments_report_main';
            downloadFormatModal.style.display = 'flex';
        });

        btnExConsult.addEventListener('click', () => {
            generateExReport();
        });

        btnExRefresh.addEventListener('click', () => {
            generateExReport();
        });

        btnExDownload.addEventListener('click', () => {
            currentDownloadContext = 'expenses_report';
            downloadFormatModal.style.display = 'flex';
        });

        btnGnConsult.addEventListener('click', () => {
            generateGnReport();
        });

        document.getElementById('btn-gn-refresh').addEventListener('click', () => {
            generateGnReport();
        });

        btnGnDownload.addEventListener('click', () => {
            currentDownloadContext = 'general_report';
            downloadFormatModal.style.display = 'flex';
        });

        async function loadPgFilters() {
            const deptInput = document.getElementById('pg-filter-department');
            const muniInput = document.getElementById('pg-filter-municipality');
            const userInput = document.getElementById('pg-filter-user');

            deptInput.value = '';
            deptInput.placeholder = 'Cargando...';
            muniInput.value = '';
            muniInput.placeholder = 'Seleccionar Municipio...';
            muniInput.disabled = true;
            userInput.value = '';
            userInput.placeholder = 'Cargando...';

            try {
                const snapshot = await db.collection('municipality').get();
                const departments = snapshot.docs.map(doc => doc.id).sort();
                
                setupSearchableInput('pg-filter-department', 'list-pg-filter-department', departments);
                
                if (departments.length === 1) {
                    deptInput.value = departments[0];
                    deptInput.disabled = true;
                    loadMunicipalitiesForSelect(departments[0], muniInput, true, true);
                    muniInput.value = ''; // Limpiar selección por defecto
                    muniInput.placeholder = 'Seleccionar Municipio...';
                } else {
                    deptInput.placeholder = 'Seleccionar Departamento...';
                    deptInput.disabled = false;
                }
            } catch (error) {
                console.error("Error loading departments:", error);
            }

            try {
                const usersSnapshot = await db.collection('users').where('role', '==', 'Usuario').get();
                let userNames = [];
                usersSnapshot.forEach(doc => {
                    if (doc.data().name) userNames.push(doc.data().name);
                });
                userNames.sort((a, b) => a.localeCompare(b));
                const users = ['Todos los usuarios', ...userNames];
                setupSearchableInput('pg-filter-user', 'list-pg-filter-user', users);
                userInput.value = ''; // Limpiar selección por defecto
                userInput.placeholder = 'Seleccionar Usuario...';
            } catch (error) {
                console.error("Error loading users:", error);
            }
        }

        async function loadCrFilters() {
            const deptInput = document.getElementById('cr-filter-department');
            const muniInput = document.getElementById('cr-filter-municipality');
            const userInput = document.getElementById('cr-filter-user');

            deptInput.value = '';
            deptInput.placeholder = 'Cargando...';
            muniInput.value = '';
            muniInput.placeholder = 'Seleccionar Municipio...';
            muniInput.disabled = true;
            userInput.value = '';
            userInput.placeholder = 'Cargando...';

            try {
                const snapshot = await db.collection('municipality').get();
                const departments = snapshot.docs.map(doc => doc.id).sort();
                setupSearchableInput('cr-filter-department', 'list-cr-filter-department', departments);
                if (departments.length === 1) {
                    deptInput.value = departments[0];
                    deptInput.disabled = true;
                    loadMunicipalitiesForSelect(departments[0], muniInput, true, true);
                } else {
                    deptInput.placeholder = 'Seleccionar Departamento...';
                    deptInput.disabled = false;
                }
                
                const usersSnapshot = await db.collection('users').where('role', '==', 'Usuario').get();
                const users = ['Todos los usuarios', ...usersSnapshot.docs.map(d => d.data().name).sort()];
                setupSearchableInput('cr-filter-user', 'list-cr-filter-user', users);
                userInput.placeholder = 'Seleccionar Usuario...';
            } catch (error) { console.error(error); }
        }

        async function loadPmFilters() {
            const deptInput = document.getElementById('pm-filter-department');
            const muniInput = document.getElementById('pm-filter-municipality');
            const userInput = document.getElementById('pm-filter-user');

            deptInput.value = '';
            deptInput.placeholder = 'Cargando...';
            muniInput.value = '';
            muniInput.placeholder = 'Seleccionar Municipio...';
            muniInput.disabled = true;
            userInput.value = '';
            userInput.placeholder = 'Cargando...';

            try {
                const snapshot = await db.collection('municipality').get();
                const departments = snapshot.docs.map(doc => doc.id).sort();
                setupSearchableInput('pm-filter-department', 'list-pm-filter-department', departments);
                if (departments.length === 1) {
                    deptInput.value = departments[0];
                    deptInput.disabled = true;
                    loadMunicipalitiesForSelect(departments[0], muniInput, true, true);
                } else {
                    deptInput.placeholder = 'Seleccionar Departamento...';
                    deptInput.disabled = false;
                }
                
                const usersSnapshot = await db.collection('users').where('role', '==', 'Usuario').get();
                const users = ['Todos los usuarios', ...usersSnapshot.docs.map(d => d.data().name).sort()];
                setupSearchableInput('pm-filter-user', 'list-pm-filter-user', users);
                userInput.placeholder = 'Seleccionar Usuario...';
            } catch (error) { console.error(error); }
        }

        async function loadExFilters() {
            const userInput = document.getElementById('ex-filter-user');

            userInput.value = '';
            userInput.placeholder = 'Cargando...';

            try {
                const usersSnapshot = await db.collection('users').where('role', '==', 'Usuario').get();
                const users = ['Todos los usuarios', ...usersSnapshot.docs.map(d => d.data().name).sort()];
                setupSearchableInput('ex-filter-user', 'list-ex-filter-user', users);
                userInput.placeholder = 'Seleccionar Usuario...';
            } catch (error) { console.error(error); }
        }

        async function loadGnFilters() {
            const userInput = document.getElementById('gn-filter-user');

            userInput.value = '';
            userInput.placeholder = 'Cargando...';

            try {
                const usersSnapshot = await db.collection('users').where('role', '==', 'Usuario').get();
                const users = ['Todos los usuarios', ...usersSnapshot.docs.map(d => d.data().name).sort()];
                setupSearchableInput('gn-filter-user', 'list-gn-filter-user', users);
                userInput.placeholder = 'Seleccionar Usuario...';
            } catch (error) { console.error(error); }
        }

        async function loadPbFilters() {
            const deptInput = document.getElementById('pb-filter-department');
            const muniInput = document.getElementById('pb-filter-municipality');
            const userInput = document.getElementById('pb-filter-user');

            deptInput.value = '';
            deptInput.placeholder = 'Cargando...';
            muniInput.value = '';
            muniInput.placeholder = 'Seleccionar Municipio...';
            muniInput.disabled = true;
            userInput.value = '';
            userInput.placeholder = 'Cargando...';

            try {
                const snapshot = await db.collection('municipality').get();
                const departments = snapshot.docs.map(doc => doc.id).sort();
                setupSearchableInput('pb-filter-department', 'list-pb-filter-department', departments);
                if (departments.length === 1) {
                    deptInput.value = departments[0];
                    deptInput.disabled = true;
                    loadMunicipalitiesForSelect(departments[0], muniInput, true, true);
                } else {
                    deptInput.placeholder = 'Seleccionar Departamento...';
                    deptInput.disabled = false;
                }
                
                const usersSnapshot = await db.collection('users').where('role', '==', 'Usuario').get();
                const users = ['Todos los usuarios', ...usersSnapshot.docs.map(d => d.data().name).sort()];
                setupSearchableInput('pb-filter-user', 'list-pb-filter-user', users);
                userInput.placeholder = 'Seleccionar Usuario...';
            } catch (error) { console.error(error); }
        }

        async function generatePgReport(mode) {
            const tbody = document.getElementById('pg-table-body');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';

            // Obtener Filtros
            const dept = document.getElementById('pg-filter-department').value;
            const muni = document.getElementById('pg-filter-municipality').value;
            const user = document.getElementById('pg-filter-user').value;
            
            // Obtener Rango de Fechas
            const type = document.getElementById('pg-date-type').value;
            let startDate, endDate;
            
            if (type === 'specific') {
                // Diario: Fecha específica
                const d = document.getElementById('pg-specific-day').value;
                const m = document.getElementById('pg-specific-month').value;
                const y = document.getElementById('pg-specific-year').value;
                startDate = new Date(y, m - 1, d, 0, 0, 0);
                endDate = new Date(y, m - 1, d, 23, 59, 59);
            } else if (type === 'week_of_month') {
                // Semanal: Semana específica del mes
                const w = parseInt(document.getElementById('pg-week-number').value);
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                
                // Calcular rango de la semana (1-7, 8-14, 15-21, 22-Fin)
                const startDay = (w - 1) * 7 + 1;
                let endDay = w * 7;
                
                // Ajustar fin de mes para la semana 4
                const daysInMonth = new Date(y, m, 0).getDate();
                if (w === 4) endDay = daysInMonth;
                
                startDate = new Date(y, m - 1, startDay, 0, 0, 0);
                endDate = new Date(y, m - 1, endDay, 23, 59, 59);

            } else if (type === 'month') {
                // Semanal: Mes completo (mostrará 4 filas)
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                startDate = new Date(y, m - 1, 1, 0, 0, 0);
                endDate = new Date(y, m, 0, 23, 59, 59);

            } else if (type === 'range') {
                // Rango manual
                const dStart = document.getElementById('pg-range-start-day').value;
                const mStart = document.getElementById('pg-range-start-month').value;
                const yStart = document.getElementById('pg-range-start-year').value;
                
                const dEnd = document.getElementById('pg-range-end-day').value;
                const mEnd = document.getElementById('pg-range-end-month').value;
                const yEnd = document.getElementById('pg-range-end-year').value;
                
                startDate = new Date(yStart, mStart - 1, dStart, 0, 0, 0);
                endDate = new Date(yEnd, mEnd - 1, dEnd, 23, 59, 59);
            } else {
                // Todos los tiempos (Rango amplio)
                startDate = new Date(2000, 0, 1);
                endDate = new Date(2100, 11, 31);
            }

            const isWeekly = mode === 'Semanal';

            try {
                // Calcular fecha de retroceso para buscar créditos activos antiguos (aprox 6 meses atrás)
                // Esto es necesario para calcular el "Cobro" esperado de créditos que vienen de atrás.
                // Para semanal, extendemos un poco más (1 año) por si acaso
                const lookbackDate = new Date(startDate);
                lookbackDate.setDate(lookbackDate.getDate() - (isWeekly ? 365 : 180));

                // 1. Consultar Debtors (Créditos) - Rango ampliado para detectar activos
                const { data: debtorsSnap, error: debtorsError } = await supabase
                    .from('debtors')
                    .select('*')
                    .gte('created_at', lookbackDate.toISOString())
                    .lte('created_at', endDate.toISOString());
                
                if (debtorsError) throw debtorsError;
                
                // 2. Consultar Payments (Cobro Real)
                const { data: paymentsSnap, error: paymentsError } = await supabase
                    .from('payments')
                    .select('*')
                    .gte('created_at', startDate.toISOString())
                    .lte('created_at', endDate.toISOString());

                if (paymentsError) throw paymentsError;

                // 3. Consultar Reports (Gastos)
                let reportsQuery = supabase.from(isWeekly ? 'wreports' : 'reports').select('*');
                if (user && user !== 'Todos los usuarios') {
                    reportsQuery = reportsQuery.eq('user_name', user);
                }
                const { data: reportsSnap, error: reportsError } = await reportsQuery;
                if (reportsError) throw reportsError;

                // Procesar Datos
                const dataMap = {}; // Clave: Fecha|Usuario|Municipio
                const getKey = (dateStr, userName, muniName) => `${dateStr}|${userName}|${muniName}`;
                
                // Helper para inicializar fila
                const initRow = (key, dateStr, userName, muniName, sortTime) => {
                    if (!dataMap[key]) {
                        dataMap[key] = { 
                            date: dateStr, 
                            user: userName, 
                            muni: muniName, 
                            cobro: 0, // Esperado
                            creditos: 0, // Nuevos
                            ganancia: 0, 
                            cobroReal: 0, 
                            gastos: 0, 
                            sortDate: sortTime 
                        };
                    }
                };

                // Helper para verificar si es Diario
                const isDiario = (term) => {
                    if (!term) return false;
                    if (Array.isArray(term)) return term.some(t => String(t).toUpperCase() === 'DIARIO');
                    return String(term).toUpperCase() === 'DIARIO';
                };
                
                // Helper para verificar si es Semanal
                const isSemanal = (term) => {
                    if (!term) return false;
                    if (Array.isArray(term)) return term.some(t => String(t).toUpperCase() === 'SEMANAL');
                    return String(term).toUpperCase() === 'SEMANAL';
                };

                // Helper para obtener la clave de semana (Semanal)
                const getWeekInfo = (dateObj) => {
                    const d = dateObj.getDate();
                    const m = dateObj.getMonth();
                    const y = dateObj.getFullYear();
                    const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                    
                    // Lógica de 4 semanas: 1-7, 8-14, 15-21, 22-Fin
                    let w = 4;
                    if (d <= 7) w = 1;
                    else if (d <= 14) w = 2;
                    else if (d <= 21) w = 3;
                    
                    const label = `Semana ${w} - ${months[m]} ${y}`;
                    // Fecha de ordenamiento: inicio de la semana
                    const sortTime = new Date(y, m, (w - 1) * 7 + 1).getTime();
                    return { label, sortTime };
                };

                // Mapa de deudores para verificación rápida en pagos
                const debtorsMap = new Map();

                // Generar array de fechas en el rango seleccionado para iterar "Cobro Esperado"
                const datesInRange = [];
                let currentDateIter = new Date(startDate);
                while (currentDateIter <= endDate) {
                    datesInRange.push(new Date(currentDateIter));
                    currentDateIter.setDate(currentDateIter.getDate() + 1);
                }

                // Procesar Créditos
                debtorsSnap.forEach(d => {
                    
                    // Filtrar por Usuario y Municipio en memoria (para evitar error de índices)
                    if (user && user !== 'Todos los usuarios' && d.asesor_name !== user) return;
                    if (muni && muni !== 'Todos los Municipios' && d.municipality !== muni) return;

                    // Guardar en mapa para uso en pagos
                    debtorsMap.set(d.id, d);

                    // Filtrar según modo
                    if (isWeekly) {
                        if (!isSemanal(d.payment_term)) return;
                    } else {
                        if (!isDiario(d.payment_term)) return;
                    }

                    const createdAt = new Date(d.created_at);
                    
                    // A. Columnas "CREDITOS" y "GANANCIA" (Solo si fue creado dentro del rango seleccionado y NO es importado)
                    if (d.imported !== true && createdAt >= startDate && createdAt <= endDate) {
                        let dateStr;
                        let sortTime;
                        if (isWeekly) {
                            const info = getWeekInfo(createdAt);
                            dateStr = info.label;
                            sortTime = info.sortTime;
                        } else {
                            dateStr = `${String(createdAt.getDate()).padStart(2,'0')}-${String(createdAt.getMonth()+1).padStart(2,'0')}-${createdAt.getFullYear()}`;
                            sortTime = createdAt.getTime();
                        }

                        const key = getKey(dateStr, d.asesor_name, d.municipality);
                        initRow(key, dateStr, d.asesor_name, d.municipality, sortTime);
                        
                        dataMap[key].creditos += (Number(d.sale_value) || 0);
                        dataMap[key].ganancia += (Number(d.interests) || 0);
                    }

                    // B. Columna "COBRO" (Esperado)
                    // Determinar fecha efectiva de inicio del crédito (usar saleDate si existe, especialmente para importados)
                    let effectiveDate = createdAt;
                    if (d.sale_date) {
                        if (typeof d.sale_date === 'string') {
                            if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(d.sale_date)) {
                                const parts = d.sale_date.split('-');
                                effectiveDate = new Date(parts[2], parts[1] - 1, parts[0]);
                            } else if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(d.sale_date)) {
                                const parts = d.sale_date.split('-');
                                effectiveDate = new Date(parts[0], parts[1] - 1, parts[2]);
                            }
                        }
                    }

                    // Sumar valorCuota si el crédito estaba "activo" en la fecha del reporte.
                    const numDays = Number(d.number_of_payments) || 0;
                    const expirationDate = new Date(effectiveDate);
                    // Calcular fecha de expiración según frecuencia
                    if (isWeekly) {
                        expirationDate.setDate(expirationDate.getDate() + (numDays * 7));
                    } else {
                        expirationDate.setDate(expirationDate.getDate() + numDays);
                    }
                    
                    // Rango de vida del crédito (desde el día siguiente a la creación)
                    const activeStart = new Date(effectiveDate);
                    activeStart.setDate(activeStart.getDate() + 1);
                    activeStart.setHours(0,0,0,0);
                    
                    const activeEnd = new Date(expirationDate);
                    activeEnd.setHours(23,59,59,999);

                    // Verificar para cada día del reporte si este crédito debe sumar al cobro
                    datesInRange.forEach(dayDate => {
                        const dayStart = new Date(dayDate);
                        dayStart.setHours(0,0,0,0);
                        
                        // Si el día está dentro del periodo activo del crédito O si tiene saldo pendiente (aunque esté vencido)
                        const hasBalance = (Number(d.balance) || 0) > 0;

                        if (dayStart >= activeStart && (dayStart <= activeEnd || hasBalance)) {
                            // Para semanal, verificar que el día coincida (ej: si se creó un martes, cobra los martes)
                            // Para diario, cobra todos los días
                            if (!isWeekly || (isWeekly && dayStart.getDay() === effectiveDate.getDay())) {
                                let dateStr;
                                let sortTime;
                                if (isWeekly) {
                                    const info = getWeekInfo(dayStart);
                                    dateStr = info.label;
                                    sortTime = info.sortTime;
                                } else {
                                    dateStr = `${String(dayStart.getDate()).padStart(2,'0')}-${String(dayStart.getMonth()+1).padStart(2,'0')}-${dayStart.getFullYear()}`;
                                    sortTime = dayStart.getTime();
                                }

                                const key = getKey(dateStr, d.asesor_name, d.municipality);
                                initRow(key, dateStr, d.asesor_name, d.municipality, sortTime);
                                
                                dataMap[key].cobro += (Number(d.valor_cuota) || 0);
                            }
                        }
                    });
                });

                // Procesar Pagos
                paymentsSnap.forEach(p => {
                    
                    // Filtrar por Usuario y Municipio en memoria (para evitar error de índices)
                    if (user && user !== 'Todos los usuarios' && p.user_name !== user) return;
                    if (muni && muni !== 'Todos los Municipios' && p.municipality !== muni) return;

                    // Regla Semanal: Ignorar pagos importados
                    if (isWeekly && p.imported === true) return;

                    // Ignorar importados
                    if (p.imported === true) return;

                    // Verificar que el crédito asociado sea Diario usando el mapa de deudores
                    // Si el deudor no está en el mapa (ej. muy antiguo fuera del lookback o importado), se ignora según lógica estricta
                    const debtor = debtorsMap.get(p.debtor_id);
                    if (!debtor) return; 
                    if (isWeekly) {
                        if (!isSemanal(debtor.payment_term)) return;
                    } else {
                        if (!isDiario(debtor.payment_term)) return;
                    }

                    const date = new Date(p.created_at);
                    let dateStr;
                    let sortTime;
                    if (isWeekly) {
                        const info = getWeekInfo(date);
                        dateStr = info.label;
                        sortTime = info.sortTime;
                    } else {
                        dateStr = `${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`;
                        sortTime = date.getTime();
                    }

                    const key = getKey(dateStr, p.user_name, p.municipality);

                    initRow(key, dateStr, p.user_name, p.municipality, sortTime);
                    dataMap[key].cobroReal += (Number(p.payment_amount) || 0);
                });

                // Procesar Gastos (Reports) y asignarlos
                const expensesMap = {};
                reportsSnap.forEach(r => {
                    let rDate;
                    let dateStr;

                    if (isWeekly) {
                        // wreports usa createdAt (Timestamp)
                        rDate = new Date(r.created_at);
                        const info = getWeekInfo(rDate);
                        dateStr = info.label;
                    } else {
                        // reports usa report_date (String dd-MM-yyyy)
                        const [d, m, y] = r.report_date.split('-').map(Number);
                        rDate = new Date(y, m - 1, d);
                        dateStr = r.report_date;
                    }

                    if (rDate >= startDate && rDate <= endDate) {
                        expensesMap[`${dateStr}|${r.user_name}`] = (Number(r.expense_report) || 0);
                    }
                });

                const expensesApplied = new Set();
                Object.values(dataMap).forEach(row => {
                    const expKey = `${row.date}|${row.user}`;
                    if (expensesMap[expKey] && !expensesApplied.has(expKey)) {
                        row.gastos = expensesMap[expKey];
                        expensesApplied.add(expKey); // Asignar gasto solo a la primera fila encontrada del usuario/fecha
                    }
                });

                // Renderizar
                const sortedRows = Object.values(dataMap).sort((a, b) => b.sortDate - a.sortDate);
                currentPgReportData = sortedRows; // Guardar para descarga
                let html = sortedRows.length ? sortedRows.map(row => `<tr><td>${row.date}</td><td>${row.user}</td><td>${row.muni}</td><td>$${row.cobro.toLocaleString('es-CO')}</td><td>$${row.gastos.toLocaleString('es-CO')}</td><td>$${row.creditos.toLocaleString('es-CO')}</td><td>$${row.ganancia.toLocaleString('es-CO')}</td><td>$${row.cobroReal.toLocaleString('es-CO')}</td></tr>`).join('') : '<tr><td colspan="8" style="text-align:center;">No hay datos para el rango seleccionado.</td></tr>';
                
                tbody.innerHTML = html;

            } catch (error) {
                console.error("Error generating P&G report:", error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">Error al generar reporte.</td></tr>';
            }
        }

        // Helper to get last N payments for dropdown
        async function getLastPaymentsForDebtor(debtorId, refDate, n, isWeekly) {
            // refDate is the date of the missed payment. We want payments BEFORE this date.
            // For simplicity, we query all payments for this debtor and sort/slice in memory or query with limit.
            // Since we need "last N before date", a query with orderBy desc and startAfter is best, 
            // but refDate might be a string or object.
            
            try {
                const { data: paymentsSnap, error } = await supabase
                    .from('payments')
                    .select('*')
                    .eq('debtor_id', debtorId);
                
                let payments = paymentsSnap.map(d => {
                    const dateObj = parseDate(d.payment_date) || (d.created_at ? new Date(d.created_at) : new Date(0));
                    return { ...d, dateObj };
                });

                // Filter payments strictly BEFORE the reference date/time
                // refDate passed here is the start of the missed day/week.
                payments = payments.filter(p => p.dateObj < refDate);

                // Sort descending
                payments.sort((a, b) => b.dateObj - a.dateObj);

                // Take top N
                payments = payments.slice(0, n);

                // Format for display
                const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                
                return payments.map(p => {
                    const d = p.dateObj;
                    const dateStr = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
                    
                    // Calculate week num for weekly mode
                    let weekNum = 0;
                    if (isWeekly) {
                        const day = d.getDate();
                        if (day <= 7) weekNum = 1;
                        else if (day <= 14) weekNum = 2;
                        else if (day <= 21) weekNum = 3;
                        else weekNum = 4;
                    }

                    return {
                        date: dateStr,
                        quotaVal: Number(p.valor_cuota) || 0,
                        amount: Number(p.payment_amount) || 0,
                        weekNum: weekNum,
                        month: months[d.getMonth()]
                    };
                });
            } catch (e) {
                console.error("Error fetching history:", e);
                return [];
            }
        }

        // Function to toggle dropdown
        window.toggleMissedPaymentDetails = async (btn, debtorId, dateStr, mode) => {
            const tr = btn.closest('tr');
            const nextTr = tr.nextElementSibling;
            
            if (nextTr && nextTr.classList.contains('history-dropdown-row')) {
                nextTr.remove();
                btn.classList.remove('fa-chevron-up');
                btn.classList.add('fa-chevron-down');
                return;
            }

            // Change icon
            btn.classList.remove('fa-chevron-down');
            btn.classList.add('fa-chevron-up');

            // Create row
            const newRow = document.createElement('tr');
            newRow.className = 'history-dropdown-row';
            const cell = document.createElement('td');
            cell.colSpan = 9;
            cell.innerHTML = '<div class="history-table-container"><div class="spinner" style="width:20px; height:20px; margin:0 auto;"></div></div>';
            newRow.appendChild(cell);
            tr.parentNode.insertBefore(newRow, tr.nextSibling);

            // Fetch data
            // Parse dateStr back to object for comparison
            const [d, m, y] = dateStr.split('-').map(Number);
            const refDate = new Date(y, m - 1, d);
            const isWeekly = mode === 'Semanal';
            const limit = isWeekly ? 4 : 15;

            const history = await getLastPaymentsForDebtor(debtorId, refDate, limit, isWeekly);
            
            // Get debtor info for header (stored in button dataset or fetch?)
            // We can fetch from DB or pass via dataset. Fetching is safer.
            const { data: debtorData } = await supabase.from('debtors').select('*').eq('id', debtorId).single();

            // Store for download
            currentHistoryData = { debtor: { ...debtorData, name: debtorData.name || 'Cliente' }, payments: history, mode: mode };

            // Render table
            let tableHtml = `<div style="display:flex; justify-content:flex-end; margin-bottom:8px;"><button class="history-download-btn" onclick="currentDownloadContext='payment_behavior_history'; downloadFormatModal.style.display='flex';"><i class="fas fa-download"></i></button></div>`;
            tableHtml += `<table class="history-table"><thead><tr>`;
            
            if (isWeekly) {
                tableHtml += `<th>Semana</th><th>Mes</th><th>Fecha Pago</th><th>Valor Cuota</th><th>Abono</th>`;
            } else {
                tableHtml += `<th>Fecha Pago</th><th>Valor Cuota</th><th>Abono</th>`;
            }
            tableHtml += `</tr></thead><tbody>`;

            if (history.length === 0) {
                tableHtml += `<tr><td colspan="${isWeekly?5:3}" style="text-align:center;">No hay pagos anteriores recientes.</td></tr>`;
            } else {
                history.forEach(h => {
                    if (isWeekly) {
                        tableHtml += `<tr><td>${h.weekNum}</td><td>${h.month}</td><td>${h.date}</td><td>$${h.quotaVal.toLocaleString('es-CO')}</td><td>$${h.amount.toLocaleString('es-CO')}</td></tr>`;
                    } else {
                        tableHtml += `<tr><td>${h.date}</td><td>$${h.quotaVal.toLocaleString('es-CO')}</td><td>$${h.amount.toLocaleString('es-CO')}</td></tr>`;
                    }
                });
            }
            tableHtml += `</tbody></table>`;

            cell.querySelector('.history-table-container').innerHTML = tableHtml;
        };

        async function generatePaymentBehaviorReport() {
            const tbody = document.getElementById('pb-table-body');
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';

            const dept = document.getElementById('pb-filter-department').value;
            const muni = document.getElementById('pb-filter-municipality').value;
            const user = document.getElementById('pb-filter-user').value;
            const isWeekly = document.getElementById('btn-pb-weekly').classList.contains('active');
            
            // Get Date Range (Reuse logic from P&G)
            const type = document.getElementById('pg-date-type').value;
            let startDate, endDate;
            let dateStrForImported = null;
            
            if (type === 'specific') {
                const d = document.getElementById('pg-specific-day').value;
                const m = document.getElementById('pg-specific-month').value;
                const y = document.getElementById('pg-specific-year').value;
                startDate = new Date(y, m - 1, d, 0, 0, 0);
                endDate = new Date(y, m - 1, d, 23, 59, 59);
                dateStrForImported = `${String(d).padStart(2,'0')}-${String(m).padStart(2,'0')}-${y}`;
            } else if (type === 'week_of_month') {
                const w = parseInt(document.getElementById('pg-week-number').value);
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                const startDay = (w - 1) * 7 + 1;
                let endDay = w * 7;
                const daysInMonth = new Date(y, m, 0).getDate();
                if (w === 4) endDay = daysInMonth;
                startDate = new Date(y, m - 1, startDay, 0, 0, 0);
                endDate = new Date(y, m - 1, endDay, 23, 59, 59);
            } else if (type === 'month') {
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                startDate = new Date(y, m - 1, 1, 0, 0, 0);
                endDate = new Date(y, m, 0, 23, 59, 59);
            } else if (type === 'range') {
                const dStart = document.getElementById('pg-range-start-day').value;
                const mStart = document.getElementById('pg-range-start-month').value;
                const yStart = document.getElementById('pg-range-start-year').value;
                
                const dEnd = document.getElementById('pg-range-end-day').value;
                const mEnd = document.getElementById('pg-range-end-month').value;
                const yEnd = document.getElementById('pg-range-end-year').value;
                
                startDate = new Date(yStart, mStart - 1, dStart, 0, 0, 0);
                endDate = new Date(yEnd, mEnd - 1, dEnd, 23, 59, 59);
            } else {
                startDate = new Date(2000, 0, 1);
                endDate = new Date(2100, 11, 31);
            }

            // Helper to format date
            const formatDate = (date) => `${String(date.getDate()).padStart(2,'0')}-${String(date.getMonth()+1).padStart(2,'0')}-${date.getFullYear()}`;
            const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

            try {
                if (!isWeekly) {
                    // --- LOGICA DIARIO ---
                    
                    // 1. Consultar Deudores (Activos y Diario)
                    let debtorsQuery = supabase.from('debtors').select('*');
                    let filterMuniInJs = false;

                    if (user && user !== 'Todos los usuarios') {
                        debtorsQuery = debtorsQuery.eq('asesor_name', user);
                        if (muni && muni !== 'Todos los Municipios') filterMuniInJs = true;
                    } else if (muni && muni !== 'Todos los Municipios') {
                        debtorsQuery = debtorsQuery.eq('municipality', muni);
                    }
                    
                    const { data: debtorsSnap, error: debtorsError } = await debtorsQuery;
                    if (debtorsError) throw debtorsError;
                    const debtors = [];
                    
                    debtorsSnap.forEach(d => {
                        
                        // Filtro JS Municipio (si aplica)
                        if (filterMuniInJs && d.municipality !== muni) return;

                        // Filtro Balance > 0
                        if ((Number(d.balance) || 0) <= 0) return;
                        
                        // Filtro PaymentTerm == DIARIO
                        let isDiario = false;
                        if (Array.isArray(d.payment_term)) {
                            isDiario = d.payment_term.some(t => String(t).toUpperCase() === 'DIARIO');
                        } else {
                            isDiario = String(d.payment_term).toUpperCase() === 'DIARIO';
                        }
                        
                        if (isDiario) {
                            debtors.push(d);
                        }
                    });

                    // 2. Consultar Pagos (Por paymentDate)
                    const paymentsMap = {}; // Key: debtorId|dateStr -> amount
                    const dateStrings = [];
                    
                    if (type === 'specific') {
                        dateStrings.push(dateStrForImported);
                    } else {
                        let currentDate = new Date(startDate);
                        // Iterate through range to build keys
                        while (currentDate <= endDate) {
                            dateStrings.push(formatDate(currentDate));
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }

                    // Fetch payments in chunks
                    const chunks = [];
                    for (let i = 0; i < dateStrings.length; i += 10) {
                        chunks.push(dateStrings.slice(i, i + 10));
                    }

                    const paymentPromises = chunks.map(chunk => supabase.from('payments').select('*').in('payment_date', chunk));
                    const paymentSnaps = await Promise.all(paymentPromises);

                    paymentSnaps.forEach(({ data: snap }) => {
                        if (snap) {
                            snap.forEach(p => {
                            if (user && user !== 'Todos los usuarios' && p.user_name !== user) return;
                            if (muni && muni !== 'Todos los Municipios' && p.municipality !== muni) return;
                            if (p.debtor_id) {
                                // Map by debtor AND date
                                const key = `${p.debtor_id}|${p.payment_date}`;
                                paymentsMap[key] = (paymentsMap[key] || 0) + (Number(p.payment_amount) || 0);
                            }
                        });
                        }
                    });

                    // 3. Render
                    let html = '';
                    debtors.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    
                    const reportData = [];

                    // Iterate debtors and dates to find misses
                    debtors.forEach(r => {
                        dateStrings.forEach(dateStr => {
                            // Check if debtor was active on this date
                            const created = r.created_at ? new Date(r.created_at) : new Date(0);
                            const [d, m, y] = dateStr.split('-').map(Number); 
                            const checkDateStart = new Date(y, m - 1, d, 0, 0, 0);
                            
                            if (created >= checkDateStart) return; // Created on or after this date (no payment due yet)

                            const key = `${r.id}|${dateStr}`;
                            const paidAmount = paymentsMap[key] || 0;

                            if (paidAmount === 0) {
                                // Missed Payment!
                                const nuevos = r.credit_type === 'Nuevo' ? (Number(r.sale_value) || 0) : 0;
                                const represtes = r.credit_type === 'Represte' ? (Number(r.sale_value) || 0) : 0;

                                reportData.push({
                                    id: r.id,
                                    name: r.name,
                                    municipality: r.municipality,
                                    asesor_name: r.asesor_name,
                                    dateStr: dateStr, // Date of missed payment
                                    saleDate: r.sale_date || 'N/A', // Actual loan date
                                    dateObj: checkDateStart,
                                    nuevos: nuevos,
                                    represtes: represtes,
                                    valor_cuota: Number(r.valor_cuota) || 0,
                                    abonos: 0, // It's missed
                                    balance: Number(r.balance) || 0
                                });
                            }
                        });
                    });

                    reportData.forEach(row => {
                        html += `<tr>
                            <td>${row.name || 'N/A'}</td>
                            <td>${row.municipality || 'N/A'}</td>
                            <td>${row.asesor_name || 'N/A'}</td>
                            <td>${row.saleDate}</td>
                            <td>$${row.nuevos.toLocaleString('es-CO')}</td>
                            <td>$${row.represtes.toLocaleString('es-CO')}</td>
                            <td>$${row.valor_cuota.toLocaleString('es-CO')}</td>
                            <td style="text-align:center; cursor:pointer;" onclick="toggleMissedPaymentDetails(this.querySelector('i'), '${row.id}', '${row.dateStr}', 'Diario')">
                                <i class="fas fa-chevron-down dropdown-toggle"></i>
                            </td>
                            <td>$${row.balance.toLocaleString('es-CO')}</td>
                        </tr>`;
                    });
                    
                    currentPbReportData = reportData; // For main export if needed (though format differs)
                    tbody.innerHTML = html || '<tr><td colspan="9" style="text-align:center;">Todos los clientes realizaron sus pagos en las fechas seleccionadas.</td></tr>';

                } else {
                    // --- LOGICA SEMANAL ---
                    
                    // 1. Consultar Deudores (Activos y Semanal)
                    let debtorsQuery = supabase.from('debtors').select('*');
                    let filterMuniInJs = false;

                    if (user && user !== 'Todos los usuarios') {
                        debtorsQuery = debtorsQuery.eq('asesor_name', user);
                        if (muni && muni !== 'Todos los Municipios') filterMuniInJs = true;
                    } else if (muni && muni !== 'Todos los Municipios') {
                        debtorsQuery = debtorsQuery.eq('municipality', muni);
                    }

                    const { data: debtorsSnap, error: debtorsError } = await debtorsQuery;
                    if (debtorsError) throw debtorsError;
                    const debtors = [];

                    debtorsSnap.forEach(d => {
                        
                        // Filtro JS Municipio
                        if (filterMuniInJs && d.municipality !== muni) return;

                        // Filtro Balance > 0
                        if ((Number(d.balance) || 0) <= 0) return;

                        // Filtro PaymentTerm == SEMANAL
                        let isSemanal = false;
                        if (Array.isArray(d.payment_term)) {
                            isSemanal = d.payment_term.some(t => String(t).toUpperCase() === 'SEMANAL');
                        } else {
                            isSemanal = String(d.payment_term).toUpperCase() === 'SEMANAL';
                        }

                        if (isSemanal) {
                            debtors.push(d);
                        }
                    });

                    // 2. Consultar Pagos (Por paymentDate)
                    const paymentsMap = {}; // Key: debtorId|WeekLabel -> amount
                    const dateStrings = [];
                    const weekLabels = new Set();
                    const weekMap = {}; // dateStr -> WeekLabel
                    const weekRanges = {}; // Label -> {start, end}

                    let currentDate = new Date(startDate);
                    while (currentDate <= endDate) {
                        const dStr = formatDate(currentDate);
                        dateStrings.push(dStr);
                        
                        // Determine Week Label
                        const d = currentDate.getDate();
                        const m = currentDate.getMonth();
                        const y = currentDate.getFullYear();
                        let w = 4;
                        if (d <= 7) w = 1;
                        else if (d <= 14) w = 2;
                        else if (d <= 21) w = 3;
                        
                        const label = `Semana ${w} - ${months[m]} ${y}`;
                        weekLabels.add(label);
                        weekMap[dStr] = label;

                        // Track range for this week label
                        if (!weekRanges[label]) weekRanges[label] = { start: new Date(currentDate), end: new Date(currentDate) };
                        const range = weekRanges[label];
                        if (currentDate < range.start) range.start = new Date(currentDate);
                        if (currentDate > range.end) range.end = new Date(currentDate);

                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    // Convert Set to Array for iteration
                    const sortedWeeks = Array.from(weekLabels).sort((a,b) => {
                        // Simple sort, might need better logic if crossing years, but sufficient for now
                        return a.localeCompare(b);
                    });

                    const chunks = [];
                    for (let i = 0; i < dateStrings.length; i += 10) {
                        chunks.push(dateStrings.slice(i, i + 10));
                    }

                    const paymentPromises = chunks.map(chunk => supabase.from('payments').select('*').in('payment_date', chunk));
                    const paymentSnaps = await Promise.all(paymentPromises);

                    paymentSnaps.forEach(({ data: snap }) => {
                        if (snap) {
                            snap.forEach(p => {
                            if (user && user !== 'Todos los usuarios' && p.user_name !== user) return;
                            if (muni && muni !== 'Todos los Municipios' && p.municipality !== muni) return;
                            if (p.debtor_id) {
                                const label = weekMap[p.payment_date];
                                const key = `${p.debtor_id}|${label}`;
                                paymentsMap[key] = (paymentsMap[key] || 0) + (Number(p.payment_amount) || 0);
                            }
                        });
                        }
                    });

                    // 3. Render
                    let html = '';
                    debtors.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    
                    const reportData = [];

                    // Iterate debtors and weeks
                    debtors.forEach(r => {
                        sortedWeeks.forEach(weekLabel => {
                            // Check creation date vs week
                            const created = r.created_at ? new Date(r.created_at) : new Date(0);
                            const range = weekRanges[weekLabel];
                            
                            // If created on or after the start of the week, exclude
                            if (range && created >= range.start) return;
                            
                            const key = `${r.id}|${weekLabel}`;
                            const paidAmount = paymentsMap[key] || 0;

                            if (paidAmount === 0) {
                                const nuevos = r.credit_type === 'Nuevo' ? (Number(r.sale_value) || 0) : 0;
                                const represtes = r.credit_type === 'Represte' ? (Number(r.sale_value) || 0) : 0;
                                
                                // Use week start date for sorting/reference if needed, or just label
                                // We pass the label as dateStr
                                
                                reportData.push({
                                    id: r.id,
                                    name: r.name,
                                    municipality: r.municipality,
                                    asesorName: r.asesor_name,
                                    dateStr: weekLabel,
                                    saleDate: r.sale_date || 'N/A',
                                    dateObj: null, // Not strictly needed for display
                                    nuevos: nuevos,
                                    represtes: represtes,
                                    valorCuota: Number(r.valor_cuota) || 0,
                                    abonos: 0,
                                    balance: Number(r.balance) || 0
                                });
                            }
                        });
                    });

                    reportData.forEach(row => {
                        // For weekly, we need a date string for the dropdown to calculate "previous 4 weeks".
                        // We can pass the week label and parse it in the toggle function, or pass a representative date.
                        // Let's pass a representative date (e.g. start of that week) to the toggle function.
                        // We need to reconstruct date from label "Semana X - Mes YYYY".
                        // Or simpler: pass the label and handle logic in getLastPayments.
                        // Actually, toggleMissedPaymentDetails expects a dateStr dd-mm-yyyy.
                        // Let's find a date within that week.
                        // We can use the first date in `dateStrings` that matches the label in `weekMap`.
                        const repDate = dateStrings.find(d => weekMap[d] === row.dateStr) || formatDate(new Date());

                        html += `<tr>
                            <td>${row.name || 'N/A'}</td>
                            <td>${row.municipality || 'N/A'}</td>
                            <td>${row.asesor_name || 'N/A'}</td>
                            <td>${row.saleDate}</td>
                            <td>$${row.nuevos.toLocaleString('es-CO')}</td>
                            <td>$${row.represtes.toLocaleString('es-CO')}</td>
                            <td>$${row.valor_cuota.toLocaleString('es-CO')}</td>
                            <td style="text-align:center; cursor:pointer;" onclick="toggleMissedPaymentDetails(this.querySelector('i'), '${row.id}', '${repDate}', 'Semanal')">
                                <i class="fas fa-chevron-down dropdown-toggle"></i>
                            </td>
                            <td>$${row.balance.toLocaleString('es-CO')}</td>
                        </tr>`;
                    });

                    currentPbReportData = reportData;
                    tbody.innerHTML = html || '<tr><td colspan="9" style="text-align:center;">Todos los clientes realizaron sus pagos en las semanas seleccionadas.</td></tr>';
                }
            } catch (error) {
                console.error("Error generating PB report:", error);
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; color:red;">Error al generar reporte.</td></tr>';
            }
        }

        // Helper to update municipality filter based on user selection
        async function updateUserMunicipalities(userName, targetInputId) {
            const targetInput = document.getElementById(targetInputId);
            if (!userName || userName === 'Todos los usuarios') {
                // If all users, we might want to allow all municipalities or reset. 
                // The prompt says "siempre tenga la opcion de seleccionar todos los municipios".
                // We'll leave it as is or reload all departments? 
                // Existing logic loads munis based on department filter usually.
                // If we want to filter by user's assigned munis, we do it here.
                return; 
            }
            
            targetInput.value = '';
            targetInput.placeholder = 'Cargando...';
            targetInput.disabled = true;

            try {
                const { data: userData, error } = await supabase.from('users').select('assigned_municipality').eq('name', userName).limit(1).single();
                
                if (userData) {
                    let assigned = userData.assigned_municipality || [];
                    assigned.sort();
                    assigned.unshift('Todos los Municipios');
                    
                    setupSearchableInput(targetInputId, 'list-' + targetInputId, assigned);
                    targetInput.placeholder = 'Seleccionar Municipio...';
                    targetInput.disabled = false;
                } else {
                     targetInput.placeholder = 'Usuario no encontrado';
                     targetInput.disabled = false;
                }
            } catch (e) {
                console.error(e);
                targetInput.placeholder = 'Error';
                targetInput.disabled = false;
            }
        }

        // Attach listeners to user filters
        ['pg', 'pb', 'cr', 'pm', 'ex', 'gn'].forEach(prefix => {
            const userInput = document.getElementById(`${prefix}-filter-user`);
            if (userInput) {
                userInput.addEventListener('change', (e) => {
                    updateUserMunicipalities(e.target.value, `${prefix}-filter-municipality`);
                });
            }
        });

        async function generateCreditsReport() {
            const tbody = document.getElementById('cr-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';
            document.getElementById('cr-total-display').textContent = '$0';

            const dept = document.getElementById('cr-filter-department').value;
            const muni = document.getElementById('cr-filter-municipality').value;
            const user = document.getElementById('cr-filter-user').value;
            const isWeekly = document.getElementById('btn-cr-weekly').classList.contains('active');
            
            // Get Date Range
            const type = document.getElementById('pg-date-type').value;
            let startDate, endDate;
            
            if (type === 'specific') {
                const d = document.getElementById('pg-specific-day').value;
                const m = document.getElementById('pg-specific-month').value;
                const y = document.getElementById('pg-specific-year').value;
                startDate = new Date(y, m - 1, d, 0, 0, 0);
                endDate = new Date(y, m - 1, d, 23, 59, 59);
            } else if (type === 'week_of_month') {
                const w = parseInt(document.getElementById('pg-week-number').value);
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                const startDay = (w - 1) * 7 + 1;
                let endDay = w * 7;
                const daysInMonth = new Date(y, m, 0).getDate();
                if (w === 4) endDay = daysInMonth;
                startDate = new Date(y, m - 1, startDay, 0, 0, 0);
                endDate = new Date(y, m - 1, endDay, 23, 59, 59);
            } else if (type === 'month') {
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                startDate = new Date(y, m - 1, 1, 0, 0, 0);
                endDate = new Date(y, m, 0, 23, 59, 59);
            } else if (type === 'range') {
                const dStart = document.getElementById('pg-range-start-day').value;
                const mStart = document.getElementById('pg-range-start-month').value;
                const yStart = document.getElementById('pg-range-start-year').value;
                
                const dEnd = document.getElementById('pg-range-end-day').value;
                const mEnd = document.getElementById('pg-range-end-month').value;
                const yEnd = document.getElementById('pg-range-end-year').value;
                
                startDate = new Date(yStart, mStart - 1, dStart, 0, 0, 0);
                endDate = new Date(yEnd, mEnd - 1, dEnd, 23, 59, 59);
            } else {
                startDate = new Date(2000, 0, 1);
                endDate = new Date(2100, 11, 31);
            }

            try {
                let query = supabase.from('debtors').select('*');
                let filterMuniInJs = false;

                if (user && user !== 'Todos los usuarios') {
                    query = query.eq('asesor_name', user);
                    if (muni && muni !== 'Todos los Municipios') filterMuniInJs = true;
                } else if (muni && muni !== 'Todos los Municipios') {
                    query = query.eq('municipality', muni);
                }
                
                const { data: snapshot, error } = await query;
                if (error) throw error;
                const records = [];

                snapshot.forEach(d => {
                    
                    // Filters JS
                    if (filterMuniInJs && d.municipality !== muni) return;

                    const recordDate = parseDate(d.sale_date) || (d.created_at ? new Date(d.created_at) : null);
                    if (!recordDate || recordDate < startDate || recordDate > endDate) return;

                    // Mode Filter
                    let term = d.payment_term;
                    let match = false;
                    const targetTerm = isWeekly ? 'SEMANAL' : 'DIARIO';
                    
                    if (Array.isArray(term)) {
                        match = term.some(t => String(t).toUpperCase() === targetTerm);
                    } else {
                        match = String(term).toUpperCase() === targetTerm;
                    }
                    
                    if (!match) return;

                    records.push(d);
                });

                // Sort
                records.sort((a, b) => {
                    const dateA = parseDate(a.sale_date) || (a.created_at ? new Date(a.created_at) : new Date(0));
                    const dateB = parseDate(b.sale_date) || (b.created_at ? new Date(b.created_at) : new Date(0));
                    return dateB - dateA;
                });

                currentCrReportData = records; // Guardar para descarga

                let totalCredits = 0;
                let html = '';
                records.forEach(r => {
                    const saleValue = Number(r.sale_value) || 0;
                    totalCredits += saleValue;

                    const creditType = (r.credit_type || '').toUpperCase();
                    
                    let nuevo = 0;
                    let represte = 0;

                    if (creditType === 'NUEVO') {
                        nuevo = saleValue;
                    } else if (creditType === 'REPRESTE') {
                        represte = saleValue;
                    }

                    let dateStr = 'N/A';
                    if (r.sale_date) dateStr = r.sale_date;
                    else if (r.created_at) dateStr = new Date(r.created_at).toLocaleDateString();

                    html += `<tr>
                        <td>${r.name || 'N/A'}</td>
                        <td>${dateStr}</td>
                        <td>${r.asesor_name || 'N/A'}</td>
                        <td>${r.municipality || 'N/A'}</td>
                        <td>$${nuevo.toLocaleString('es-CO')}</td>
                        <td>$${represte.toLocaleString('es-CO')}</td>
                    </tr>`;
                });

                document.getElementById('cr-total-display').textContent = '$' + totalCredits.toLocaleString('es-CO');
                tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;">No se encontraron registros.</td></tr>';
            } catch (error) {
                console.error("Error generating CR report:", error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error al generar reporte.</td></tr>';
            }
        }

        async function generateExReport() {
            const tbody = document.getElementById('ex-table-body');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';

            const user = document.getElementById('ex-filter-user').value;
            const isWeekly = document.getElementById('btn-ex-weekly').classList.contains('active');
            
            // Get Date Range
            const type = document.getElementById('pg-date-type').value;
            let startDate, endDate;
            
            if (type === 'specific') {
                const d = document.getElementById('pg-specific-day').value;
                const m = document.getElementById('pg-specific-month').value;
                const y = document.getElementById('pg-specific-year').value;
                startDate = new Date(y, m - 1, d, 0, 0, 0);
                endDate = new Date(y, m - 1, d, 23, 59, 59);
            } else if (type === 'week_of_month') {
                const w = parseInt(document.getElementById('pg-week-number').value);
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                const startDay = (w - 1) * 7 + 1;
                let endDay = w * 7;
                const daysInMonth = new Date(y, m, 0).getDate();
                if (w === 4) endDay = daysInMonth;
                startDate = new Date(y, m - 1, startDay, 0, 0, 0);
                endDate = new Date(y, m - 1, endDay, 23, 59, 59);
            } else if (type === 'month') {
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                startDate = new Date(y, m - 1, 1, 0, 0, 0);
                endDate = new Date(y, m, 0, 23, 59, 59);
            } else if (type === 'range') {
                const dStart = document.getElementById('pg-range-start-day').value;
                const mStart = document.getElementById('pg-range-start-month').value;
                const yStart = document.getElementById('pg-range-start-year').value;
                
                const dEnd = document.getElementById('pg-range-end-day').value;
                const mEnd = document.getElementById('pg-range-end-month').value;
                const yEnd = document.getElementById('pg-range-end-year').value;
                
                startDate = new Date(yStart, mStart - 1, dStart, 0, 0, 0);
                endDate = new Date(yEnd, mEnd - 1, dEnd, 23, 59, 59);
            } else {
                startDate = new Date(2000, 0, 1);
                endDate = new Date(2100, 11, 31);
            }

            try {
                const collectionName = isWeekly ? 'wexpenses' : 'expenses';
                let query = supabase.from(collectionName)
                    .select('*')
                    .gte('created_at', startDate.toISOString())
                    .lte('created_at', endDate.toISOString());
                
                if (user && user !== 'Todos los usuarios') {
                    query = query.eq('user_name', user);
                }

                const { data: snapshot, error } = await query;
                if (error) throw error;
                const records = snapshot;

                // Sort by date desc
                records.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                currentExReportData = records; // Guardar para descarga

                let html = '';
                records.forEach(r => {
                    const othersVal = (r.others && r.others.length > 0) ? (Number(r.others[0]) || 0) : 0;
                    if (othersVal <= 0) return;

                    const othersDesc = (r.others && r.others.length > 1) ? r.others[1] : 'N/A';
                    
                    let dateStr = 'N/A';
                    if (r.created_at) dateStr = new Date(r.created_at).toLocaleDateString();

                    html += `<tr>
                        <td>${r.user_name || 'N/A'}</td>
                        <td>${dateStr}</td>
                        <td>$${othersVal.toLocaleString('es-CO')}</td>
                        <td>${othersDesc}</td>
                    </tr>`;
                });

                tbody.innerHTML = html || '<tr><td colspan="4" style="text-align:center;">No se encontraron registros.</td></tr>';
            } catch (error) {
                console.error("Error generating EX report:", error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Error al generar reporte.</td></tr>';
            }
        }

        async function generateGnReport() {
            const tbody = document.getElementById('gn-table-body');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';

            const user = document.getElementById('gn-filter-user').value;
            const isWeekly = document.getElementById('btn-gn-weekly').classList.contains('active');
            
            // Get Date Range
            const type = document.getElementById('pg-date-type').value;
            let startDate, endDate;
            
            if (type === 'specific') {
                const d = document.getElementById('pg-specific-day').value;
                const m = document.getElementById('pg-specific-month').value;
                const y = document.getElementById('pg-specific-year').value;
                startDate = new Date(y, m - 1, d, 0, 0, 0);
                endDate = new Date(y, m - 1, d, 23, 59, 59);
            } else if (type === 'week_of_month') {
                const w = parseInt(document.getElementById('pg-week-number').value);
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                const startDay = (w - 1) * 7 + 1;
                let endDay = w * 7;
                const daysInMonth = new Date(y, m, 0).getDate();
                if (w === 4) endDay = daysInMonth;
                startDate = new Date(y, m - 1, startDay, 0, 0, 0);
                endDate = new Date(y, m - 1, endDay, 23, 59, 59);
            } else if (type === 'month') {
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                startDate = new Date(y, m - 1, 1, 0, 0, 0);
                endDate = new Date(y, m, 0, 23, 59, 59);
            } else if (type === 'range') {
                const dStart = document.getElementById('pg-range-start-day').value;
                const mStart = document.getElementById('pg-range-start-month').value;
                const yStart = document.getElementById('pg-range-start-year').value;
                
                const dEnd = document.getElementById('pg-range-end-day').value;
                const mEnd = document.getElementById('pg-range-end-month').value;
                const yEnd = document.getElementById('pg-range-end-year').value;
                
                startDate = new Date(yStart, mStart - 1, dStart, 0, 0, 0);
                endDate = new Date(yEnd, mEnd - 1, dEnd, 23, 59, 59);
            } else {
                startDate = new Date(2000, 0, 1);
                endDate = new Date(2100, 11, 31);
            }

            try {
                const collectionName = isWeekly ? 'wreports' : 'reports';
                let query = supabase.from(collectionName)
                    .select('*')
                    .gte('created_at', startDate.toISOString())
                    .lte('created_at', endDate.toISOString());
                
                if (user && user !== 'Todos los usuarios') {
                    query = query.eq('user_name', user);
                }

                const { data: snapshot, error } = await query;
                if (error) throw error;
                const records = snapshot;

                // Sort by date desc
                records.sort((a, b) => {
                    const tA = a.created_at ? new Date(a.created_at).getTime() : 0;
                    const tB = b.created_at ? new Date(b.created_at).getTime() : 0;
                    return tB - tA;
                });

                currentGnReportData = records; // Guardar para descarga

                let html = '';
                const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

                let injectionHtml = '';
                // Lógica de Inyección (Proyección del siguiente reporte)
                if (user && user !== 'Todos los usuarios' && records.length > 0) {
                    const lastRecord = records[0]; // El más reciente (por orden descendente)
                    const lastDate = lastRecord.created_at ? new Date(lastRecord.created_at) : null;

                    if (lastDate) {
                        const nextDate = new Date(lastDate);
                        if (isWeekly) {
                            nextDate.setDate(nextDate.getDate() + 7);
                        } else {
                            nextDate.setDate(nextDate.getDate() + 1);
                        }

                        const nextDayName = days[nextDate.getDay()];
                        const nextDisplayDate = nextDate.toLocaleDateString();
                        const nextInitialBase = Number(lastRecord.final_base) || 0;

                        // Fila de proyección (Inyección)
                        injectionHtml = `<tr style="background-color: #e8f8f5; border-bottom: 2px solid #2ecc71;">
                            <td>${user} <span style="font-size: 10px; color: #27ae60; font-weight: bold;">(Inyección)</span></td>
                            <td>-</td>
                            <td>-</td>
                            <td>-</td>
                            <td id="cell-injection-${lastRecord.id}">
                                $${nextInitialBase.toLocaleString('es-CO')} 
                                <button class="btn btn-inject-base" data-id="${lastRecord.id}" data-val="${nextInitialBase}" data-collection="${collectionName}" style="width: 20px; height: 20px; padding: 0; font-size: 10px; margin-left: 5px; background-color: #27ae60; display: inline-flex; justify-content: center; align-items: center;" title="Inyectar Base"><i class="fas fa-edit"></i></button>
                            </td>
                            <td>-</td>
                            <td>${nextDayName}</td>
                            <td>${nextDisplayDate}</td>
                        </tr>`;
                    }
                }

                records.forEach((r, index) => {
                    const createdAt = r.created_at ? new Date(r.created_at) : null;
                    let dayName = 'N/A';
                    let displayDate = 'N/A';
                    let btnDateStr = '';

                    // Lógica para mostrar ogFinalBase si existe (Inyección realizada)
                    let finalBaseDisplay = r.final_base;
                    if (r.og_final_base !== undefined && r.og_final_base !== null) {
                        finalBaseDisplay = r.og_final_base;
                    }

                    if (createdAt) {
                        dayName = days[createdAt.getDay()];
                        displayDate = createdAt.toLocaleDateString();
                    }

                    if (isWeekly) {
                         if (createdAt) {
                            const dStr = String(createdAt.getDate()).padStart(2, '0');
                            const mStr = String(createdAt.getMonth() + 1).padStart(2, '0');
                            const yStr = createdAt.getFullYear();
                            btnDateStr = `${dStr}-${mStr}-${yStr}`;
                         }
                    } else {
                        btnDateStr = r.report_date || displayDate.replace(/\//g, '-');
                    }

                    // Handle expenseReport vs expensesReport
                    const gastos = r.expense_report !== undefined ? r.expense_report : (r.expenses_report || 0);

                    let buttons = { credits: '', payments: '', expenses: '' };
                    let editExpenseBtn = '';
                    
                    if (isWeekly) {
                         const ts = createdAt ? createdAt.getTime() : 0;
                         buttons.credits = `<button class="btn view-report-credits-btn" data-date="${btnDateStr}" data-user="${r.user_name}" data-collection="wreports" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Créditos"><i class="fas fa-eye"></i></button>`;
                         buttons.payments = `<button class="btn view-report-payments-btn" data-date="${btnDateStr}" data-user="${r.user_name}" data-collection="wreports" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Cobros"><i class="fas fa-eye"></i></button>`;
                         buttons.expenses = `<button class="btn view-weekly-expense-details-btn" data-created-at="${ts}" data-user="${r.user_name}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver detalles"><i class="fas fa-eye"></i></button>`;
                         editExpenseBtn = `<button class="btn edit-weekly-expense-btn" data-created-at="${ts}" data-user="${r.user_name}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;" title="Editar"><i class="fas fa-edit"></i></button>`;
                    } else {
                         buttons.credits = `<button class="btn view-report-credits-btn" data-date="${btnDateStr}" data-user="${r.user_name}" data-collection="reports" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Créditos"><i class="fas fa-eye"></i></button>`;
                         buttons.payments = `<button class="btn view-report-payments-btn" data-date="${btnDateStr}" data-user="${r.user_name}" data-collection="reports" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver Cobros"><i class="fas fa-eye"></i></button>`;
                         buttons.expenses = `<button class="btn view-expense-details-btn" data-date="${btnDateStr}" data-user="${r.user_name}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #3498db; display: inline-flex; justify-content: center; align-items: center;" title="Ver detalles"><i class="fas fa-eye"></i></button>`;
                         editExpenseBtn = `<button class="btn edit-expense-btn" data-date="${btnDateStr}" data-user="${r.user_name}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;" title="Editar"><i class="fas fa-edit"></i></button>`;
                    }

                    const collectionName = isWeekly ? 'wreports' : 'reports';

                    html += `<tr>
                        <td>${r.user_name || 'N/A'}</td>
                        <td>$${(Number(r.credits_report) || 0).toLocaleString('es-CO')} ${buttons.credits}</td>
                        <td>$${(Number(r.payments_report) || 0).toLocaleString('es-CO')} ${buttons.payments}</td>
                        <td>$${(Number(gastos) || 0).toLocaleString('es-CO')} ${editExpenseBtn} ${buttons.expenses}</td>
                        <td id="cell-initialBase-${r.id}">$${(Number(r.initial_base) || 0).toLocaleString('es-CO')} <button class="btn edit-base-btn" data-id="${r.id}" data-field="initial_base" data-val="${r.initial_base || 0}" data-collection="${collectionName}" style="width: 20px; height: 20px; padding: 0; font-size: 10px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-edit"></i></button></td>
                        <td id="cell-finalBase-${r.id}">$${(Number(finalBaseDisplay) || 0).toLocaleString('es-CO')} <button class="btn edit-base-btn" data-id="${r.id}" data-field="final_base" data-val="${finalBaseDisplay || 0}" data-collection="${collectionName}" style="width: 20px; height: 20px; padding: 0; font-size: 10px; margin-left: 5px; background-color: #f39c12; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-edit"></i></button></td>
                        <td>${dayName}</td>
                        <td>${displayDate}</td>
                    </tr>`;

                    if (index === 0 && injectionHtml) {
                        html += injectionHtml;
                    }
                });

                tbody.innerHTML = html || '<tr><td colspan="8" style="text-align:center;">No se encontraron registros.</td></tr>';
            } catch (error) {
                console.error("Error generating GN report:", error);
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">Error al generar reporte.</td></tr>';
            }
        }

        // Listener para botones en la tabla de Reportes General (GN)
        document.getElementById('gn-table-body').addEventListener('click', async (e) => {
            // Editar Inyección
            const btnInject = e.target.closest('.btn-inject-base');
            if (btnInject) {
                const id = btnInject.dataset.id;
                const val = btnInject.dataset.val;
                const collection = btnInject.dataset.collection;
                const cell = document.getElementById(`cell-injection-${id}`);
                
                cell.innerHTML = `
                    <input type="number" id="input-injection-${id}" value="${val}" style="width: 80px;">
                    <button class="btn save-injection-btn" data-id="${id}" data-collection="${collection}" style="width: 25px; height: 25px; padding: 0; font-size: 12px; background-color: #2ecc71; display: inline-flex; justify-content: center; align-items: center;"><i class="fas fa-save"></i></button>
                `;
                return;
            }

            const btnSaveInject = e.target.closest('.save-injection-btn');
            if (btnSaveInject) {
                const id = btnSaveInject.dataset.id;
                const collection = btnSaveInject.dataset.collection;
                const newVal = Number(document.getElementById(`input-injection-${id}`).value);
                
                btnSaveInject.innerHTML = '<div class="small-spinner"></div>';
                btnSaveInject.disabled = true;

                try {
                    const { data: docSnap, error } = await supabase.from(collection).select('*').eq('id', id).single();
                    if (docSnap) {
                        const data = docSnap;
                        const currentFinalBase = data.final_base;
                        const updateData = { final_base: newVal };
                        if (data.og_final_base === undefined) {
                            updateData.og_final_base = currentFinalBase;
                        }
                        await supabase.from(collection).update(updateData).eq('id', id);
                        showToast("Inyección realizada correctamente");
                        generateGnReport();
                    }
                } catch (error) { console.error(error); alert("Error: " + error.message); }
                return;
            }

            // Ver Detalle Cobros
            const btnPayments = e.target.closest('.view-report-payments-btn');
            if (btnPayments) {
                const dateStr = btnPayments.dataset.date;
                const userName = btnPayments.dataset.user;
                const collection = btnPayments.dataset.collection || 'reports';
                const term = collection === 'wreports' ? 'Semanal' : 'Diario';
                loadReportPaymentsDetails(userName, dateStr, term, collection);
                return;
            }

            // Ver Detalle Créditos
            const btnCredits = e.target.closest('.view-report-credits-btn');
            if (btnCredits) {
                const dateStr = btnCredits.dataset.date;
                const userName = btnCredits.dataset.user;
                const collection = btnCredits.dataset.collection || 'reports';
                const term = collection === 'wreports' ? 'Semanal' : 'Diario';
                loadReportCreditsDetails(userName, dateStr, term, collection);
                return;
            }

            // Ver Detalle Gastos (Diario)
            const btnExpenses = e.target.closest('.view-expense-details-btn');
            if (btnExpenses) {
                const reportDateStr = btnExpenses.dataset.date;
                const userName = btnExpenses.dataset.user;
                try {
                    const [day, month, year] = reportDateStr.split('-').map(Number);
                    const startDate = new Date(year, month - 1, day, 0, 0, 0);
                    const endDate = new Date(year, month - 1, day, 23, 59, 59);
                    const { data: expensesSnapshot, error } = await supabase.from('expenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1).single();
                    if (!expensesSnapshot) { alert("No se encontraron detalles de gastos."); return; }
                    const data = expensesSnapshot;
                    const othersVal = (data.others && data.others.length > 0) ? data.others[0] : 0;
                    const othersDesc = (data.others && data.others.length > 1) ? data.others[1] : '';
                    const content = document.getElementById('expenses-details-content');
                    content.innerHTML = `
                        <p><strong>Gasolina:</strong> $${(data.fuel || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Almuerzo:</strong> $${(data.lunch || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Otros:</strong> $${Number(othersVal).toLocaleString('es-CO')} <br> <span style="font-size: 0.9em; color: #666;">(Este gasto es de: ${othersDesc || 'Sin descripción'})</span></p>
                    `;
                    document.getElementById('view-expenses-details-modal').style.display = 'flex';
                } catch (error) { console.error(error); }
                return;
            }

            // Ver Detalle Gastos (Semanal)
            const btnWeeklyExpenses = e.target.closest('.view-weekly-expense-details-btn');
            if (btnWeeklyExpenses) {
                const createdAtMillis = Number(btnWeeklyExpenses.dataset.createdAt);
                const userName = btnWeeklyExpenses.dataset.user;
                if (!createdAtMillis) return;
                try {
                    const reportDate = new Date(createdAtMillis);
                    const startDate = new Date(reportDate); startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(reportDate); endDate.setHours(23, 59, 59, 999);
                    const { data: expensesSnapshot, error } = await supabase.from('wexpenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1).single();
                    if (!expensesSnapshot) { alert("No se encontraron detalles de gastos semanales."); return; }
                    const data = expensesSnapshot;
                    const othersVal = (data.others && data.others.length > 0) ? data.others[0] : 0;
                    const othersDesc = (data.others && data.others.length > 1) ? data.others[1] : '';
                    const content = document.getElementById('expenses-details-content');
                    content.innerHTML = `
                        <p><strong>Gasolina:</strong> $${(data.fuel || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Almuerzo:</strong> $${(data.lunch || 0).toLocaleString('es-CO')}</p>
                        <p><strong>Otros:</strong> $${Number(othersVal).toLocaleString('es-CO')} <br> <span style="font-size: 0.9em; color: #666;">(Este gasto es de: ${othersDesc || 'Sin descripción'})</span></p>
                    `;
                    document.getElementById('view-expenses-details-modal').style.display = 'flex';
                } catch (error) { console.error(error); }
                return;
            }

            // Editar Gastos (Diario)
            const btnEditExpense = e.target.closest('.edit-expense-btn');
            if (btnEditExpense) {
                const reportDateStr = btnEditExpense.dataset.date;
                const userName = btnEditExpense.dataset.user;
                if (!reportDateStr || !userName) return;
                try {
                    const [day, month, year] = reportDateStr.split('-').map(Number);
                    const startDate = new Date(year, month - 1, day, 0, 0, 0);
                    const endDate = new Date(year, month - 1, day, 23, 59, 59);
                    const { data: doc, error } = await supabase.from('expenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1).single();
                    if (!doc) { alert("No se encontró el registro de gastos detallado."); return; }
                    const data = doc;
                    document.getElementById('edit-expenses-id').value = doc.id;
                    document.getElementById('edit-expenses-user').value = userName;
                    document.getElementById('edit-expenses-date').value = reportDateStr;
                    document.getElementById('edit-expenses-collection').value = 'expenses';
                    editExpensesFuel.value = formatCurrency(data.fuel || 0);
                    editExpensesLunch.value = formatCurrency(data.lunch || 0);
                    editExpensesOthers.value = formatCurrency((data.others && data.others.length > 0) ? data.others[0] : 0);
                    editExpensesOthersDesc.value = (data.others && data.others.length > 1) ? data.others[1] : '';
                    calculateExpensesTotal();
                    editExpensesModal.style.display = 'flex';
                } catch (error) { console.error(error); alert("Error: " + error.message); }
                return;
            }

            // Editar Gastos (Semanal)
            const btnEditWeeklyExpense = e.target.closest('.edit-weekly-expense-btn');
            if (btnEditWeeklyExpense) {
                const createdAtMillis = Number(btnEditWeeklyExpense.dataset.createdAt);
                const userName = btnEditWeeklyExpense.dataset.user;
                if (!createdAtMillis) return;
                try {
                    const reportDate = new Date(createdAtMillis);
                    const startDate = new Date(reportDate); startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(reportDate); endDate.setHours(23, 59, 59, 999);
                    const { data: doc, error } = await supabase.from('wexpenses')
                        .select('*')
                        .eq('user_name', userName)
                        .gte('created_at', startDate.toISOString())
                        .lte('created_at', endDate.toISOString())
                        .limit(1).single();
                    if (!doc) { alert("No se encontró el registro de gastos."); return; }
                    const data = doc;
                    document.getElementById('edit-expenses-id').value = doc.id;
                    document.getElementById('edit-expenses-user').value = userName;
                    document.getElementById('edit-expenses-collection').value = 'wexpenses';
                    document.getElementById('edit-expenses-timestamp').value = createdAtMillis;
                    editExpensesFuel.value = formatCurrency(data.fuel || 0);
                    editExpensesLunch.value = formatCurrency(data.lunch || 0);
                    editExpensesOthers.value = formatCurrency((data.others && data.others.length > 0) ? data.others[0] : 0);
                    editExpensesOthersDesc.value = (data.others && data.others.length > 1) ? data.others[1] : '';
                    calculateExpensesTotal();
                    editExpensesModal.style.display = 'flex';
                } catch (error) { console.error(error); alert("Error: " + error.message); }
                return;
            }
        });

        async function generatePmReport() {
            const tbody = document.getElementById('pm-table-body');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;"><div class="spinner" style="width:30px; height:30px; margin:0 auto;"></div></td></tr>';
            document.getElementById('pm-total-cobro-display').textContent = '$0';
            document.getElementById('pm-total-recaudo-display').textContent = '$0';

            const dept = document.getElementById('pm-filter-department').value;
            const muni = document.getElementById('pm-filter-municipality').value;
            const user = document.getElementById('pm-filter-user').value;
            const isWeekly = document.getElementById('btn-pm-weekly').classList.contains('active');
            
            // Get Date Range
            const type = document.getElementById('pg-date-type').value;
            let startDate, endDate;
            
            if (type === 'specific') {
                const d = document.getElementById('pg-specific-day').value;
                const m = document.getElementById('pg-specific-month').value;
                const y = document.getElementById('pg-specific-year').value;
                startDate = new Date(y, m - 1, d, 0, 0, 0);
                endDate = new Date(y, m - 1, d, 23, 59, 59);
            } else if (type === 'week_of_month') {
                const w = parseInt(document.getElementById('pg-week-number').value);
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                const startDay = (w - 1) * 7 + 1;
                let endDay = w * 7;
                const daysInMonth = new Date(y, m, 0).getDate();
                if (w === 4) endDay = daysInMonth;
                startDate = new Date(y, m - 1, startDay, 0, 0, 0);
                endDate = new Date(y, m - 1, endDay, 23, 59, 59);
            } else if (type === 'month') {
                const m = parseInt(document.getElementById('pg-wm-month').value);
                const y = parseInt(document.getElementById('pg-wm-year').value);
                startDate = new Date(y, m - 1, 1, 0, 0, 0);
                endDate = new Date(y, m, 0, 23, 59, 59);
            } else if (type === 'range') {
                const dStart = document.getElementById('pg-range-start-day').value;
                const mStart = document.getElementById('pg-range-start-month').value;
                const yStart = document.getElementById('pg-range-start-year').value;
                
                const dEnd = document.getElementById('pg-range-end-day').value;
                const mEnd = document.getElementById('pg-range-end-month').value;
                const yEnd = document.getElementById('pg-range-end-year').value;
                
                startDate = new Date(yStart, mStart - 1, dStart, 0, 0, 0);
                endDate = new Date(yEnd, mEnd - 1, dEnd, 23, 59, 59);
            } else {
                startDate = new Date(2000, 0, 1);
                endDate = new Date(2100, 11, 31);
            }

            try {
                let payments = [];

                // 1. Native Payments (createdAt)
                let nativeQuery = db.collection('payments')
                    .where('createdAt', '>=', startDate)
                    .where('createdAt', '<=', endDate);
                
                const nativeSnap = await nativeQuery.get();
                nativeSnap.forEach(doc => payments.push({id: doc.id, ...doc.data()}));

                // 2. Imported Payments (paymentDate string)
                const dateStrings = [];
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const d = String(currentDate.getDate()).padStart(2, '0');
                    const m = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const y = currentDate.getFullYear();
                    dateStrings.push(`${d}-${m}-${y}`);
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                const chunks = [];
                for (let i = 0; i < dateStrings.length; i += 10) {
                    chunks.push(dateStrings.slice(i, i + 10));
                }

                const importedPromises = chunks.map(chunk => 
                    db.collection('payments').where('imported', '==', true).where('paymentDate', 'in', chunk).get()
                );

                const importedSnaps = await Promise.all(importedPromises);
                importedSnaps.forEach(snap => {
                    snap.forEach(doc => {
                        if (!payments.some(p => p.id === doc.id)) {
                            payments.push({id: doc.id, ...doc.data()});
                        }
                    });
                });

                // 3. Filter & Fetch Debtors
                const filteredPayments = payments.filter(p => {
                    if (user && user !== 'Todos los usuarios' && p.userName !== user) return false;
                    if (muni && muni !== 'Todos los Municipios' && p.municipality !== muni) return false;
                    return true;
                });

                const debtorIds = new Set(filteredPayments.map(p => p.debtorId).filter(id => id));
                const debtorMap = new Map();

                if (debtorIds.size > 0) {
                    const ids = Array.from(debtorIds);
                    const dChunks = [];
                    for (let i = 0; i < ids.length; i += 10) dChunks.push(ids.slice(i, i + 10));
                    
                    const dPromises = dChunks.map(chunk => db.collection('debtors').where(firebase.firestore.FieldPath.documentId(), 'in', chunk).get());
                    const dSnaps = await Promise.all(dPromises);
                    dSnaps.forEach(snap => snap.forEach(doc => debtorMap.set(doc.id, doc.data())));
                }

                // 4. Process & Sort
                const records = [];
                const targetTerm = isWeekly ? 'SEMANAL' : 'DIARIO';

                filteredPayments.forEach(p => {
                    const debtor = debtorMap.get(p.debtorId);
                    const term = debtor ? debtor.paymentTerm : 'Diario'; // Default if missing
                    
                    let match = false;
                    if (Array.isArray(term)) match = term.some(t => String(t).toUpperCase() === targetTerm);
                    else match = String(term).toUpperCase() === targetTerm;
                    
                    if (!match) return;

                    records.push({
                        ...p,
                        valorCuota: debtor ? debtor.valorCuota : (p.valorCuota || 0)
                    });
                });

                records.sort((a, b) => {
                    const dateA = parseDate(a.paymentDate) || (a.createdAt ? a.createdAt.toDate() : new Date(0));
                    const dateB = parseDate(b.paymentDate) || (b.createdAt ? b.createdAt.toDate() : new Date(0));
                    return dateB - dateA;
                });

                currentPmReportData = records; // Guardar para descarga

                let totalCobro = 0;
                let totalRecaudo = 0;
                let html = '';

                records.forEach(r => {
                    let dateStr = r.paymentDate || 'N/A';
                    if (r.createdAt && (!r.paymentDate || r.paymentDate === 'N/A')) {
                        dateStr = r.createdAt.toDate().toLocaleDateString();
                    }

                    totalCobro += (Number(r.valorCuota) || 0);
                    totalRecaudo += (Number(r.paymentAmount) || 0);

                    html += `<tr>
                        <td>${r.debtorName || 'N/A'}</td>
                        <td>${dateStr}</td>
                        <td>${r.userName || 'N/A'}</td>
                        <td>${r.municipality || 'N/A'}</td>
                        <td>$${(Number(r.valorCuota) || 0).toLocaleString('es-CO')}</td>
                        <td>$${(Number(r.paymentAmount) || 0).toLocaleString('es-CO')}</td>
                    </tr>`;
                });

                document.getElementById('pm-total-cobro-display').textContent = '$' + totalCobro.toLocaleString('es-CO');
                document.getElementById('pm-total-recaudo-display').textContent = '$' + totalRecaudo.toLocaleString('es-CO');
                tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;">No se encontraron registros.</td></tr>';
            } catch (error) {
                console.error("Error generating PM report:", error);
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error al generar reporte.</td></tr>';
            }
        }

        // Función ROBUSTA para limpiar alertas antiguas (> 10 min) de alertsReprest
        async function cleanOldAlertsReprest() {
            try {
                // Get alerts created more than 10 minutes ago
                const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000).toISOString();

                const { error } = await supabase
                    .from('alerts_represt')
                    .delete()
                    .lt('created_at', tenMinutesAgo);

                if (error) {
                    console.error("Error cleaning old alertsReprest:", error);
                }
            } catch (error) {
                console.error("Error in cleanOldAlertsReprest function:", error);
            }
        }

        // Agrega esto al final de tu script para quitar la carga si algo falla
        setTimeout(() => {
            if (document.getElementById('loading-screen').style.display !== 'none') {
                console.warn("La pantalla de carga tardó demasiado, ocultando manualmente.");
                fadeOutLoadingScreen();
                // Si después de quitar la carga no se ve ni el panel ni el login, forzar el login
                if (document.getElementById('admin-panel').style.display === 'none' && document.getElementById('login-container').style.display === 'none') {
                    document.getElementById('login-container').style.display = 'flex';
                }
            }
        }, 8000); // 8 segundos máximo

    </script>
</body>
</html>